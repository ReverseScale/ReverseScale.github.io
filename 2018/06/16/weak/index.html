<!DOCTYPE html>
<!--[if lte IE 8 ]>
<html class="ie" xmlns="http://www.w3.org/1999/xhtml" xml:lang="en-US" lang="en-US">
<![endif]-->
<!--[if (gte IE 9)|!(IE)]><!-->
<!--
***************  *      *     *
      8          *    *       *
      8          *  *         *
      8          **           *
      8          *  *         *
      8          *    *       *
      8          *      *     *
      8          *        *   ***********    -----Theme By Kieran(http://go.kieran.top)
-->
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en-US" lang="en-US">
<!--<![endif]-->

<head>
  <title>Objective-C Principle - weak | Steven&#39;s Technology Blog</title>
  <!-- Meta data -->
    <meta http-equiv="Content-Type" content="text/html" charset="UTF-8" >
    <meta http-equiv="X-UA-Compatible" content="IE=edge"/>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="generator" content="Steven's Technology Blog">
    <meta name="author" content="Steven">
    <meta name="description" content="" />
    <meta name="keywords" content="" />

    <!-- Favicon, (keep icon in root folder) -->
    <link rel="Shortcut Icon" href="/img/favicon.ico" type="image/ico">

    <link rel="alternate" href="/atom.xml" title="Steven&#39;s Technology Blog" type="application/atom+xml">
    <link rel="stylesheet" href="/css/all.css" media="screen" type="text/css">
	
    <link rel="stylesheet" href="/highlightjs/vs.css" type="text/css">
    
    

    <!-- Custom stylesheet, (add custom styles here, always load last) -->
    <!-- Load our stylesheet for IE8 -->
    <!--[if IE 8]>
    <link rel="stylesheet" type="text/css" href="/css/ie8.css" />
    <![endif]-->

    <!-- Google Webfonts (Monserrat 400/700, Open Sans 400/600) -->
    <link href='//fonts.useso.com/css?family=Montserrat:400,700' rel='stylesheet' type='text/css'>
    <link href='//fonts.useso.com/css?family=Open+Sans:400,600' rel='stylesheet' type='text/css'>

    <!-- Load our fonts individually if IE8+, to avoid faux bold & italic rendering -->
    <!--[if IE]>
    <link href='http://fonts.useso.com/css?family=Montserrat:400' rel='stylesheet' type='text/css'>
    <link href='http://fonts.useso.com/css?family=Montserrat:700' rel='stylesheet' type='text/css'>
    <link href='http://fonts.useso.com/css?family=Open+Sans:400' rel='stylesheet' type='text/css'>
    <link href='http://fonts.useso.com/css?family=Open+Sans:600' rel='stylesheet' type='text/css'>
    <![endif]-->

    <!-- jQuery | Load our jQuery, with an alternative source fallback to a local version if request is unavailable -->
    <script src="/js/jquery-1.11.1.min.js"></script>
    <script>window.jQuery || document.write('<script src="js/jquery-1.11.1.min.js"><\/script>')</script>

    <!-- Load these in the <head> for quicker IE8+ load times -->
    <!-- HTML5 shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!--[if lt IE 9]>
    <script src="/js/html5shiv.min.js"></script>
    <script src="/js/respond.min.js"></script>
    <![endif]-->










  
  
  

  
  <style>.col-md-8.col-md-offset-2.opening-statement img{display:none;}</style>
</head>

<!--
<body class="post-template">
-->
<body id="index" class="lightnav animsition">

      <!-- ============================ Off-canvas navigation =========================== -->

    <div class="sb-slidebar sb-right sb-style-overlay sb-momentum-scrolling">
        <div class="sb-close" aria-label="Close Menu" aria-hidden="true">
            <img src="/img/close.png" alt="Close"/>
        </div>
        <!-- Lists in Slidebars -->
        <ul class="sb-menu">
            <li><a href="/" class="animsition-link" title="Home">Home</a></li>
            <li><a href="/archives" class="animsition-link" title="archive">archives</a></li>
            <!-- Dropdown Menu -->
			 
            <li>
                <a class="sb-toggle-submenu">Works<span class="sb-caret"></span></a>
                <ul class="sb-submenu">
                    
                        <li><a href="/tags/åšå®¢ï¼Œæ–‡ç« " target="_BLANK" class="animsition-link">æ–‡ç« </a></li>
                    
                        <li><a href="/tags/åšå®¢ï¼Œèµ„æ–™" target="_BLANK" class="animsition-link">èµ„æ–™</a></li>
                    
                </ul>
            </li>
            
            
        	<li>
        		<a class="sb-toggle-submenu">Categories<span class="sb-caret"></span></a>
            	<ul class="sb-submenu">
				  	
				    <li><a href="/categories/API/" class="animsition-link">API<small>(1)</small></a></li>
				    
				    <li><a href="/categories/Android/" class="animsition-link">Android<small>(1)</small></a></li>
				    
				    <li><a href="/categories/Git/" class="animsition-link">Git<small>(1)</small></a></li>
				    
				    <li><a href="/categories/HTML5/" class="animsition-link">HTML5<small>(5)</small></a></li>
				    
				    <li><a href="/categories/Markdown/" class="animsition-link">Markdown<small>(1)</small></a></li>
				    
				    <li><a href="/categories/PHP/" class="animsition-link">PHP<small>(1)</small></a></li>
				    
				    <li><a href="/categories/Tools/" class="animsition-link">Tools<small>(2)</small></a></li>
				    
				    <li><a href="/categories/Unity-3D/" class="animsition-link">Unity 3D<small>(1)</small></a></li>
				    
				    <li><a href="/categories/iOS/" class="animsition-link">iOS<small>(130)</small></a></li>
				    
				    <li><a href="/categories/å‰æ²¿æŠ€æœ¯/" class="animsition-link">å‰æ²¿æŠ€æœ¯<small>(5)</small></a></li>
				    
				    <li><a href="/categories/æ–‡ç« /" class="animsition-link">æ–‡ç« <small>(5)</small></a></li>
				    
				    <li><a href="/categories/è®¾è®¡/" class="animsition-link">è®¾è®¡<small>(4)</small></a></li>
				    
				</ul>
        	</li>
			
            
            <li>
                <a class="sb-toggle-submenu">Links<span class="sb-caret"></span></a>
                <ul class="sb-submenu">
                    
                    <li><a href="https://www.qtumist.com" class="animsition-link">é‡å­è®¡ç®—</a></li>
                    
                    <li><a href="https://blog.ibeats.top" class="animsition-link">CI_Knight</a></li>
                    
                </ul>
            </li>
            
        </ul>
        <!-- Lists in Slidebars -->
        <ul class="sb-menu secondary">
            <li><a href="/about.html" class="animsition-link" title="about">About</a></li>
            <li><a href="/atom.xml" class="animsition-link" title="rss">RSS</a></li>
        </ul>
    </div>
    
    <!-- ============================ END Off-canvas navigation =========================== -->

    <!-- ============================ #sb-site Main Page Wrapper =========================== -->

    <div id="sb-site">
        <!-- #sb-site - All page content should be contained within this id, except the off-canvas navigation itself -->

        <!-- ============================ Header & Logo bar =========================== -->

        <div id="navigation" class="navbar navbar-fixed-top">
            <div class="navbar-inner">
                <div class="container">
                    <!-- Nav logo -->
                    <div class="logo">
                        <a href="/" title="Logo" class="animsition-link">
                         <img src="/img/logo.png" alt="Logo" width="35px;"/> 
                        </a>
                    </div>
                    <!-- // Nav logo -->
                    <!-- Info-bar -->
                    <nav>
                        <ul class="nav">
                            <li><a href="/" class="animsition-link">Steven's Technology Blog</a></li>
                            <li class="nolink"><span>Always </span>Creative.</li>
                            
                            <li><a href="https://github.com/ReverseScale" title="Github" target="_blank"><i class="icon-github"></i></a></li>
                            
                            
                            <li><a href="https://twitter.com/" title="Twitter" target="_blank"><i class="icon-twitter"></i></a></li>
                            
                            
                            <li><a href="https://www.facebook.com/" title="Facebook" target="_blank"><i class="icon-facebook"></i></a></li>
                            
                            
                            <li><a href="https://google.com/" title="Google-Plus" target="_blank"><i class="icon-google-plus"></i></a></li>
                            
                            
                            <li><a href="http://www.weibo.com/5844576818/profile?rightmod=1&wvr=6&mod=personinfo&is_all=1" title="Sina-Weibo" target="_blank"><i class="icon-sina-weibo"></i></a></li>
                            
                            <li class="nolink"><span>Welcome!</span></li>
                        </ul>
                    </nav>
                    <!--// Info-bar -->
                </div>
                <!-- // .container -->
                <div class="learnmore sb-toggle-right">More</div>
                <button type="button" class="navbar-toggle menu-icon sb-toggle-right" title="More">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar before"></span>
                <span class="icon-bar main"></span>
                <span class="icon-bar after"></span>
                </button>
            </div>
            <!-- // .navbar-inner -->
        </div>

        <!-- ============================ Header & Logo bar =========================== -->


      
<section id="intro">
    <div class="container">
        <div class="row col-md-offset-2">
            <div class="col-md-8">
    			<span class="post-meta">
      <time datetime="2018-06-16T11:54:57.000Z" itemprop="datePublished">
          2018-06-16
      </time>
    
    
    | 
    <a href='/tags/åšå®¢ï¼Œæ–‡ç« /'>åšå®¢ï¼Œæ–‡ç« </a>
    
    
</span>
                <h1>Objective-C Principle - weak</h1>
            </div>
        </div>
        <div class="col-md-8 col-md-offset-2">
      		<p>#OC åº•å±‚åŸç†æ€»ç»“ä¹‹ weak </p>
<h2 id=""><a href="#" class="headerlink" title=""></a><a id="more"></a><!--more--></h2><p>ğŸ‘¨ğŸ»â€ğŸ’» <a href="https://github.com/ReverseScale/iOSPrinciple_weak" target="_blank" rel="external">Github Demo</a></p>
<h3 id="æ–¹ä¾¿è®°å¿†ï¼š"><a href="#æ–¹ä¾¿è®°å¿†ï¼š" class="headerlink" title="æ–¹ä¾¿è®°å¿†ï¼š"></a>æ–¹ä¾¿è®°å¿†ï¼š</h3><ul>
<li>ä½œç”¨ï¼šä½œä¸ºä¸€ç§å¼±å¼•ç”¨å±æ€§ä¿®é¥°è¯ï¼Œä¸å¢åŠ å¯¹è±¡çš„å¼•ç”¨è®¡æ•°ï¼Œä¹Ÿä¸æŒæœ‰å¯¹è±¡ï¼Œå¯¹è±¡æ¶ˆå¤±åï¼ŒæŒ‡é’ˆè‡ªåŠ¨å˜æˆnil</li>
<li>åŸç†ï¼šweak å…¶å®æ˜¯ä¸€ä¸ª hashï¼ˆå“ˆå¸Œï¼‰è¡¨ï¼ŒKey:å¯¹è±¡çš„åœ°å€ï¼ŒValue:weak æŒ‡é’ˆçš„åœ°å€æ•°ç»„</li>
<li>åº•å±‚å®ç°è¿‡ç¨‹<ul>
<li>åˆå§‹åŒ–æ—¶ï¼šruntimeä¼šè°ƒç”¨objc_initWeakå‡½æ•°ï¼Œåˆå§‹åŒ–ä¸€ä¸ªæ–°çš„weakæŒ‡é’ˆæŒ‡å‘å¯¹è±¡çš„åœ°å€</li>
<li>æ·»åŠ å¼•ç”¨æ—¶ï¼šobjc_initWeakå‡½æ•°ä¼šè°ƒç”¨ objc_storeWeak() å‡½æ•°ï¼Œ objc_storeWeak() çš„ä½œç”¨æ˜¯æ›´æ–°æŒ‡é’ˆæŒ‡å‘ï¼Œåˆ›å»ºå¯¹åº”çš„å¼±å¼•ç”¨è¡¨</li>
<li>é‡Šæ”¾æ—¶ï¼šè°ƒç”¨clearDeallocatingå‡½æ•°ï¼Œå¯¹è±¡åœ°å€è·å–æ‰€æœ‰weakæŒ‡é’ˆåœ°å€çš„æ•°ç»„ï¼Œç„¶åéå†è¿™ä¸ªæ•°ç»„æŠŠå…¶ä¸­çš„æ•°æ®è®¾ä¸ºnil</li>
</ul>
</li>
</ul>
<hr>
<h2 id="å¼•æ–‡"><a href="#å¼•æ–‡" class="headerlink" title="å¼•æ–‡"></a>å¼•æ–‡</h2><p>ä¹‹å‰åªæ˜¯è®¤è¯†åˆ° weak ä½œä¸ºä¸€ç§å¼±å¼•ç”¨å±æ€§ä¿®é¥°è¯ï¼Œä¸å¢åŠ å¯¹è±¡çš„å¼•ç”¨è®¡æ•°ï¼Œä¹Ÿä¸æŒæœ‰å¯¹è±¡ï¼Œå¯¹è±¡æ¶ˆå¤±åï¼ŒæŒ‡é’ˆè‡ªåŠ¨å˜æˆnilã€‚åœ¨ARCç¯å¢ƒä¸‹ï¼Œä¸ºé¿å…å¾ªç¯å¼•ç”¨ï¼Œå¾€å¾€ä¼šæŠŠdelegateå±æ€§ç”¨weakä¿®é¥°ã€‚</p>
<p>ä»Šå¤©æ•´ç†ä¸€ä¸‹ weak çš„å®ç°åŸç†ï¼Œå…ˆæ¦‚æ‹¬çš„è®² weak å…¶å®æ˜¯ä¸€ä¸ª hashï¼ˆå“ˆå¸Œï¼‰è¡¨ï¼ŒKey æ˜¯æ‰€æŒ‡å¯¹è±¡çš„åœ°å€ï¼ŒValue æ˜¯ weak æŒ‡é’ˆçš„åœ°å€æ•°ç»„ã€‚</p>
<p>é¡ºä¾¿å‘ç°å…¶å®ç°åœ¨æƒ³å¾ªç¯å¼•ç”¨ä¹ŸæŒºéš¾çš„ï¼ŒXcodeä¼šæœ‰ä¸ªæé†’ï¼Œé»„é»„çš„æŒºæ˜¾çœ¼çš„â€¦</p>
<p><img src="https://user-gold-cdn.xitu.io/2018/6/12/163f30ecf7d18639?w=963&amp;h=129&amp;f=png&amp;s=31588" alt=""></p>
<h2 id="å®ç°åŸç†"><a href="#å®ç°åŸç†" class="headerlink" title="å®ç°åŸç†"></a>å®ç°åŸç†</h2><p>Runtimeç»´æŠ¤äº†ä¸€ä¸ªweakè¡¨ï¼Œç”¨äºå­˜å‚¨æŒ‡å‘æŸä¸ªå¯¹è±¡çš„æ‰€æœ‰weakæŒ‡é’ˆã€‚weakè¡¨å…¶å®æ˜¯ä¸€ä¸ªhashï¼ˆå“ˆå¸Œï¼‰è¡¨ï¼ŒKeyæ˜¯æ‰€æŒ‡å¯¹è±¡çš„åœ°å€ï¼ŒValueæ˜¯weakæŒ‡é’ˆçš„åœ°å€ï¼ˆè¿™ä¸ªåœ°å€çš„å€¼æ˜¯æ‰€æŒ‡å¯¹è±¡çš„åœ°å€ï¼‰æ•°ç»„ã€‚</p>
<p>åº•å±‚çš„å®ç°å¤§ä½“åˆ†ä¸ºä¸‰æ­¥ï¼š</p>
<ul>
<li>1.åˆå§‹åŒ–æ—¶ï¼šruntimeä¼šè°ƒç”¨objc_initWeakå‡½æ•°ï¼Œåˆå§‹åŒ–ä¸€ä¸ªæ–°çš„weakæŒ‡é’ˆæŒ‡å‘å¯¹è±¡çš„åœ°å€ã€‚ï¼ˆç»™ä½ æ·»ä¸ªå¹²å…„å¼Ÿï¼‰</li>
<li>2.æ·»åŠ å¼•ç”¨æ—¶ï¼šobjc_initWeakå‡½æ•°ä¼šè°ƒç”¨ objc_storeWeak() å‡½æ•°ï¼Œ objc_storeWeak() çš„ä½œç”¨æ˜¯æ›´æ–°æŒ‡é’ˆæŒ‡å‘ï¼Œåˆ›å»ºå¯¹åº”çš„å¼±å¼•ç”¨è¡¨ã€‚ï¼ˆç»™è¿™ä¸ªå¹²å…„å¼Ÿè½ä¸ªæˆ·å£ï¼Œä»‹ç»ç»™äº²æˆšæœ‹å‹ï¼‰</li>
<li>3.é‡Šæ”¾æ—¶ï¼Œè°ƒç”¨clearDeallocatingå‡½æ•°ã€‚clearDeallocatingå‡½æ•°é¦–å…ˆæ ¹æ®å¯¹è±¡åœ°å€è·å–æ‰€æœ‰weakæŒ‡é’ˆåœ°å€çš„æ•°ç»„ï¼Œç„¶åéå†è¿™ä¸ªæ•°ç»„æŠŠå…¶ä¸­çš„æ•°æ®è®¾ä¸ºnilï¼Œæœ€åæŠŠè¿™ä¸ªentryä»weakè¡¨ä¸­åˆ é™¤ï¼Œæœ€åæ¸…ç†å¯¹è±¡çš„è®°å½•ã€‚ï¼ˆæœ€åç­‰è¿™ä¸ªå¹²å…„å¼Ÿå¹²å®Œæ´»åï¼Œè¢«å¸ç£¨æ€é©´ï¼‰</li>
</ul>
<h3 id="åˆ†æ­¥è§£æå†…éƒ¨å®ç°ï¼š"><a href="#åˆ†æ­¥è§£æå†…éƒ¨å®ç°ï¼š" class="headerlink" title="åˆ†æ­¥è§£æå†…éƒ¨å®ç°ï¼š"></a>åˆ†æ­¥è§£æå†…éƒ¨å®ç°ï¼š</h3><p>1ï¼‰åˆå§‹åŒ–æ—¶ï¼šruntimeä¼šè°ƒç”¨objc_initWeakå‡½æ•°ï¼Œobjc_initWeakå‡½æ•°ä¼šåˆå§‹åŒ–ä¸€ä¸ªæ–°çš„weakæŒ‡é’ˆæŒ‡å‘å¯¹è±¡çš„åœ°å€ã€‚</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="built_in">NSObject</span> *obj = [[<span class="built_in">NSObject</span> alloc] init];</div><div class="line"><span class="keyword">id</span> __<span class="keyword">weak</span> obj1 = obj; <span class="comment">// çœ‹å¥½ weak äº†</span></div></pre></td></tr></table></figure>
<p>å½“æˆ‘ä»¬åˆå§‹åŒ–ä¸€ä¸ªweakå˜é‡æ—¶ï¼Œruntimeä¼šè°ƒç”¨ NSObject.mm ä¸­çš„objc_initWeakå‡½æ•°ã€‚è¿™ä¸ªå‡½æ•°åœ¨Clangä¸­çš„å£°æ˜å¦‚ä¸‹ï¼š</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="function">idÂ <span class="title">objc_initWeak</span><span class="params">(idÂ *object,Â idÂ value)</span></span>;</div></pre></td></tr></table></figure>
<p>objc_initWeak() æ–¹æ³•çš„å®ç°</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"><span class="function">id <span class="title">objc_initWeak</span><span class="params">(id *location, id newObj)</span> </span>&#123;</div><div class="line">    <span class="comment">// æŸ¥çœ‹å¯¹è±¡å®ä¾‹æ˜¯å¦æœ‰æ•ˆ</span></div><div class="line">    <span class="comment">// æ— æ•ˆå¯¹è±¡ç›´æ¥å¯¼è‡´æŒ‡é’ˆé‡Šæ”¾</span></div><div class="line">    <span class="keyword">if</span> (!newObj) &#123;</div><div class="line">        *location = nil;</div><div class="line">        <span class="keyword">return</span> nil;</div><div class="line">    &#125;</div><div class="line">    <span class="comment">// è¿™é‡Œä¼ é€’äº†ä¸‰ä¸ª bool æ•°å€¼</span></div><div class="line">    <span class="comment">// ä½¿ç”¨ template è¿›è¡Œå¸¸é‡å‚æ•°ä¼ é€’æ˜¯ä¸ºäº†ä¼˜åŒ–æ€§èƒ½</span></div><div class="line">    <span class="keyword">return</span> storeWeakfalse<span class="comment">/*old*/</span>, <span class="literal">true</span><span class="comment">/*new*/</span>, <span class="literal">true</span><span class="comment">/*crash*/</span>&gt;</div><div class="line">    (location, (objc_object*)newObj);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>å¯ä»¥çœ‹å‡ºï¼Œè¿™ä¸ªå‡½æ•°ä»…ä»…æ˜¯ä¸€ä¸ªæ·±å±‚å‡½æ•°çš„è°ƒç”¨å…¥å£ï¼Œè€Œä¸€èˆ¬çš„å…¥å£å‡½æ•°ä¸­ï¼Œéƒ½ä¼šåšä¸€äº›ç®€å•çš„åˆ¤æ–­ï¼ˆä¾‹å¦‚ objc_msgSend ä¸­çš„ç¼“å­˜åˆ¤æ–­ï¼‰ï¼Œè¿™é‡Œåˆ¤æ–­äº†å…¶æŒ‡é’ˆæŒ‡å‘çš„ç±»å¯¹è±¡æ˜¯å¦æœ‰æ•ˆï¼Œæ— æ•ˆç›´æ¥é‡Šæ”¾ï¼Œä¸å†å¾€æ·±å±‚è°ƒç”¨å‡½æ•°ã€‚å¦åˆ™ï¼Œobjectå°†è¢«æ³¨å†Œä¸ºä¸€ä¸ªæŒ‡å‘valueçš„__weakå¯¹è±¡ã€‚</p>
<blockquote>
<p>æ³¨æ„ï¼šobjc_initWeakå‡½æ•°æœ‰ä¸€ä¸ªå‰ææ¡ä»¶ï¼šå°±æ˜¯objectå¿…é¡»æ˜¯ä¸€ä¸ªæ²¡æœ‰è¢«æ³¨å†Œä¸º__weakå¯¹è±¡çš„æœ‰æ•ˆæŒ‡é’ˆã€‚è€Œvalueåˆ™å¯ä»¥æ˜¯nullï¼Œæˆ–è€…æŒ‡å‘ä¸€ä¸ªæœ‰æ•ˆçš„å¯¹è±¡ã€‚</p>
</blockquote>
<p>2ï¼‰æ·»åŠ å¼•ç”¨æ—¶ï¼šobjc_initWeakå‡½æ•°ä¼šè°ƒç”¨ objc_storeWeak() å‡½æ•°ï¼Œ objc_storeWeak() çš„ä½œç”¨æ˜¯æ›´æ–°æŒ‡é’ˆæŒ‡å‘ï¼Œåˆ›å»ºå¯¹åº”çš„å¼±å¼•ç”¨è¡¨ã€‚</p>
<p>objc_storeWeakçš„å‡½æ•°å£°æ˜å¦‚ä¸‹ï¼š</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="function">id <span class="title">objc_storeWeak</span><span class="params">(id *location, id value)</span></span>;</div></pre></td></tr></table></figure>
<p>objc_storeWeak æ–¹æ³•çš„å®ç°ï¼š</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// HaveOld:     true - å˜é‡æœ‰å€¼</span></div><div class="line"><span class="comment">//             false - éœ€è¦è¢«åŠæ—¶æ¸…ç†ï¼Œå½“å‰å€¼å¯èƒ½ä¸º nil</span></div><div class="line"><span class="comment">// HaveNew:     true - éœ€è¦è¢«åˆ†é…çš„æ–°å€¼ï¼Œå½“å‰å€¼å¯èƒ½ä¸º nil</span></div><div class="line"><span class="comment">//             false - ä¸éœ€è¦åˆ†é…æ–°å€¼</span></div><div class="line"><span class="comment">// CrashIfDeallocating: true - è¯´æ˜ newObj å·²ç»é‡Šæ”¾æˆ–è€… newObj ä¸æ”¯æŒå¼±å¼•ç”¨ï¼Œè¯¥è¿‡ç¨‹éœ€è¦æš‚åœ</span></div><div class="line"><span class="comment">//             false - ç”¨ nil æ›¿ä»£å­˜å‚¨</span></div><div class="line"><span class="keyword">template</span> <span class="keyword">bool</span> HaveOld, <span class="keyword">bool</span> HaveNew, <span class="keyword">bool</span> CrashIfDeallocating&gt;</div><div class="line"><span class="function"><span class="keyword">static</span> id <span class="title">storeWeak</span><span class="params">(id *location, objc_object *newObj)</span> </span>&#123;</div><div class="line">    <span class="comment">// è¯¥è¿‡ç¨‹ç”¨æ¥æ›´æ–°å¼±å¼•ç”¨æŒ‡é’ˆçš„æŒ‡å‘</span></div><div class="line">    <span class="comment">// åˆå§‹åŒ– previouslyInitializedClass æŒ‡é’ˆ</span></div><div class="line">    Class previouslyInitializedClass = nil;</div><div class="line">    id oldObj;</div><div class="line">    <span class="comment">// å£°æ˜ä¸¤ä¸ª SideTable</span></div><div class="line">    <span class="comment">// â‘  æ–°æ—§æ•£åˆ—åˆ›å»º</span></div><div class="line">    SideTable *oldTable;</div><div class="line">    SideTable *newTable;</div><div class="line">    <span class="comment">// è·å¾—æ–°å€¼å’Œæ—§å€¼çš„é”å­˜ä½ç½®ï¼ˆç”¨åœ°å€ä½œä¸ºå”¯ä¸€æ ‡ç¤ºï¼‰</span></div><div class="line">    <span class="comment">// é€šè¿‡åœ°å€æ¥å»ºç«‹ç´¢å¼•æ ‡å¿—ï¼Œé˜²æ­¢æ¡¶é‡å¤</span></div><div class="line">    <span class="comment">// ä¸‹é¢æŒ‡å‘çš„æ“ä½œä¼šæ”¹å˜æ—§å€¼</span></div><div class="line">    retry:</div><div class="line">    <span class="keyword">if</span> (HaveOld) &#123;</div><div class="line">        <span class="comment">// æ›´æ”¹æŒ‡é’ˆï¼Œè·å¾—ä»¥ oldObj ä¸ºç´¢å¼•æ‰€å­˜å‚¨çš„å€¼åœ°å€</span></div><div class="line">        oldObj = *location;</div><div class="line">        oldTable = &amp;SideTables()[oldObj];</div><div class="line">    &#125; <span class="keyword">else</span> &#123;</div><div class="line">        oldTable = nil;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">if</span> (HaveNew) &#123;</div><div class="line">        <span class="comment">// æ›´æ”¹æ–°å€¼æŒ‡é’ˆï¼Œè·å¾—ä»¥ newObj ä¸ºç´¢å¼•æ‰€å­˜å‚¨çš„å€¼åœ°å€</span></div><div class="line">        newTable = &amp;SideTables()[newObj];</div><div class="line">    &#125; <span class="keyword">else</span> &#123;</div><div class="line">        newTable = nil;</div><div class="line">    &#125;</div><div class="line">    <span class="comment">// åŠ é”æ“ä½œï¼Œé˜²æ­¢å¤šçº¿ç¨‹ä¸­ç«äº‰å†²çª</span></div><div class="line">    SideTable::lockTwoHaveOld, HaveNew&gt;(oldTable, newTable);</div><div class="line">    <span class="comment">// é¿å…çº¿ç¨‹å†²çªé‡å¤„ç†</span></div><div class="line">    <span class="comment">// location åº”è¯¥ä¸ oldObj ä¿æŒä¸€è‡´ï¼Œå¦‚æœä¸åŒï¼Œè¯´æ˜å½“å‰çš„ location å·²ç»å¤„ç†è¿‡ oldObj å¯æ˜¯åˆè¢«å…¶ä»–çº¿ç¨‹æ‰€ä¿®æ”¹</span></div><div class="line">    <span class="keyword">if</span> (HaveOld  &amp;&amp;  *location != oldObj) &#123;</div><div class="line">        SideTable::unlockTwoHaveOld, HaveNew&gt;(oldTable, newTable);</div><div class="line">        <span class="keyword">goto</span> retry;</div><div class="line">    &#125;</div><div class="line">    <span class="comment">// é˜²æ­¢å¼±å¼•ç”¨é—´æ­»é”</span></div><div class="line">    <span class="comment">// å¹¶ä¸”é€šè¿‡ +initialize åˆå§‹åŒ–æ„é€ å™¨ä¿è¯æ‰€æœ‰å¼±å¼•ç”¨çš„ isa éç©ºæŒ‡å‘</span></div><div class="line">    <span class="keyword">if</span> (HaveNew  &amp;&amp;  newObj) &#123;</div><div class="line">        <span class="comment">// è·å¾—æ–°å¯¹è±¡çš„ isa æŒ‡é’ˆ</span></div><div class="line">        Class cls = newObj-&gt;getIsa();</div><div class="line">        <span class="comment">// åˆ¤æ–­ isa éç©ºä¸”å·²ç»åˆå§‹åŒ–</span></div><div class="line">        <span class="keyword">if</span> (cls != previouslyInitializedClass  &amp;&amp;</div><div class="line">        !((objc_class *)cls)-&gt;isInitialized()) &#123;</div><div class="line">            <span class="comment">// è§£é”</span></div><div class="line">            SideTable::unlockTwoHaveOld, HaveNew&gt;(oldTable, newTable);</div><div class="line">            <span class="comment">// å¯¹å…¶ isa æŒ‡é’ˆè¿›è¡Œåˆå§‹åŒ–</span></div><div class="line">            _class_initialize(_class_getNonMetaClass(cls, (id)newObj));</div><div class="line">            <span class="comment">// å¦‚æœè¯¥ç±»å·²ç»å®Œæˆæ‰§è¡Œ +initialize æ–¹æ³•æ˜¯æœ€ç†æƒ³æƒ…å†µ</span></div><div class="line">            <span class="comment">// å¦‚æœè¯¥ç±» +initialize åœ¨çº¿ç¨‹ä¸­</span></div><div class="line">            <span class="comment">// ä¾‹å¦‚ +initialize æ­£åœ¨è°ƒç”¨ storeWeak æ–¹æ³•</span></div><div class="line">            <span class="comment">// éœ€è¦æ‰‹åŠ¨å¯¹å…¶å¢åŠ ä¿æŠ¤ç­–ç•¥ï¼Œå¹¶è®¾ç½® previouslyInitializedClass æŒ‡é’ˆè¿›è¡Œæ ‡è®°</span></div><div class="line">            previouslyInitializedClass = cls;</div><div class="line">            <span class="comment">// é‡æ–°å°è¯•</span></div><div class="line">            <span class="keyword">goto</span> retry;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    <span class="comment">// â‘¡ æ¸…é™¤æ—§å€¼</span></div><div class="line">    <span class="keyword">if</span> (HaveOld) &#123;</div><div class="line">        weak_unregister_no_lock(&amp;oldTable-&gt;weak_table, oldObj, location);</div><div class="line">    &#125;</div><div class="line">    <span class="comment">// â‘¢ åˆ†é…æ–°å€¼</span></div><div class="line">    <span class="keyword">if</span> (HaveNew) &#123;</div><div class="line">        newObj = (objc_object *)weak_register_no_lock(&amp;newTable-&gt;weak_table,</div><div class="line">        (id)newObj, location,</div><div class="line">        CrashIfDeallocating);</div><div class="line">        <span class="comment">// å¦‚æœå¼±å¼•ç”¨è¢«é‡Šæ”¾ weak_register_no_lock æ–¹æ³•è¿”å› nil</span></div><div class="line">        <span class="comment">// åœ¨å¼•ç”¨è®¡æ•°è¡¨ä¸­è®¾ç½®è‹¥å¼•ç”¨æ ‡è®°ä½</span></div><div class="line">        <span class="keyword">if</span> (newObj  &amp;&amp;  !newObj-&gt;isTaggedPointer()) &#123;</div><div class="line">            <span class="comment">// å¼±å¼•ç”¨ä½åˆå§‹åŒ–æ“ä½œ</span></div><div class="line">            <span class="comment">// å¼•ç”¨è®¡æ•°é‚£å¼ æ•£åˆ—è¡¨çš„weakå¼•ç”¨å¯¹è±¡çš„å¼•ç”¨è®¡æ•°ä¸­æ ‡è¯†ä¸ºweakå¼•ç”¨</span></div><div class="line">            newObj-&gt;setWeaklyReferenced_nolock();</div><div class="line">        &#125;</div><div class="line">        <span class="comment">// ä¹‹å‰ä¸è¦è®¾ç½® location å¯¹è±¡ï¼Œè¿™é‡Œéœ€è¦æ›´æ”¹æŒ‡é’ˆæŒ‡å‘</span></div><div class="line">        *location = (id)newObj;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">else</span> &#123;</div><div class="line">    <span class="comment">// æ²¡æœ‰æ–°å€¼ï¼Œåˆ™æ— éœ€æ›´æ”¹</span></div><div class="line">    &#125;</div><div class="line">    SideTable::unlockTwoHaveOld, HaveNew&gt;(oldTable, newTable);</div><div class="line">    <span class="keyword">return</span> (id)newObj;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="æ‹†åˆ†è§£æä¸Šè¿°ä»£ç "><a href="#æ‹†åˆ†è§£æä¸Šè¿°ä»£ç " class="headerlink" title="æ‹†åˆ†è§£æä¸Šè¿°ä»£ç "></a>æ‹†åˆ†è§£æä¸Šè¿°ä»£ç </h3><p>â‘  SideTable</p>
<p>ä¸»è¦ç”¨äºç®¡ç†å¯¹è±¡çš„å¼•ç”¨è®¡æ•°å’Œ weak è¡¨ã€‚åœ¨ NSObject.mm ä¸­å£°æ˜å…¶æ•°æ®ç»“æ„ï¼š</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">struct</span> SideTable &#123;</div><div class="line">    <span class="comment">// ä¿è¯åŸå­æ“ä½œçš„è‡ªæ—‹é”</span></div><div class="line">    <span class="keyword">spinlock_t</span> slock;</div><div class="line">    <span class="comment">// å¼•ç”¨è®¡æ•°çš„ hash è¡¨</span></div><div class="line">    RefcountMap refcnts;</div><div class="line">    <span class="comment">// weak å¼•ç”¨å…¨å±€ hash è¡¨</span></div><div class="line">    <span class="keyword">weak_table_t</span> weak_table;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>å¯¹äº slock å’Œ refcnts ä¸¤ä¸ªæˆå‘˜ä¸ç”¨å¤šè¯´ï¼Œç¬¬ä¸€ä¸ªæ˜¯ä¸ºäº†é˜²æ­¢ç«äº‰é€‰æ‹©çš„è‡ªæ—‹é”ï¼Œç¬¬äºŒä¸ªæ˜¯ååŠ©å¯¹è±¡çš„ isa æŒ‡é’ˆçš„ extra_rc å…±åŒå¼•ç”¨è®¡æ•°çš„å˜é‡ï¼ˆå¯¹äºå¯¹è±¡ç»“æœï¼Œåœ¨ä»Šåçš„æ–‡ä¸­æåˆ°ï¼‰ã€‚è¿™é‡Œä¸»è¦çœ‹ weak å…¨å±€ hash è¡¨çš„ç»“æ„ä¸ä½œç”¨ã€‚</p>
<p>â‘¡ weak è¡¨</p>
<p>weakè¡¨æ˜¯ä¸€ä¸ªå¼±å¼•ç”¨è¡¨ï¼Œå®ç°ä¸ºä¸€ä¸ªweak_table_tç»“æ„ä½“ï¼Œå­˜å‚¨äº†æŸä¸ªå¯¹è±¡ç›¸å…³çš„æ‰€æœ‰çš„å¼±å¼•ç”¨ä¿¡æ¯ã€‚</p>
<p>åœ¨objc-weak.hä¸­å…¶å®šä¹‰å¦‚ä¸‹</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">struct</span> <span class="keyword">weak_table_t</span> &#123;</div><div class="line">    <span class="comment">// ä¿å­˜äº†æ‰€æœ‰æŒ‡å‘æŒ‡å®šå¯¹è±¡çš„ weak æŒ‡é’ˆ</span></div><div class="line">    <span class="keyword">weak_entry_t</span> *weak_entries;</div><div class="line">    <span class="comment">// å­˜å‚¨ç©ºé—´</span></div><div class="line">    <span class="keyword">size_t</span>    num_entries;</div><div class="line">    <span class="comment">// å‚ä¸åˆ¤æ–­å¼•ç”¨è®¡æ•°è¾…åŠ©é‡</span></div><div class="line">    <span class="keyword">uintptr_t</span> mask;</div><div class="line">    <span class="comment">// hash key æœ€å¤§åç§»å€¼</span></div><div class="line">    <span class="keyword">uintptr_t</span> max_hash_displacement;</div><div class="line">&#125;;</div></pre></td></tr></table></figure>
<p>è¿™æ˜¯ä¸€ä¸ªå…¨å±€å¼±å¼•ç”¨hashè¡¨ã€‚ä½¿ç”¨ä¸å®šç±»å‹å¯¹è±¡çš„åœ°å€ä½œä¸º key ï¼Œç”¨ weak_entry_t ç±»å‹ç»“æ„ä½“å¯¹è±¡ä½œä¸º value ã€‚å…¶ä¸­çš„ weak_entries æˆå‘˜ï¼Œä»å­—é¢æ„æ€ä¸Šçœ‹ï¼Œå³ä¸ºå¼±å¼•ç”¨è¡¨å…¥å£ã€‚å…¶å®ç°ä¹Ÿæ˜¯è¿™æ ·çš„ã€‚</p>
<p>å…¶ä¸­weak_entry_tæ˜¯å­˜å‚¨åœ¨å¼±å¼•ç”¨è¡¨ä¸­çš„ä¸€ä¸ªå†…éƒ¨ç»“æ„ä½“ï¼Œå®ƒè´Ÿè´£ç»´æŠ¤å’Œå­˜å‚¨æŒ‡å‘ä¸€ä¸ªå¯¹è±¡çš„æ‰€æœ‰å¼±å¼•ç”¨hashè¡¨ã€‚å…¶å®šä¹‰å¦‚ä¸‹ï¼š</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">typedef</span> objc_object ** <span class="keyword">weak_referrer_t</span>;</div><div class="line"><span class="keyword">struct</span> <span class="keyword">weak_entry_t</span> &#123;</div><div class="line">    DisguisedPtrobjc_object&gt; referent;</div><div class="line">    <span class="keyword">union</span> &#123;</div><div class="line">        <span class="keyword">struct</span> &#123;</div><div class="line">            <span class="keyword">weak_referrer_t</span> *referrers;</div><div class="line">            <span class="keyword">uintptr_t</span>        out_of_line : <span class="number">1</span>;</div><div class="line">            <span class="keyword">uintptr_t</span>        num_refs : PTR_MINUS_1;</div><div class="line">            <span class="keyword">uintptr_t</span>        mask;</div><div class="line">            <span class="keyword">uintptr_t</span>        max_hash_displacement;</div><div class="line">        &#125;;</div><div class="line">        <span class="keyword">struct</span> &#123;</div><div class="line">            <span class="comment">// out_of_line=0 is LSB of one of these (don't care which)</span></div><div class="line">            <span class="keyword">weak_referrer_t</span>  inline_referrers[WEAK_INLINE_COUNT];</div><div class="line">        &#125;;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>åœ¨ weak_entry_t çš„ç»“æ„ä¸­ï¼ŒDisguisedPtr referent æ˜¯å¯¹æ³›å‹å¯¹è±¡çš„æŒ‡é’ˆåšäº†ä¸€ä¸ªå°è£…ï¼Œé€šè¿‡è¿™ä¸ªæ³›å‹ç±»æ¥è§£å†³å†…å­˜æ³„æ¼çš„é—®é¢˜ã€‚ä»æ³¨é‡Šä¸­å†™ out_of_line æˆå‘˜ä¸ºæœ€ä½æœ‰æ•ˆä½ï¼Œå½“å…¶ä¸º0çš„æ—¶å€™ï¼Œ weak_referrer_t æˆå‘˜å°†æ‰©å±•ä¸ºå¤šè¡Œé™æ€ hash tableã€‚</p>
<p>å…¶å®å…¶ä¸­çš„ weak_referrer_t æ˜¯äºŒç»´ objc_object çš„åˆ«åï¼Œé€šè¿‡ä¸€ä¸ªäºŒç»´æŒ‡é’ˆåœ°å€åç§»ï¼Œç”¨ä¸‹æ ‡ä½œä¸º hash çš„ keyï¼Œåšæˆäº†ä¸€ä¸ªå¼±å¼•ç”¨æ•£åˆ—ã€‚</p>
<p>out_of_line çš„å€¼é€šå¸¸æƒ…å†µä¸‹æ˜¯ç­‰äºé›¶çš„ï¼Œæ‰€ä»¥å¼±å¼•ç”¨è¡¨æ€»æ˜¯ä¸€ä¸ª objc_objective æŒ‡é’ˆäºŒç»´æ•°ç»„ã€‚ä¸€ç»´ objc_objective æŒ‡é’ˆå¯æ„æˆä¸€å¼ å¼±å¼•ç”¨æ•£åˆ—è¡¨ï¼Œé€šè¿‡ç¬¬ä¸‰çº¬åº¦å®ç°äº†å¤šå¼ æ•£åˆ—è¡¨ï¼Œå¹¶ä¸”è¡¨æ•°é‡ä¸º WEAK_INLINE_COUNT ã€‚</p>
<p>StripedMap æ˜¯ä¸€ä¸ªæ¨¡æ¿ç±»ï¼Œåœ¨è¿™ä¸ªç±»ä¸­æœ‰ä¸€ä¸ª array æˆå‘˜ï¼Œç”¨æ¥å­˜å‚¨ PaddedT å¯¹è±¡ï¼Œå¹¶ä¸”å…¶ä¸­å¯¹äº [] ç¬¦çš„é‡è½½å®šä¹‰ä¸­ï¼Œä¼šè¿”å›è¿™ä¸ª PaddedT çš„ value æˆå‘˜ï¼Œè¿™ä¸ª value å°±æ˜¯æˆ‘ä»¬ä¼ å…¥çš„ T æ³›å‹æˆå‘˜ï¼Œä¹Ÿå°±æ˜¯ SideTable å¯¹è±¡ã€‚</p>
<p>åœ¨ array çš„ä¸‹æ ‡ä¸­ï¼Œè¿™é‡Œä½¿ç”¨äº† indexForPointer æ–¹æ³•é€šè¿‡ä½è¿ç®—è®¡ç®—ä¸‹æ ‡ï¼Œå®ç°äº†é™æ€çš„ Hash Tableã€‚è€Œåœ¨ weak_table ä¸­ï¼Œå…¶æˆå‘˜ weak_entry ä¼šå°†ä¼ å…¥å¯¹è±¡çš„åœ°å€åŠ ä»¥å°è£…èµ·æ¥ï¼Œå¹¶ä¸”å…¶ä¸­ä¹Ÿæœ‰è®¿é—®å…¨å±€å¼±å¼•ç”¨è¡¨çš„å…¥å£ã€‚</p>
<p><img src="https://user-gold-cdn.xitu.io/2018/6/12/163f30ecf0d7c7df?w=589&amp;h=563&amp;f=png&amp;s=79568" alt=""></p>
<p>æ—§å¯¹è±¡è§£é™¤æ³¨å†Œæ“ä½œ weak_unregister_no_lock</p>
<p>è¯¥æ–¹æ³•ä¸»è¦ä½œç”¨æ˜¯å°†æ—§å¯¹è±¡åœ¨ weak_table ä¸­æ¥è§¦ weak æŒ‡é’ˆçš„å¯¹åº”ç»‘å®šã€‚æ ¹æ®å‡½æ•°åï¼Œç§°ä¹‹ä¸ºè§£é™¤æ³¨å†Œæ“ä½œã€‚ä»æºç ä¸­ï¼Œå¯ä»¥çŸ¥é“å…¶åŠŸèƒ½å°±æ˜¯ä» weak_table ä¸­æ¥è§¦ weak æŒ‡é’ˆçš„ç»‘å®šã€‚è€Œå…¶ä¸­çš„éå†æŸ¥è¯¢ï¼Œå°±æ˜¯é’ˆå¯¹äº weak_entry ä¸­çš„å¤šå¼ å¼±å¼•ç”¨æ•£åˆ—è¡¨ã€‚</p>
<p>æ–°å¯¹è±¡æ·»åŠ æ³¨å†Œæ“ä½œ weak_register_no_lock</p>
<p>è¿™ä¸€æ­¥ä¸ä¸Šä¸€æ­¥ç›¸åï¼Œé€šè¿‡ weak_register_no_lock å‡½æ•°æŠŠå¿ƒçš„å¯¹è±¡è¿›è¡Œæ³¨å†Œæ“ä½œï¼Œå®Œæˆä¸å¯¹åº”çš„å¼±å¼•ç”¨è¡¨è¿›è¡Œç»‘å®šæ“ä½œã€‚</p>
<p>â‘¢ åˆå§‹åŒ–å¼±å¼•ç”¨å¯¹è±¡æµç¨‹ä¸€è§ˆ</p>
<p>å¼±å¼•ç”¨çš„åˆå§‹åŒ–ï¼Œä»ä¸Šæ–‡çš„åˆ†æä¸­å¯ä»¥çœ‹å‡ºï¼Œä¸»è¦çš„æ“ä½œéƒ¨åˆ†å°±åœ¨å¼±å¼•ç”¨è¡¨çš„å–é”®ã€æŸ¥è¯¢æ•£åˆ—ã€åˆ›å»ºå¼±å¼•ç”¨è¡¨ç­‰æ“ä½œï¼Œå¯ä»¥æ€»ç»“å‡ºå¦‚ä¸‹çš„æµç¨‹å›¾ï¼š</p>
<p><img src="https://user-gold-cdn.xitu.io/2018/6/12/163f30ed0395bee2?w=547&amp;h=595&amp;f=png&amp;s=74638" alt=""></p>
<p>è¿™ä¸ªå›¾ä¸­çœç•¥äº†å¾ˆå¤šæƒ…å†µçš„åˆ¤æ–­ï¼Œä½†æ˜¯å½“å£°æ˜ä¸€ä¸ª weak ä¼šè°ƒç”¨ä¸Šå›¾ä¸­çš„è¿™äº›æ–¹æ³•ã€‚å½“ç„¶ï¼Œ storeWeak æ–¹æ³•ä¸ä»…ä»…ç”¨åœ¨ weak çš„å£°æ˜ä¸­ï¼Œåœ¨ class å†…éƒ¨çš„æ“ä½œä¸­ä¹Ÿä¼šå¸¸å¸¸é€šè¿‡è¯¥æ–¹æ³•æ¥å¯¹ weak å¯¹è±¡è¿›è¡Œæ“ä½œã€‚</p>
<p>3ï¼‰é‡Šæ”¾æ—¶ï¼Œè°ƒç”¨clearDeallocatingå‡½æ•°ã€‚clearDeallocatingå‡½æ•°é¦–å…ˆæ ¹æ®å¯¹è±¡åœ°å€è·å–æ‰€æœ‰weakæŒ‡é’ˆåœ°å€çš„æ•°ç»„ï¼Œç„¶åéå†è¿™ä¸ªæ•°ç»„æŠŠå…¶ä¸­çš„æ•°æ®è®¾ä¸ºnilï¼Œæœ€åæŠŠè¿™ä¸ªentryä»weakè¡¨ä¸­åˆ é™¤ï¼Œæœ€åæ¸…ç†å¯¹è±¡çš„è®°å½•ã€‚</p>
<p>å½“weakå¼•ç”¨æŒ‡å‘çš„å¯¹è±¡è¢«é‡Šæ”¾æ—¶ï¼Œåˆæ˜¯å¦‚ä½•å»å¤„ç†weakæŒ‡é’ˆçš„å‘¢ï¼Ÿå½“é‡Šæ”¾å¯¹è±¡æ—¶ï¼Œå…¶åŸºæœ¬æµç¨‹å¦‚ä¸‹ï¼š</p>
<ul>
<li>1ã€è°ƒç”¨objc_release</li>
<li>2ã€å› ä¸ºå¯¹è±¡çš„å¼•ç”¨è®¡æ•°ä¸º0ï¼Œæ‰€ä»¥æ‰§è¡Œdealloc</li>
<li>3ã€åœ¨deallocä¸­ï¼Œè°ƒç”¨äº†_objc_rootDeallocå‡½æ•°</li>
<li>4ã€åœ¨_objc_rootDeallocä¸­ï¼Œè°ƒç”¨äº†object_disposeå‡½æ•°</li>
<li>5ã€è°ƒç”¨objc_destructInstance</li>
<li>6ã€æœ€åè°ƒç”¨objc_clear_deallocating</li>
</ul>
<p>é‡ç‚¹çœ‹å¯¹è±¡è¢«é‡Šæ”¾æ—¶è°ƒç”¨çš„objc_clear_deallocatingå‡½æ•°ã€‚</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">objc_clear_deallocating</span><span class="params">(id obj)</span> </span>&#123;</div><div class="line">    assert(obj);</div><div class="line">    assert(!UseGC);</div><div class="line">    <span class="keyword">if</span> (obj-&gt;isTaggedPointer()) <span class="keyword">return</span>;</div><div class="line">    obj-&gt;clearDeallocating();</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>ä¹Ÿå°±æ˜¯è°ƒç”¨äº†clearDeallocatingï¼Œç»§ç»­è¿½è¸ªå¯ä»¥å‘ç°ï¼Œå®ƒæœ€ç»ˆæ˜¯ä½¿ç”¨äº†è¿­ä»£å™¨æ¥å–weakè¡¨çš„valueï¼Œç„¶åè°ƒç”¨weak_clear_no_lock,ç„¶åæŸ¥æ‰¾å¯¹åº”çš„valueï¼Œå°†è¯¥weakæŒ‡é’ˆç½®ç©ºï¼Œweak_clear_no_lockå‡½æ•°çš„å®ç°å¦‚ä¸‹ï¼š</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line">* Called by dealloc; nils out all weak pointers that point to the</div><div class="line">* provided object so that they can no longer be used.</div><div class="line">*</div><div class="line">* @param weak_table</div><div class="line">* @param referent The object being deallocated.</div><div class="line">*/</div><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">weak_clear_no_lock</span><span class="params">(<span class="keyword">weak_table_t</span> *weak_table, id referent_id)</span> </span>&#123;</div><div class="line">    objc_object *referent = (objc_object *)referent_id;</div><div class="line">    <span class="keyword">weak_entry_t</span> *entry = weak_entry_for_referent(weak_table, referent);</div><div class="line">    <span class="keyword">if</span> (entry == nil) &#123;</div><div class="line">        <span class="comment">/// XXX shouldn't happen, but does with mismatched CF/objc</span></div><div class="line">        <span class="comment">//printf("XXX no entry for clear deallocating %p\n", referent);</span></div><div class="line">        <span class="keyword">return</span>;</div><div class="line">    &#125;</div><div class="line">    <span class="comment">// zero out references</span></div><div class="line">    <span class="keyword">weak_referrer_t</span> *referrers;</div><div class="line">    <span class="keyword">size_t</span> count;</div><div class="line">    <span class="keyword">if</span> (entry-&gt;out_of_line) &#123;</div><div class="line">        referrers = entry-&gt;referrers;</div><div class="line">        count = TABLE_SIZE(entry);</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">else</span> &#123;</div><div class="line">        referrers = entry-&gt;inline_referrers;</div><div class="line">        count = WEAK_INLINE_COUNT;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">for</span> (<span class="keyword">size_t</span> i = <span class="number">0</span>; i &lt; count; ++i) &#123;</div><div class="line">        objc_object **referrer = referrers[i];</div><div class="line">        <span class="keyword">if</span> (referrer) &#123;</div><div class="line">            <span class="keyword">if</span> (*referrer == referent) &#123;</div><div class="line">                *referrer = nil;</div><div class="line">            &#125;</div><div class="line">            <span class="keyword">else</span> <span class="keyword">if</span> (*referrer) &#123;</div><div class="line">                _objc_inform(<span class="string">"__weak variable at %p holds %p instead of %p. "</span></div><div class="line">                <span class="string">"This is probably incorrect use of "</span></div><div class="line">                <span class="string">"objc_storeWeak() and objc_loadWeak(). "</span></div><div class="line">                <span class="string">"Break on objc_weak_error to debug.\n"</span>,</div><div class="line">                referrer, (<span class="keyword">void</span>*)*referrer, (<span class="keyword">void</span>*)referent);</div><div class="line">                objc_weak_error();</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    weak_entry_remove(weak_table, entry);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>objc_clear_deallocating å®ç°å¦‚ä¸‹</p>
<ul>
<li>1ã€ä»weakè¡¨ä¸­è·å–åºŸå¼ƒå¯¹è±¡çš„åœ°å€ä¸ºé”®å€¼çš„è®°å½•</li>
<li>2ã€å°†åŒ…å«åœ¨è®°å½•ä¸­çš„æ‰€æœ‰é™„æœ‰ weakä¿®é¥°ç¬¦å˜é‡çš„åœ°å€ï¼Œèµ‹å€¼ä¸ºnil</li>
<li>3ã€å°†weakè¡¨ä¸­è¯¥è®°å½•åˆ é™¤</li>
<li>4ã€ä»å¼•ç”¨è®¡æ•°è¡¨ä¸­åˆ é™¤åºŸå¼ƒå¯¹è±¡çš„åœ°å€ä¸ºé”®å€¼çš„è®°å½•</li>
</ul>
<p>æ³¨é‡Šï¼šå“ˆå¸Œè¡¨æœ€å¤§çš„ä¼˜ç‚¹å°±æ˜¯æŠŠæ•°æ®çš„å­˜å‚¨å’ŒæŸ¥æ‰¾æ¶ˆè€—çš„æ—¶é—´å¤§å¤§é™ä½ï¼Œå‡ ä¹å¯ä»¥çœ‹æˆæ˜¯å¸¸æ•°æ—¶é—´ï¼›è€Œä»£ä»·ä»…ä»…æ˜¯æ¶ˆè€—æ¯”è¾ƒå¤šçš„å†…å­˜ã€‚ç„¶è€Œåœ¨å½“å‰å¯åˆ©ç”¨å†…å­˜è¶Šæ¥è¶Šå¤šçš„æƒ…å†µä¸‹ï¼Œç”¨ç©ºé—´æ¢æ—¶é—´çš„åšæ³•æ˜¯å€¼å¾—çš„ã€‚å¦å¤–ï¼Œç¼–ç æ¯”è¾ƒå®¹æ˜“ä¹Ÿæ˜¯å®ƒçš„ç‰¹ç‚¹ä¹‹ä¸€ã€‚</p>
<blockquote>
<p>ä»¥ä¸ŠåŸç†è§£ææ–‡ç« æ¥æºï¼š<a href="http://www.cocoachina.com/ios/20170328/18962.html" target="_blank" rel="external">http://www.cocoachina.com/ios/20170328/18962.html</a></p>
</blockquote>

            <div class="clearfix"></div>
            <hr class="nogutter">
        </div>
        <nav class="pagination" role="pagination">
    
    
    <a class="pull-right" href="/2018/06/16/Notification/">
        Objective-C Principle - Notification â†’
    </a>
    
</nav>

        <div class="duoshuo"></div>
    </div>
</section>


      
<!-- ============================ Footer =========================== -->

<footer>
    <div class="container">
            <div class="copy">
                <p>
                    &copy; 2014<script>new Date().getFullYear()>2010&&document.write("-"+new Date().getFullYear());</script>, Content By Steven. All Rights Reserved.
                </p>
                <p>Theme By <a href="//go.kieran.top" style="color: #767D84">Kieran</a></p>
            </div>
            <div class="social">
                <ul>
                    
                    <li><a href="https://github.com/ReverseScale" title="Github" target="_blank"><i class="icon-github"></i></a>&nbsp;</li>
                    
                    
                    <li><a href="https://twitter.com/" title="Twitter" target="_blank"><i class="icon-twitter"></i></a>&nbsp;</li>
                    
                    
                    <li><a href="https://www.facebook.com/" title="Facebook" target="_blank"><i class="icon-facebook"></i></a>&nbsp;</li>
                    
                    
                    <li><a href="https://google.com/" title="Google-Plus" target="_blank"><i class="icon-google-plus"></i></a>&nbsp;</li>
                    
                    
                    <li><a href="http://www.weibo.com/5844576818/profile?rightmod=1&wvr=6&mod=personinfo&is_all=1" title="Sina-Weibo" target="_blank"><i class="icon-sina-weibo"></i></a>&nbsp;</li>
                    
                </ul>
            </div>
            <div class="clearfix"> </div>
        </div>
</footer>

<!-- ============================ END Footer =========================== -->
      <!-- Load our scripts -->
        
<!-- Resizable 'on-demand' full-height hero -->
<script type="text/javascript">
    
    var resizeHero = function () {
        var hero = $(".cover,.heightblock"),
            window1 = $(window);
        hero.css({
            "height": window1.height()
        });
    };
    
    resizeHero();
    
    $(window).resize(function () {
        resizeHero();
    });
</script>
<script src="/js/plugins.min.js"></script><!-- Bootstrap core and concatenated plugins always load here -->
<script src="/js/jquery.flexslider-min.js"></script><!-- Flexslider plugin -->
<script src="/js/scripts.js"></script><!-- Theme scripts -->

<!-- Initiate flexslider plugin -->
<script type="text/javascript">
    $(document).ready(function($) {
      $('.flexslider').flexslider({
        animation: "fade",
        prevText: "",
        nextText: "",
        directionNav: true
      });
    });
</script>

</body>
</html>
