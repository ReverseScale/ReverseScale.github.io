<!DOCTYPE html>
<html>
<head><meta name="generator" content="Hexo 3.8.0">
  <meta charset="utf-8">
  
  <title>ios principleï¼šblock | Technology</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  
    <meta name="keywords" content="Principle">
  
  
  
  
  <meta name="description" content="Blockå…¶å®å°±æ˜¯Cè¯­è¨€çš„æ‰©å……åŠŸèƒ½ï¼Œå®ç°äº†å¯¹Cçš„é—­åŒ…å®ç°ï¼Œä¸€ä¸ªå¸¦æœ‰å±€éƒ¨å˜é‡çš„åŒ¿åå‡½æ•°~">
<meta name="keywords" content="Principle">
<meta property="og:type" content="article">
<meta property="og:title" content="iOS Principleï¼šBlock">
<meta property="og:url" content="https://reversescale.github.io/2018/06/10/iOS Principle Block/index.html">
<meta property="og:site_name" content="Technology">
<meta property="og:description" content="Blockå…¶å®å°±æ˜¯Cè¯­è¨€çš„æ‰©å……åŠŸèƒ½ï¼Œå®ç°äº†å¯¹Cçš„é—­åŒ…å®ç°ï¼Œä¸€ä¸ªå¸¦æœ‰å±€éƒ¨å˜é‡çš„åŒ¿åå‡½æ•°~">
<meta property="og:locale" content="default">
<meta property="og:image" content="https://user-gold-cdn.xitu.io/2018/6/5/163cef4658d95a21?w=427&h=75&f=png&s=13706">
<meta property="og:image" content="https://user-gold-cdn.xitu.io/2018/6/5/163cef465e456757?w=465&h=59&f=png&s=14449">
<meta property="og:image" content="https://user-gold-cdn.xitu.io/2018/6/5/163cef465d5b19ef?w=1096&h=83&f=png&s=30210">
<meta property="og:updated_time" content="2018-11-18T05:41:01.214Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="iOS Principleï¼šBlock">
<meta name="twitter:description" content="Blockå…¶å®å°±æ˜¯Cè¯­è¨€çš„æ‰©å……åŠŸèƒ½ï¼Œå®ç°äº†å¯¹Cçš„é—­åŒ…å®ç°ï¼Œä¸€ä¸ªå¸¦æœ‰å±€éƒ¨å˜é‡çš„åŒ¿åå‡½æ•°~">
<meta name="twitter:image" content="https://user-gold-cdn.xitu.io/2018/6/5/163cef4658d95a21?w=427&h=75&f=png&s=13706">
  
    <link rel="alternate" href="/atom.xml" title="Technology" type="application/atom+xml">
  

  

  <link rel="icon" href="/css/images/docccc.png">
  <link rel="apple-touch-icon" href="/css/images/docccc.png">
  
    <link href="//fonts.googleapis.com/css?family=Source+Code+Pro" rel="stylesheet" type="text/css">
  
  <link href="https://fonts.googleapis.com/css?family=Open+Sans|Montserrat:700" rel="stylesheet" type="text/css">
  <link href="https://fonts.googleapis.com/css?family=Roboto:400,300,300italic,400italic" rel="stylesheet" type="text/css">
  <link href="//cdn.bootcss.com/font-awesome/4.6.3/css/font-awesome.min.css" rel="stylesheet">
  <style type="text/css">
    @font-face{font-family:futura-pt;src:url(https://use.typekit.net/af/9749f0/00000000000000000001008f/27/l?subset_id=2&fvd=n5) format("woff2");font-weight:500;font-style:normal;}
    @font-face{font-family:futura-pt;src:url(https://use.typekit.net/af/90cf9f/000000000000000000010091/27/l?subset_id=2&fvd=n7) format("woff2");font-weight:500;font-style:normal;}
    @font-face{font-family:futura-pt;src:url(https://use.typekit.net/af/8a5494/000000000000000000013365/27/l?subset_id=2&fvd=n4) format("woff2");font-weight:lighter;font-style:normal;}
    @font-face{font-family:futura-pt;src:url(https://use.typekit.net/af/d337d8/000000000000000000010095/27/l?subset_id=2&fvd=i4) format("woff2");font-weight:400;font-style:italic;}</style>
  <link rel="stylesheet" href="../../../../css/style.css">

  <script src="../../../../js/jquery-3.1.1.min.js"></script>
  <script src="../../../../js/bootstrap.js"></script>

  <!-- Bootstrap core CSS -->
  <link rel="stylesheet" href="/css/bootstrap.css">

  
    <link rel="stylesheet" href="../../../../css/dialog.css">
  

  

  
    <link rel="stylesheet" href="/css/header-post.css">
  

  
  
  
    <link rel="stylesheet" href="/css/vdonate.css">
  

</head>
</html>


  <body data-spy="scroll" data-target="#toc" data-offset="50">


  
  <div id="container">
    <div id="wrap">
      
        <header>

    <div id="allheader" class="navbar navbar-default navbar-static-top" role="navigation">
        <div class="navbar-inner">
          
          <div class="container"> 
            <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
              <span class="sr-only">Toggle navigation</span>
              <span class="icon-bar"></span>
              <span class="icon-bar"></span>
              <span class="icon-bar"></span>
            </button>

            
              <a class="brand" style="
                 border-width: 0px;  margin-top: 0px;" href="#" data-toggle="modal" data-target="#myModal">
                  <img width="88px" height="88px" alt="Hike News" src="/css/images/docccc.png">
              </a>
            
            
            <div class="navbar-collapse collapse">
              <ul class="hnav navbar-nav">
                
                  <li> <a class="main-nav-link" href="../../../../index.html">Home</a> </li>
                
                  <li> <a class="main-nav-link" href="../../../../archives">Archives</a> </li>
                
                  <li> <a class="main-nav-link" href="../../../../categories">Categories</a> </li>
                
                  <li> <a class="main-nav-link" href="../../../../tags">Tags</a> </li>
                
                  <li> <a class="main-nav-link" href="../../../../about">About</a> </li>
                
                  <li><div id="search-form-wrap">

    <form class="search-form">
        <input type="text" class="ins-search-input search-form-input" placeholder="">
        <button type="submit" class="search-form-submit"></button>
    </form>
    <div class="ins-search">
    <div class="ins-search-mask"></div>
    <div class="ins-search-container">
        <div class="ins-input-wrapper">
            <input type="text" class="ins-search-input" placeholder="Type something...">
            <span class="ins-close ins-selectable"><i class="fa fa-times-circle"></i></span>
        </div>
        <div class="ins-section-wrapper">
            <div class="ins-section-container"></div>
        </div>
    </div>
</div>
<script>
(function (window) {
    var INSIGHT_CONFIG = {
        TRANSLATION: {
            POSTS: 'Posts',
            PAGES: 'Pages',
            CATEGORIES: 'Categories',
            TAGS: 'Tags',
            UNTITLED: '(Untitled)',
        },
        ROOT_URL: '/',
        CONTENT_URL: '../../../../content.json',
    };
    window.INSIGHT_CONFIG = INSIGHT_CONFIG;
})(window);
</script>
<script src="../../../../js/insight.js"></script>

</div></li>
            </ul></div>
          </div>
                
      </div>
    </div>

</header>



      
            
      <div id="content" class="outer">
        
          <section id="main" style="float:none;"><article id="post-iOS Principle Block" style="width: 75%; float:left;" class="article article-type-post" itemscope="" itemprop="blogPost">
  <div id="articleInner" class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 class="thumb" itemprop="name">
      iOS Principleï¼šBlock
    </h1>
  

      </header>
    
    <div class="article-meta">
      
	<a href="" class="article-date">
	  <time datetime="2018-06-10T13:56:27.000Z" itemprop="datePublished">2018-06-10</time>
	</a>

      
    <a class="article-category-link" href="../../../../categories/Principle/">Principle</a>

      
	<a class="article-views">
	<span id="busuanzi_container_page_pv">
		PV:<span id="busuanzi_value_page_pv"></span>
	</span>
	</a>

    </div>
    <div class="article-entry" itemprop="articleBody">
      
        <p>Blockå…¶å®å°±æ˜¯Cè¯­è¨€çš„æ‰©å……åŠŸèƒ½ï¼Œå®ç°äº†å¯¹Cçš„é—­åŒ…å®ç°ï¼Œä¸€ä¸ªå¸¦æœ‰å±€éƒ¨å˜é‡çš„åŒ¿åå‡½æ•°~ </p>
<a id="more"></a>
<hr>
<p>ğŸ‘¨ğŸ»â€ğŸ’» <a href="https://github.com/ReverseScale/iOSPrinciple_Block" target="_blank" rel="noopener">Github Demo</a></p>
<h3 id="æ–¹ä¾¿è®°å¿†ï¼š"><a href="#æ–¹ä¾¿è®°å¿†ï¼š" class="headerlink" title="æ–¹ä¾¿è®°å¿†ï¼š"></a>æ–¹ä¾¿è®°å¿†ï¼š</h3><ul>
<li>Block å®ç°äº†å¯¹Cçš„é—­åŒ…å®ç°ï¼Œä¸€ä¸ªå¸¦æœ‰å±€éƒ¨å˜é‡çš„åŒ¿åå‡½æ•°</li>
<li>æºç ç»“æ„åˆ†æ<ul>
<li>æœ¬ä½“éƒ¨åˆ†ï¼šblockå®é™…çš„ç»“æ„ä½“éƒ¨åˆ†</li>
<li>æˆå‘˜å˜é‡ï¼šimplå’ŒDesc</li>
<li>ç»“æ„ä½“çš„æ„é€ å‡½æ•°ï¼š__main_block_impl_0</li>
</ul>
</li>
<li>æ•è·å¤–éƒ¨å˜é‡<ul>
<li>å±€éƒ¨å˜é‡ä½œä¸ºBlockç»“æ„ä½“çš„æˆå‘˜å˜é‡è¿½åŠ åˆ°äº†__main_block_impl_0</li>
<li>æ ¹æ®ä¼ é€’ç»™æ„é€ å‡½æ•°çš„å‚æ•°å¯¹ç”±å±€éƒ¨å˜é‡è¿½åŠ çš„æˆå‘˜å˜é‡è¿›è¡Œåˆå§‹åŒ–</li>
<li>__main_block_func_0ä¸­è¿›è¡Œäº†å˜é‡è·å–_cself-&gt;ch(å˜é‡çš„å€¼-æ·±æ‹·è´)</li>
</ul>
</li>
<li>æ”¹å˜Blocké‡Œçš„å€¼<ul>
<li>cæ–¹æ³•ï¼šé™æ€å˜é‡ã€é™æ€å…¨å±€å˜é‡ã€å…¨å±€å˜é‡</li>
<li>__blockä¿®é¥°ç¬¦ï¼šå˜æˆäº†ç»“æ„ä½“å®ä¾‹ï¼Œåˆå§‹åŒ–_main_block_impl_0çš„æ—¶å€™è¿½åŠ çš„æ˜¯_blockç”Ÿæˆçš„ç»“æ„ä½“æŒ‡é’ˆ</li>
</ul>
</li>
<li>ä¸‰ç§Blockæœ¬ä½“<ul>
<li>NSConcreteStackBlockï¼šåœ¨å±€éƒ¨å®šä¹‰çš„ï¼ˆæ ˆï¼‰</li>
<li>NSConcreteGlobalBlockï¼šåœ¨å…¨å±€ä¸­å®šä¹‰çš„ï¼ˆæ•°æ®åŒºåŸŸï¼‰-ä¸å­˜åœ¨å¯¹å±€éƒ¨å˜é‡çš„æ•è·</li>
<li>NSConcreteMallocBlockï¼šåˆ†é…åœ¨å †ä¸­-Blockä»æ ˆä¸Šå¤åˆ¶åˆ°å †ä¸Šçš„æ–¹æ³•</li>
</ul>
</li>
</ul>
<hr>
<h3 id="å£°æ˜ä¸€ä¸ªBlock"><a href="#å£°æ˜ä¸€ä¸ªBlock" class="headerlink" title="å£°æ˜ä¸€ä¸ªBlock:"></a>å£°æ˜ä¸€ä¸ªBlock:</h3><h4 id="ä½¿ç”¨åœºæ™¯ä¸€ï¼š"><a href="#ä½¿ç”¨åœºæ™¯ä¸€ï¼š" class="headerlink" title="ä½¿ç”¨åœºæ™¯ä¸€ï¼š"></a>ä½¿ç”¨åœºæ™¯ä¸€ï¼š</h4><p>è¿”å›å€¼ (^åç§°) (å‚æ•°åˆ—è¡¨) = ^(å‚æ•°åˆ—è¡¨) {<br>};</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">int</span> (^name)(<span class="keyword">int</span>, <span class="keyword">int</span>) = ^(<span class="keyword">int</span> a, <span class="keyword">int</span> b) &#123;</span><br><span class="line"> Â  Â <span class="keyword">return</span> (a+b);</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<h4 id="ä½¿ç”¨åœºæ™¯äºŒï¼š"><a href="#ä½¿ç”¨åœºæ™¯äºŒï¼š" class="headerlink" title="ä½¿ç”¨åœºæ™¯äºŒï¼š"></a>ä½¿ç”¨åœºæ™¯äºŒï¼š</h4><p>ä½œä¸ºä¸€ä¸ªå‡½æ•°çš„å‚æ•°ï¼š</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">- (<span class="keyword">void</span>)testBlock:(<span class="built_in">NSString</span> *(è¿”å›ç±»å‹) (^)(<span class="keyword">int</span> a))s (blockåå­—ï¼‰ &#123;</span><br><span class="line">    <span class="built_in">NSString</span> *a = s(<span class="number">1</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line">    [<span class="keyword">self</span> testBlock:^<span class="built_in">NSString</span> *(<span class="keyword">int</span> a) &#123;</span><br><span class="line">        a = <span class="number">5</span>;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">@"1"</span>;</span><br><span class="line">    &#125;];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="Demo-ä¸­æ–‡ä»¶å¯¹ç…§"><a href="#Demo-ä¸­æ–‡ä»¶å¯¹ç…§" class="headerlink" title="Demo ä¸­æ–‡ä»¶å¯¹ç…§"></a>Demo ä¸­æ–‡ä»¶å¯¹ç…§</h3><p><img src="https://user-gold-cdn.xitu.io/2018/6/5/163cef4658d95a21?w=427&amp;h=75&amp;f=png&amp;s=13706" alt=""></p>
<ul>
<li>mainTestBlock.cpp -&gt; åŸºæœ¬çš„blockè½¬è¯‘</li>
<li>mainTestBlockValue.cpp -&gt; blockæ•è·å¤–éƒ¨å˜é‡</li>
<li>mainTestBlockValueC.cpp -&gt; é€šè¿‡Cè¯­è¨€å˜é‡è®¿é—®å€¼</li>
<li>mainTestBlockValueValueBlock.cpp -&gt; é€šè¿‡__blockå˜é‡è®¿é—®å€¼</li>
</ul>
<h3 id="ä»åº•å±‚åˆ†æBlockçš„å®ç°"><a href="#ä»åº•å±‚åˆ†æBlockçš„å®ç°" class="headerlink" title="ä»åº•å±‚åˆ†æBlockçš„å®ç°"></a>ä»åº•å±‚åˆ†æBlockçš„å®ç°</h3><h4 id="å…ˆä»æœ€ç®€å•çš„çœ‹èµ·"><a href="#å…ˆä»æœ€ç®€å•çš„çœ‹èµ·" class="headerlink" title="å…ˆä»æœ€ç®€å•çš„çœ‹èµ·"></a>å…ˆä»æœ€ç®€å•çš„çœ‹èµ·</h4><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span> (^block)(<span class="keyword">void</span>) = ^(<span class="keyword">void</span>) &#123;</span><br><span class="line">    </span><br><span class="line">&#125;;</span><br><span class="line">block();</span><br></pre></td></tr></table></figure>
<p>ä½¿ç”¨ Clangï¼ˆLLVMï¼‰è½¬åŒ–ä¸º C++ çš„å®ç°<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">clang -rewrite-objc æ–‡ä»¶å</span><br></pre></td></tr></table></figure></p>
<p>æ³¨æ„ï¼šç”±äº ViewController ä¸­ä½¿ç”¨ UIKit åº“ï¼Œç¼–è¯‘æ—¶ä¼šå‡ºç°æ‰¾ä¸åˆ°æ–‡ä»¶çš„æƒ…å†µã€‚</p>
<p><img src="https://user-gold-cdn.xitu.io/2018/6/5/163cef465e456757?w=465&amp;h=59&amp;f=png&amp;s=14449" alt=""></p>
<p>è½¬åŒ–åçš„ä»£ç å¦‚ä¸‹ï¼š<br><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> __<span class="title">block_impl</span> &#123;</span>  </span><br><span class="line">    <span class="keyword">void</span> *isa;  </span><br><span class="line">    <span class="keyword">int</span> Flags;  </span><br><span class="line">    <span class="keyword">int</span> Reserved;  </span><br><span class="line">    <span class="keyword">void</span> *FuncPtr;  </span><br><span class="line">&#125;;  </span><br><span class="line"><span class="class"><span class="keyword">struct</span> __<span class="title">main_block_impl_0</span> &#123;</span>  </span><br><span class="line">    <span class="class"><span class="keyword">struct</span> __<span class="title">block_impl</span> <span class="title">impl</span>;</span>  </span><br><span class="line">    <span class="class"><span class="keyword">struct</span> __<span class="title">main_block_desc_0</span>* <span class="title">Desc</span>;</span>  </span><br><span class="line">    __main_block_impl_0(<span class="keyword">void</span> *fp, struct __main_block_desc_0 *desc, <span class="keyword">int</span> flags=<span class="number">0</span>) &#123;  </span><br><span class="line">        impl.isa = &amp;_NSConcreteStackBlock;  </span><br><span class="line">        impl.Flags = flags;  </span><br><span class="line">        impl.FuncPtr = fp;  </span><br><span class="line">        Desc = desc;  </span><br><span class="line">    &#125;  </span><br><span class="line">&#125;;  </span><br><span class="line"><span class="keyword">static</span> <span class="keyword">void</span> __main_block_func_0(struct __main_block_impl_0 *__cself) &#123;  </span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"aaa\n"</span>);</span><br><span class="line">&#125;  </span><br><span class="line"><span class="keyword">static</span> <span class="class"><span class="keyword">struct</span> __<span class="title">main_block_desc_0</span> &#123;</span>  </span><br><span class="line">    <span class="keyword">size_t</span> reserved;  </span><br><span class="line">    <span class="keyword">size_t</span> Block_size;  </span><br><span class="line">&#125; __main_block_desc_0_DATA = &#123; <span class="number">0</span>, <span class="keyword">sizeof</span>(struct __main_block_impl_0)&#125;;  </span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;  </span><br><span class="line">    <span class="keyword">void</span> (*block)(<span class="keyword">void</span>) = ((<span class="keyword">void</span> (*)())&amp;__main_block_impl_0((<span class="keyword">void</span> *)__main_block_func_0, &amp;__main_block_desc_0_DATA));  </span><br><span class="line">    ((<span class="keyword">void</span> (*)(__block_impl *))((__block_impl *)block)-&gt;FuncPtr)((__block_impl *)block);  </span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h4 id="æºç ç»“æ„åˆ†æ"><a href="#æºç ç»“æ„åˆ†æ" class="headerlink" title="æºç ç»“æ„åˆ†æ"></a>æºç ç»“æ„åˆ†æ</h4><p>1.blockå®é™…çš„ç»“æ„ä½“éƒ¨åˆ†ï¼ˆæœ¬ä½“ï¼‰<br><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> __<span class="title">main_block_impl_0</span> &#123;</span>  </span><br><span class="line">    <span class="class"><span class="keyword">struct</span> __<span class="title">block_impl</span> <span class="title">impl</span>;</span> <span class="comment">// ç»“æ„ä½“ implï¼Œè§ä¸‹ 2</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> __<span class="title">main_block_desc_0</span>* <span class="title">Desc</span>;</span> <span class="comment">// ç»“æ„ä½“ Descï¼Œè§ä¸‹ 3</span></span><br><span class="line">    __main_block_impl_0(<span class="keyword">void</span> *fp, struct __main_block_desc_0 *desc, <span class="keyword">int</span> flags=<span class="number">0</span>) &#123;  <span class="comment">// æ„é€ å‡½æ•°ï¼Œè§ä¸‹ 4</span></span><br><span class="line">        impl.isa = &amp;_NSConcreteStackBlock;  </span><br><span class="line">        impl.Flags = flags;  </span><br><span class="line">        impl.FuncPtr = fp;  </span><br><span class="line">        Desc = desc;  </span><br><span class="line">    &#125;  </span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure></p>
<p>2.å†çœ‹çœ‹ç¬¬ä¸€ä¸ªæˆå‘˜å˜é‡impl<br><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> __<span class="title">block_impl</span> &#123;</span>  </span><br><span class="line">    <span class="keyword">void</span> *isa; <span class="comment">// struct ä¸­ï¼Œé¦–åœ°å€æ˜¯ *isaï¼Œè¯æ˜ block æ˜¯ objc ä¸­çš„å¯¹è±¡</span></span><br><span class="line">    <span class="keyword">int</span> Flags; <span class="comment">// æ ‡è®°</span></span><br><span class="line">    <span class="keyword">int</span> Reserved; <span class="comment">// æ ‡è®°</span></span><br><span class="line">    <span class="keyword">void</span> *FuncPtr; <span class="comment">// å‡½æ•°æŒ‡é’ˆï¼Œblockæ‰€éœ€è¦æ‰§è¡Œçš„ä»£ç æ®µ</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure></p>
<p>ä»–çš„ç¬¬ä¸€ä¸ªå±æ€§ä¹Ÿæ˜¯ä¸€ä¸ªç»“æ„__block_implï¼Œè€Œç¬¬ä¸€ä¸ªå‚æ•°ä¹Ÿæ˜¯ä¸€ä¸ªisaçš„æŒ‡é’ˆã€‚</p>
<p>åœ¨è¿è¡Œæ—¶ï¼ŒNSObjectå’Œblockçš„isaæŒ‡é’ˆéƒ½æ˜¯æŒ‡å‘å¯¹è±¡çš„ä¸€ä¸ª8å­—èŠ‚ã€‚<br>NSObjectåŠæ´¾ç”Ÿç±»å¯¹è±¡çš„isaæŒ‡å‘Classçš„prototypeï¼Œè€Œblockçš„isaæŒ‡å‘äº†_NSConcreteStackBlockè¿™ä¸ªæŒ‡é’ˆã€‚<br>å°±æ˜¯è¯´å½“ä¸€ä¸ªblockè¢«å£°æ˜çš„æ—¶å€™ä»–éƒ½æ˜¯ä¸€ä¸ª_NSConcreteStackBlockç±»çš„å¯¹è±¡ã€‚</p>
<p>3.ç¬¬äºŒä¸ªæˆå‘˜å˜é‡Desc<br><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="class"><span class="keyword">struct</span> __<span class="title">main_block_desc_0</span> &#123;</span>  </span><br><span class="line">    <span class="keyword">size_t</span> reserved; <span class="comment">// ç‰ˆæœ¬å‡çº§æ‰€éœ€çš„åŒºåŸŸ</span></span><br><span class="line">    <span class="keyword">size_t</span> Block_size;  <span class="comment">// Blockçš„å ç”¨ç©ºé—´å¤§å°</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>4.ç¬¬ä¸‰ä¸ªå°±æ˜¯è¿™ä¸ªç»“æ„ä½“çš„æ„é€ å‡½æ•°ï¼ˆå¯ä»¥ç†è§£ä¸ºå¯¹è±¡çš„åˆå§‹åŒ–æ–¹æ³•ï¼‰<br><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">__main_block_impl_0(<span class="keyword">void</span> *fp, struct __main_block_desc_0 *desc, <span class="keyword">int</span> flags=<span class="number">0</span>) &#123;  </span><br><span class="line">    impl.isa = &amp;_NSConcreteStackBlock; <span class="comment">// block çš„æœ¬ä½“ç±»å‹ï¼Œåé¢ä¸“é—¨è®²è§£</span></span><br><span class="line">    impl.Flags = flags;  </span><br><span class="line">    impl.FuncPtr = fp; <span class="comment">// void *fpçš„æŒ‡é’ˆèµ‹å€¼ç»™äº†FuncPtræŒ‡é’ˆ</span></span><br><span class="line">    Desc = desc; <span class="comment">// desc ç»“æ„ä½“çš„æŒ‡é’ˆä¼ å…¥çš„åˆå§‹åŒ–</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<blockquote>
<p>ä»¥ä¸‹æ˜¯æºç è°ƒç”¨åˆ†æ</p>
</blockquote>
<p>5.ç°åœ¨æ¥çœ‹çœ‹Mainå‡½æ•°ä¸­è°ƒç”¨çš„åŸºæœ¬è½¬æ¢ï¼ˆåˆå§‹åŒ–è½¬æ¢ï¼‰<br><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span> (*block)(<span class="keyword">void</span>) = ((<span class="keyword">void</span> (*)())&amp;__main_block_impl_0((<span class="keyword">void</span> *)__main_block_func_0, &amp;__main_block_desc_0_DATA));</span><br></pre></td></tr></table></figure></p>
<p>çœ‹èµ·æ¥è¿™ä¸ªå‡½æ•°å¥½å“äººå•Šï¼Œæ²¡äº‹ï¼Œå’±ä»¬æŠŠç±»å‹éƒ½å»äº†ï¼Œè€Œä¸”åˆ†å¼€ä¸¤æ­¥æ¥å†™<br><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* è°ƒç”¨ç»“æ„ä½“å‡½æ•°åˆå§‹åŒ–   </span></span><br><span class="line"><span class="comment">struct __main_block_impl_0 impBlock = __main_block_impl_0(__main_block_func_0,&amp;__main_block_desc_0_DATA);  </span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">/* èµ‹å€¼ç»™è¯¥ç»“æ„ä½“ç±»å‹æŒ‡é’ˆå˜é‡  </span></span><br><span class="line"><span class="comment">struct __main_block_impl_0 *block = &amp;impBlock;</span></span><br></pre></td></tr></table></figure></p>
<p>æŠŠæ ˆä¸Šç”Ÿæˆçš„<strong>main_block_impl_0çš„ç»“æ„ä½“å®ä¾‹çš„æŒ‡é’ˆï¼Œèµ‹å€¼ç»™</strong>main_block_impl_0ç»“æ„ä½“æŒ‡é’ˆç±»å‹çš„å˜é‡block</p>
<p>__main_block_func_0å°±æ˜¯è½¬æ¢æˆçš„å‡½æ•°æŒ‡é’ˆï¼Œè¿™æ ·void (*block)(void) = ^{}è¿™å¥ç®€å•çš„ä»£ç æœ€ç»ˆå°±æ˜¯ä¸Šé¢çš„ç»“æ„ä½“åˆå§‹åŒ–å‡½æ•°çš„å†…éƒ¨å®ç°é€»è¾‘</p>
<p>6.å†æ¥ç»†çœ‹ä¸‹åˆå§‹åŒ–å‡½æ•°å†…éƒ¨çš„å®ç°__block_main_impl_0<br><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">__main_block_impl_0(__main_block_func_0,&amp;__main_block_desc_0_DATA);</span><br></pre></td></tr></table></figure></p>
<p>ç¬¬ä¸€ä¸ªå‚æ•°æ˜¯ç”±Blockå—è¯­æ³•è½¬æ¢çš„æ­£çœŸå†…éƒ¨å‡½æ•°æŒ‡é’ˆï¼Œç¬¬äºŒä¸ªå‚æ•°å°±æ˜¯ä½œä¸ºé™æ€å…¨å±€å˜é‡åˆå§‹åŒ–__main_block_desc_0çš„ç»“æ„ä½“å®ä¾‹æŒ‡é’ˆï¼Œåˆå§‹åŒ–å¦‚ä¸‹<br><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">__main_block_desc_0_DATA = &#123; <span class="number">0</span>, <span class="keyword">sizeof</span>(struct __main_block_impl_0)&#125;;</span><br></pre></td></tr></table></figure></p>
<p>æœ€ç»ˆï¼Œåˆå§‹åŒ–å†…éƒ¨è¿›è¡Œèµ‹å€¼<br><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">isa = &amp;_NSConcreteStackBlock</span><br><span class="line">Flags = <span class="number">0</span></span><br><span class="line">Reversed = <span class="number">0</span></span><br><span class="line">FuncPtr = __main_blcok_func_0 <span class="comment">// å°±æ˜¯Blockå—ä»£ç è½¬æ¢æˆçš„Cè¯­è¨€å‡½æ•°æŒ‡é’ˆ</span></span><br><span class="line">Desc = &amp;__ main_block_desc_0_DATA</span><br></pre></td></tr></table></figure></p>
<p>7.æœ€ç»ˆ block() è°ƒç”¨çš„å†…éƒ¨å®ç°<br><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">((<span class="keyword">void</span> (*)(__block_impl *))((__block_impl *)block)-&gt;FuncPtr)((__block_impl *)block);</span><br></pre></td></tr></table></figure></p>
<p>è€è§„çŸ© ï¼Œå»æ‰ç±»å‹å°±æ˜¯<br><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">(*block-&gt;imp.FuncPtr)(block);</span><br></pre></td></tr></table></figure></p>
<p>æ‰“å°æ¢è¡Œ<br><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">void</span> __main_block_func_0(struct __main_block_impl_0 *__cself) &#123;  </span><br><span class="line"><span class="built_in">printf</span>(<span class="string">"aaa\n"</span>);&#125;</span><br></pre></td></tr></table></figure></p>
<p>æ²¡é”™ï¼Œæœ€åå°±æ˜¯ç›´æ¥è°ƒç”¨å‡½æ•°æŒ‡é’ˆè¿›è¡Œæœ€ç»ˆçš„è°ƒç”¨ï¼Œç”±ä¸Šé¢æ‰€æè¿°çš„ï¼ŒFuncPtrå°±æ˜¯ç”±__main_block_func_0çš„å‡½æ•°æŒ‡é’ˆæ‰€èµ‹å€¼çš„æŒ‡é’ˆï¼Œè€Œä¸”å¯ä»¥çœ‹å‡ºï¼Œè¿™ä¸ªå‡½æ•°çš„å‚æ•°æ­£æ˜¯æŒ‡å‘blockæœ¬èº«ç»“æ„ä½“å®ä¾‹ï¼Œblockä½œä¸ºå‚æ•°è¿›è¡Œäº†ä¼ é€’</p>
<p>ç»¼ä¸Šæ‰€è¿°ï¼Œblockçš„å®è´¨ï¼Œå°±æ˜¯ä¸€ä¸ªå¯¹è±¡ï¼ŒåŒ…å«äº†ä¸€ä¸ªæŒ‡å‘å‡½æ•°é¦–åœ°å€çš„æŒ‡é’ˆï¼Œå’Œä¸€äº›ä¸è‡ªå·±ç›¸å…³çš„æˆå‘˜å˜é‡ã€‚</p>
<h3 id="Block-è®¿é—®å¤–éƒ¨å˜é‡æ˜¯æ€ä¹ˆå›äº‹"><a href="#Block-è®¿é—®å¤–éƒ¨å˜é‡æ˜¯æ€ä¹ˆå›äº‹" class="headerlink" title="Block è®¿é—®å¤–éƒ¨å˜é‡æ˜¯æ€ä¹ˆå›äº‹"></a>Block è®¿é—®å¤–éƒ¨å˜é‡æ˜¯æ€ä¹ˆå›äº‹</h3><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">int</span> main()&#123;  </span><br><span class="line">    <span class="keyword">int</span> a = <span class="number">100</span>;  </span><br><span class="line">    <span class="keyword">int</span> b = <span class="number">200</span>;  </span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">char</span> *ch = <span class="string">"b = %d\n"</span>;  </span><br><span class="line">    <span class="keyword">void</span> (^block)(<span class="keyword">void</span>) = ^&#123;   </span><br><span class="line">    &#125;;  </span><br><span class="line"></span><br><span class="line">    b = <span class="number">300</span>;  </span><br><span class="line">    ch = <span class="string">"value had changed.b = %d\n"</span>;  </span><br><span class="line">    block();  </span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Clang è½¬åŒ–åä»£ç <br><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> __<span class="title">block_impl</span> &#123;</span></span><br><span class="line">    <span class="keyword">void</span> *isa;</span><br><span class="line">    <span class="keyword">int</span> Flags;</span><br><span class="line">    <span class="keyword">int</span> Reserved;</span><br><span class="line">    <span class="keyword">void</span> *FuncPtr;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> __<span class="title">main_block_impl_0</span> &#123;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> __<span class="title">block_impl</span> <span class="title">impl</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> __<span class="title">main_block_desc_0</span>* <span class="title">Desc</span>;</span></span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">char</span> *ch;</span><br><span class="line">    <span class="keyword">int</span> b;</span><br><span class="line">    __main_block_impl_0(<span class="keyword">void</span> *fp, struct __main_block_desc_0 *desc, <span class="keyword">const</span> <span class="keyword">char</span> *_ch, <span class="keyword">int</span> _b, <span class="keyword">int</span> flags=<span class="number">0</span>) : ch(_ch), b(_b) &#123;</span><br><span class="line">        impl.isa = &amp;_NSConcreteStackBlock;</span><br><span class="line">        impl.Flags = flags;</span><br><span class="line">        impl.FuncPtr = fp;</span><br><span class="line">        Desc = desc;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="keyword">static</span> <span class="keyword">void</span> __main_block_func_0(struct __main_block_impl_0 *__cself) &#123;</span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">char</span> *ch = __cself-&gt;ch; <span class="comment">// bound by copy</span></span><br><span class="line">    <span class="keyword">int</span> b = __cself-&gt;b; <span class="comment">// bound by copy</span></span><br><span class="line">    <span class="built_in">printf</span>(ch,b);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">static</span> <span class="class"><span class="keyword">struct</span> __<span class="title">main_block_desc_0</span> &#123;</span></span><br><span class="line">    <span class="keyword">size_t</span> reserved;</span><br><span class="line">    <span class="keyword">size_t</span> Block_size;</span><br><span class="line">&#125; __main_block_desc_0_DATA = &#123; <span class="number">0</span>, <span class="keyword">sizeof</span>(struct __main_block_impl_0)&#125;;</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> a = <span class="number">100</span>;</span><br><span class="line">    <span class="keyword">int</span> b = <span class="number">200</span>;</span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">char</span> *ch = <span class="string">"b = %d\n"</span>;</span><br><span class="line">    <span class="keyword">void</span> (*block)(<span class="keyword">void</span>) = ((<span class="keyword">void</span> (*)())&amp;__main_block_impl_0((<span class="keyword">void</span> *)__main_block_func_0, &amp;__main_block_desc_0_DATA, ch, b));</span><br><span class="line">    b = <span class="number">300</span>;</span><br><span class="line">    ch = <span class="string">"value had changed.b = %d\n"</span>;</span><br><span class="line">    ((<span class="keyword">void</span> (*)(__block_impl *))((__block_impl *)block)-&gt;FuncPtr)((__block_impl *)block);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>1.é¦–å…ˆçœ‹çœ‹Blockçš„å†…éƒ¨ç»“æ„æœ¬å°Šå’Œæ²¡æœ‰æˆªè·çš„åŒºåˆ«<br><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> __<span class="title">main_block_impl_0</span> &#123;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> __<span class="title">block_impl</span> <span class="title">impl</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> __<span class="title">main_block_desc_0</span>* <span class="title">Desc</span>;</span></span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">char</span> *ch;</span><br><span class="line">    <span class="keyword">int</span> b;</span><br><span class="line">    __main_block_impl_0(<span class="keyword">void</span> *fp, struct __main_block_desc_0 *desc, <span class="keyword">const</span> <span class="keyword">char</span> *_ch, <span class="keyword">int</span> _b, <span class="keyword">int</span> flags=<span class="number">0</span>) : ch(_ch), b(_b) &#123;</span><br><span class="line">        impl.isa = &amp;_NSConcreteStackBlock;</span><br><span class="line">        impl.Flags = flags;</span><br><span class="line">        impl.FuncPtr = fp;</span><br><span class="line">        Desc = desc;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure></p>
<p>æ ¹æ®mainå‡½æ•°é‡Œé¢çš„Blockè¯­æ³•ï¼Œè¿™é‡ŒæŠŠBlockå—è¡¨è¾¾å¼é‡Œé¢çš„å±€éƒ¨å˜é‡ä½œä¸ºäº†è¿™ä¸ªBlockç»“æ„ä½“çš„æˆå‘˜å˜é‡è¿½åŠ åˆ°äº†__main_block_impl_0çš„ç»“æ„ä½“ä¸­</p>
<p>å€¼å¾—æ³¨æ„çš„æ˜¯ï¼š</p>
<ul>
<li>ç»“æ„ä½“å†…å£°æ˜çš„æˆå‘˜å˜é‡ç±»å‹ä¸å±€éƒ¨å˜é‡ç±»å‹å®Œå…¨ç›¸åŒ</li>
<li>è¯­æ³•ä¸­æ²¡æœ‰ä½¿ç”¨çš„å±€éƒ¨å˜é‡ï¼ˆä¾‹å¦‚å’±ä»¬è¿™é‡Œçš„aå˜é‡ï¼‰ä¸ä¼šè¢«è¿½åŠ </li>
<li>ç»†èŠ‚éœ€è¦æ³¨æ„ï¼Œè¿™é‡Œæˆªè·çš„chæ˜¯ä¸å¯ä¿®æ”¹çš„ï¼Œè€Œä¸”æ•æ‰çš„båªæ˜¯æˆªè·äº†è¯¥å±€éƒ¨å˜é‡çš„å€¼è€Œå·²ï¼ˆä¸‹é¢åœ¨å°†å¦‚ä½•æˆªè·æŒ‡é’ˆï¼‰</li>
</ul>
<p>2.å†æ¥çœ‹çœ‹è¯¥ç»“æ„ä½“å®ä¾‹åŒ–çš„æ„é€ å‡½æ•°ä»¥åŠè°ƒç”¨å’Œæ²¡æœ‰æˆªè·çš„åŒºåˆ«<br><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">__main_block_impl_0(<span class="keyword">void</span> *fp, struct __main_block_desc_0 *desc, <span class="keyword">const</span> charchar *_ch, <span class="keyword">int</span> _b, <span class="keyword">int</span> flags=<span class="number">0</span>) : ch(_ch), b(_b) &#123;  </span><br><span class="line">    impl.isa = &amp;_NSConcreteStackBlock;  </span><br><span class="line">    impl.Flags = flags;  </span><br><span class="line">    impl.FuncPtr = fp;  </span><br><span class="line">    Desc = desc;  </span><br><span class="line">&#125;  </span><br><span class="line"><span class="keyword">void</span> (*block)(<span class="keyword">void</span>) = ((<span class="keyword">void</span> (*)())&amp;__main_block_impl_0((<span class="keyword">void</span> *)__main_block_func_0, &amp;__main_block_desc_0_DATA, ch, b));</span><br></pre></td></tr></table></figure></p>
<p>æ ¹æ®ä¼ é€’ç»™æ„é€ å‡½æ•°çš„å‚æ•°å¯¹ç”±å±€éƒ¨å˜é‡è¿½åŠ çš„æˆå‘˜å˜é‡è¿›è¡Œåˆå§‹åŒ–ã€‚ï¼ˆè¿™é‡Œä¼ é€’çš„å‚æ•°ä»…ä»…åªæ˜¯chå’Œbçš„å€¼è€Œå·²ï¼‰</p>
<p>ç†è§£ä¸ºæŠŠBlockè¯­æ³•å—é‡Œé¢æˆªè·çš„å±€éƒ¨å˜é‡å¯¹__main_block_impl_0çš„æˆå‘˜è¿½åŠ å¹¶ä¸”ä¼ é€’èµ‹å€¼ï¼Œå¦‚ï¼š<br><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">impl.isa = &amp;_NSConcreteStackBlock;</span><br><span class="line">impl.Flags = <span class="number">0</span>;</span><br><span class="line">impl.FuncPtr = __main_block_func_0;</span><br><span class="line">Desc = &amp;__main_block_desc_0_DATA;</span><br><span class="line">ch = <span class="string">"b=%d\n"</span>;</span><br><span class="line">b = <span class="number">200</span>;</span><br></pre></td></tr></table></figure></p>
<p>ç”±æ­¤å¯ä»¥çœ‹å‡ºï¼Œ__main_block_impl_0çš„ç»“æ„ä½“ï¼ˆå³Blockï¼‰å¯¹è‡ªåŠ¨å˜é‡è¿›è¡Œäº†æˆªè·</p>
<p>3.å†æ¥çœ‹çœ‹æœ€ç»ˆè°ƒç”¨Blockçš„æ—¶å€™å’Œæ²¡æœ‰æˆªè·çš„åŒºåˆ«<br><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">((<span class="keyword">void</span> (*)(__block_impl *))((__block_impl *)block)-&gt;FuncPtr)((__block_impl *)block);  </span><br><span class="line"><span class="keyword">static</span> <span class="keyword">void</span> __main_block_func_0(struct __main_block_impl_0 *__cself) &#123;  </span><br><span class="line">    <span class="keyword">const</span> charchar *ch = __cself-&gt;ch; <span class="comment">// bound by copy  </span></span><br><span class="line">    <span class="keyword">int</span> b = __cself-&gt;b; <span class="comment">// bound by copy  </span></span><br><span class="line">    <span class="built_in">printf</span>(ch,b);  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>å¯ä»¥çœ‹å‡ºblock()è¿™å¥ä»£ç è½¬æ¢çš„è°ƒç”¨æ–¹å¼æ²¡æœ‰ä»»ä½•å˜åŒ–<br>è¿˜æ˜¯è½¬æ¢ä¸ºä¸€ä¸‹è¿™å¥è¯ï¼Œè€Œä¸”æŠŠæœ¬èº«ç»“æ„ä½“ä½œä¸ºå‚æ•°è¿›è¡Œäº†ä¼ é€’<br><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">(*block-impl.FuncPtr)(block)</span><br></pre></td></tr></table></figure></p>
<p>ç°åœ¨æ³¨æ„çœ‹<strong>main_block_func_0è¿™ä¸ªCè¯­è¨€çš„å‡½æ•°ï¼Œå’Œä¹‹å‰ç›¸æ¯”è¿™é‡Œå¯¹ä¼ é€’è¿‡æ¥çš„blockç»“æ„ä½“å‚æ•°è¿›è¡Œäº†å˜é‡è·å–</strong>cself-&gt;ch å’Œ __cself-&gt;bï¼ˆè¿™ä¸¤ä¸ªå˜é‡å·²ç»åœ¨Blockè¡¨è¾¾å¼ä¹‹å‰è¿›è¡Œäº†å£°æ˜å®šä¹‰ï¼‰ï¼Œå¹¶æœ€ç»ˆæ‰“å°å‡ºæ¥</p>
<p>ä½†æ˜¯ï¼ŒBlockä¸­æ‰€æ•è·çš„å˜é‡å°±çŠ¹å¦‚â€œå¸¦æœ‰å±€éƒ¨å˜é‡å€¼çš„åŒ¿åå‡½æ•°â€æ‰€è¯´ï¼Œä»…ä»…æˆªè·å±€éƒ¨å˜é‡çš„å€¼è€Œå·²ï¼Œå¦‚æœåœ¨æˆªè·çš„Blocké‡Œé¢é‡å†™å±€éƒ¨å˜é‡ä¹Ÿä¸ä¼šæ”¹å˜åŸå…ˆæ‰€æˆªè·çš„å±€éƒ¨å˜é‡</p>
<p>block å¼•ç”¨å¤–éƒ¨å¯¹è±¡æ—¶å€™ï¼Œä¸æ˜¯ç®€å•çš„æŒ‡é’ˆå¼•ç”¨ï¼ˆæµ…å¤åˆ¶ï¼‰ï¼Œè€Œæ˜¯ä¸€ç§é‡å»ºï¼ˆæ·±å¤åˆ¶ï¼‰æ–¹å¼ï¼ˆæ‹¬å·å†…å¤–åˆ†åˆ«å¯¹äºåŸºæœ¬æ•°æ®ç±»å‹å’Œå¯¹è±¡åˆ†åˆ«æè¿°ï¼‰</p>
<p>æ‰€ä»¥å¦‚æœåœ¨ block ä¸­å¯¹å¤–éƒ¨å¯¹è±¡è¿›è¡Œä¿®æ”¹ï¼Œæ— è®ºæ˜¯å€¼ä¿®æ”¹è¿˜æ˜¯æŒ‡é’ˆä¿®æ”¹ï¼Œè‡ªç„¶æ˜¯æ²¡æœ‰ä»»ä½•æ•ˆæœ</p>
<p>ä¾‹å¦‚ï¼š<br><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">int</span> a = <span class="number">0</span>ï¼›</span><br><span class="line"><span class="keyword">void</span> (^block)(<span class="keyword">void</span>) = ^&#123;a = <span class="number">1</span>&#125;;</span><br></pre></td></tr></table></figure></p>
<p>è¿™æ ·å†™ç›´æ¥å°±ç¼–è¯‘å‡ºé”™äº†ï¼ï¼ï¼</p>
<p>å¯ä»¥ç›´æ¥çœ‹__block_main_block_impl_0çš„å®ç°ä¸Šï¼Œå¹¶ä¸èƒ½æ”¹å†™å…¶æ•è·å˜é‡çš„å€¼ï¼Œå› æ­¤ç›´æ¥æŠ¥é”™äº†</p>
<p>ç»¼ä¸Šæ‰€è¿°ï¼Œæ‰€è°“çš„â€œæˆªè·è‡ªåŠ¨å˜é‡â€ï¼Œæ— éå°±æ˜¯åœ¨æ‰§è¡ŒBlockè¯­æ³•çš„æ—¶å€™ï¼ŒBlockè¯­æ³•æ‰€ç”¨åˆ°çš„å±€éƒ¨å˜é‡å€¼è¢«ä¿å­˜åˆ°Blockçš„ç»“æ„ä½“å®ä¾‹å½“ä¸­ï¼ˆå³æ‰€è°“çš„Blockæœ¬ä½“ï¼‰</p>
<h3 id="è¦åœ¨-Block-ä¸­æ”¹å˜é‡Œé¢çš„å€¼"><a href="#è¦åœ¨-Block-ä¸­æ”¹å˜é‡Œé¢çš„å€¼" class="headerlink" title="è¦åœ¨ Block ä¸­æ”¹å˜é‡Œé¢çš„å€¼"></a>è¦åœ¨ Block ä¸­æ”¹å˜é‡Œé¢çš„å€¼</h3><h4 id="ç¬¬ä¸€ç§æ–¹æ³•ï¼šè¿ç”¨Cè¯­è¨€ä¸­çš„å˜é‡"><a href="#ç¬¬ä¸€ç§æ–¹æ³•ï¼šè¿ç”¨Cè¯­è¨€ä¸­çš„å˜é‡" class="headerlink" title="ç¬¬ä¸€ç§æ–¹æ³•ï¼šè¿ç”¨Cè¯­è¨€ä¸­çš„å˜é‡"></a>ç¬¬ä¸€ç§æ–¹æ³•ï¼šè¿ç”¨Cè¯­è¨€ä¸­çš„å˜é‡</h4><ul>
<li>é™æ€å˜é‡</li>
<li>é™æ€å…¨å±€å˜é‡</li>
<li>å…¨å±€å˜é‡</li>
</ul>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">int</span> global_val = <span class="number">1</span>; <span class="comment">// å…¨å±€å˜é‡  </span></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">int</span> static_global_val = <span class="number">2</span>; <span class="comment">// é™æ€å…¨å±€  </span></span><br><span class="line"><span class="keyword">int</span> main()&#123;  </span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">int</span> static_val = <span class="number">3</span>; <span class="comment">// é™æ€å±€éƒ¨  </span></span><br><span class="line">    <span class="keyword">void</span> (^block)(<span class="keyword">void</span>) = ^&#123;  </span><br><span class="line">        global_val *= <span class="number">1</span>;  </span><br><span class="line">        static_global_val *= <span class="number">2</span>;  </span><br><span class="line">        static_val *= <span class="number">3</span>;  </span><br><span class="line">    &#125;;  </span><br><span class="line">    block(); </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>è¿™é‡Œå…¨å±€å’Œé™æ€å…¨å±€é—®é¢˜ä¸å¤§ï¼Œå‡ºäº†ä½œç”¨äºç…§æ ·èƒ½è®¿é—®ï¼Œä½†æ˜¯é™æ€å±€éƒ¨çš„è¯å¦‚æœå»æ‰StaticæŒ‰ä¸Šé¢é‚£ç§å†™æ³•ï¼Œå°±ç›´æ¥æŠ¥é”™äº†ï¼ŒåŸå› å°±æ˜¯å®ç°ä¸Šä¸èƒ½æ”¹å˜æ•è·çš„å±€éƒ¨å˜é‡çš„å€¼ã€‚</p>
<p>æ²¡é”™ï¼Œåº”è¯¥èƒ½æƒ³åˆ°äº†ï¼Œèƒ½æ”¹å˜çš„æƒ…å†µå°±æ˜¯ç›´æ¥è®©Blockæˆªè·å±€éƒ¨å˜é‡çš„æŒ‡é’ˆï¼Œçœ‹Clangçš„æºç <br><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">int</span> global_val = <span class="number">1</span>;  </span><br><span class="line"><span class="keyword">static</span> <span class="keyword">int</span> static_global_val = <span class="number">2</span>;  </span><br><span class="line"><span class="class"><span class="keyword">struct</span> __<span class="title">main_block_impl_0</span> &#123;</span>  </span><br><span class="line">    <span class="class"><span class="keyword">struct</span> __<span class="title">block_impl</span> <span class="title">impl</span>;</span>  </span><br><span class="line">    <span class="class"><span class="keyword">struct</span> __<span class="title">main_block_desc_0</span>* <span class="title">Desc</span>;</span>  </span><br><span class="line">    intint *static_val;  </span><br><span class="line">    __main_block_impl_0(<span class="keyword">void</span> *fp, struct __main_block_desc_0 *desc, intint *_static_val, <span class="keyword">int</span> flags=<span class="number">0</span>) : static_val(_static_val) &#123;  </span><br><span class="line">        impl.isa = &amp;_NSConcreteStackBlock;  </span><br><span class="line">        impl.Flags = flags;  </span><br><span class="line">        impl.FuncPtr = fp;  </span><br><span class="line">        Desc = desc;  </span><br><span class="line">    &#125;  </span><br><span class="line">&#125;;  </span><br><span class="line"><span class="keyword">static</span> <span class="keyword">void</span> __main_block_func_0(struct __main_block_impl_0 *__cself) &#123;  </span><br><span class="line">    intint *static_val = __cself-&gt;static_val; <span class="comment">// bound by copy  </span></span><br><span class="line">    global_val *= <span class="number">1</span>;  </span><br><span class="line">    static_global_val *= <span class="number">2</span>;  </span><br><span class="line">    (*static_val) *= <span class="number">3</span>;  </span><br><span class="line">&#125;  </span><br><span class="line"><span class="keyword">static</span> <span class="class"><span class="keyword">struct</span> __<span class="title">main_block_desc_0</span> &#123;</span>  </span><br><span class="line">    <span class="keyword">size_t</span> reserved;  </span><br><span class="line">    <span class="keyword">size_t</span> Block_size;  </span><br><span class="line">&#125; __main_block_desc_0_DATA = &#123; <span class="number">0</span>, <span class="keyword">sizeof</span>(struct __main_block_impl_0)&#125;;  </span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span>&#123;  </span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">int</span> static_val = <span class="number">3</span>;  </span><br><span class="line">    <span class="keyword">void</span> (*block)(<span class="keyword">void</span>) = ((<span class="keyword">void</span> (*)())&amp;__main_block_impl_0((<span class="keyword">void</span> *)__main_block_func_0, &amp;__main_block_desc_0_DATA, &amp;static_val));  </span><br><span class="line">    ((<span class="keyword">void</span> (*)(__block_impl *))((__block_impl *)block)-&gt;FuncPtr)((__block_impl *)block);  </span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"%d\n"</span>,global_val);  </span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"%d\n"</span>,static_global_val);  </span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"%d\n"</span>,static_val);  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>å¾ˆç®€å•å°±èƒ½çœ‹å‡ºåŒºåˆ«äº†</p>
<ul>
<li>åœ¨__main_block_impl_0è¿™ä¸ªç»“æ„ä½“ä¸­çš„è¿½åŠ çš„æˆå‘˜å˜é‡å˜æˆäº†int *_static_valæŒ‡é’ˆäº†</li>
<li>åœ¨ç»“æ„ä½“å®ä¾‹åŒ–å‡½æ•°ä¸­__main_block_impl_0å‚æ•°ä¹Ÿå˜ä¸ºäº†&amp;static_valåœ°å€äº†</li>
</ul>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">void</span> __main_block_func_0(struct __main_block_impl_0 *__cself) &#123;  </span><br><span class="line">    intint *static_val = __cself-&gt;static_val; <span class="comment">// bound by copy  </span></span><br><span class="line">    global_val *= <span class="number">1</span>;  </span><br><span class="line">    static_global_val *= <span class="number">2</span>;  </span><br><span class="line">    (*static_val) *= <span class="number">3</span>;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>æ ¹æ®Blockè¯­æ³•è½¬æ¢è€Œæ¥çš„Cé™æ€å‡½æ•°ï¼Œä½¿ç”¨static_valçš„æŒ‡é’ˆè¿›è¡Œè®¿é—®ï¼Œä¸Šé¢å‚æ•°å¯ä»¥çœ‹å‡ºï¼Œåˆå§‹åŒ–çš„æ—¶å€™å°†é™æ€å˜é‡çš„static_valæŒ‡é’ˆä¼ é€’ç»™__main_block_impl_0ç»“æ„ä½“è¿›è¡Œè¿½åŠ æˆå‘˜å˜é‡åˆå§‹åŒ–å¹¶ä¿å­˜ï¼Œè¿™æ ·åšä¹Ÿæ˜¯å¯¹è¶…å‡ºä½œç”¨äºä½¿ç”¨å˜é‡çš„æœ€ç®€å•çš„æ–¹æ³•</p>
<h4 id="ç¬¬äºŒç§æ–¹æ³•ï¼šå°±æ˜¯å¤§å®¶æ‰€ç†ŸçŸ¥çš„-blockä¿®é¥°ç¬¦çš„ä½¿ç”¨"><a href="#ç¬¬äºŒç§æ–¹æ³•ï¼šå°±æ˜¯å¤§å®¶æ‰€ç†ŸçŸ¥çš„-blockä¿®é¥°ç¬¦çš„ä½¿ç”¨" class="headerlink" title="ç¬¬äºŒç§æ–¹æ³•ï¼šå°±æ˜¯å¤§å®¶æ‰€ç†ŸçŸ¥çš„__blockä¿®é¥°ç¬¦çš„ä½¿ç”¨"></a>ç¬¬äºŒç§æ–¹æ³•ï¼šå°±æ˜¯å¤§å®¶æ‰€ç†ŸçŸ¥çš„__blockä¿®é¥°ç¬¦çš„ä½¿ç”¨</h4><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">__block <span class="keyword">int</span> a = <span class="number">0</span>;</span><br><span class="line"><span class="keyword">void</span> (^block)(<span class="keyword">void</span>) = ^&#123;a = <span class="number">1</span>&#125;;</span><br></pre></td></tr></table></figure>
<p>Clang è½¬åŒ–åä»£ç <br><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> __<span class="title">Block_byref_a_0</span> &#123;</span>  </span><br><span class="line">    <span class="keyword">void</span> *__isa;  </span><br><span class="line">    __Block_byref_a_0 *__forwarding;  </span><br><span class="line">    <span class="keyword">int</span> __flags;  </span><br><span class="line">    <span class="keyword">int</span> __size;  </span><br><span class="line">    <span class="keyword">int</span> a;  </span><br><span class="line">&#125;;  </span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> __<span class="title">main_block_impl_0</span> &#123;</span>  </span><br><span class="line">    <span class="class"><span class="keyword">struct</span> __<span class="title">block_impl</span> <span class="title">impl</span>;</span>  </span><br><span class="line">    <span class="class"><span class="keyword">struct</span> __<span class="title">main_block_desc_0</span>* <span class="title">Desc</span>;</span>  </span><br><span class="line">    __Block_byref_a_0 *a; <span class="comment">// by ref  </span></span><br><span class="line">    __main_block_impl_0(<span class="keyword">void</span> *fp, struct __main_block_desc_0 *desc, __Block_byref_a_0 *_a, <span class="keyword">int</span> flags=<span class="number">0</span>) : a(_a-&gt;__forwarding) &#123;  </span><br><span class="line">        impl.isa = &amp;_NSConcreteStackBlock;  </span><br><span class="line">        impl.Flags = flags;  </span><br><span class="line">        impl.FuncPtr = fp;  </span><br><span class="line">        Desc = desc;  </span><br><span class="line">    &#125;  </span><br><span class="line">&#125;;  </span><br><span class="line"><span class="keyword">static</span> <span class="keyword">void</span> __main_block_func_0(struct __main_block_impl_0 *__cself) &#123;  </span><br><span class="line">    __Block_byref_a_0 *a = __cself-&gt;a; <span class="comment">// bound by ref  </span></span><br><span class="line">    (a-&gt;__forwarding-&gt;a) = <span class="number">1</span>;</span><br><span class="line">&#125;  </span><br><span class="line"><span class="keyword">static</span> <span class="keyword">void</span> __main_block_copy_0(struct __main_block_impl_0*dst, struct __main_block_impl_0*src) &#123;</span><br><span class="line">    _Block_object_assign((<span class="keyword">void</span>*)&amp;dst-&gt;a, (<span class="keyword">void</span>*)src-&gt;a, <span class="number">8</span><span class="comment">/*BLOCK_FIELD_IS_BYREF*/</span>);</span><br><span class="line">&#125;  </span><br><span class="line"><span class="keyword">static</span> <span class="keyword">void</span> __main_block_dispose_0(struct __main_block_impl_0*src) &#123;</span><br><span class="line">    _Block_object_dispose((<span class="keyword">void</span>*)src-&gt;a, <span class="number">8</span><span class="comment">/*BLOCK_FIELD_IS_BYREF*/</span>);</span><br><span class="line">&#125;  </span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> <span class="class"><span class="keyword">struct</span> __<span class="title">main_block_desc_0</span> &#123;</span>  </span><br><span class="line">    <span class="keyword">size_t</span> reserved;  </span><br><span class="line">    <span class="keyword">size_t</span> Block_size;  </span><br><span class="line">    <span class="keyword">void</span> (*copy)(struct __main_block_impl_0*, struct __main_block_impl_0*);  </span><br><span class="line">    <span class="keyword">void</span> (*dispose)(struct __main_block_impl_0*);  </span><br><span class="line">&#125; __main_block_desc_0_DATA = &#123; <span class="number">0</span>, <span class="keyword">sizeof</span>(struct __main_block_impl_0), __main_block_copy_0, __main_block_dispose_0&#125;;  </span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span>&#123;  </span><br><span class="line">    __attribute__((__blocks__(byref))) __Block_byref_a_0 a = &#123;(<span class="keyword">void</span>*)<span class="number">0</span>,(__Block_byref_a_0 *)&amp;a, <span class="number">0</span>, <span class="keyword">sizeof</span>(__Block_byref_a_0), <span class="number">0</span>&#125;;  </span><br><span class="line">    <span class="keyword">void</span>(*blk)(<span class="keyword">void</span>) = ((<span class="keyword">void</span> (*)())&amp;__main_block_impl_0((<span class="keyword">void</span> *)__main_block_func_0, &amp;__main_block_desc_0_DATA, (__Block_byref_a_0 *)&amp;a, <span class="number">570425344</span>));  </span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>; </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>ä»£ç å¤šäº†ä¸å°‘ï¼Œåˆ†è§£ä¸€ä¸‹<br><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">__block <span class="keyword">int</span> a = <span class="number">0</span>ï¼›</span><br></pre></td></tr></table></figure></p>
<p>Clang çš„ä»£ç å¦‚ä¸‹<br><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">__Block_byref_a_0 a = &#123;(<span class="keyword">void</span>*)<span class="number">0</span>,(__Block_byref_a_0 *)&amp;a,<span class="number">0</span>,<span class="keyword">sizeof</span>(__Block_byref_a_0),<span class="number">0</span>&#125;;</span><br></pre></td></tr></table></figure></p>
<p>è¿™è´§ç«Ÿç„¶åŠ äº†_blockå˜æˆäº†ç»“æ„ä½“å®ä¾‹ï¼Œåœ¨æ ˆä¸Šç”Ÿæˆäº†__block_byref_a_0çš„ç»“æ„ä½“å®ä¾‹ï¼Œaå˜é‡åˆå§‹åŒ–ä¸º0ï¼Œè¿™ä¸ªå€¼ä¹Ÿå‡ºç°åœ¨äº†è¿™ä¸ªç»“æ„ä½“æˆå‘˜å˜é‡å˜é‡ä¸­ï¼Œæ„å‘³ç€è¯¥ç»“æ„ä½“æŒæœ‰ç›¸å½“äºåŸå±€éƒ¨å˜é‡çš„æˆå‘˜å˜é‡</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> __<span class="title">Block_byref_a_0</span> &#123;</span>  </span><br><span class="line"> </span><br><span class="line"> *__isa;  </span><br><span class="line">    __Block_byref_a_0 *__forwarding;  </span><br><span class="line">    <span class="keyword">int</span> __flags;  </span><br><span class="line">    <span class="keyword">int</span> __size;  </span><br><span class="line">    <span class="keyword">int</span> a;  </span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>è¿™ä¸ªåˆå§‹åŒ–çš„åŸç»“æ„ï¼Œé‡Œé¢çš„æœ€åä¸€ä¸ªint aå°±æ˜¯åŸå±€éƒ¨å˜é‡çš„æˆå‘˜å˜é‡</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span> (^block)(<span class="keyword">void</span>) = ^&#123;a = <span class="number">1</span>&#125;;</span><br></pre></td></tr></table></figure>
<p>åˆ†è§£å¦‚ä¸‹</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span>(*blk)(<span class="keyword">void</span>) = ((<span class="keyword">void</span> (*)())&amp;__main_block_impl_0((<span class="keyword">void</span> *)__main_block_func_0, &amp;__main_block_desc_0_DATA, (__Block_byref_a_0 *)&amp;a, <span class="number">570425344</span>));</span><br></pre></td></tr></table></figure>
<p>è¿˜æ˜¯è°ƒç”¨<strong>main_block_impl_0çš„åˆå§‹åŒ–ç»“æ„ä½“ï¼Œç”±äºint aåŠ äº†</strong>blockä¿®é¥°ç¬¦ï¼Œé‚£ä¹ˆè¿™ä¸ªåˆå§‹åŒ–å‡½æ•°ä¼ é€’çš„ä¸å†æ˜¯&amp;açš„åœ°å€ï¼Œè€Œæ˜¯æ¢æˆ__Block_byref_a_0è¿™ä¸ªç»“æ„ä½“å®ä¾‹çš„æŒ‡é’ˆè¿›è¡Œä¼ é€’ï¼ˆè¯¥ç»“æ„ä½“å…¶å®ä¹Ÿæ˜¯ä¸ªå¯¹è±¡ï¼Œæœ€åçš„å±æ€§æ”¾ç€éœ€è¦æˆªè·çš„å±€éƒ¨å˜é‡ï¼‰</p>
<p>è¿™é‡Œçš„__main_block_func_0å¯¹åº”çš„blockå—å‡½æ•°è½¬æ¢ä¸ºC</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">void</span> __main_block_func_0(struct __main_block_impl_0 *__cself) &#123;  </span><br><span class="line">    __Block_byref_a_0 *a = __cself-&gt;a; <span class="comment">// bound by ref  </span></span><br><span class="line">    (a-&gt;__forwarding-&gt;a) = <span class="number">1</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>çœ‹äº†ä¸¤ä¸ªæ–¹æ¡ˆï¼Œç¬¬ä¸€ä¸ªç”¨Cè¯­è¨€çš„é™æ€å˜é‡æ¥è§£å†³ï¼Œé‚£ä¹ˆç›´æ¥æ“ä½œé™æ€å˜é‡çš„æŒ‡é’ˆå°±å®Œäº‹äº†ï¼Œä½†æ˜¯<strong>blockè¦æ¯”è¿™ä¸ªçœŸçš„å¤æ‚å¤šäº†ã€‚Blockçš„ç»“æ„ä½“å®ä¾‹æŒæœ‰æŒ‡å‘</strong>blockå˜é‡çš„ __Block_byref_a_0ç»“æ„ä½“å®ä¾‹çš„æŒ‡é’ˆã€‚</p>
<p><strong>Block_byref_a_0è¿™ä¸ªç»“æ„ä½“å®ä¾‹çš„æˆå‘˜å˜é‡</strong>forwardingæŒæœ‰æŒ‡å‘è¯¥ç»“æ„ä½“å®ä¾‹è‡ªèº«çš„æŒ‡é’ˆã€‚é€šè¿‡__forwardingè®¿é—®æˆå‘˜å˜é‡aã€‚</p>
<p>å¦å¤–æä¸€ç‚¹ï¼Œ<strong>blockå†…éƒ¨çš„</strong>Block_byhef_val_0è¿™ä¸ªä¹Ÿæ˜¯ç‹¬ç«‹çš„ç»“æ„ä½“å®ä¾‹ï¼Œä¸å±äº<strong>main_blocl_impl_0ç»“æ„ä½“ä¸­ï¼Œè¿™æ ·æ–¹ä¾¿äº†åœ¨å¤šä¸ªblockä¸­éƒ½èƒ½è®¿é—®</strong>blockå˜é‡ã€‚</p>
<p>å°ç»“ä¸€ä¸‹ï¼Œä¸ç„¶å¤ªä¹±ï¼š</p>
<p>1.æ™®é€šçš„å±€éƒ¨å˜é‡è¢«Blockæˆªè·åªæ˜¯å•çº¯çš„æˆªè·å…¶å€¼ï¼Œå¹¶è¿½åŠ åˆ°__main_block_impl_0ç»“æ„ä½“ä¸­ï¼ˆæ— æ³•ä¿®æ”¹é‡å†™ï¼‰</p>
<p>2.è¦å…è®¸Blockä¿®æ”¹å€¼æœ‰ä¸¤ä¸ªæ–¹æ³•ï¼Œç¬¬ä¸€ä¸ªå°±æ˜¯ç”¨Cè¯­è¨€çš„å˜é‡ï¼Œä»£è¡¨å°±æ˜¯é™æ€å±€éƒ¨å˜é‡ï¼Œç¬¬äºŒä¸ªå°±æ˜¯__blockä¿®é¥°ç¬¦</p>
<p>3.<strong>blockä¿®é¥°çš„å˜é‡ï¼Œå…¶å®è¿™å°±æ˜¯å˜æˆäº†ä¸ªå¯¹è±¡ç»“æ„ä½“</strong>Block_byref_val_0,åˆå§‹åŒ–<strong>main_block_impl_0çš„æ—¶å€™è¿½åŠ çš„æ˜¯</strong>blockç”Ÿæˆçš„ç»“æ„ä½“æŒ‡é’ˆ,ä¾‹å¦‚__block int a = 0;è¿™ä¸ªintä¸åœ¨æ˜¯æ™®é€šçš„æ•°æ®ç±»å‹ï¼Œè€Œæ˜¯åœ¨æ ‡è¯†ç¬¦çš„å¼•ç”¨ä¸‹å˜æˆäº†å¯¹è±¡</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> __<span class="title">Block_byref_a_0</span> &#123;</span>  </span><br><span class="line">    <span class="keyword">void</span> *__isa;  </span><br><span class="line">    __Block_byref_a_0 *__forwarding;  </span><br><span class="line">    <span class="keyword">int</span> __flags;  </span><br><span class="line">    <span class="keyword">int</span> __size;  </span><br><span class="line">    <span class="keyword">int</span> a;  </span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>è€Œintçš„å€¼å°±å­˜å‚¨åœ¨è¿™ä¸ªå¯¹è±¡çš„ä¸€ä¸ªå­—æ®µ aä¸­ï¼Œè€ŒBlockæˆªè·çš„å°±æ˜¯è¿™ä¸ªç»“æ„ä½“å¯¹è±¡çš„æŒ‡é’ˆï¼Œå¯ä»¥éšæ„ä¿®æ”¹ç»“æ„ä½“å†…éƒ¨açš„å€¼</p>
<p>4.æœ€ç»ˆåœ¨<strong>main_block_func_0å‡½æ•°ä¸­è°ƒç”¨</strong>blockç»“æ„ä½“æŒ‡é’ˆçš„forwardingæŒ‡é’ˆï¼ˆè¿™ä¸€èŠ‚æŒ‡å‘è‡ªå·±ï¼Œåé¢ä¼šå˜ï¼‰çš„æˆå‘˜å˜é‡aæ¥è¿›è¡Œé‡æ–°èµ‹å€¼</p>
<p>5.å…¶å®__blockè¿™æ–¹æ³•ç”Ÿæˆçš„æºç ï¼Œèƒ½å¤§è‡´çœ‹å‡ºæ¥è¿™å…¶å®ç±»ä¼¼OCé‡Œé¢å¯¹è±¡çš„retainå’Œreleaseä¸€ç³»åˆ—æ“ä½œ</p>
<h3 id="ä¸‰ç§-Block-æœ¬ä½“"><a href="#ä¸‰ç§-Block-æœ¬ä½“" class="headerlink" title="ä¸‰ç§ Block æœ¬ä½“"></a>ä¸‰ç§ Block æœ¬ä½“</h3><p>åˆ°è¿™ä¸ªé˜¶æ®µï¼Œæˆ‘ä»¬ç”¨Cçš„ç»“æ„ç¼–è¯‘çš„ä»£ç ä»¥åŠæºç èƒ½çœ‹åˆ°Blockç»“æ„ä½“å†…éƒ¨çš„isaæŒ‡é’ˆæ˜¯æŒ‡å‘_NSConcreteStackBlockçš„ï¼Œå…¶å®è¿™åªæ˜¯å…¶ä¸­çš„ä¸€ç§ï¼Œåˆ†åˆ«è¿˜æœ‰_NSContreteGlobalBlock å’Œ _NSContreteMallocBlock,å¯ä»¥æ ¹æ®å‘½åçš„åç¼€çœ‹å‡ºæ¥StackBlockæ˜¯è®¾ç½®åœ¨æ ˆä¸Šçš„ï¼ŒGlobalBlockå°±ç±»ä¼¼å…¨å±€å˜é‡ï¼Œè®¾ç½®åœ¨ç¨‹åºçš„æ•°æ®åŒºåŸŸï¼ˆ.dataåŒºåŸŸï¼‰ï¼Œé‚£ä¹ˆæœ€é‡è¦çš„ä¹Ÿæ˜¯æˆ‘ä»¬å†™OCä»£ç çš„æ—¶å€™æ ¹æœ¬ä¸å…³æ³¨çš„ä¸€ç§ç±»å‹NSContreteMallocBlockï¼Œæ²¡é”™ï¼Œä»–å°±æ˜¯å’Œå¯¹è±¡ä¸€æ ·åˆ†ç±»å†…å­˜å—(å †)ä¸­ã€‚</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="built_in">NSConcreteGlobalBlock</span>; <span class="comment">// åœ¨å…¨å±€ä¸­å®šä¹‰çš„ï¼ˆæ•°æ®åŒºåŸŸï¼‰</span></span><br><span class="line">    <span class="built_in">NSConcreteStackBlock</span>; <span class="comment">// åœ¨å±€éƒ¨å®šä¹‰çš„ï¼ˆæ ˆï¼‰</span></span><br><span class="line">    <span class="built_in">NSConcreteMallocBlock</span>; <span class="comment">// åˆ†é…åœ¨å †ä¸­</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="NSConcreteGlobalBlock-å…¨å±€å®šä¹‰"><a href="#NSConcreteGlobalBlock-å…¨å±€å®šä¹‰" class="headerlink" title="NSConcreteGlobalBlock å…¨å±€å®šä¹‰"></a>NSConcreteGlobalBlock å…¨å±€å®šä¹‰</h4><p>ä¸Šé¢æˆ‘ä»¬è¯´çš„éƒ½æ˜¯ NSConcreteStackBlock åœ¨å±€éƒ¨å®šä¹‰çš„ï¼ˆæ ˆï¼‰ï¼Œä¸‹é¢æˆ‘ä»¬æ¥çœ‹çœ‹ NSConcreteGlobalBlock</p>
<p>ä½ å¯ä»¥æŠŠå®ƒç†è§£ä¸ºå…¨å±€å˜é‡ï¼Œåæ­£å­˜å‚¨åœ¨.dataåŒºåŸŸçš„ï¼Œæœ€ç›´æ¥å¾—å†™æ³•æ˜¯è¿™æ ·çš„</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span> (^block)(<span class="keyword">void</span>) = ^&#123;&#125;;  </span><br><span class="line"><span class="keyword">int</span> main()&#123;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Clang è½¬æ¢è¿‡åçš„æºç æŒ‡é’ˆimpl.isa = &amp;_NSContreteGlobalBlockç±»å‹çš„</p>
<p>ç”±äºåœ¨ä½¿ç”¨å…¨å±€å˜é‡çš„åœ°æ–¹ä¸èƒ½ä½¿ç”¨å±€éƒ¨å˜é‡ï¼Œè¿™ä¹ˆè¯´æ¥å°±æ ¹æœ¬ä¸å­˜åœ¨å¯¹å±€éƒ¨å˜é‡çš„æ•è·ã€‚é‚£ä¹ˆè¿™ä¸ªBlockçš„ç»“æ„ä½“å®ä¾‹çš„å†…å®¹å‹æ ¹ä¸ä¼šå†è¿›è¡Œè¿½åŠ æˆå‘˜å˜é‡ï¼Œæ‰€ä»¥ä¸ä¼šä¾èµ–äºæ‰§è¡ŒçŠ¶æ€ï¼Œæ‰€ä»¥æ•´ä¸ªç¨‹åºè¿è¡Œåªæœ‰ä¸€ä¸ªå®ä¾‹ã€‚å› æ­¤å°†Blockä½¿ç”¨çš„ç»“æ„ä½“å®ä¾‹è®¾ç½®åœ¨ä¸å…¨å±€å˜é‡ç›¸åŒçš„æ•°æ®åŒºåŸŸå³å¯ã€‚ï¼ˆæŠŠå®ƒç†è§£ä¸ºå•çº¯çš„å…¨å±€å˜é‡å°±å¥½äº†ï¼Œè€Œä¸”ä¸ä¼šæœ‰ä»»ä½•å€¼çš„æ•è·ï¼‰</p>
<p>å­˜åœ¨çš„ä¸¤ç§æ¡ˆä¾‹</p>
<ul>
<li>å…¨å±€å˜é‡çš„åœ°æ–¹ï¼Œç”¨è¿™ç§Blockè¯­æ³•æ—¶ï¼Œå¦‚ä¸Šé¢æ‰€ç¤º</li>
<li>Blockè¯­æ³•ä¸­è¡¨è¾¾å¼ä¸æˆªè·ä»»ä½•å±€éƒ¨å˜é‡æ—¶ï¼Œè¿™ä¸ªç¨åDemoä»‹ç»ï¼Œä¹Ÿå¾ˆç®€å•</li>
</ul>
<h4 id="NSContreteMallocBlock-å †å®šä¹‰"><a href="#NSContreteMallocBlock-å †å®šä¹‰" class="headerlink" title="NSContreteMallocBlock å †å®šä¹‰"></a>NSContreteMallocBlock å †å®šä¹‰</h4><p>é…ç½®åœ¨å…¨å±€çš„GlobalBlockå¯ä»¥å‡ºäº†ä½œç”¨åŸŸè¿˜æ˜¯èƒ½ç»§ç»­è®¿é—®ï¼Œä½†æ˜¯åœ¨æ ˆä¸Šçš„StackBlockå°±åºŸå¼ƒäº†ï¼Œå› æ­¤ä¸ºäº†å‡ºäº†ä½œç”¨åŸŸèƒ½ç»§ç»­ä½¿ç”¨ï¼ŒBlocksæä¾›äº†æŠŠBlockå’Œ<strong>blockè¿™ä¸¤ä¸ªä¸œè¥¿ä»æ ˆä¸Šå¤åˆ¶åˆ°å †ä¸Šçš„æ–¹æ³•æ¥è§£å†³è¿™ä¸ªé—®é¢˜ã€‚è€Œ_forwardingå…¶å®æ—¢å¯ä»¥æŒ‡å‘è‡ªå·±ï¼Œä¹Ÿå¯ä»¥æŒ‡å‘å¤åˆ¶åçš„è‡ªå·±ï¼Œä¹Ÿå°±æ˜¯è¯´æœ‰äº†è¿™ä¸ªæŒ‡é’ˆçš„å­˜åœ¨ï¼Œæ— è®º</strong>blockå˜é‡é…ç½®åœ¨å †ä¸Šè¿˜æ˜¯æ ˆä¸Šéƒ½èƒ½å¤Ÿæ­£ç¡®çš„è®¿é—®__blockå˜é‡</p>
<p>ä¸€ç§ä½œä¸ºè¿”å›å€¼è¿”å›çš„æƒ…å†µ<br><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="keyword">void</span>(^block)(<span class="keyword">void</span>);  </span><br><span class="line">block func (<span class="keyword">int</span> a) &#123;  </span><br><span class="line">    <span class="keyword">return</span> ^&#123;&#125;;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>è½¬æ¢å<br><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">block <span class="title">func</span> <span class="params">(<span class="keyword">int</span> a)</span> </span>&#123;  </span><br><span class="line">    block tmp = ((<span class="keyword">void</span> (*)())&amp;__func_block_impl_0((<span class="keyword">void</span> *)__func_block_func_0, &amp;__func_block_desc_0_DATA));  </span><br><span class="line">    tmp = objc_retainBlock(tmp);  </span><br><span class="line">    <span class="keyword">return</span> objc_autoreleaseReturnValue(tmp);  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>è¿™é‡Œå…ˆæ˜¯é€šè¿‡Blockè¯­æ³•ç”ŸæˆBlockï¼Œå³ç”Ÿæˆé…ç½®åœ¨æ ˆä¸Šçš„Blockç»“æ„ä½“å®ä¾‹ï¼Œç„¶åèµ‹å€¼ç»™Blockç±»å‹çš„å˜é‡tmpä¸­ï¼Œç„¶åæ‰§è¡Œobjc_retainBlock(tmp)è¿™å¥å…¶å®å°±æ˜¯_Block_copy(tmp)ï¼Œå°†æ ˆä¸Šçš„çš„Blockå¤åˆ¶åˆ°å †ä¸Šï¼Œèµ‹å€¼åå°†å †ä¸Šçš„æŒ‡é’ˆèµ‹å€¼ç»™tmpï¼Œç„¶åå †ä¸Šçš„æ‰€æœ‰éƒ½æ˜¯å¯¹è±¡ï¼Œéœ€è¦æ³¨å†Œé™¶autoreleasepoolä¸­è¿›è¡Œç®¡ç†ï¼Œç„¶åè¿”å›å…¶å¯¹è±¡</p>
<p>å…¶å®è¿™ç§å†…éƒ¨è°ƒç”¨æ–¹å¼ï¼ŒMallocBlockå°±æ˜¯å¯¹è±¡ï¼Œè€Œä¸”è¿™ç§å†™æ³•æ˜¯å¦å¾ˆä¼¼æ›¾ç›¸è¯†ï¼Œå°±æ˜¯ç±»æ–¹æ³•å®ä¾‹åŒ–</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">- (<span class="built_in">NSArray</span> *) myTestArray &#123;  </span><br><span class="line">    <span class="built_in">NSArray</span> *array = [[<span class="built_in">NSArray</span> alloc] initWithObjects: <span class="string">@"a"</span>, <span class="string">@"b"</span>, <span class="string">@"c"</span>, <span class="literal">nil</span> <span class="literal">nil</span>];  </span><br><span class="line">    <span class="keyword">return</span> [array autorelease];  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ç®€å•æ¥è¯´å°±æ˜¯ç¬¬ä¸€æ­¥copyBlockåˆ°å †ä¸Šï¼Œç„¶åå’ŒOCå¯¹è±¡ä¸€æ ·ï¼Œè¿”å›çš„å¯¹è±¡éœ€è¦è¿›è¡Œautoreleaseé˜²æ²»å†…å­˜æ³„éœ²</p>
<p>ARCä¸‹é¢å¾ˆå¤šéƒ½å·²ç»è‡ªåŠ¨å¸®æˆ‘ä»¬Copyæˆäº†MallocBlockäº†ï¼Œè¯·çœ‹ä¸€ä¸‹å‡ ç§æƒ…å†µ</p>
<p>ç”±äºBlockæ˜¯é»˜è®¤å»ºç«‹åœ¨æ ˆä¸Š,æ‰€ä»¥å¦‚æœç¦»å¼€æ–¹æ³•ä½œç”¨åŸŸï¼ŒBlockå°±ä¼šè¢«ä¸¢å¼ƒï¼Œåœ¨éARCæƒ…å†µä¸‹ï¼Œæˆ‘ä»¬è¦è¿”å›ä¸€ä¸ªBlockï¼Œéœ€è¦ </p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[Block <span class="keyword">copy</span>];</span><br></pre></td></tr></table></figure>
<p>åœ¨ARCä¸‹,ä»¥ä¸‹å‡ ç§æƒ…å†µ, Blockä¼šè‡ªåŠ¨è¢«ä»æ ˆå¤åˆ¶åˆ°å †:</p>
<ul>
<li>1.è¢«æ‰§è¡Œcopyæ–¹æ³•</li>
<li>2.ä½œä¸ºæ–¹æ³•è¿”å›å€¼</li>
<li>3.å°†Blockèµ‹å€¼ç»™é™„æœ‰__strongä¿®é¥°ç¬¦çš„idç±»å‹çš„ç±»æˆ–è€…Blcokç±»å‹æˆå‘˜å˜é‡æ—¶</li>
<li>4.åœ¨æ–¹æ³•åä¸­å«æœ‰usingBlockçš„Cocoaæ¡†æ¶æ–¹æ³•æˆ–è€…GDCçš„APIä¸­ä¼ é€’çš„æ—¶å€™</li>
</ul>
<h3 id="æ¥çŒœä¸€çŒœ"><a href="#æ¥çŒœä¸€çŒœ" class="headerlink" title="æ¥çŒœä¸€çŒœ"></a>æ¥çŒœä¸€çŒœ</h3><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">int</span> a = <span class="number">1</span>;  </span><br><span class="line"></span><br><span class="line"><span class="comment">// è¿™é‡Œçš„^&#123;&#125;åˆå§‹åŒ–çš„blockèµ‹å€¼ç»™blockå˜é‡ï¼Œåœ¨OCä¸­æ²¡æœ‰å…·ä½“å†™æ˜çš„æƒ…å†µä¸‹åº”è¯¥å°±æ˜¯strongç±»å‹çš„ï¼Œè¿™å°±æ˜¯ä¸Šé¢ç¬¬ä¸‰ç‚¹çš„ä¾‹å­  </span></span><br><span class="line"><span class="comment">// æ‰“å°å‡ºæ¥ first &lt;__NSMallocBlock__: 0x60800004d290&gt;  </span></span><br><span class="line"><span class="keyword">void</span> (^block)(<span class="keyword">void</span>) = ^&#123;  </span><br><span class="line">   <span class="built_in">NSLog</span>(<span class="string">@"%d"</span>,a);  </span><br><span class="line">&#125;;  </span><br><span class="line"><span class="built_in">NSLog</span>(<span class="string">@"first %@"</span>,block);  </span><br><span class="line"></span><br><span class="line"><span class="comment">// æ²¡æœ‰æˆªè·å˜é‡çš„æ—¶å€™å°±æ˜¯globalBlock  </span></span><br><span class="line"><span class="comment">// second&lt;__NSGlobalBlock__: 0x102f80100&gt;  </span></span><br><span class="line"><span class="built_in">NSLog</span>(<span class="string">@"second%@"</span>,^&#123;<span class="built_in">NSLog</span>(<span class="string">@"å‘µå‘µ"</span>);&#125;);  </span><br><span class="line"></span><br><span class="line"><span class="comment">// æˆªè·äº†å˜é‡å°±æ˜¯stackBlock  </span></span><br><span class="line"><span class="comment">// third&lt;__NSStackBlock__: 0x7fff5cc7faa0&gt;  </span></span><br><span class="line"><span class="built_in">NSLog</span>(<span class="string">@"third%@"</span>,^&#123;<span class="built_in">NSLog</span>(<span class="string">@"%d"</span>,a);&#125;);  </span><br><span class="line"></span><br><span class="line">__block <span class="keyword">int</span> val = <span class="number">10</span>;  </span><br><span class="line">__<span class="keyword">strong</span> blk strongPointerBlock = ^&#123;<span class="built_in">NSLog</span>(<span class="string">@"val1 = %d"</span>, ++val);&#125;;  </span><br><span class="line"><span class="comment">// strongPointerBlock: &lt;__NSMallocBlock__: 0x600000044e90&gt;  </span></span><br><span class="line"><span class="built_in">NSLog</span>(<span class="string">@"strongPointerBlock: %@"</span>, strongPointerBlock); <span class="comment">//1  </span></span><br><span class="line"></span><br><span class="line">__<span class="keyword">weak</span> blk weakPointerBlock = ^&#123;<span class="built_in">NSLog</span>(<span class="string">@"val2 = %d"</span>, ++val);&#125;;  </span><br><span class="line"><span class="comment">// weakPointerBlock: &lt;__NSStackBlock__: 0x7fff5282ea70&gt;  </span></span><br><span class="line"><span class="built_in">NSLog</span>(<span class="string">@"weakPointerBlock: %@"</span>, weakPointerBlock); <span class="comment">//2  </span></span><br><span class="line"></span><br><span class="line"><span class="comment">// mallocBlock3: &lt;__NSMallocBlock__: 0x608000046930&gt;  </span></span><br><span class="line"><span class="built_in">NSLog</span>(<span class="string">@"mallocBlock3: %@"</span>, [weakPointerBlock <span class="keyword">copy</span>]); <span class="comment">//3  </span></span><br><span class="line"></span><br><span class="line"><span class="comment">// æˆªè·äº†test &lt;__NSStackBlock__: 0x7fff5282ea48&gt;  </span></span><br><span class="line"><span class="built_in">NSLog</span>(<span class="string">@"test4 %@"</span>, ^&#123;<span class="built_in">NSLog</span>(<span class="string">@"val4 = %d"</span>, ++val);&#125;); <span class="comment">//4  </span></span><br><span class="line"></span><br><span class="line"><span class="comment">// test5 &lt;__NSMallocBlock__: 0x60800005c0b0&gt;  </span></span><br><span class="line"><span class="built_in">NSLog</span>(<span class="string">@"test5 %@"</span>, [^&#123;<span class="built_in">NSLog</span>(<span class="string">@"val4 = %d"</span>, ++val);&#125; <span class="keyword">copy</span>]); <span class="comment">//5  </span></span><br><span class="line"></span><br><span class="line"><span class="comment">// stackBlockç»è¿‡ä¼ å‚ æ‰“å°  </span></span><br><span class="line"><span class="built_in">NSLog</span>(<span class="string">@"ä¼ å‚å %@"</span>,[<span class="keyword">self</span> getBlock]);  </span><br><span class="line">&#125;  </span><br><span class="line"></span><br><span class="line">- (blk)getBlock &#123;  </span><br><span class="line"><span class="keyword">int</span> val = <span class="number">11</span>;  </span><br><span class="line"><span class="comment">// ä¸Šé¢å·²ç»ä»‹ç»äº†ï¼Œè¿™ç§ç›´æ¥æ‰“å°ä¼ å‚å‰çš„blockï¼Œåº”è¯¥æ˜¯__NSStackBlock__  </span></span><br><span class="line"><span class="built_in">NSLog</span>(<span class="string">@"ä¼ å‚å‰ï¼š%@"</span>,^&#123;<span class="built_in">NSLog</span>(<span class="string">@"%d"</span>,val);&#125;);  </span><br><span class="line"></span><br><span class="line"><span class="comment">// é‚£ä¹ˆç°åœ¨æˆ‘ä»¬ç›´æ¥ä¼ å‡ºå»  </span></span><br><span class="line"><span class="keyword">return</span> ^&#123;<span class="built_in">NSLog</span>(<span class="string">@"%d"</span>,val);&#125;;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>è¿™é‡ŒæŠŠå‡ ç§æƒ…å†µéƒ½æ‰“å°äº†ä¸€ä¸‹çœ‹çœ‹åˆ°åº•æ˜¯å“ªä¸ªç±»å‹</p>
<p>1.ç¬¬ä¸€ä¸ªå’Œç¬¬äºŒä¸ªæ‰“å°çš„åŒºåˆ«åœ¨äºï¼Œç¬¬ä¸€ä¸ªç”Ÿæˆçš„Blocké»˜è®¤èµ‹å€¼ç»™äº†blockå˜é‡ï¼Œç¬¬äºŒä¸ªç›´æ¥æ‰“å°ï¼Œç”±äºOCé‡Œé¢æ²¡æœ‰ä¿®é¥°ç¬¦é»˜è®¤å°±æ˜¯strongï¼Œæ‰€ä»¥è¿™ä¹ˆçœ‹æ¥éµå¾ªç¬¬ä¸‰æ¡è§„åˆ™ä¹‹åï¼Œç¬¬äºŒæ¡æ¡æ‰“å°å°±æ˜¯<em>NSGlobalBlock</em>ï¼ˆæ²¡æœ‰æˆªè·å˜é‡ï¼‰ï¼Œç¬¬ä¸€æ¡æ‰“å°å°±æ˜¯<em>NSMallocBlock</em>ï¼ˆè‡ªåŠ¨å¤åˆ¶åˆ°å †ä¸Šäº†ï¼‰</p>
<p>2.åé¢ç”¨strongä¿®é¥°ç¬¦å’Œweakä¿®é¥°ç¬¦åˆ†åˆ«æ‰“å°çš„æ˜¯mallocçš„å’Œstackçš„ï¼Œä½†æ˜¯æ— è®ºå“ªç§ï¼Œåªè¦copyå°±æ˜¯å˜æˆmallocç±»å‹äº†</p>
<p>3.æœ€åä¸€ç§å°±æ˜¯ä¸Šé¢ä»‹ç»çš„ï¼ŒstackBlockç»è¿‡ä¼ å‚ï¼Œè‡ªåŠ¨å˜æˆäº†mallocBlock</p>
<h3 id="å±æ€§ä¿®é¥°ç¬¦-copy-ä¿®é¥°-Block"><a href="#å±æ€§ä¿®é¥°ç¬¦-copy-ä¿®é¥°-Block" class="headerlink" title="å±æ€§ä¿®é¥°ç¬¦ copy ä¿®é¥° Block"></a>å±æ€§ä¿®é¥°ç¬¦ copy ä¿®é¥° Block</h3><p>æ¥çœ‹ä¸€å¼ è¡¨ï¼Œçœ‹çœ‹ä¸‰ç§ç±»å‹copyä¹‹åæœ‰ä»€ä¹ˆåŒºåˆ«</p>
<p><img src="https://user-gold-cdn.xitu.io/2018/6/5/163cef465d5b19ef?w=1096&amp;h=83&amp;f=png&amp;s=30210" alt=""></p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>,<span class="keyword">copy</span>) blk blk;</span><br></pre></td></tr></table></figure>
<p>å½“æˆ‘ä»¬è¿™ä¹ˆå£°æ˜å±æ€§çš„æ—¶å€™ï¼Œå…¶setteræ–¹æ³•å°±æ˜¯ç”¨äº†copyæ–¹æ³•</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">- (<span class="keyword">void</span>)setBlk:(blk)blk &#123;  </span><br><span class="line">    <span class="keyword">if</span> (_blk != blk) &#123;  </span><br><span class="line">        [_blk release]; <span class="comment">// MRC  </span></span><br><span class="line">        _blk = [blk <span class="keyword">copy</span>];  </span><br><span class="line">    &#125;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>1.è¶…å‡ºä½œç”¨åŸŸå­˜åœ¨çš„ç†ç”±å°±æ˜¯ç”Ÿæˆäº†MallocBlockå¯¹è±¡ï¼Œå³ä½¿å‡ºæ ˆäº†è¿˜æ˜¯èƒ½ç»§ç»­è°ƒç”¨</li>
<li>2.forwardingçš„ç†ç”±å°±æ˜¯æ— è®ºåœ¨å †ä¸Šè¿˜æ˜¯æ ˆä¸Šï¼Œæˆ‘ä»¬éƒ½èƒ½è®¿é—®Blockï¼Œè€Œä¸”èƒ½ä¿è¯è®¿é—®åŒä¸€ä¸ª</li>
<li>3.GlobalBlock ã€MallocBlockå’ŒStackBlockçš„åŒºåˆ«ä»¥åŠå¦‚ä½•Blockå¦‚ä½•ä¼šè¢«copyåˆ°å †ä¸Š</li>
<li>4.ç‰¹åˆ«ä¸Šä½œä¸ºå‚æ•°ä¼ é€’æ—¶ï¼Œç±»ä¼¼ç±»æ–¹æ³•çš„autoreleasepoolæ³¨å†Œè¿›å»ï¼Œé¿å…å†…å­˜æ³„éœ²</li>
<li>5.åœ¨æ­£å¸¸å†™ä»£ç çš„æ—¶å€™ä¸éœ€è¦ç®¡ç†è¿™ä¸ªï¼Œé»˜è®¤ç™¾åˆ†ä¹‹99çš„æƒ…å†µåŸºæœ¬éƒ½æ˜¯MallocBlock</li>
<li>6.æ— è®ºä»€ä¹ˆæƒ…å†µä¸‹ï¼Œcopyä¸€ä¸‹æˆ–è€…å¼ºæŒ‡é’ˆå¼•ç”¨ä¸€ä¸‹æ˜¯ä¸ä¼šæœ‰é”™çš„ï¼Œèƒ½ä¿è¯å¿…ç„¶æ˜¯MallocBlock</li>
<li>7.å„ç§è¿¹è±¡è¡¨æ˜ï¼Œä»–å°±æ˜¯ä¸€ä¸ªå¯¹è±¡ï¼Œå¯ä»¥é€šè¿‡copyæ”¹å˜ç±»å‹çš„ç‰¹æ®Šå¯¹è±¡</li>
</ul>
<blockquote>
<p>ä»¥ä¸Šæ–‡ç« æ•´ç†è‡ªï¼š<a href="https://blog.csdn.net/deft_mkjing/article/details/53143076" target="_blank" rel="noopener">https://blog.csdn.net/deft_mkjing/article/details/53143076</a></p>
</blockquote>

      
    </div>
    <footer class="article-footer">
      
        <div id="donation_div"></div>

<script src="../../../../js/vdonate.js"></script>
<script>
var a = new Donate({
  title: 'å¦‚æœè§‰å¾—æˆ‘çš„æ–‡ç« å¯¹æ‚¨æœ‰ç”¨ï¼Œè¯·éšæ„æ‰“èµã€‚æ‚¨çš„æ”¯æŒå°†é¼“åŠ±æˆ‘ç»§ç»­åˆ›ä½œ!', // å¯é€‰å‚æ•°ï¼Œæ‰“èµæ ‡é¢˜
  btnText: 'Donate', // å¯é€‰å‚æ•°ï¼Œæ‰“èµæŒ‰é’®æ–‡å­—
  el: document.getElementById('donation_div'),
  wechatImage: 'http://ghexoblogimages.oss-cn-beijing.aliyuncs.com/18-11-14/6067039.jpg',
  alipayImage: 'http://ghexoblogimages.oss-cn-beijing.aliyuncs.com/18-11-16/6997594.jpg'
});
</script>
      
      
      
        
	<div id="comment">
		<!-- æ¥å¿…åŠ›Cityç‰ˆå®‰è£…ä»£ç  -->
		<div id="lv-container" data-id="city" data-uid="MTAyMC80MTA5OC8xNzYyMw==">
		<script type="text/javascript">
		   (function(d, s) {
		       var j, e = d.getElementsByTagName(s)[0];

		       if (typeof LivereTower === 'function') { return; }

		       j = d.createElement(s);
		       j.src = 'https://cdn-city.livere.com/js/embed.dist.js';
		       j.async = true;

		       e.parentNode.insertBefore(j, e);
		   })(document, 'script');
		</script>
		<noscript>ä¸ºæ­£å¸¸ä½¿ç”¨æ¥å¿…åŠ›è¯„è®ºåŠŸèƒ½è¯·æ¿€æ´»JavaScript</noscript>
		</div>
		<!-- Cityç‰ˆå®‰è£…ä»£ç å·²å®Œæˆ -->
	</div>



      
      

    </footer>
  </div>
  
    
<nav id="article-nav">
  
    <a href="../../../07/06/How to build DApp/" id="article-nav-newer" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Newer</strong>
      <div class="article-nav-title">
        
          å¦‚ä½•ç”¨ Swift æ‰“é€ ä½ çš„ç¬¬ä¸€ä¸ªåŒºå—é“¾ App
        
      </div>
    </a>
  
  
    <a href="../../09/iOS Principle Thread/" id="article-nav-older" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Older</strong>
      <div class="article-nav-title">iOS Principleï¼šThread</div>
    </a>
  
</nav>

  
</article>

<!-- Table of Contents -->

  <aside id="toc-sidebar">
    <div id="toc" class="toc-article">
    <strong class="toc-title">Contents</strong>
    
        <ol class="nav"><li class="nav-item nav-level-3"><a class="nav-link" href="#æ–¹ä¾¿è®°å¿†ï¼š"><span class="nav-number">1.</span> <span class="nav-text">æ–¹ä¾¿è®°å¿†ï¼š</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#å£°æ˜ä¸€ä¸ªBlock"><span class="nav-number">2.</span> <span class="nav-text">å£°æ˜ä¸€ä¸ªBlock:</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#ä½¿ç”¨åœºæ™¯ä¸€ï¼š"><span class="nav-number">2.1.</span> <span class="nav-text">ä½¿ç”¨åœºæ™¯ä¸€ï¼š</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#ä½¿ç”¨åœºæ™¯äºŒï¼š"><span class="nav-number">2.2.</span> <span class="nav-text">ä½¿ç”¨åœºæ™¯äºŒï¼š</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Demo-ä¸­æ–‡ä»¶å¯¹ç…§"><span class="nav-number">3.</span> <span class="nav-text">Demo ä¸­æ–‡ä»¶å¯¹ç…§</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#ä»åº•å±‚åˆ†æBlockçš„å®ç°"><span class="nav-number">4.</span> <span class="nav-text">ä»åº•å±‚åˆ†æBlockçš„å®ç°</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#å…ˆä»æœ€ç®€å•çš„çœ‹èµ·"><span class="nav-number">4.1.</span> <span class="nav-text">å…ˆä»æœ€ç®€å•çš„çœ‹èµ·</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#æºç ç»“æ„åˆ†æ"><span class="nav-number">4.2.</span> <span class="nav-text">æºç ç»“æ„åˆ†æ</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Block-è®¿é—®å¤–éƒ¨å˜é‡æ˜¯æ€ä¹ˆå›äº‹"><span class="nav-number">5.</span> <span class="nav-text">Block è®¿é—®å¤–éƒ¨å˜é‡æ˜¯æ€ä¹ˆå›äº‹</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#è¦åœ¨-Block-ä¸­æ”¹å˜é‡Œé¢çš„å€¼"><span class="nav-number">6.</span> <span class="nav-text">è¦åœ¨ Block ä¸­æ”¹å˜é‡Œé¢çš„å€¼</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#ç¬¬ä¸€ç§æ–¹æ³•ï¼šè¿ç”¨Cè¯­è¨€ä¸­çš„å˜é‡"><span class="nav-number">6.1.</span> <span class="nav-text">ç¬¬ä¸€ç§æ–¹æ³•ï¼šè¿ç”¨Cè¯­è¨€ä¸­çš„å˜é‡</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#ç¬¬äºŒç§æ–¹æ³•ï¼šå°±æ˜¯å¤§å®¶æ‰€ç†ŸçŸ¥çš„-blockä¿®é¥°ç¬¦çš„ä½¿ç”¨"><span class="nav-number">6.2.</span> <span class="nav-text">ç¬¬äºŒç§æ–¹æ³•ï¼šå°±æ˜¯å¤§å®¶æ‰€ç†ŸçŸ¥çš„__blockä¿®é¥°ç¬¦çš„ä½¿ç”¨</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#ä¸‰ç§-Block-æœ¬ä½“"><span class="nav-number">7.</span> <span class="nav-text">ä¸‰ç§ Block æœ¬ä½“</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#NSConcreteGlobalBlock-å…¨å±€å®šä¹‰"><span class="nav-number">7.1.</span> <span class="nav-text">NSConcreteGlobalBlock å…¨å±€å®šä¹‰</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#NSContreteMallocBlock-å †å®šä¹‰"><span class="nav-number">7.2.</span> <span class="nav-text">NSContreteMallocBlock å †å®šä¹‰</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#æ¥çŒœä¸€çŒœ"><span class="nav-number">8.</span> <span class="nav-text">æ¥çŒœä¸€çŒœ</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#å±æ€§ä¿®é¥°ç¬¦-copy-ä¿®é¥°-Block"><span class="nav-number">9.</span> <span class="nav-text">å±æ€§ä¿®é¥°ç¬¦ copy ä¿®é¥° Block</span></a></li></ol>
    
    </div>
  </aside>

</section>
        
      </div>
      
      <footer id="footer">
  

  <div class="container">
      	<div class="row">
	      <p> Powered by <a href="http://hexo.io/" target="_blank">Hexo</a> and <a href="https://github.com/iTimeTraveler/hexo-theme-hiker" target="_blank">Hexo-theme-hiker</a> </p>
	      <p id="copyRightEn">Copyright &copy; 2013 - 2018 Technology All Rights Reserved.</p>
	      
	      
    		<p class="busuanzi_uv">
				UV : <span id="busuanzi_value_site_uv"></span> |  
				PV : <span id="busuanzi_value_site_pv"></span>
		    </p>
  		   
		</div>

		
  </div>
</footer>


<!-- min height -->

<script>
    var wrapdiv = document.getElementById("wrap");
    var contentdiv = document.getElementById("content");
    var allheader = document.getElementById("allheader");

    wrapdiv.style.minHeight = document.body.offsetHeight + "px";
    if (allheader != null) {
      contentdiv.style.minHeight = document.body.offsetHeight - allheader.offsetHeight - document.getElementById("footer").offsetHeight + "px";
    } else {
      contentdiv.style.minHeight = document.body.offsetHeight - document.getElementById("footer").offsetHeight + "px";
    }
</script>
    </div>
    <!-- <nav id="mobile-nav">
  
    <a href="../../../../index.html" class="mobile-nav-link">Home</a>
  
    <a href="../../../../archives" class="mobile-nav-link">Archives</a>
  
    <a href="../../../../categories" class="mobile-nav-link">Categories</a>
  
    <a href="../../../../tags" class="mobile-nav-link">Tags</a>
  
    <a href="../../../../about" class="mobile-nav-link">About</a>
  
</nav> -->
    

<!-- mathjax config similar to math.stackexchange -->

<script type="text/x-mathjax-config">
  MathJax.Hub.Config({
    tex2jax: {
      inlineMath: [ ['$','$'], ["\\(","\\)"] ],
      processEscapes: true
    }
  });
</script>

<script type="text/x-mathjax-config">
    MathJax.Hub.Config({
      tex2jax: {
        skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
      }
    });
</script>

<script type="text/x-mathjax-config">
    MathJax.Hub.Queue(function() {
        var all = MathJax.Hub.getAllJax(), i;
        for(i=0; i < all.length; i += 1) {
            all[i].SourceElement().parentNode.className += ' has-jax';
        }
    });
</script>

<script type="text/javascript" src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
</script>


  <link rel="stylesheet" href="../../../../fancybox/jquery.fancybox.css">
  <script src="../../../../fancybox/jquery.fancybox.pack.js"></script>


<script src="../../../../js/scripts.js"></script>




  <script src="../../../../js/dialog.js"></script>








	<div style="display: none;">
    <script src="https://s95.cnzz.com/z_stat.php?id=1260716016&web_id=1260716016" language="JavaScript"></script>
  </div>



	<script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js">
	</script>






  </div>

  <div class="modal fade" id="myModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true" style="display: none;">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h2 class="modal-title" id="myModalLabel">è®¾ç½®</h2>
      </div>
      <hr style="margin-top:0px; margin-bottom:0px; width:80%; border-top: 3px solid #000;">
      <hr style="margin-top:2px; margin-bottom:0px; width:80%; border-top: 1px solid #000;">


      <div class="modal-body">
          <div style="margin:6px;">
            <a data-toggle="collapse" data-parent="#accordion" href="#collapseOne" onclick="javascript:setFontSize();" aria-expanded="true" aria-controls="collapseOne">
              æ­£æ–‡å­—å·å¤§å°
            </a>
          </div>
          <div id="collapseOne" class="panel-collapse collapse" role="tabpanel" aria-labelledby="headingOne">
          <div class="panel-body">
            æ‚¨å·²è°ƒæ•´é¡µé¢å­—ä½“å¤§å°
          </div>
        </div>
      


          <div style="margin:6px;">
            <a data-toggle="collapse" data-parent="#accordion" href="#collapseTwo" onclick="javascript:setBackground();" aria-expanded="true" aria-controls="collapseTwo">
              å¤œé—´æŠ¤çœ¼æ¨¡å¼
            </a>
        </div>
          <div id="collapseTwo" class="panel-collapse collapse" role="tabpanel" aria-labelledby="headingTwo">
          <div class="panel-body">
            å¤œé—´æ¨¡å¼å·²ç»å¼€å¯ï¼Œå†æ¬¡å•å‡»æŒ‰é’®å³å¯å…³é—­ 
          </div>
        </div>

        <div>
            <a data-toggle="collapse" data-parent="#accordion" href="#collapseThree" aria-expanded="true" aria-controls="collapseThree">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;å…³ äº&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</a>
        </div>
         <div id="collapseThree" class="panel-collapse collapse" role="tabpanel" aria-labelledby="headingThree">
          <div class="panel-body">
            Technology
          </div>
          <div class="panel-body">
            Copyright Â© 2018 Steven&#39;s Blog All Rights Reserved.
          </div>
        </div>
      </div>


      <hr style="margin-top:0px; margin-bottom:0px; width:80%; border-top: 1px solid #000;">
      <hr style="margin-top:2px; margin-bottom:0px; width:80%; border-top: 3px solid #000;">
      <div class="modal-footer">
        <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">Ã—</span></button>
      </div>
    </div>
  </div>
</div>
  
  <a id="rocket" href="#top" class=""></a>
  <script type="text/javascript" src="/js/totop.js?v=1.0.0" async=""></script>
  
    <a id="menu-switch"><i class="fa fa-bars fa-lg"></i></a>
  
</body>
</html>