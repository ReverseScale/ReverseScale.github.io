<!DOCTYPE html>
<html>
<head><meta name="generator" content="Hexo 3.8.0">
  <meta charset="utf-8">
  
  <title>ios principleï¼šweak | Technology</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  
    <meta name="keywords" content="Principle">
  
  
  
  
  <meta name="description" content="ä¹‹å‰åªæ˜¯è®¤è¯†åˆ° weak ä½œä¸ºä¸€ç§å¼±å¼•ç”¨å±æ€§ä¿®é¥°è¯ï¼Œä¸å¢åŠ å¯¹è±¡çš„å¼•ç”¨è®¡æ•°ï¼Œä¹Ÿä¸æŒæœ‰å¯¹è±¡ï¼Œå¯¹è±¡æ¶ˆå¤±åï¼ŒæŒ‡é’ˆè‡ªåŠ¨å˜æˆnilã€‚åœ¨ARCç¯å¢ƒä¸‹ï¼Œä¸ºé¿å…å¾ªç¯å¼•ç”¨ï¼Œå¾€å¾€ä¼šæŠŠdelegateå±æ€§ç”¨weakä¿®é¥°~">
<meta name="keywords" content="Principle">
<meta property="og:type" content="article">
<meta property="og:title" content="iOS Principleï¼šweak">
<meta property="og:url" content="https://reversescale.github.io/2018/06/13/iOS Principle weak/index.html">
<meta property="og:site_name" content="Technology">
<meta property="og:description" content="ä¹‹å‰åªæ˜¯è®¤è¯†åˆ° weak ä½œä¸ºä¸€ç§å¼±å¼•ç”¨å±æ€§ä¿®é¥°è¯ï¼Œä¸å¢åŠ å¯¹è±¡çš„å¼•ç”¨è®¡æ•°ï¼Œä¹Ÿä¸æŒæœ‰å¯¹è±¡ï¼Œå¯¹è±¡æ¶ˆå¤±åï¼ŒæŒ‡é’ˆè‡ªåŠ¨å˜æˆnilã€‚åœ¨ARCç¯å¢ƒä¸‹ï¼Œä¸ºé¿å…å¾ªç¯å¼•ç”¨ï¼Œå¾€å¾€ä¼šæŠŠdelegateå±æ€§ç”¨weakä¿®é¥°~">
<meta property="og:locale" content="default">
<meta property="og:image" content="https://user-gold-cdn.xitu.io/2018/6/12/163f30ecf7d18639?w=963&h=129&f=png&s=31588">
<meta property="og:image" content="https://user-gold-cdn.xitu.io/2018/6/12/163f30ecf0d7c7df?w=589&h=563&f=png&s=79568">
<meta property="og:image" content="https://user-gold-cdn.xitu.io/2018/6/12/163f30ed0395bee2?w=547&h=595&f=png&s=74638">
<meta property="og:updated_time" content="2018-11-26T12:57:10.860Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="iOS Principleï¼šweak">
<meta name="twitter:description" content="ä¹‹å‰åªæ˜¯è®¤è¯†åˆ° weak ä½œä¸ºä¸€ç§å¼±å¼•ç”¨å±æ€§ä¿®é¥°è¯ï¼Œä¸å¢åŠ å¯¹è±¡çš„å¼•ç”¨è®¡æ•°ï¼Œä¹Ÿä¸æŒæœ‰å¯¹è±¡ï¼Œå¯¹è±¡æ¶ˆå¤±åï¼ŒæŒ‡é’ˆè‡ªåŠ¨å˜æˆnilã€‚åœ¨ARCç¯å¢ƒä¸‹ï¼Œä¸ºé¿å…å¾ªç¯å¼•ç”¨ï¼Œå¾€å¾€ä¼šæŠŠdelegateå±æ€§ç”¨weakä¿®é¥°~">
<meta name="twitter:image" content="https://user-gold-cdn.xitu.io/2018/6/12/163f30ecf7d18639?w=963&h=129&f=png&s=31588">
  
    <link rel="alternate" href="/atom.xml" title="Technology" type="application/atom+xml">
  

  

  <link rel="icon" href="/css/images/docccc.png">
  <link rel="apple-touch-icon" href="/css/images/docccc.png">
  
    <link href="//fonts.googleapis.com/css?family=Source+Code+Pro" rel="stylesheet" type="text/css">
  
  <link href="https://fonts.googleapis.com/css?family=Open+Sans|Montserrat:700" rel="stylesheet" type="text/css">
  <link href="https://fonts.googleapis.com/css?family=Roboto:400,300,300italic,400italic" rel="stylesheet" type="text/css">
  <link href="//cdn.bootcss.com/font-awesome/4.6.3/css/font-awesome.min.css" rel="stylesheet">
  <style type="text/css">
    @font-face{font-family:futura-pt;src:url(https://use.typekit.net/af/9749f0/00000000000000000001008f/27/l?subset_id=2&fvd=n5) format("woff2");font-weight:500;font-style:normal;}
    @font-face{font-family:futura-pt;src:url(https://use.typekit.net/af/90cf9f/000000000000000000010091/27/l?subset_id=2&fvd=n7) format("woff2");font-weight:500;font-style:normal;}
    @font-face{font-family:futura-pt;src:url(https://use.typekit.net/af/8a5494/000000000000000000013365/27/l?subset_id=2&fvd=n4) format("woff2");font-weight:lighter;font-style:normal;}
    @font-face{font-family:futura-pt;src:url(https://use.typekit.net/af/d337d8/000000000000000000010095/27/l?subset_id=2&fvd=i4) format("woff2");font-weight:400;font-style:italic;}</style>
  <link rel="stylesheet" href="../../../../css/style.css">

  <script src="../../../../js/jquery-3.1.1.min.js"></script>
  <script src="../../../../js/bootstrap.js"></script>

  <!-- Bootstrap core CSS -->
  <link rel="stylesheet" href="/css/bootstrap.css">

  
    <link rel="stylesheet" href="../../../../css/dialog.css">
  

  

  
    <link rel="stylesheet" href="/css/header-post.css">
  

  
  
  
    <link rel="stylesheet" href="/css/vdonate.css">
  

</head>
</html>


  <body data-spy="scroll" data-target="#toc" data-offset="50">


  
  <div id="container">
    <div id="wrap">
      
        <header>

    <div id="allheader" class="navbar navbar-default navbar-static-top" role="navigation">
        <div class="navbar-inner">
          
          <div class="container"> 
            <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
              <span class="sr-only">Toggle navigation</span>
              <span class="icon-bar"></span>
              <span class="icon-bar"></span>
              <span class="icon-bar"></span>
            </button>

            
              <a class="brand" style="
                 border-width: 0px;  margin-top: 0px;" href="#" data-toggle="modal" data-target="#myModal">
                  <img width="88px" height="88px" alt="Hike News" src="/css/images/docccc.png">
              </a>
            
            
            <div class="navbar-collapse collapse">
              <ul class="hnav navbar-nav">
                
                  <li> <a class="main-nav-link" href="../../../../index.html">Home</a> </li>
                
                  <li> <a class="main-nav-link" href="../../../../archives">Archives</a> </li>
                
                  <li> <a class="main-nav-link" href="../../../../categories">Categories</a> </li>
                
                  <li> <a class="main-nav-link" href="../../../../tags">Tags</a> </li>
                
                  <li> <a class="main-nav-link" href="../../../../about">About</a> </li>
                
                  <li><div id="search-form-wrap">

    <form class="search-form">
        <input type="text" class="ins-search-input search-form-input" placeholder="">
        <button type="submit" class="search-form-submit"></button>
    </form>
    <div class="ins-search">
    <div class="ins-search-mask"></div>
    <div class="ins-search-container">
        <div class="ins-input-wrapper">
            <input type="text" class="ins-search-input" placeholder="Type something...">
            <span class="ins-close ins-selectable"><i class="fa fa-times-circle"></i></span>
        </div>
        <div class="ins-section-wrapper">
            <div class="ins-section-container"></div>
        </div>
    </div>
</div>
<script>
(function (window) {
    var INSIGHT_CONFIG = {
        TRANSLATION: {
            POSTS: 'Posts',
            PAGES: 'Pages',
            CATEGORIES: 'Categories',
            TAGS: 'Tags',
            UNTITLED: '(Untitled)',
        },
        ROOT_URL: '/',
        CONTENT_URL: '../../../../content.json',
    };
    window.INSIGHT_CONFIG = INSIGHT_CONFIG;
})(window);
</script>
<script src="../../../../js/insight.js"></script>

</div></li>
            </ul></div>
          </div>
                
      </div>
    </div>

</header>



      
            
      <div id="content" class="outer">
        
          <section id="main" style="float:none;"><article id="post-iOS Principle weak" style="width: 75%; float:left;" class="article article-type-post" itemscope="" itemprop="blogPost">
  <div id="articleInner" class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 class="thumb" itemprop="name">
      iOS Principleï¼šweak
    </h1>
  

      </header>
    
    <div class="article-meta">
      
	<a href="" class="article-date">
	  <time datetime="2018-06-13T13:56:27.000Z" itemprop="datePublished">2018-06-13</time>
	</a>

      
    <a class="article-category-link" href="../../../../categories/Principle/">Principle</a>

      
	<a class="article-views">
	<span id="busuanzi_container_page_pv">
		PV:<span id="busuanzi_value_page_pv"></span>
	</span>
	</a>

    </div>
    <div class="article-entry" itemprop="articleBody">
      
        <p>ä¹‹å‰åªæ˜¯è®¤è¯†åˆ° weak ä½œä¸ºä¸€ç§å¼±å¼•ç”¨å±æ€§ä¿®é¥°è¯ï¼Œä¸å¢åŠ å¯¹è±¡çš„å¼•ç”¨è®¡æ•°ï¼Œä¹Ÿä¸æŒæœ‰å¯¹è±¡ï¼Œå¯¹è±¡æ¶ˆå¤±åï¼ŒæŒ‡é’ˆè‡ªåŠ¨å˜æˆnilã€‚åœ¨ARCç¯å¢ƒä¸‹ï¼Œä¸ºé¿å…å¾ªç¯å¼•ç”¨ï¼Œå¾€å¾€ä¼šæŠŠdelegateå±æ€§ç”¨weakä¿®é¥°~ </p>
<a id="more"></a>
<hr>
<p>ğŸ‘¨ğŸ»â€ğŸ’» <a href="https://github.com/ReverseScale/iOSPrinciple_weak" target="_blank" rel="noopener">Github Demo</a></p>
<h3 id="æ–¹ä¾¿è®°å¿†ï¼š"><a href="#æ–¹ä¾¿è®°å¿†ï¼š" class="headerlink" title="æ–¹ä¾¿è®°å¿†ï¼š"></a>æ–¹ä¾¿è®°å¿†ï¼š</h3><ul>
<li>ä½œç”¨ï¼šä½œä¸ºä¸€ç§å¼±å¼•ç”¨å±æ€§ä¿®é¥°è¯ï¼Œä¸å¢åŠ å¯¹è±¡çš„å¼•ç”¨è®¡æ•°ï¼Œä¹Ÿä¸æŒæœ‰å¯¹è±¡ï¼Œå¯¹è±¡æ¶ˆå¤±åï¼ŒæŒ‡é’ˆè‡ªåŠ¨å˜æˆnil</li>
<li>åŸç†ï¼šweak å…¶å®æ˜¯ä¸€ä¸ª hashï¼ˆå“ˆå¸Œï¼‰è¡¨ï¼ŒKey:å¯¹è±¡çš„åœ°å€ï¼ŒValue:weak æŒ‡é’ˆçš„åœ°å€æ•°ç»„</li>
<li>åº•å±‚å®ç°è¿‡ç¨‹<ul>
<li>åˆå§‹åŒ–æ—¶ï¼šruntimeä¼šè°ƒç”¨objc_initWeakå‡½æ•°ï¼Œåˆå§‹åŒ–ä¸€ä¸ªæ–°çš„weakæŒ‡é’ˆæŒ‡å‘å¯¹è±¡çš„åœ°å€</li>
<li>æ·»åŠ å¼•ç”¨æ—¶ï¼šobjc_initWeakå‡½æ•°ä¼šè°ƒç”¨ objc_storeWeak() å‡½æ•°ï¼Œ objc_storeWeak() çš„ä½œç”¨æ˜¯æ›´æ–°æŒ‡é’ˆæŒ‡å‘ï¼Œåˆ›å»ºå¯¹åº”çš„å¼±å¼•ç”¨è¡¨</li>
<li>é‡Šæ”¾æ—¶ï¼šè°ƒç”¨clearDeallocatingå‡½æ•°ï¼Œå¯¹è±¡åœ°å€è·å–æ‰€æœ‰weakæŒ‡é’ˆåœ°å€çš„æ•°ç»„ï¼Œç„¶åéå†è¿™ä¸ªæ•°ç»„æŠŠå…¶ä¸­çš„æ•°æ®è®¾ä¸ºnil</li>
</ul>
</li>
</ul>
<hr>
<h3 id="å¼•æ–‡"><a href="#å¼•æ–‡" class="headerlink" title="å¼•æ–‡"></a>å¼•æ–‡</h3><p>ä»Šå¤©æ•´ç†ä¸€ä¸‹ weak çš„å®ç°åŸç†ï¼Œå…ˆæ¦‚æ‹¬çš„è®² weak å…¶å®æ˜¯ä¸€ä¸ª hashï¼ˆå“ˆå¸Œï¼‰è¡¨ï¼ŒKey æ˜¯æ‰€æŒ‡å¯¹è±¡çš„åœ°å€ï¼ŒValue æ˜¯ weak æŒ‡é’ˆçš„åœ°å€æ•°ç»„ã€‚</p>
<p>é¡ºä¾¿å‘ç°å…¶å®ç°åœ¨æƒ³å¾ªç¯å¼•ç”¨ä¹ŸæŒºéš¾çš„ï¼ŒXcodeä¼šæœ‰ä¸ªæé†’ï¼Œé»„é»„çš„æŒºæ˜¾çœ¼çš„â€¦</p>
<p><img src="https://user-gold-cdn.xitu.io/2018/6/12/163f30ecf7d18639?w=963&amp;h=129&amp;f=png&amp;s=31588" alt=""></p>
<h3 id="å®ç°åŸç†"><a href="#å®ç°åŸç†" class="headerlink" title="å®ç°åŸç†"></a>å®ç°åŸç†</h3><p>Runtimeç»´æŠ¤äº†ä¸€ä¸ªweakè¡¨ï¼Œç”¨äºå­˜å‚¨æŒ‡å‘æŸä¸ªå¯¹è±¡çš„æ‰€æœ‰weakæŒ‡é’ˆã€‚weakè¡¨å…¶å®æ˜¯ä¸€ä¸ªhashï¼ˆå“ˆå¸Œï¼‰è¡¨ï¼ŒKeyæ˜¯æ‰€æŒ‡å¯¹è±¡çš„åœ°å€ï¼ŒValueæ˜¯weakæŒ‡é’ˆçš„åœ°å€ï¼ˆè¿™ä¸ªåœ°å€çš„å€¼æ˜¯æ‰€æŒ‡å¯¹è±¡çš„åœ°å€ï¼‰æ•°ç»„ã€‚</p>
<p>åº•å±‚çš„å®ç°å¤§ä½“åˆ†ä¸ºä¸‰æ­¥ï¼š</p>
<ul>
<li>1.åˆå§‹åŒ–æ—¶ï¼šruntimeä¼šè°ƒç”¨objc_initWeakå‡½æ•°ï¼Œåˆå§‹åŒ–ä¸€ä¸ªæ–°çš„weakæŒ‡é’ˆæŒ‡å‘å¯¹è±¡çš„åœ°å€ã€‚ï¼ˆç»™ä½ æ·»ä¸ªå¹²å…„å¼Ÿï¼‰</li>
<li>2.æ·»åŠ å¼•ç”¨æ—¶ï¼šobjc_initWeakå‡½æ•°ä¼šè°ƒç”¨ objc_storeWeak() å‡½æ•°ï¼Œ objc_storeWeak() çš„ä½œç”¨æ˜¯æ›´æ–°æŒ‡é’ˆæŒ‡å‘ï¼Œåˆ›å»ºå¯¹åº”çš„å¼±å¼•ç”¨è¡¨ã€‚ï¼ˆç»™è¿™ä¸ªå¹²å…„å¼Ÿè½ä¸ªæˆ·å£ï¼Œä»‹ç»ç»™äº²æˆšæœ‹å‹ï¼‰</li>
<li>3.é‡Šæ”¾æ—¶ï¼Œè°ƒç”¨clearDeallocatingå‡½æ•°ã€‚clearDeallocatingå‡½æ•°é¦–å…ˆæ ¹æ®å¯¹è±¡åœ°å€è·å–æ‰€æœ‰weakæŒ‡é’ˆåœ°å€çš„æ•°ç»„ï¼Œç„¶åéå†è¿™ä¸ªæ•°ç»„æŠŠå…¶ä¸­çš„æ•°æ®è®¾ä¸ºnilï¼Œæœ€åæŠŠè¿™ä¸ªentryä»weakè¡¨ä¸­åˆ é™¤ï¼Œæœ€åæ¸…ç†å¯¹è±¡çš„è®°å½•ã€‚ï¼ˆæœ€åç­‰è¿™ä¸ªå¹²å…„å¼Ÿå¹²å®Œæ´»åï¼Œè¢«å¸ç£¨æ€é©´ï¼‰</li>
</ul>
<h3 id="åˆ†æ­¥è§£æå†…éƒ¨å®ç°ï¼š"><a href="#åˆ†æ­¥è§£æå†…éƒ¨å®ç°ï¼š" class="headerlink" title="åˆ†æ­¥è§£æå†…éƒ¨å®ç°ï¼š"></a>åˆ†æ­¥è§£æå†…éƒ¨å®ç°ï¼š</h3><p>1ï¼‰åˆå§‹åŒ–æ—¶ï¼šruntimeä¼šè°ƒç”¨objc_initWeakå‡½æ•°ï¼Œobjc_initWeakå‡½æ•°ä¼šåˆå§‹åŒ–ä¸€ä¸ªæ–°çš„weakæŒ‡é’ˆæŒ‡å‘å¯¹è±¡çš„åœ°å€ã€‚</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">NSObject</span> *obj = [[<span class="built_in">NSObject</span> alloc] init];</span><br><span class="line"><span class="keyword">id</span> __<span class="keyword">weak</span> obj1 = obj; <span class="comment">// çœ‹å¥½ weak äº†</span></span><br></pre></td></tr></table></figure>
<p>å½“æˆ‘ä»¬åˆå§‹åŒ–ä¸€ä¸ªweakå˜é‡æ—¶ï¼Œruntimeä¼šè°ƒç”¨ NSObject.mm ä¸­çš„objc_initWeakå‡½æ•°ã€‚è¿™ä¸ªå‡½æ•°åœ¨Clangä¸­çš„å£°æ˜å¦‚ä¸‹ï¼š</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">idÂ <span class="title">objc_initWeak</span><span class="params">(idÂ *object,Â idÂ value)</span></span>;</span><br></pre></td></tr></table></figure>
<p>objc_initWeak() æ–¹æ³•çš„å®ç°</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">id <span class="title">objc_initWeak</span><span class="params">(id *location, id newObj)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// æŸ¥çœ‹å¯¹è±¡å®ä¾‹æ˜¯å¦æœ‰æ•ˆ</span></span><br><span class="line">    <span class="comment">// æ— æ•ˆå¯¹è±¡ç›´æ¥å¯¼è‡´æŒ‡é’ˆé‡Šæ”¾</span></span><br><span class="line">    <span class="keyword">if</span> (!newObj) &#123;</span><br><span class="line">        *location = nil;</span><br><span class="line">        <span class="keyword">return</span> nil;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// è¿™é‡Œä¼ é€’äº†ä¸‰ä¸ª bool æ•°å€¼</span></span><br><span class="line">    <span class="comment">// ä½¿ç”¨ template è¿›è¡Œå¸¸é‡å‚æ•°ä¼ é€’æ˜¯ä¸ºäº†ä¼˜åŒ–æ€§èƒ½</span></span><br><span class="line">    <span class="keyword">return</span> storeWeakfalse<span class="comment">/*old*/</span>, <span class="literal">true</span><span class="comment">/*new*/</span>, <span class="literal">true</span><span class="comment">/*crash*/</span>&gt;</span><br><span class="line">    (location, (objc_object*)newObj);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>å¯ä»¥çœ‹å‡ºï¼Œè¿™ä¸ªå‡½æ•°ä»…ä»…æ˜¯ä¸€ä¸ªæ·±å±‚å‡½æ•°çš„è°ƒç”¨å…¥å£ï¼Œè€Œä¸€èˆ¬çš„å…¥å£å‡½æ•°ä¸­ï¼Œéƒ½ä¼šåšä¸€äº›ç®€å•çš„åˆ¤æ–­ï¼ˆä¾‹å¦‚ objc_msgSend ä¸­çš„ç¼“å­˜åˆ¤æ–­ï¼‰ï¼Œè¿™é‡Œåˆ¤æ–­äº†å…¶æŒ‡é’ˆæŒ‡å‘çš„ç±»å¯¹è±¡æ˜¯å¦æœ‰æ•ˆï¼Œæ— æ•ˆç›´æ¥é‡Šæ”¾ï¼Œä¸å†å¾€æ·±å±‚è°ƒç”¨å‡½æ•°ã€‚å¦åˆ™ï¼Œobjectå°†è¢«æ³¨å†Œä¸ºä¸€ä¸ªæŒ‡å‘valueçš„__weakå¯¹è±¡ã€‚</p>
<blockquote>
<p>æ³¨æ„ï¼šobjc_initWeakå‡½æ•°æœ‰ä¸€ä¸ªå‰ææ¡ä»¶ï¼šå°±æ˜¯objectå¿…é¡»æ˜¯ä¸€ä¸ªæ²¡æœ‰è¢«æ³¨å†Œä¸º__weakå¯¹è±¡çš„æœ‰æ•ˆæŒ‡é’ˆã€‚è€Œvalueåˆ™å¯ä»¥æ˜¯nullï¼Œæˆ–è€…æŒ‡å‘ä¸€ä¸ªæœ‰æ•ˆçš„å¯¹è±¡ã€‚</p>
</blockquote>
<p>2ï¼‰æ·»åŠ å¼•ç”¨æ—¶ï¼šobjc_initWeakå‡½æ•°ä¼šè°ƒç”¨ objc_storeWeak() å‡½æ•°ï¼Œ objc_storeWeak() çš„ä½œç”¨æ˜¯æ›´æ–°æŒ‡é’ˆæŒ‡å‘ï¼Œåˆ›å»ºå¯¹åº”çš„å¼±å¼•ç”¨è¡¨ã€‚</p>
<p>objc_storeWeakçš„å‡½æ•°å£°æ˜å¦‚ä¸‹ï¼š</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">id <span class="title">objc_storeWeak</span><span class="params">(id *location, id value)</span></span>;</span><br></pre></td></tr></table></figure>
<p>objc_storeWeak æ–¹æ³•çš„å®ç°ï¼š</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// HaveOld:     true - å˜é‡æœ‰å€¼</span></span><br><span class="line"><span class="comment">//             false - éœ€è¦è¢«åŠæ—¶æ¸…ç†ï¼Œå½“å‰å€¼å¯èƒ½ä¸º nil</span></span><br><span class="line"><span class="comment">// HaveNew:     true - éœ€è¦è¢«åˆ†é…çš„æ–°å€¼ï¼Œå½“å‰å€¼å¯èƒ½ä¸º nil</span></span><br><span class="line"><span class="comment">//             false - ä¸éœ€è¦åˆ†é…æ–°å€¼</span></span><br><span class="line"><span class="comment">// CrashIfDeallocating: true - è¯´æ˜ newObj å·²ç»é‡Šæ”¾æˆ–è€… newObj ä¸æ”¯æŒå¼±å¼•ç”¨ï¼Œè¯¥è¿‡ç¨‹éœ€è¦æš‚åœ</span></span><br><span class="line"><span class="comment">//             false - ç”¨ nil æ›¿ä»£å­˜å‚¨</span></span><br><span class="line"><span class="keyword">template</span> <span class="keyword">bool</span> HaveOld, <span class="keyword">bool</span> HaveNew, <span class="keyword">bool</span> CrashIfDeallocating&gt;</span><br><span class="line"><span class="function"><span class="keyword">static</span> id <span class="title">storeWeak</span><span class="params">(id *location, objc_object *newObj)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// è¯¥è¿‡ç¨‹ç”¨æ¥æ›´æ–°å¼±å¼•ç”¨æŒ‡é’ˆçš„æŒ‡å‘</span></span><br><span class="line">    <span class="comment">// åˆå§‹åŒ– previouslyInitializedClass æŒ‡é’ˆ</span></span><br><span class="line">    Class previouslyInitializedClass = nil;</span><br><span class="line">    id oldObj;</span><br><span class="line">    <span class="comment">// å£°æ˜ä¸¤ä¸ª SideTable</span></span><br><span class="line">    <span class="comment">// â‘  æ–°æ—§æ•£åˆ—åˆ›å»º</span></span><br><span class="line">    SideTable *oldTable;</span><br><span class="line">    SideTable *newTable;</span><br><span class="line">    <span class="comment">// è·å¾—æ–°å€¼å’Œæ—§å€¼çš„é”å­˜ä½ç½®ï¼ˆç”¨åœ°å€ä½œä¸ºå”¯ä¸€æ ‡ç¤ºï¼‰</span></span><br><span class="line">    <span class="comment">// é€šè¿‡åœ°å€æ¥å»ºç«‹ç´¢å¼•æ ‡å¿—ï¼Œé˜²æ­¢æ¡¶é‡å¤</span></span><br><span class="line">    <span class="comment">// ä¸‹é¢æŒ‡å‘çš„æ“ä½œä¼šæ”¹å˜æ—§å€¼</span></span><br><span class="line">    retry:</span><br><span class="line">    <span class="keyword">if</span> (HaveOld) &#123;</span><br><span class="line">        <span class="comment">// æ›´æ”¹æŒ‡é’ˆï¼Œè·å¾—ä»¥ oldObj ä¸ºç´¢å¼•æ‰€å­˜å‚¨çš„å€¼åœ°å€</span></span><br><span class="line">        oldObj = *location;</span><br><span class="line">        oldTable = &amp;SideTables()[oldObj];</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        oldTable = nil;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (HaveNew) &#123;</span><br><span class="line">        <span class="comment">// æ›´æ”¹æ–°å€¼æŒ‡é’ˆï¼Œè·å¾—ä»¥ newObj ä¸ºç´¢å¼•æ‰€å­˜å‚¨çš„å€¼åœ°å€</span></span><br><span class="line">        newTable = &amp;SideTables()[newObj];</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        newTable = nil;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// åŠ é”æ“ä½œï¼Œé˜²æ­¢å¤šçº¿ç¨‹ä¸­ç«äº‰å†²çª</span></span><br><span class="line">    SideTable::lockTwoHaveOld, HaveNew&gt;(oldTable, newTable);</span><br><span class="line">    <span class="comment">// é¿å…çº¿ç¨‹å†²çªé‡å¤„ç†</span></span><br><span class="line">    <span class="comment">// location åº”è¯¥ä¸ oldObj ä¿æŒä¸€è‡´ï¼Œå¦‚æœä¸åŒï¼Œè¯´æ˜å½“å‰çš„ location å·²ç»å¤„ç†è¿‡ oldObj å¯æ˜¯åˆè¢«å…¶ä»–çº¿ç¨‹æ‰€ä¿®æ”¹</span></span><br><span class="line">    <span class="keyword">if</span> (HaveOld  &amp;&amp;  *location != oldObj) &#123;</span><br><span class="line">        SideTable::unlockTwoHaveOld, HaveNew&gt;(oldTable, newTable);</span><br><span class="line">        <span class="keyword">goto</span> retry;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// é˜²æ­¢å¼±å¼•ç”¨é—´æ­»é”</span></span><br><span class="line">    <span class="comment">// å¹¶ä¸”é€šè¿‡ +initialize åˆå§‹åŒ–æ„é€ å™¨ä¿è¯æ‰€æœ‰å¼±å¼•ç”¨çš„ isa éç©ºæŒ‡å‘</span></span><br><span class="line">    <span class="keyword">if</span> (HaveNew  &amp;&amp;  newObj) &#123;</span><br><span class="line">        <span class="comment">// è·å¾—æ–°å¯¹è±¡çš„ isa æŒ‡é’ˆ</span></span><br><span class="line">        Class cls = newObj-&gt;getIsa();</span><br><span class="line">        <span class="comment">// åˆ¤æ–­ isa éç©ºä¸”å·²ç»åˆå§‹åŒ–</span></span><br><span class="line">        <span class="keyword">if</span> (cls != previouslyInitializedClass  &amp;&amp;</span><br><span class="line">        !((objc_class *)cls)-&gt;isInitialized()) &#123;</span><br><span class="line">            <span class="comment">// è§£é”</span></span><br><span class="line">            SideTable::unlockTwoHaveOld, HaveNew&gt;(oldTable, newTable);</span><br><span class="line">            <span class="comment">// å¯¹å…¶ isa æŒ‡é’ˆè¿›è¡Œåˆå§‹åŒ–</span></span><br><span class="line">            _class_initialize(_class_getNonMetaClass(cls, (id)newObj));</span><br><span class="line">            <span class="comment">// å¦‚æœè¯¥ç±»å·²ç»å®Œæˆæ‰§è¡Œ +initialize æ–¹æ³•æ˜¯æœ€ç†æƒ³æƒ…å†µ</span></span><br><span class="line">            <span class="comment">// å¦‚æœè¯¥ç±» +initialize åœ¨çº¿ç¨‹ä¸­</span></span><br><span class="line">            <span class="comment">// ä¾‹å¦‚ +initialize æ­£åœ¨è°ƒç”¨ storeWeak æ–¹æ³•</span></span><br><span class="line">            <span class="comment">// éœ€è¦æ‰‹åŠ¨å¯¹å…¶å¢åŠ ä¿æŠ¤ç­–ç•¥ï¼Œå¹¶è®¾ç½® previouslyInitializedClass æŒ‡é’ˆè¿›è¡Œæ ‡è®°</span></span><br><span class="line">            previouslyInitializedClass = cls;</span><br><span class="line">            <span class="comment">// é‡æ–°å°è¯•</span></span><br><span class="line">            <span class="keyword">goto</span> retry;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// â‘¡ æ¸…é™¤æ—§å€¼</span></span><br><span class="line">    <span class="keyword">if</span> (HaveOld) &#123;</span><br><span class="line">        weak_unregister_no_lock(&amp;oldTable-&gt;weak_table, oldObj, location);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// â‘¢ åˆ†é…æ–°å€¼</span></span><br><span class="line">    <span class="keyword">if</span> (HaveNew) &#123;</span><br><span class="line">        newObj = (objc_object *)weak_register_no_lock(&amp;newTable-&gt;weak_table,</span><br><span class="line">        (id)newObj, location,</span><br><span class="line">        CrashIfDeallocating);</span><br><span class="line">        <span class="comment">// å¦‚æœå¼±å¼•ç”¨è¢«é‡Šæ”¾ weak_register_no_lock æ–¹æ³•è¿”å› nil</span></span><br><span class="line">        <span class="comment">// åœ¨å¼•ç”¨è®¡æ•°è¡¨ä¸­è®¾ç½®è‹¥å¼•ç”¨æ ‡è®°ä½</span></span><br><span class="line">        <span class="keyword">if</span> (newObj  &amp;&amp;  !newObj-&gt;isTaggedPointer()) &#123;</span><br><span class="line">            <span class="comment">// å¼±å¼•ç”¨ä½åˆå§‹åŒ–æ“ä½œ</span></span><br><span class="line">            <span class="comment">// å¼•ç”¨è®¡æ•°é‚£å¼ æ•£åˆ—è¡¨çš„weakå¼•ç”¨å¯¹è±¡çš„å¼•ç”¨è®¡æ•°ä¸­æ ‡è¯†ä¸ºweakå¼•ç”¨</span></span><br><span class="line">            newObj-&gt;setWeaklyReferenced_nolock();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// ä¹‹å‰ä¸è¦è®¾ç½® location å¯¹è±¡ï¼Œè¿™é‡Œéœ€è¦æ›´æ”¹æŒ‡é’ˆæŒ‡å‘</span></span><br><span class="line">        *location = (id)newObj;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="comment">// æ²¡æœ‰æ–°å€¼ï¼Œåˆ™æ— éœ€æ›´æ”¹</span></span><br><span class="line">    &#125;</span><br><span class="line">    SideTable::unlockTwoHaveOld, HaveNew&gt;(oldTable, newTable);</span><br><span class="line">    <span class="keyword">return</span> (id)newObj;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="æ‹†åˆ†è§£æä¸Šè¿°ä»£ç "><a href="#æ‹†åˆ†è§£æä¸Šè¿°ä»£ç " class="headerlink" title="æ‹†åˆ†è§£æä¸Šè¿°ä»£ç "></a>æ‹†åˆ†è§£æä¸Šè¿°ä»£ç </h3><p>â‘  SideTable</p>
<p>ä¸»è¦ç”¨äºç®¡ç†å¯¹è±¡çš„å¼•ç”¨è®¡æ•°å’Œ weak è¡¨ã€‚åœ¨ NSObject.mm ä¸­å£°æ˜å…¶æ•°æ®ç»“æ„ï¼š</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">SideTable</span> &#123;</span></span><br><span class="line">    <span class="comment">// ä¿è¯åŸå­æ“ä½œçš„è‡ªæ—‹é”</span></span><br><span class="line">    <span class="keyword">spinlock_t</span> slock;</span><br><span class="line">    <span class="comment">// å¼•ç”¨è®¡æ•°çš„ hash è¡¨</span></span><br><span class="line">    RefcountMap refcnts;</span><br><span class="line">    <span class="comment">// weak å¼•ç”¨å…¨å±€ hash è¡¨</span></span><br><span class="line">    <span class="keyword">weak_table_t</span> weak_table;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>å¯¹äº slock å’Œ refcnts ä¸¤ä¸ªæˆå‘˜ä¸ç”¨å¤šè¯´ï¼Œç¬¬ä¸€ä¸ªæ˜¯ä¸ºäº†é˜²æ­¢ç«äº‰é€‰æ‹©çš„è‡ªæ—‹é”ï¼Œç¬¬äºŒä¸ªæ˜¯ååŠ©å¯¹è±¡çš„ isa æŒ‡é’ˆçš„ extra_rc å…±åŒå¼•ç”¨è®¡æ•°çš„å˜é‡ï¼ˆå¯¹äºå¯¹è±¡ç»“æœï¼Œåœ¨ä»Šåçš„æ–‡ä¸­æåˆ°ï¼‰ã€‚è¿™é‡Œä¸»è¦çœ‹ weak å…¨å±€ hash è¡¨çš„ç»“æ„ä¸ä½œç”¨ã€‚</p>
<p>â‘¡ weak è¡¨</p>
<p>weakè¡¨æ˜¯ä¸€ä¸ªå¼±å¼•ç”¨è¡¨ï¼Œå®ç°ä¸ºä¸€ä¸ªweak_table_tç»“æ„ä½“ï¼Œå­˜å‚¨äº†æŸä¸ªå¯¹è±¡ç›¸å…³çš„æ‰€æœ‰çš„å¼±å¼•ç”¨ä¿¡æ¯ã€‚</p>
<p>åœ¨objc-weak.hä¸­å…¶å®šä¹‰å¦‚ä¸‹</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">weak_table_t</span> &#123;</span></span><br><span class="line">    <span class="comment">// ä¿å­˜äº†æ‰€æœ‰æŒ‡å‘æŒ‡å®šå¯¹è±¡çš„ weak æŒ‡é’ˆ</span></span><br><span class="line">    <span class="keyword">weak_entry_t</span> *weak_entries;</span><br><span class="line">    <span class="comment">// å­˜å‚¨ç©ºé—´</span></span><br><span class="line">    <span class="keyword">size_t</span>    num_entries;</span><br><span class="line">    <span class="comment">// å‚ä¸åˆ¤æ–­å¼•ç”¨è®¡æ•°è¾…åŠ©é‡</span></span><br><span class="line">    <span class="keyword">uintptr_t</span> mask;</span><br><span class="line">    <span class="comment">// hash key æœ€å¤§åç§»å€¼</span></span><br><span class="line">    <span class="keyword">uintptr_t</span> max_hash_displacement;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>è¿™æ˜¯ä¸€ä¸ªå…¨å±€å¼±å¼•ç”¨hashè¡¨ã€‚ä½¿ç”¨ä¸å®šç±»å‹å¯¹è±¡çš„åœ°å€ä½œä¸º key ï¼Œç”¨ weak_entry_t ç±»å‹ç»“æ„ä½“å¯¹è±¡ä½œä¸º value ã€‚å…¶ä¸­çš„ weak_entries æˆå‘˜ï¼Œä»å­—é¢æ„æ€ä¸Šçœ‹ï¼Œå³ä¸ºå¼±å¼•ç”¨è¡¨å…¥å£ã€‚å…¶å®ç°ä¹Ÿæ˜¯è¿™æ ·çš„ã€‚</p>
<p>å…¶ä¸­weak_entry_tæ˜¯å­˜å‚¨åœ¨å¼±å¼•ç”¨è¡¨ä¸­çš„ä¸€ä¸ªå†…éƒ¨ç»“æ„ä½“ï¼Œå®ƒè´Ÿè´£ç»´æŠ¤å’Œå­˜å‚¨æŒ‡å‘ä¸€ä¸ªå¯¹è±¡çš„æ‰€æœ‰å¼±å¼•ç”¨hashè¡¨ã€‚å…¶å®šä¹‰å¦‚ä¸‹ï¼š</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> objc_object ** <span class="keyword">weak_referrer_t</span>;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">weak_entry_t</span> &#123;</span></span><br><span class="line">    DisguisedPtrobjc_object&gt; referent;</span><br><span class="line">    <span class="keyword">union</span> &#123;</span><br><span class="line">        <span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line">            <span class="keyword">weak_referrer_t</span> *referrers;</span><br><span class="line">            <span class="keyword">uintptr_t</span>        out_of_line : <span class="number">1</span>;</span><br><span class="line">            <span class="keyword">uintptr_t</span>        num_refs : PTR_MINUS_1;</span><br><span class="line">            <span class="keyword">uintptr_t</span>        mask;</span><br><span class="line">            <span class="keyword">uintptr_t</span>        max_hash_displacement;</span><br><span class="line">        &#125;;</span><br><span class="line">        <span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line">            <span class="comment">// out_of_line=0 is LSB of one of these (don't care which)</span></span><br><span class="line">            <span class="keyword">weak_referrer_t</span>  inline_referrers[WEAK_INLINE_COUNT];</span><br><span class="line">        &#125;;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>åœ¨ weak_entry_t çš„ç»“æ„ä¸­ï¼ŒDisguisedPtr referent æ˜¯å¯¹æ³›å‹å¯¹è±¡çš„æŒ‡é’ˆåšäº†ä¸€ä¸ªå°è£…ï¼Œé€šè¿‡è¿™ä¸ªæ³›å‹ç±»æ¥è§£å†³å†…å­˜æ³„æ¼çš„é—®é¢˜ã€‚ä»æ³¨é‡Šä¸­å†™ out_of_line æˆå‘˜ä¸ºæœ€ä½æœ‰æ•ˆä½ï¼Œå½“å…¶ä¸º0çš„æ—¶å€™ï¼Œ weak_referrer_t æˆå‘˜å°†æ‰©å±•ä¸ºå¤šè¡Œé™æ€ hash tableã€‚</p>
<p>å…¶å®å…¶ä¸­çš„ weak_referrer_t æ˜¯äºŒç»´ objc_object çš„åˆ«åï¼Œé€šè¿‡ä¸€ä¸ªäºŒç»´æŒ‡é’ˆåœ°å€åç§»ï¼Œç”¨ä¸‹æ ‡ä½œä¸º hash çš„ keyï¼Œåšæˆäº†ä¸€ä¸ªå¼±å¼•ç”¨æ•£åˆ—ã€‚</p>
<p>out_of_line çš„å€¼é€šå¸¸æƒ…å†µä¸‹æ˜¯ç­‰äºé›¶çš„ï¼Œæ‰€ä»¥å¼±å¼•ç”¨è¡¨æ€»æ˜¯ä¸€ä¸ª objc_objective æŒ‡é’ˆäºŒç»´æ•°ç»„ã€‚ä¸€ç»´ objc_objective æŒ‡é’ˆå¯æ„æˆä¸€å¼ å¼±å¼•ç”¨æ•£åˆ—è¡¨ï¼Œé€šè¿‡ç¬¬ä¸‰çº¬åº¦å®ç°äº†å¤šå¼ æ•£åˆ—è¡¨ï¼Œå¹¶ä¸”è¡¨æ•°é‡ä¸º WEAK_INLINE_COUNT ã€‚</p>
<p>StripedMap æ˜¯ä¸€ä¸ªæ¨¡æ¿ç±»ï¼Œåœ¨è¿™ä¸ªç±»ä¸­æœ‰ä¸€ä¸ª array æˆå‘˜ï¼Œç”¨æ¥å­˜å‚¨ PaddedT å¯¹è±¡ï¼Œå¹¶ä¸”å…¶ä¸­å¯¹äº [] ç¬¦çš„é‡è½½å®šä¹‰ä¸­ï¼Œä¼šè¿”å›è¿™ä¸ª PaddedT çš„ value æˆå‘˜ï¼Œè¿™ä¸ª value å°±æ˜¯æˆ‘ä»¬ä¼ å…¥çš„ T æ³›å‹æˆå‘˜ï¼Œä¹Ÿå°±æ˜¯ SideTable å¯¹è±¡ã€‚</p>
<p>åœ¨ array çš„ä¸‹æ ‡ä¸­ï¼Œè¿™é‡Œä½¿ç”¨äº† indexForPointer æ–¹æ³•é€šè¿‡ä½è¿ç®—è®¡ç®—ä¸‹æ ‡ï¼Œå®ç°äº†é™æ€çš„ Hash Tableã€‚è€Œåœ¨ weak_table ä¸­ï¼Œå…¶æˆå‘˜ weak_entry ä¼šå°†ä¼ å…¥å¯¹è±¡çš„åœ°å€åŠ ä»¥å°è£…èµ·æ¥ï¼Œå¹¶ä¸”å…¶ä¸­ä¹Ÿæœ‰è®¿é—®å…¨å±€å¼±å¼•ç”¨è¡¨çš„å…¥å£ã€‚</p>
<p><img src="https://user-gold-cdn.xitu.io/2018/6/12/163f30ecf0d7c7df?w=589&amp;h=563&amp;f=png&amp;s=79568" alt=""></p>
<p>æ—§å¯¹è±¡è§£é™¤æ³¨å†Œæ“ä½œ weak_unregister_no_lock</p>
<p>è¯¥æ–¹æ³•ä¸»è¦ä½œç”¨æ˜¯å°†æ—§å¯¹è±¡åœ¨ weak_table ä¸­æ¥è§¦ weak æŒ‡é’ˆçš„å¯¹åº”ç»‘å®šã€‚æ ¹æ®å‡½æ•°åï¼Œç§°ä¹‹ä¸ºè§£é™¤æ³¨å†Œæ“ä½œã€‚ä»æºç ä¸­ï¼Œå¯ä»¥çŸ¥é“å…¶åŠŸèƒ½å°±æ˜¯ä» weak_table ä¸­æ¥è§¦ weak æŒ‡é’ˆçš„ç»‘å®šã€‚è€Œå…¶ä¸­çš„éå†æŸ¥è¯¢ï¼Œå°±æ˜¯é’ˆå¯¹äº weak_entry ä¸­çš„å¤šå¼ å¼±å¼•ç”¨æ•£åˆ—è¡¨ã€‚</p>
<p>æ–°å¯¹è±¡æ·»åŠ æ³¨å†Œæ“ä½œ weak_register_no_lock</p>
<p>è¿™ä¸€æ­¥ä¸ä¸Šä¸€æ­¥ç›¸åï¼Œé€šè¿‡ weak_register_no_lock å‡½æ•°æŠŠå¿ƒçš„å¯¹è±¡è¿›è¡Œæ³¨å†Œæ“ä½œï¼Œå®Œæˆä¸å¯¹åº”çš„å¼±å¼•ç”¨è¡¨è¿›è¡Œç»‘å®šæ“ä½œã€‚</p>
<p>â‘¢ åˆå§‹åŒ–å¼±å¼•ç”¨å¯¹è±¡æµç¨‹ä¸€è§ˆ</p>
<p>å¼±å¼•ç”¨çš„åˆå§‹åŒ–ï¼Œä»ä¸Šæ–‡çš„åˆ†æä¸­å¯ä»¥çœ‹å‡ºï¼Œä¸»è¦çš„æ“ä½œéƒ¨åˆ†å°±åœ¨å¼±å¼•ç”¨è¡¨çš„å–é”®ã€æŸ¥è¯¢æ•£åˆ—ã€åˆ›å»ºå¼±å¼•ç”¨è¡¨ç­‰æ“ä½œï¼Œå¯ä»¥æ€»ç»“å‡ºå¦‚ä¸‹çš„æµç¨‹å›¾ï¼š</p>
<p><img src="https://user-gold-cdn.xitu.io/2018/6/12/163f30ed0395bee2?w=547&amp;h=595&amp;f=png&amp;s=74638" alt=""></p>
<p>è¿™ä¸ªå›¾ä¸­çœç•¥äº†å¾ˆå¤šæƒ…å†µçš„åˆ¤æ–­ï¼Œä½†æ˜¯å½“å£°æ˜ä¸€ä¸ª weak ä¼šè°ƒç”¨ä¸Šå›¾ä¸­çš„è¿™äº›æ–¹æ³•ã€‚å½“ç„¶ï¼Œ storeWeak æ–¹æ³•ä¸ä»…ä»…ç”¨åœ¨ weak çš„å£°æ˜ä¸­ï¼Œåœ¨ class å†…éƒ¨çš„æ“ä½œä¸­ä¹Ÿä¼šå¸¸å¸¸é€šè¿‡è¯¥æ–¹æ³•æ¥å¯¹ weak å¯¹è±¡è¿›è¡Œæ“ä½œã€‚</p>
<p>3ï¼‰é‡Šæ”¾æ—¶ï¼Œè°ƒç”¨clearDeallocatingå‡½æ•°ã€‚clearDeallocatingå‡½æ•°é¦–å…ˆæ ¹æ®å¯¹è±¡åœ°å€è·å–æ‰€æœ‰weakæŒ‡é’ˆåœ°å€çš„æ•°ç»„ï¼Œç„¶åéå†è¿™ä¸ªæ•°ç»„æŠŠå…¶ä¸­çš„æ•°æ®è®¾ä¸ºnilï¼Œæœ€åæŠŠè¿™ä¸ªentryä»weakè¡¨ä¸­åˆ é™¤ï¼Œæœ€åæ¸…ç†å¯¹è±¡çš„è®°å½•ã€‚</p>
<p>å½“weakå¼•ç”¨æŒ‡å‘çš„å¯¹è±¡è¢«é‡Šæ”¾æ—¶ï¼Œåˆæ˜¯å¦‚ä½•å»å¤„ç†weakæŒ‡é’ˆçš„å‘¢ï¼Ÿå½“é‡Šæ”¾å¯¹è±¡æ—¶ï¼Œå…¶åŸºæœ¬æµç¨‹å¦‚ä¸‹ï¼š</p>
<ul>
<li>1ã€è°ƒç”¨objc_release</li>
<li>2ã€å› ä¸ºå¯¹è±¡çš„å¼•ç”¨è®¡æ•°ä¸º0ï¼Œæ‰€ä»¥æ‰§è¡Œdealloc</li>
<li>3ã€åœ¨deallocä¸­ï¼Œè°ƒç”¨äº†_objc_rootDeallocå‡½æ•°</li>
<li>4ã€åœ¨_objc_rootDeallocä¸­ï¼Œè°ƒç”¨äº†object_disposeå‡½æ•°</li>
<li>5ã€è°ƒç”¨objc_destructInstance</li>
<li>6ã€æœ€åè°ƒç”¨objc_clear_deallocating</li>
</ul>
<p>é‡ç‚¹çœ‹å¯¹è±¡è¢«é‡Šæ”¾æ—¶è°ƒç”¨çš„objc_clear_deallocatingå‡½æ•°ã€‚</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">objc_clear_deallocating</span><span class="params">(id obj)</span> </span>&#123;</span><br><span class="line">    assert(obj);</span><br><span class="line">    assert(!UseGC);</span><br><span class="line">    <span class="keyword">if</span> (obj-&gt;isTaggedPointer()) <span class="keyword">return</span>;</span><br><span class="line">    obj-&gt;clearDeallocating();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ä¹Ÿå°±æ˜¯è°ƒç”¨äº†clearDeallocatingï¼Œç»§ç»­è¿½è¸ªå¯ä»¥å‘ç°ï¼Œå®ƒæœ€ç»ˆæ˜¯ä½¿ç”¨äº†è¿­ä»£å™¨æ¥å–weakè¡¨çš„valueï¼Œç„¶åè°ƒç”¨weak_clear_no_lock,ç„¶åæŸ¥æ‰¾å¯¹åº”çš„valueï¼Œå°†è¯¥weakæŒ‡é’ˆç½®ç©ºï¼Œweak_clear_no_lockå‡½æ•°çš„å®ç°å¦‚ä¸‹ï¼š</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">* Called by dealloc; nils out all weak pointers that point to the</span></span><br><span class="line"><span class="comment">* provided object so that they can no longer be used.</span></span><br><span class="line"><span class="comment">*</span></span><br><span class="line"><span class="comment">* @param weak_table</span></span><br><span class="line"><span class="comment">* @param referent The object being deallocated.</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">weak_clear_no_lock</span><span class="params">(<span class="keyword">weak_table_t</span> *weak_table, id referent_id)</span> </span>&#123;</span><br><span class="line">    objc_object *referent = (objc_object *)referent_id;</span><br><span class="line">    <span class="keyword">weak_entry_t</span> *entry = weak_entry_for_referent(weak_table, referent);</span><br><span class="line">    <span class="keyword">if</span> (entry == nil) &#123;</span><br><span class="line">        <span class="comment">/// XXX shouldn't happen, but does with mismatched CF/objc</span></span><br><span class="line">        <span class="comment">//printf("XXX no entry for clear deallocating %p\n", referent);</span></span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// zero out references</span></span><br><span class="line">    <span class="keyword">weak_referrer_t</span> *referrers;</span><br><span class="line">    <span class="keyword">size_t</span> count;</span><br><span class="line">    <span class="keyword">if</span> (entry-&gt;out_of_line) &#123;</span><br><span class="line">        referrers = entry-&gt;referrers;</span><br><span class="line">        count = TABLE_SIZE(entry);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> &#123;</span><br><span class="line">        referrers = entry-&gt;inline_referrers;</span><br><span class="line">        count = WEAK_INLINE_COUNT;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">size_t</span> i = <span class="number">0</span>; i &lt; count; ++i) &#123;</span><br><span class="line">        objc_object **referrer = referrers[i];</span><br><span class="line">        <span class="keyword">if</span> (referrer) &#123;</span><br><span class="line">            <span class="keyword">if</span> (*referrer == referent) &#123;</span><br><span class="line">                *referrer = nil;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span> <span class="keyword">if</span> (*referrer) &#123;</span><br><span class="line">                _objc_inform(<span class="string">"__weak variable at %p holds %p instead of %p. "</span></span><br><span class="line">                <span class="string">"This is probably incorrect use of "</span></span><br><span class="line">                <span class="string">"objc_storeWeak() and objc_loadWeak(). "</span></span><br><span class="line">                <span class="string">"Break on objc_weak_error to debug.\n"</span>,</span><br><span class="line">                referrer, (<span class="keyword">void</span>*)*referrer, (<span class="keyword">void</span>*)referent);</span><br><span class="line">                objc_weak_error();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    weak_entry_remove(weak_table, entry);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>objc_clear_deallocating å®ç°å¦‚ä¸‹</p>
<ul>
<li>1ã€ä»weakè¡¨ä¸­è·å–åºŸå¼ƒå¯¹è±¡çš„åœ°å€ä¸ºé”®å€¼çš„è®°å½•</li>
<li>2ã€å°†åŒ…å«åœ¨è®°å½•ä¸­çš„æ‰€æœ‰é™„æœ‰ weakä¿®é¥°ç¬¦å˜é‡çš„åœ°å€ï¼Œèµ‹å€¼ä¸ºnil</li>
<li>3ã€å°†weakè¡¨ä¸­è¯¥è®°å½•åˆ é™¤</li>
<li>4ã€ä»å¼•ç”¨è®¡æ•°è¡¨ä¸­åˆ é™¤åºŸå¼ƒå¯¹è±¡çš„åœ°å€ä¸ºé”®å€¼çš„è®°å½•</li>
</ul>
<p>æ³¨é‡Šï¼šå“ˆå¸Œè¡¨æœ€å¤§çš„ä¼˜ç‚¹å°±æ˜¯æŠŠæ•°æ®çš„å­˜å‚¨å’ŒæŸ¥æ‰¾æ¶ˆè€—çš„æ—¶é—´å¤§å¤§é™ä½ï¼Œå‡ ä¹å¯ä»¥çœ‹æˆæ˜¯å¸¸æ•°æ—¶é—´ï¼›è€Œä»£ä»·ä»…ä»…æ˜¯æ¶ˆè€—æ¯”è¾ƒå¤šçš„å†…å­˜ã€‚ç„¶è€Œåœ¨å½“å‰å¯åˆ©ç”¨å†…å­˜è¶Šæ¥è¶Šå¤šçš„æƒ…å†µä¸‹ï¼Œç”¨ç©ºé—´æ¢æ—¶é—´çš„åšæ³•æ˜¯å€¼å¾—çš„ã€‚å¦å¤–ï¼Œç¼–ç æ¯”è¾ƒå®¹æ˜“ä¹Ÿæ˜¯å®ƒçš„ç‰¹ç‚¹ä¹‹ä¸€ã€‚</p>
<blockquote>
<p>ä»¥ä¸ŠåŸç†è§£ææ–‡ç« æ¥æºï¼š<a href="http://www.cocoachina.com/ios/20170328/18962.html" target="_blank" rel="noopener">http://www.cocoachina.com/ios/20170328/18962.html</a></p>
</blockquote>

      
    </div>
    <footer class="article-footer">
      
        <div id="donation_div"></div>

<script src="../../../../js/vdonate.js"></script>
<script>
var a = new Donate({
  title: 'å¦‚æœè§‰å¾—æˆ‘çš„æ–‡ç« å¯¹æ‚¨æœ‰ç”¨ï¼Œè¯·éšæ„æ‰“èµã€‚æ‚¨çš„æ”¯æŒå°†é¼“åŠ±æˆ‘ç»§ç»­åˆ›ä½œ!', // å¯é€‰å‚æ•°ï¼Œæ‰“èµæ ‡é¢˜
  btnText: 'Donate', // å¯é€‰å‚æ•°ï¼Œæ‰“èµæŒ‰é’®æ–‡å­—
  el: document.getElementById('donation_div'),
  wechatImage: 'http://ghexoblogimages.oss-cn-beijing.aliyuncs.com/18-11-14/6067039.jpg',
  alipayImage: 'http://ghexoblogimages.oss-cn-beijing.aliyuncs.com/18-11-16/6997594.jpg'
});
</script>
      
      
      
        
	<div id="comment">
		<!-- æ¥å¿…åŠ›Cityç‰ˆå®‰è£…ä»£ç  -->
		<div id="lv-container" data-id="city" data-uid="MTAyMC80MTA5OC8xNzYyMw==">
		<script type="text/javascript">
		   (function(d, s) {
		       var j, e = d.getElementsByTagName(s)[0];

		       if (typeof LivereTower === 'function') { return; }

		       j = d.createElement(s);
		       j.src = 'https://cdn-city.livere.com/js/embed.dist.js';
		       j.async = true;

		       e.parentNode.insertBefore(j, e);
		   })(document, 'script');
		</script>
		<noscript>ä¸ºæ­£å¸¸ä½¿ç”¨æ¥å¿…åŠ›è¯„è®ºåŠŸèƒ½è¯·æ¿€æ´»JavaScript</noscript>
		</div>
		<!-- Cityç‰ˆå®‰è£…ä»£ç å·²å®Œæˆ -->
	</div>



      
      

    </footer>
  </div>
  
    
<nav id="article-nav">
  
    <a href="../../14/iOS Principle CALayer/" id="article-nav-newer" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Newer</strong>
      <div class="article-nav-title">
        
          iOS Principleï¼šCALayer
        
      </div>
    </a>
  
  
    <a href="../../12/iOS Principle Notification/" id="article-nav-older" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Older</strong>
      <div class="article-nav-title">iOS Principleï¼šNotification</div>
    </a>
  
</nav>

  
</article>

<!-- Table of Contents -->

  <aside id="toc-sidebar">
    <div id="toc" class="toc-article">
    <strong class="toc-title">Contents</strong>
    
        <ol class="nav"><li class="nav-item nav-level-3"><a class="nav-link" href="#æ–¹ä¾¿è®°å¿†ï¼š"><span class="nav-number">1.</span> <span class="nav-text">æ–¹ä¾¿è®°å¿†ï¼š</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#å¼•æ–‡"><span class="nav-number">2.</span> <span class="nav-text">å¼•æ–‡</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#å®ç°åŸç†"><span class="nav-number">3.</span> <span class="nav-text">å®ç°åŸç†</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#åˆ†æ­¥è§£æå†…éƒ¨å®ç°ï¼š"><span class="nav-number">4.</span> <span class="nav-text">åˆ†æ­¥è§£æå†…éƒ¨å®ç°ï¼š</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#æ‹†åˆ†è§£æä¸Šè¿°ä»£ç "><span class="nav-number">5.</span> <span class="nav-text">æ‹†åˆ†è§£æä¸Šè¿°ä»£ç </span></a></li></ol>
    
    </div>
  </aside>

</section>
        
      </div>
      
      <footer id="footer">
  

  <div class="container">
      	<div class="row">
	      <p> Powered by <a href="http://hexo.io/" target="_blank">Hexo</a> and <a href="https://github.com/iTimeTraveler/hexo-theme-hiker" target="_blank">Hexo-theme-hiker</a> </p>
	      <p id="copyRightEn">Copyright &copy; 2013 - 2018 Technology All Rights Reserved.</p>
	      
	      
    		<p class="busuanzi_uv">
				UV : <span id="busuanzi_value_site_uv"></span> |  
				PV : <span id="busuanzi_value_site_pv"></span>
		    </p>
  		   
		</div>

		
  </div>
</footer>


<!-- min height -->

<script>
    var wrapdiv = document.getElementById("wrap");
    var contentdiv = document.getElementById("content");
    var allheader = document.getElementById("allheader");

    wrapdiv.style.minHeight = document.body.offsetHeight + "px";
    if (allheader != null) {
      contentdiv.style.minHeight = document.body.offsetHeight - allheader.offsetHeight - document.getElementById("footer").offsetHeight + "px";
    } else {
      contentdiv.style.minHeight = document.body.offsetHeight - document.getElementById("footer").offsetHeight + "px";
    }
</script>
    </div>
    <!-- <nav id="mobile-nav">
  
    <a href="../../../../index.html" class="mobile-nav-link">Home</a>
  
    <a href="../../../../archives" class="mobile-nav-link">Archives</a>
  
    <a href="../../../../categories" class="mobile-nav-link">Categories</a>
  
    <a href="../../../../tags" class="mobile-nav-link">Tags</a>
  
    <a href="../../../../about" class="mobile-nav-link">About</a>
  
</nav> -->
    

<!-- mathjax config similar to math.stackexchange -->

<script type="text/x-mathjax-config">
  MathJax.Hub.Config({
    tex2jax: {
      inlineMath: [ ['$','$'], ["\\(","\\)"] ],
      processEscapes: true
    }
  });
</script>

<script type="text/x-mathjax-config">
    MathJax.Hub.Config({
      tex2jax: {
        skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
      }
    });
</script>

<script type="text/x-mathjax-config">
    MathJax.Hub.Queue(function() {
        var all = MathJax.Hub.getAllJax(), i;
        for(i=0; i < all.length; i += 1) {
            all[i].SourceElement().parentNode.className += ' has-jax';
        }
    });
</script>

<script type="text/javascript" src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
</script>


  <link rel="stylesheet" href="../../../../fancybox/jquery.fancybox.css">
  <script src="../../../../fancybox/jquery.fancybox.pack.js"></script>


<script src="../../../../js/scripts.js"></script>




  <script src="../../../../js/dialog.js"></script>








	<div style="display: none;">
    <script src="https://s95.cnzz.com/z_stat.php?id=1260716016&web_id=1260716016" language="JavaScript"></script>
  </div>



	<script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js">
	</script>






  </div>

  <div class="modal fade" id="myModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true" style="display: none;">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h2 class="modal-title" id="myModalLabel">è®¾ç½®</h2>
      </div>
      <hr style="margin-top:0px; margin-bottom:0px; width:80%; border-top: 3px solid #000;">
      <hr style="margin-top:2px; margin-bottom:0px; width:80%; border-top: 1px solid #000;">


      <div class="modal-body">
          <div style="margin:6px;">
            <a data-toggle="collapse" data-parent="#accordion" href="#collapseOne" onclick="javascript:setFontSize();" aria-expanded="true" aria-controls="collapseOne">
              æ­£æ–‡å­—å·å¤§å°
            </a>
          </div>
          <div id="collapseOne" class="panel-collapse collapse" role="tabpanel" aria-labelledby="headingOne">
          <div class="panel-body">
            æ‚¨å·²è°ƒæ•´é¡µé¢å­—ä½“å¤§å°
          </div>
        </div>
      


          <div style="margin:6px;">
            <a data-toggle="collapse" data-parent="#accordion" href="#collapseTwo" onclick="javascript:setBackground();" aria-expanded="true" aria-controls="collapseTwo">
              å¤œé—´æŠ¤çœ¼æ¨¡å¼
            </a>
        </div>
          <div id="collapseTwo" class="panel-collapse collapse" role="tabpanel" aria-labelledby="headingTwo">
          <div class="panel-body">
            å¤œé—´æ¨¡å¼å·²ç»å¼€å¯ï¼Œå†æ¬¡å•å‡»æŒ‰é’®å³å¯å…³é—­ 
          </div>
        </div>

        <div>
            <a data-toggle="collapse" data-parent="#accordion" href="#collapseThree" aria-expanded="true" aria-controls="collapseThree">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;å…³ äº&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</a>
        </div>
         <div id="collapseThree" class="panel-collapse collapse" role="tabpanel" aria-labelledby="headingThree">
          <div class="panel-body">
            Technology
          </div>
          <div class="panel-body">
            Copyright Â© 2018 Steven&#39;s Blog All Rights Reserved.
          </div>
        </div>
      </div>


      <hr style="margin-top:0px; margin-bottom:0px; width:80%; border-top: 1px solid #000;">
      <hr style="margin-top:2px; margin-bottom:0px; width:80%; border-top: 3px solid #000;">
      <div class="modal-footer">
        <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">Ã—</span></button>
      </div>
    </div>
  </div>
</div>
  
  <a id="rocket" href="#top" class=""></a>
  <script type="text/javascript" src="/js/totop.js?v=1.0.0" async=""></script>
  
    <a id="menu-switch"><i class="fa fa-bars fa-lg"></i></a>
  
</body>
</html>