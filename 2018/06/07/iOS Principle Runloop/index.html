<!DOCTYPE html>
<html>
<head><meta name="generator" content="Hexo 3.8.0">
  <meta charset="utf-8">
  
  <title>ios principleï¼šrunloop | Technology</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  
    <meta name="keywords" content="Principle">
  
  
  
  
  <meta name="description" content="ä¸€ä¸ªçº¿ç¨‹ä¸€æ¬¡åªèƒ½æ‰§è¡Œä¸€ä¸ªä»»åŠ¡ï¼Œæ‰§è¡Œå®Œæˆåçº¿ç¨‹å°±ä¼šé€€å‡ºã€‚RunLoop æœºåˆ¶èƒ½è®©çº¿ç¨‹éšæ—¶å¤„ç†äº‹ä»¶ä½†å¹¶ä¸é€€å‡ºã€‚è¿™é‡Œè¯´çš„éšæ—¶æ˜¯æŒ‡ï¼šç¨‹åºéœ€è¦è¿è¡Œæ—¶å°±ä¿æŒç¨‹åºçš„æŒç»­è¿è¡Œï¼Œä¸éœ€è¦çš„æ—¶å€™å°±è¿›å…¥ä¼‘çœ çŠ¶æ€~">
<meta name="keywords" content="Principle">
<meta property="og:type" content="article">
<meta property="og:title" content="iOS Principleï¼šRunloop">
<meta property="og:url" content="https://reversescale.github.io/2018/06/07/iOS Principle Runloop/index.html">
<meta property="og:site_name" content="Technology">
<meta property="og:description" content="ä¸€ä¸ªçº¿ç¨‹ä¸€æ¬¡åªèƒ½æ‰§è¡Œä¸€ä¸ªä»»åŠ¡ï¼Œæ‰§è¡Œå®Œæˆåçº¿ç¨‹å°±ä¼šé€€å‡ºã€‚RunLoop æœºåˆ¶èƒ½è®©çº¿ç¨‹éšæ—¶å¤„ç†äº‹ä»¶ä½†å¹¶ä¸é€€å‡ºã€‚è¿™é‡Œè¯´çš„éšæ—¶æ˜¯æŒ‡ï¼šç¨‹åºéœ€è¦è¿è¡Œæ—¶å°±ä¿æŒç¨‹åºçš„æŒç»­è¿è¡Œï¼Œä¸éœ€è¦çš„æ—¶å€™å°±è¿›å…¥ä¼‘çœ çŠ¶æ€~">
<meta property="og:locale" content="default">
<meta property="og:image" content="https://user-gold-cdn.xitu.io/2018/6/4/163ca0a711125edd?w=495&h=261&f=png&s=66608">
<meta property="og:image" content="https://user-gold-cdn.xitu.io/2018/6/4/163ca0a716b8c1a4?w=950&h=334&f=png&s=344630">
<meta property="og:image" content="https://user-gold-cdn.xitu.io/2018/6/4/163ca0a7173c2a6d?w=1090&h=243&f=png&s=222065">
<meta property="og:image" content="https://user-gold-cdn.xitu.io/2018/6/4/163ca0a715aef5d2?w=1102&h=248&f=png&s=249879">
<meta property="og:image" content="https://user-gold-cdn.xitu.io/2018/6/4/163ca0a73688953e?w=364&h=278&f=png&s=33982">
<meta property="og:image" content="https://user-gold-cdn.xitu.io/2018/6/4/163ca0a73f1b5791?w=439&h=383&f=png&s=244833">
<meta property="og:image" content="https://user-gold-cdn.xitu.io/2018/6/4/163ca0a717288734?w=495&h=261&f=png&s=66608">
<meta property="og:image" content="https://user-gold-cdn.xitu.io/2018/6/4/163ca0a716fed87e?w=747&h=746&f=png&s=119107">
<meta property="og:updated_time" content="2018-11-18T05:30:32.020Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="iOS Principleï¼šRunloop">
<meta name="twitter:description" content="ä¸€ä¸ªçº¿ç¨‹ä¸€æ¬¡åªèƒ½æ‰§è¡Œä¸€ä¸ªä»»åŠ¡ï¼Œæ‰§è¡Œå®Œæˆåçº¿ç¨‹å°±ä¼šé€€å‡ºã€‚RunLoop æœºåˆ¶èƒ½è®©çº¿ç¨‹éšæ—¶å¤„ç†äº‹ä»¶ä½†å¹¶ä¸é€€å‡ºã€‚è¿™é‡Œè¯´çš„éšæ—¶æ˜¯æŒ‡ï¼šç¨‹åºéœ€è¦è¿è¡Œæ—¶å°±ä¿æŒç¨‹åºçš„æŒç»­è¿è¡Œï¼Œä¸éœ€è¦çš„æ—¶å€™å°±è¿›å…¥ä¼‘çœ çŠ¶æ€~">
<meta name="twitter:image" content="https://user-gold-cdn.xitu.io/2018/6/4/163ca0a711125edd?w=495&h=261&f=png&s=66608">
  
    <link rel="alternate" href="/atom.xml" title="Technology" type="application/atom+xml">
  

  

  <link rel="icon" href="/css/images/docccc.png">
  <link rel="apple-touch-icon" href="/css/images/docccc.png">
  
    <link href="//fonts.googleapis.com/css?family=Source+Code+Pro" rel="stylesheet" type="text/css">
  
  <link href="https://fonts.googleapis.com/css?family=Open+Sans|Montserrat:700" rel="stylesheet" type="text/css">
  <link href="https://fonts.googleapis.com/css?family=Roboto:400,300,300italic,400italic" rel="stylesheet" type="text/css">
  <link href="//cdn.bootcss.com/font-awesome/4.6.3/css/font-awesome.min.css" rel="stylesheet">
  <style type="text/css">
    @font-face{font-family:futura-pt;src:url(https://use.typekit.net/af/9749f0/00000000000000000001008f/27/l?subset_id=2&fvd=n5) format("woff2");font-weight:500;font-style:normal;}
    @font-face{font-family:futura-pt;src:url(https://use.typekit.net/af/90cf9f/000000000000000000010091/27/l?subset_id=2&fvd=n7) format("woff2");font-weight:500;font-style:normal;}
    @font-face{font-family:futura-pt;src:url(https://use.typekit.net/af/8a5494/000000000000000000013365/27/l?subset_id=2&fvd=n4) format("woff2");font-weight:lighter;font-style:normal;}
    @font-face{font-family:futura-pt;src:url(https://use.typekit.net/af/d337d8/000000000000000000010095/27/l?subset_id=2&fvd=i4) format("woff2");font-weight:400;font-style:italic;}</style>
  <link rel="stylesheet" href="../../../../css/style.css">

  <script src="../../../../js/jquery-3.1.1.min.js"></script>
  <script src="../../../../js/bootstrap.js"></script>

  <!-- Bootstrap core CSS -->
  <link rel="stylesheet" href="/css/bootstrap.css">

  
    <link rel="stylesheet" href="../../../../css/dialog.css">
  

  

  
    <link rel="stylesheet" href="/css/header-post.css">
  

  
  
  
    <link rel="stylesheet" href="/css/vdonate.css">
  

</head>
</html>


  <body data-spy="scroll" data-target="#toc" data-offset="50">


  
  <div id="container">
    <div id="wrap">
      
        <header>

    <div id="allheader" class="navbar navbar-default navbar-static-top" role="navigation">
        <div class="navbar-inner">
          
          <div class="container"> 
            <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
              <span class="sr-only">Toggle navigation</span>
              <span class="icon-bar"></span>
              <span class="icon-bar"></span>
              <span class="icon-bar"></span>
            </button>

            
              <a class="brand" style="
                 border-width: 0px;  margin-top: 0px;" href="#" data-toggle="modal" data-target="#myModal">
                  <img width="88px" height="88px" alt="Hike News" src="/css/images/docccc.png">
              </a>
            
            
            <div class="navbar-collapse collapse">
              <ul class="hnav navbar-nav">
                
                  <li> <a class="main-nav-link" href="../../../../index.html">Home</a> </li>
                
                  <li> <a class="main-nav-link" href="../../../../archives">Archives</a> </li>
                
                  <li> <a class="main-nav-link" href="../../../../categories">Categories</a> </li>
                
                  <li> <a class="main-nav-link" href="../../../../tags">Tags</a> </li>
                
                  <li> <a class="main-nav-link" href="../../../../about">About</a> </li>
                
                  <li><div id="search-form-wrap">

    <form class="search-form">
        <input type="text" class="ins-search-input search-form-input" placeholder="">
        <button type="submit" class="search-form-submit"></button>
    </form>
    <div class="ins-search">
    <div class="ins-search-mask"></div>
    <div class="ins-search-container">
        <div class="ins-input-wrapper">
            <input type="text" class="ins-search-input" placeholder="Type something...">
            <span class="ins-close ins-selectable"><i class="fa fa-times-circle"></i></span>
        </div>
        <div class="ins-section-wrapper">
            <div class="ins-section-container"></div>
        </div>
    </div>
</div>
<script>
(function (window) {
    var INSIGHT_CONFIG = {
        TRANSLATION: {
            POSTS: 'Posts',
            PAGES: 'Pages',
            CATEGORIES: 'Categories',
            TAGS: 'Tags',
            UNTITLED: '(Untitled)',
        },
        ROOT_URL: '/',
        CONTENT_URL: '../../../../content.json',
    };
    window.INSIGHT_CONFIG = INSIGHT_CONFIG;
})(window);
</script>
<script src="../../../../js/insight.js"></script>

</div></li>
            </ul></div>
          </div>
                
      </div>
    </div>

</header>



      
            
      <div id="content" class="outer">
        
          <section id="main" style="float:none;"><article id="post-iOS Principle Runloop" style="width: 75%; float:left;" class="article article-type-post" itemscope="" itemprop="blogPost">
  <div id="articleInner" class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 class="thumb" itemprop="name">
      iOS Principleï¼šRunloop
    </h1>
  

      </header>
    
    <div class="article-meta">
      
	<a href="" class="article-date">
	  <time datetime="2018-06-07T13:56:27.000Z" itemprop="datePublished">2018-06-07</time>
	</a>

      
    <a class="article-category-link" href="../../../../categories/Principle/">Principle</a>

      
	<a class="article-views">
	<span id="busuanzi_container_page_pv">
		PV:<span id="busuanzi_value_page_pv"></span>
	</span>
	</a>

    </div>
    <div class="article-entry" itemprop="articleBody">
      
        <p>ä¸€ä¸ªçº¿ç¨‹ä¸€æ¬¡åªèƒ½æ‰§è¡Œä¸€ä¸ªä»»åŠ¡ï¼Œæ‰§è¡Œå®Œæˆåçº¿ç¨‹å°±ä¼šé€€å‡ºã€‚RunLoop æœºåˆ¶èƒ½è®©çº¿ç¨‹éšæ—¶å¤„ç†äº‹ä»¶ä½†å¹¶ä¸é€€å‡ºã€‚è¿™é‡Œè¯´çš„éšæ—¶æ˜¯æŒ‡ï¼šç¨‹åºéœ€è¦è¿è¡Œæ—¶å°±ä¿æŒç¨‹åºçš„æŒç»­è¿è¡Œï¼Œä¸éœ€è¦çš„æ—¶å€™å°±è¿›å…¥ä¼‘çœ çŠ¶æ€~ </p>
<a id="more"></a>
<hr>
<p>ğŸ‘¨ğŸ»â€ğŸ’» <a href="https://github.com/ReverseScale/iOSPrinciple_Runloop" target="_blank" rel="noopener">Github Demo</a></p>
<h3 id="æ–¹ä¾¿è®°å¿†ï¼š"><a href="#æ–¹ä¾¿è®°å¿†ï¼š" class="headerlink" title="æ–¹ä¾¿è®°å¿†ï¼š"></a>æ–¹ä¾¿è®°å¿†ï¼š</h3><ul>
<li>å®è´¨ä½œç”¨ï¼šä¿è¯åœ¨éœ€è¦çš„æ—¶å€™è‡ªå·±è·‘èµ·æ¥è¿è¡Œï¼Œåœ¨æ²¡æœ‰æ“ä½œçš„æ—¶å€™å°±åœä¸‹æ¥ä¼‘æ¯</li>
<li>è¿è¡Œæœºåˆ¶ï¼šå¯åŠ¨ä¸»çº¿ç¨‹ä¿è¯æŒç»­è¿è¡Œï¼Œå¤„ç†è§¦æ‘¸ã€å®šæ—¶å™¨ã€Selectoräº‹ä»¶ï¼Œç©ºé—²é€šçŸ¥CPUé‡Šæ”¾èµ„æº</li>
<li>Runloopå’Œçº¿ç¨‹å…³ç³»ï¼šæ¯ä¸ªçº¿ç¨‹æœ‰å¯¹åº”runloopï¼Œçº¿ç¨‹ç»“æŸæ—¶é”€æ¯</li>
<li>Modeï¼šä»£è¡¨RunLoopçš„è¿è¡Œæ¨¡å¼ï¼Œå¯åŠ¨æ˜¯é€‰æ‹©ä¸€ç§modeï¼ˆcurrentModeï¼‰ï¼Œmodeä¸ºç©ºç«‹å³é€€å‡º<ul>
<li>Source1ï¼šåŸºäºPorté€šè¿‡å†…æ ¸å’Œå…¶ä»–çº¿ç¨‹ç›¸äº’å‘é€æ¶ˆæ¯</li>
<li>Source0ï¼šè§¦æ‘¸äº‹ä»¶ï¼ŒPerformSelectors</li>
<li>Timersï¼šå®šæ—¶å™¨ï¼ŒNSTimer</li>
<li>Observerï¼šç›‘å¬å™¨ï¼Œç”¨äºç›‘å¬RunLoopçš„çŠ¶æ€</li>
</ul>
</li>
<li>RunLoop è¿è¡Œæ¨¡å¼<ul>
<li>kCFRunLoopDefaultModeï¼šAppçš„é»˜è®¤Modeï¼Œé€šå¸¸ä¸»çº¿ç¨‹æ˜¯åœ¨è¿™ä¸ªModeä¸‹è¿è¡Œ</li>
<li>UITrackingRunLoopModeï¼šç•Œé¢è·Ÿè¸ª Modeï¼Œç”¨äº ScrollView è¿½è¸ªè§¦æ‘¸æ»‘åŠ¨ï¼Œä¿è¯ç•Œé¢æ»‘åŠ¨æ—¶ä¸å—å…¶ä»– Mode å½±å“</li>
<li>UIInitializationRunLoopMode: åœ¨åˆšå¯åŠ¨ App æ—¶ç¬¬è¿›å…¥çš„ç¬¬ä¸€ä¸ª Modeï¼Œå¯åŠ¨å®Œæˆåå°±ä¸å†ä½¿ç”¨ï¼Œä¼šåˆ‡æ¢åˆ°kCFRunLoopDefaultMode</li>
<li>GSEventReceiveRunLoopMode: æ¥å—ç³»ç»Ÿäº‹ä»¶çš„å†…éƒ¨ Modeï¼Œé€šå¸¸ç”¨ä¸åˆ°</li>
<li>kCFRunLoopCommonModes: è¿™æ˜¯ä¸€ä¸ªå ä½ç”¨çš„Modeï¼Œä½œä¸ºæ ‡è®°kCFRunLoopDefaultModeå’ŒUITrackingRunLoopModeç”¨ï¼Œå¹¶ä¸æ˜¯ä¸€ç§çœŸæ­£çš„Mode</li>
</ul>
</li>
<li>CFRunLoopObserverRef ç›‘å¬RunLoopçš„çŠ¶æ€æ”¹å˜<ul>
<li>kCFRunLoopEntry:RunLoopè¿›å…¥</li>
<li>kCFRunLoopBeforeTimers:RunLoopè¦å¤„ç†Timersäº†</li>
<li>kCFRunLoopBeforeSources:RunLoopè¦å¤„ç†Sourcesäº†</li>
<li>kCFRunLoopBeforeWaiting:RunLoopè¦ä¼‘æ¯äº†</li>
<li>kCFRunLoopAfterWaiting:RunLoopé†’æ¥äº†</li>
<li>kCFRunLoopExit:RunLoopé€€å‡ºäº†</li>
</ul>
</li>
<li>å¸¸è§çš„åº”ç”¨åœºæ™¯ï¼š<ul>
<li>å¸¸é©»çº¿ç¨‹</li>
<li>è‡ªåŠ¨é‡Šæ”¾æ± </li>
<li>AFNetworkingçš„connectionè¿æ¥å¤„ç†</li>
<li>TableViewå¹³æ»‘æ»šåŠ¨å»¶è¿ŸåŠ è½½å›¾ç‰‡</li>
<li>ç¨‹åºå´©æºƒæ—¶è‡ªä¸»å¤„ç†ä¾‹ï¼Œå¦‚ï¼šå¼¹å‡ºæç¤ºç­‰</li>
</ul>
</li>
</ul>
<hr>
<h3 id="RunLoopç®€ä»‹"><a href="#RunLoopç®€ä»‹" class="headerlink" title="RunLoopç®€ä»‹"></a>RunLoopç®€ä»‹</h3><p>è¿è¡Œå¾ªç¯ï¼Œåœ¨ç¨‹åºè¿è¡Œè¿‡ç¨‹ä¸­å¾ªç¯åšä¸€äº›äº‹æƒ…ï¼Œå¦‚æœæ²¡æœ‰Runloopç¨‹åºæ‰§è¡Œå®Œæ¯•å°±ä¼šç«‹å³é€€å‡ºï¼Œå¦‚æœæœ‰Runloopç¨‹åºä¼šä¸€ç›´è¿è¡Œï¼Œå¹¶ä¸”æ—¶æ—¶åˆ»åˆ»åœ¨ç­‰å¾…ç”¨æˆ·çš„è¾“å…¥æ“ä½œã€‚RunLoopå¯ä»¥åœ¨éœ€è¦çš„æ—¶å€™è‡ªå·±è·‘èµ·æ¥è¿è¡Œï¼Œåœ¨æ²¡æœ‰æ“ä½œçš„æ—¶å€™å°±åœä¸‹æ¥ä¼‘æ¯ã€‚èƒ½å¤Ÿå……åˆ†èŠ‚çœCPUèµ„æºï¼Œæé«˜ç¨‹åºæ€§èƒ½ã€‚</p>
<h3 id="RunLoopåŸºæœ¬ä½œç”¨"><a href="#RunLoopåŸºæœ¬ä½œç”¨" class="headerlink" title="RunLoopåŸºæœ¬ä½œç”¨"></a>RunLoopåŸºæœ¬ä½œç”¨</h3><ul>
<li>1.ä¿æŒç¨‹åºæŒç»­è¿è¡Œï¼Œç¨‹åºä¸€å¯åŠ¨å°±ä¼šå¼€ä¸€ä¸ªä¸»çº¿ç¨‹ï¼Œä¸»çº¿ç¨‹ä¸€å¼€èµ·æ¥å°±ä¼šè·‘ä¸€ä¸ªä¸»çº¿ç¨‹å¯¹åº”çš„RunLoop,RunLoopä¿è¯ä¸»çº¿ç¨‹ä¸ä¼šè¢«é”€æ¯ï¼Œä¹Ÿå°±ä¿è¯äº†ç¨‹åºçš„æŒç»­è¿è¡Œ</li>
<li>2.å¤„ç†Appä¸­çš„å„ç§äº‹ä»¶ï¼ˆæ¯”å¦‚ï¼šè§¦æ‘¸äº‹ä»¶ï¼Œå®šæ—¶å™¨äº‹ä»¶ï¼ŒSelectoräº‹ä»¶ç­‰ï¼‰</li>
<li>3.èŠ‚çœCPUèµ„æºï¼Œæé«˜ç¨‹åºæ€§èƒ½ï¼Œç¨‹åºè¿è¡Œèµ·æ¥æ—¶ï¼Œå½“ä»€ä¹ˆæ“ä½œéƒ½æ²¡æœ‰åšçš„æ—¶å€™ï¼ŒRunLoopå°±å‘Šè¯‰CPUï¼Œç°åœ¨æ²¡æœ‰äº‹æƒ…åšï¼Œæˆ‘è¦å»ä¼‘æ¯ï¼Œè¿™æ—¶CPUå°±ä¼šå°†å…¶èµ„æºé‡Šæ”¾å‡ºæ¥å»åšå…¶ä»–çš„äº‹æƒ…ï¼Œå½“æœ‰äº‹æƒ…åšçš„æ—¶å€™RunLoopå°±ä¼šç«‹é©¬èµ·æ¥å»åšäº‹æƒ…</li>
</ul>
<p>æˆ‘ä»¬å…ˆé€šè¿‡APIå†…ä¸€å¼ å›¾ç‰‡æ¥ç®€å•çœ‹ä¸€ä¸‹RunLoopå†…éƒ¨è¿è¡ŒåŸç†</p>
<p><img src="https://user-gold-cdn.xitu.io/2018/6/4/163ca0a711125edd?w=495&amp;h=261&amp;f=png&amp;s=66608" alt=""></p>
<p>é€šè¿‡å›¾ç‰‡å¯ä»¥çœ‹å‡ºï¼ŒRunLoopåœ¨è·‘åœˆè¿‡ç¨‹ä¸­ï¼Œå½“æ¥æ”¶åˆ°Input sources æˆ–è€… Timer sourcesæ—¶å°±ä¼šäº¤ç»™å¯¹åº”çš„å¤„ç†æ–¹å»å¤„ç†ã€‚å½“æ²¡æœ‰äº‹ä»¶æ¶ˆæ¯ä¼ å…¥çš„æ—¶å€™ï¼ŒRunLoopå°±ä¼‘æ¯äº†ã€‚è¿™é‡Œåªæ˜¯ç®€å•çš„ç†è§£ä¸€ä¸‹è¿™å¼ å›¾ï¼Œæ¥ä¸‹æ¥æˆ‘ä»¬æ¥äº†è§£RunLoopå¯¹è±¡å’Œå…¶ä¸€äº›ç›¸å…³ç±»ï¼Œæ¥æ›´æ·±å…¥çš„ç†è§£RunLoopè¿è¡Œæµç¨‹ã€‚</p>
<h3 id="RunLoopåœ¨å“ªé‡Œå¼€å¯"><a href="#RunLoopåœ¨å“ªé‡Œå¼€å¯" class="headerlink" title="RunLoopåœ¨å“ªé‡Œå¼€å¯"></a>RunLoopåœ¨å“ªé‡Œå¼€å¯</h3><p>UIApplicationMainå‡½æ•°å†…å¯åŠ¨äº†Runloopï¼Œç¨‹åºä¸ä¼šé©¬ä¸Šé€€å‡ºï¼Œè€Œæ˜¯ä¿æŒè¿è¡ŒçŠ¶æ€ã€‚å› æ­¤æ¯ä¸€ä¸ªåº”ç”¨å¿…é¡»è¦æœ‰ä¸€ä¸ªrunloopï¼Œæˆ‘ä»¬çŸ¥é“ä¸»çº¿ç¨‹ä¸€å¼€èµ·æ¥ï¼Œå°±ä¼šè·‘ä¸€ä¸ªå’Œä¸»çº¿ç¨‹å¯¹åº”çš„RunLoopï¼Œé‚£ä¹ˆRunLoopä¸€å®šæ˜¯åœ¨ç¨‹åºçš„å…¥å£mainå‡½æ•°ä¸­å¼€å¯ã€‚</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">int</span> main(<span class="keyword">int</span> argc, <span class="keyword">char</span> * argv[]) &#123;</span><br><span class="line">    <span class="keyword">@autoreleasepool</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">UIApplicationMain</span>(argc, argv, <span class="literal">nil</span>, <span class="built_in">NSStringFromClass</span>([AppDelegate <span class="keyword">class</span>]));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>è¿›å…¥UIApplicationMain</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">UIKIT_EXTERN <span class="keyword">int</span> <span class="title">UIApplicationMain</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span> *argv[], NSString * __nullable principalClassName, NSString * __nullable delegateClassName)</span></span>;</span><br></pre></td></tr></table></figure>
<p>æˆ‘ä»¬å‘ç°å®ƒè¿”å›çš„æ˜¯ä¸€ä¸ªintæ•°ï¼Œé‚£ä¹ˆæˆ‘ä»¬å¯¹mainå‡½æ•°åšä¸€äº›ä¿®æ”¹</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">int</span> main(<span class="keyword">int</span> argc, <span class="keyword">char</span> * argv[]) &#123;</span><br><span class="line">    <span class="keyword">@autoreleasepool</span> &#123;</span><br><span class="line">        <span class="built_in">NSLog</span>(<span class="string">@"å¼€å§‹"</span>);</span><br><span class="line">        <span class="keyword">int</span> re = <span class="built_in">UIApplicationMain</span>(argc, argv, <span class="literal">nil</span>, <span class="built_in">NSStringFromClass</span>([AppDelegate <span class="keyword">class</span>]));</span><br><span class="line">        <span class="built_in">NSLog</span>(<span class="string">@"ç»“æŸ"</span>);</span><br><span class="line">        <span class="keyword">return</span> re;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>è¿è¡Œç¨‹åºï¼Œæˆ‘ä»¬å‘ç°åªä¼šæ‰“å°å¼€å§‹ï¼Œå¹¶ä¸ä¼šæ‰“å°ç»“æŸï¼Œè¿™è¯´æ˜åœ¨UIApplicationMainå‡½æ•°ä¸­ï¼Œå¼€å¯äº†ä¸€ä¸ªå’Œä¸»çº¿ç¨‹ç›¸å…³çš„RunLoopï¼Œå¯¼è‡´UIApplicationMainä¸ä¼šè¿”å›ï¼Œä¸€ç›´åœ¨è¿è¡Œä¸­ï¼Œä¹Ÿå°±ä¿è¯äº†ç¨‹åºçš„æŒç»­è¿è¡Œã€‚<br>æˆ‘ä»¬æ¥çœ‹åˆ°RunLoopçš„æºç </p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ç”¨DefaultModeå¯åŠ¨</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">CFRunLoopRun</span><span class="params">(<span class="keyword">void</span>)</span> </span>&#123;    <span class="comment">/* DOES CALLOUT */</span></span><br><span class="line">    <span class="keyword">int32_t</span> result;</span><br><span class="line">    <span class="keyword">do</span> &#123;</span><br><span class="line">        result = CFRunLoopRunSpecific(CFRunLoopGetCurrent(), kCFRunLoopDefaultMode, <span class="number">1.0e10</span>, <span class="literal">false</span>);</span><br><span class="line">        CHECK_FOR_FORK();</span><br><span class="line">    &#125; <span class="keyword">while</span> (kCFRunLoopRunStopped != result &amp;&amp; kCFRunLoopRunFinished != result);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>æˆ‘ä»¬å‘ç°RunLoopç¡®å®æ˜¯do whileé€šè¿‡åˆ¤æ–­resultçš„å€¼å®ç°çš„ã€‚å› æ­¤ï¼Œæˆ‘ä»¬å¯ä»¥æŠŠRunLoopçœ‹æˆä¸€ä¸ªæ­»å¾ªç¯ã€‚å¦‚æœæ²¡æœ‰RunLoopï¼ŒUIApplicationMainå‡½æ•°æ‰§è¡Œå®Œæ¯•ä¹‹åå°†ç›´æ¥è¿”å›ï¼Œä¹Ÿå°±æ²¡æœ‰ç¨‹åºæŒç»­è¿è¡Œä¸€è¯´äº†ã€‚</p>
<h3 id="RunLoopå¯¹è±¡"><a href="#RunLoopå¯¹è±¡" class="headerlink" title="RunLoopå¯¹è±¡"></a>RunLoopå¯¹è±¡</h3><ul>
<li>Fundationæ¡†æ¶ï¼ˆåŸºäºCFRunLoopRefçš„å°è£…ï¼‰ NSRunLoop å¯¹è±¡</li>
<li>CoreFoundation CFRunLoopRef å¯¹è±¡</li>
</ul>
<p>å› ä¸ºFundationæ¡†æ¶æ˜¯åŸºäºCFRunLoopRefçš„ä¸€å±‚OCå°è£…ï¼Œè¿™é‡Œæˆ‘ä»¬ä¸»è¦ç ”ç©¶CFRunLoopRefæºç </p>
<h4 id="å¦‚ä½•è·å¾—RunLoopå¯¹è±¡"><a href="#å¦‚ä½•è·å¾—RunLoopå¯¹è±¡" class="headerlink" title="å¦‚ä½•è·å¾—RunLoopå¯¹è±¡"></a>å¦‚ä½•è·å¾—RunLoopå¯¹è±¡</h4><p>Foundation<br><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[<span class="built_in">NSRunLoop</span> currentRunLoop]; <span class="comment">// è·å¾—å½“å‰çº¿ç¨‹çš„RunLoopå¯¹è±¡</span></span><br><span class="line">[<span class="built_in">NSRunLoop</span> mainRunLoop]; <span class="comment">// è·å¾—ä¸»çº¿ç¨‹çš„RunLoopå¯¹è±¡</span></span><br></pre></td></tr></table></figure></p>
<p>Core Foundation<br><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">CFRunLoopGetCurrent</span>(); <span class="comment">// è·å¾—å½“å‰çº¿ç¨‹çš„RunLoopå¯¹è±¡</span></span><br><span class="line"><span class="built_in">CFRunLoopGetMain</span>(); <span class="comment">// è·å¾—ä¸»çº¿ç¨‹çš„RunLoopå¯¹è±¡</span></span><br></pre></td></tr></table></figure></p>
<h3 id="RunLoopå’Œçº¿ç¨‹é—´çš„å…³ç³»"><a href="#RunLoopå’Œçº¿ç¨‹é—´çš„å…³ç³»" class="headerlink" title="RunLoopå’Œçº¿ç¨‹é—´çš„å…³ç³»"></a>RunLoopå’Œçº¿ç¨‹é—´çš„å…³ç³»</h3><ul>
<li>1.æ¯æ¡çº¿ç¨‹éƒ½æœ‰å”¯ä¸€çš„ä¸€ä¸ªä¸ä¹‹å¯¹åº”çš„RunLoopå¯¹è±¡</li>
<li>2.RunLoopä¿å­˜åœ¨ä¸€ä¸ªå…¨å±€çš„Dictionaryé‡Œï¼Œçº¿ç¨‹ä½œä¸ºkey,RunLoopä½œä¸ºvalue</li>
<li>3.ä¸»çº¿ç¨‹çš„RunLoopå·²ç»è‡ªåŠ¨åˆ›å»ºå¥½äº†ï¼Œå­çº¿ç¨‹çš„RunLoopéœ€è¦ä¸»åŠ¨åˆ›å»º</li>
<li>4.RunLoopåœ¨ç¬¬ä¸€æ¬¡è·å–æ—¶åˆ›å»ºï¼Œåœ¨çº¿ç¨‹ç»“æŸæ—¶é”€æ¯</li>
</ul>
<blockquote>
<p>é€šè¿‡æºç æŸ¥çœ‹ä¸Šè¿°å¯¹åº”</p>
</blockquote>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// æ‹¿åˆ°å½“å‰Runloop è°ƒç”¨_CFRunLoopGet0</span></span><br><span class="line"><span class="function">CFRunLoopRef <span class="title">CFRunLoopGetCurrent</span><span class="params">(<span class="keyword">void</span>)</span> </span>&#123;</span><br><span class="line">    CHECK_FOR_FORK();</span><br><span class="line">    CFRunLoopRef rl = (CFRunLoopRef)_CFGetTSD(__CFTSDKeyRunLoop);</span><br><span class="line">    <span class="keyword">if</span> (rl) <span class="keyword">return</span> rl;</span><br><span class="line">    <span class="keyword">return</span> _CFRunLoopGet0(pthread_self());</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// æŸ¥çœ‹_CFRunLoopGet0æ–¹æ³•å†…éƒ¨</span></span><br><span class="line">CF_EXPORT CFRunLoopRef _CFRunLoopGet0(<span class="keyword">pthread_t</span> t) &#123;</span><br><span class="line">    <span class="keyword">if</span> (pthread_equal(t, kNilPthreadT)) &#123;</span><br><span class="line">        t = pthread_main_thread_np();</span><br><span class="line">    &#125;</span><br><span class="line">    __CFLock(&amp;loopsLock);</span><br><span class="line">    <span class="keyword">if</span> (!__CFRunLoops) &#123;</span><br><span class="line">        __CFUnlock(&amp;loopsLock);</span><br><span class="line">        CFMutableDictionaryRef dict = CFDictionaryCreateMutable(kCFAllocatorSystemDefault, <span class="number">0</span>, <span class="literal">NULL</span>, &amp;kCFTypeDictionaryValueCallBacks);</span><br><span class="line">        <span class="comment">// æ ¹æ®ä¼ å…¥çš„ä¸»çº¿ç¨‹è·å–ä¸»çº¿ç¨‹å¯¹åº”çš„RunLoop</span></span><br><span class="line">        CFRunLoopRef mainLoop = __CFRunLoopCreate(pthread_main_thread_np());</span><br><span class="line">        <span class="comment">// ä¿å­˜ä¸»çº¿ç¨‹ å°†ä¸»çº¿ç¨‹-keyå’ŒRunLoop-Valueä¿å­˜åˆ°å­—å…¸ä¸­</span></span><br><span class="line">        CFDictionarySetValue(dict, pthreadPointer(pthread_main_thread_np()), mainLoop);</span><br><span class="line">        <span class="keyword">if</span> (!OSAtomicCompareAndSwapPtrBarrier(<span class="literal">NULL</span>, dict, (<span class="keyword">void</span> * <span class="keyword">volatile</span> *)&amp;__CFRunLoops)) &#123;</span><br><span class="line">            CFRelease(dict);</span><br><span class="line">        &#125;</span><br><span class="line">        CFRelease(mainLoop);</span><br><span class="line">        __CFLock(&amp;loopsLock);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ä»å­—å…¸é‡Œé¢æ‹¿ï¼Œå°†çº¿ç¨‹ä½œä¸ºkeyä»å­—å…¸é‡Œè·å–ä¸€ä¸ªloop</span></span><br><span class="line">    CFRunLoopRef loop = (CFRunLoopRef)CFDictionaryGetValue(__CFRunLoops, pthreadPointer(t));</span><br><span class="line">    __CFUnlock(&amp;loopsLock);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// å¦‚æœloopä¸ºç©ºï¼Œåˆ™åˆ›å»ºä¸€ä¸ªæ–°çš„loopï¼Œæ‰€ä»¥runloopä¼šåœ¨ç¬¬ä¸€æ¬¡è·å–çš„æ—¶å€™åˆ›å»º</span></span><br><span class="line">    <span class="keyword">if</span> (!loop) &#123;  </span><br><span class="line">        CFRunLoopRef newLoop = __CFRunLoopCreate(t);</span><br><span class="line">        __CFLock(&amp;loopsLock);</span><br><span class="line">        loop = (CFRunLoopRef)CFDictionaryGetValue(__CFRunLoops, pthreadPointer(t));</span><br><span class="line"></span><br><span class="line">        <span class="comment">// åˆ›å»ºå¥½ä¹‹åï¼Œä»¥çº¿ç¨‹ä¸ºkey runloopä¸ºvalueï¼Œä¸€å¯¹ä¸€å­˜å‚¨åœ¨å­—å…¸ä¸­ï¼Œä¸‹æ¬¡è·å–çš„æ—¶å€™ï¼Œåˆ™ç›´æ¥è¿”å›å­—å…¸å†…çš„runloop</span></span><br><span class="line">        <span class="keyword">if</span> (!loop) &#123; </span><br><span class="line">            CFDictionarySetValue(__CFRunLoops, pthreadPointer(t), newLoop);</span><br><span class="line">            loop = newLoop;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// don't release run loops inside the loopsLock, because CFRunLoopDeallocate may end up taking it</span></span><br><span class="line">        __CFUnlock(&amp;loopsLock);</span><br><span class="line">        CFRelease(newLoop);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (pthread_equal(t, pthread_self())) &#123;</span><br><span class="line">        _CFSetTSD(__CFTSDKeyRunLoop, (<span class="keyword">void</span> *)loop, <span class="literal">NULL</span>);</span><br><span class="line">        <span class="keyword">if</span> (<span class="number">0</span> == _CFGetTSD(__CFTSDKeyRunLoopCntr)) &#123;</span><br><span class="line">            _CFSetTSD(__CFTSDKeyRunLoopCntr, (<span class="keyword">void</span> *)(PTHREAD_DESTRUCTOR_ITERATIONS<span class="number">-1</span>), (<span class="keyword">void</span> (*)(<span class="keyword">void</span> *))__CFFinalizeRunLoop);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> loop;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ä»ä¸Šé¢çš„ä»£ç å¯ä»¥çœ‹å‡ºï¼Œçº¿ç¨‹å’Œ RunLoop ä¹‹é—´æ˜¯ä¸€ä¸€å¯¹åº”çš„ï¼Œå…¶å…³ç³»æ˜¯ä¿å­˜åœ¨ä¸€ä¸ª Dictionary é‡Œã€‚æ‰€ä»¥æˆ‘ä»¬åˆ›å»ºå­çº¿ç¨‹RunLoopæ—¶ï¼Œåªéœ€åœ¨å­çº¿ç¨‹ä¸­è·å–å½“å‰çº¿ç¨‹çš„RunLoopå¯¹è±¡å³å¯</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[<span class="built_in">NSRunLoop</span> currentRunLoop];</span><br></pre></td></tr></table></figure>
<p>å¦‚æœä¸è·å–ï¼Œé‚£å­çº¿ç¨‹å°±ä¸ä¼šåˆ›å»ºä¸ä¹‹ç›¸å…³è”çš„RunLoopï¼Œå¹¶ä¸”åªèƒ½åœ¨ä¸€ä¸ªçº¿ç¨‹çš„å†…éƒ¨è·å–å…¶ RunLoop<br>[NSRunLoop currentRunLoop];æ–¹æ³•è°ƒç”¨æ—¶ï¼Œä¼šå…ˆçœ‹ä¸€ä¸‹å­—å…¸é‡Œæœ‰æ²¡æœ‰å­˜å­çº¿ç¨‹ç›¸å¯¹ç”¨çš„RunLoopï¼Œå¦‚æœæœ‰åˆ™ç›´æ¥è¿”å›RunLoopï¼Œå¦‚æœæ²¡æœ‰åˆ™ä¼šåˆ›å»ºä¸€ä¸ªï¼Œå¹¶å°†ä¸ä¹‹å¯¹åº”çš„å­çº¿ç¨‹å­˜å…¥å­—å…¸ä¸­ã€‚å½“çº¿ç¨‹ç»“æŸæ—¶ï¼ŒRunLoopä¼šè¢«é”€æ¯ã€‚</p>
<h3 id="RunLoopç»“æ„ä½“"><a href="#RunLoopç»“æ„ä½“" class="headerlink" title="RunLoopç»“æ„ä½“"></a>RunLoopç»“æ„ä½“</h3><p>é€šè¿‡æºç æˆ‘ä»¬æ‰¾åˆ°__CFRunLoopç»“æ„ä½“<br><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> __<span class="title">CFRunLoop</span> &#123;</span></span><br><span class="line">    CFRuntimeBase _base;</span><br><span class="line">    <span class="keyword">pthread_mutex_t</span> _lock;            <span class="comment">/* locked for accessing mode list */</span></span><br><span class="line">    __CFPort _wakeUpPort;            <span class="comment">// used for CFRunLoopWakeUp </span></span><br><span class="line">    Boolean _unused;</span><br><span class="line">    <span class="keyword">volatile</span> _per_run_data *_perRunData;              <span class="comment">// reset for runs of the run loop</span></span><br><span class="line">    <span class="keyword">pthread_t</span> _pthread;</span><br><span class="line">    <span class="keyword">uint32_t</span> _winthread;</span><br><span class="line">    CFMutableSetRef _commonModes;</span><br><span class="line">    CFMutableSetRef _commonModeItems;</span><br><span class="line">    CFRunLoopModeRef _currentMode;</span><br><span class="line">    CFMutableSetRef _modes;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> _<span class="title">block_item</span> *_<span class="title">blocks_head</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> _<span class="title">block_item</span> *_<span class="title">blocks_tail</span>;</span></span><br><span class="line">    CFAbsoluteTime _runTime;</span><br><span class="line">    CFAbsoluteTime _sleepTime;</span><br><span class="line">    CFTypeRef _counterpart;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure></p>
<p>é™¤ä¸€äº›è®°å½•æ€§å±æ€§å¤–ï¼Œä¸»è¦æ¥çœ‹ä¸€ä¸‹ä»¥ä¸‹ä¸¤ä¸ªæˆå‘˜å˜é‡<br><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">CFRunLoopModeRef _currentMode;</span><br><span class="line">CFMutableSetRef _modes;</span><br></pre></td></tr></table></figure></p>
<p>CFRunLoopModeRef å…¶å®æ˜¯æŒ‡å‘<strong>CFRunLoopModeç»“æ„ä½“çš„æŒ‡é’ˆï¼Œ</strong>CFRunLoopModeç»“æ„ä½“æºç å¦‚ä¸‹<br><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> __<span class="title">CFRunLoopMode</span> *<span class="title">CFRunLoopModeRef</span>;</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> __<span class="title">CFRunLoopMode</span> &#123;</span></span><br><span class="line">    CFRuntimeBase _base;</span><br><span class="line">    <span class="keyword">pthread_mutex_t</span> _lock;    <span class="comment">/* must have the run loop locked before locking this */</span></span><br><span class="line">    CFStringRef _name;</span><br><span class="line">    Boolean _stopped;</span><br><span class="line">    <span class="keyword">char</span> _padding[<span class="number">3</span>];</span><br><span class="line">    CFMutableSetRef _sources0;</span><br><span class="line">    CFMutableSetRef _sources1;</span><br><span class="line">    CFMutableArrayRef _observers;</span><br><span class="line">    CFMutableArrayRef _timers;</span><br><span class="line">    CFMutableDictionaryRef _portToV1SourceMap;</span><br><span class="line">    __CFPortSet _portSet;</span><br><span class="line">    CFIndex _observerMask;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> USE_DISPATCH_SOURCE_FOR_TIMERS</span></span><br><span class="line">    <span class="keyword">dispatch_source_t</span> _timerSource;</span><br><span class="line">    <span class="keyword">dispatch_queue_t</span> _queue;</span><br><span class="line">    Boolean _timerFired; <span class="comment">// set to true by the source when a timer has fired</span></span><br><span class="line">    Boolean _dispatchTimerArmed;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> USE_MK_TIMER_TOO</span></span><br><span class="line">    <span class="keyword">mach_port_t</span> _timerPort;</span><br><span class="line">    Boolean _mkTimerArmed;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> DEPLOYMENT_TARGET_WINDOWS</span></span><br><span class="line">    DWORD _msgQMask;</span><br><span class="line">    <span class="keyword">void</span> (*_msgPump)(<span class="keyword">void</span>);</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">    <span class="keyword">uint64_t</span> _timerSoftDeadline; <span class="comment">/* TSR */</span></span><br><span class="line">    <span class="keyword">uint64_t</span> _timerHardDeadline; <span class="comment">/* TSR */</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure></p>
<p>ä¸»è¦æŸ¥çœ‹ä»¥ä¸‹æˆå‘˜å˜é‡<br><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">CFMutableSetRef _sources0;</span><br><span class="line">CFMutableSetRef _sources1;</span><br><span class="line">CFMutableArrayRef _observers;</span><br><span class="line">CFMutableArrayRef _timers;</span><br></pre></td></tr></table></figure></p>
<p>é€šè¿‡ä¸Šé¢åˆ†ææˆ‘ä»¬çŸ¥é“ï¼ŒCFRunLoopModeRefä»£è¡¨RunLoopçš„è¿è¡Œæ¨¡å¼ï¼Œä¸€ä¸ªRunLoopåŒ…å«è‹¥å¹²ä¸ªModeï¼Œæ¯ä¸ªModeåˆåŒ…å«è‹¥å¹²ä¸ªSource0/Source1/Timer/Observerï¼Œè€ŒRunLoopå¯åŠ¨æ—¶åªèƒ½é€‰æ‹©å…¶ä¸­ä¸€ä¸ªModeä½œä¸ºcurrentModeã€‚</p>
<blockquote>
<p>Source1/Source0/Timers/Observeråˆ†åˆ«ä»£è¡¨ä»€ä¹ˆ</p>
</blockquote>
<h4 id="Source1-åŸºäºPortçš„çº¿ç¨‹é—´é€šä¿¡"><a href="#Source1-åŸºäºPortçš„çº¿ç¨‹é—´é€šä¿¡" class="headerlink" title="Source1 : åŸºäºPortçš„çº¿ç¨‹é—´é€šä¿¡"></a>Source1 : åŸºäºPortçš„çº¿ç¨‹é—´é€šä¿¡</h4><h4 id="Source0-è§¦æ‘¸äº‹ä»¶ï¼ŒPerformSelectors"><a href="#Source0-è§¦æ‘¸äº‹ä»¶ï¼ŒPerformSelectors" class="headerlink" title="Source0 : è§¦æ‘¸äº‹ä»¶ï¼ŒPerformSelectors"></a>Source0 : è§¦æ‘¸äº‹ä»¶ï¼ŒPerformSelectors</h4><p>æˆ‘ä»¬é€šè¿‡ä»£ç éªŒè¯ä¸€ä¸‹</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">- (<span class="keyword">void</span>)touchesBegan:(<span class="built_in">NSSet</span>&lt;<span class="built_in">UITouch</span> *&gt; *)touches withEvent:(<span class="built_in">UIEvent</span> *)event &#123;</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@"ç‚¹å‡»äº†å±å¹•"</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>æ‰“æ–­ç‚¹ä¹‹åæ‰“å°å †æ ˆä¿¡æ¯ï¼Œå½“xcodeå·¥å…·åŒºæ‰“å°çš„å †æ ˆä¿¡æ¯ä¸å…¨æ—¶ï¼Œå¯ä»¥åœ¨æ§åˆ¶å°é€šè¿‡â€œbtâ€æŒ‡ä»¤æ‰“å°å®Œæ•´çš„å †æ ˆä¿¡æ¯ï¼Œç”±å †æ ˆä¿¡æ¯ä¸­å¯ä»¥å‘ç°ï¼Œè§¦æ‘¸äº‹ä»¶ç¡®å®æ˜¯ä¼šè§¦å‘Source0äº‹ä»¶ã€‚</p>
<p><img src="https://user-gold-cdn.xitu.io/2018/6/4/163ca0a716b8c1a4?w=950&amp;h=334&amp;f=png&amp;s=344630" alt=""></p>
<p>åŒæ ·çš„æ–¹å¼éªŒè¯performSelectorå †æ ˆä¿¡æ¯</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">dispatch_async</span>(dispatch_get_global_queue(<span class="number">0</span>, <span class="number">0</span>), ^&#123;</span><br><span class="line">    [<span class="keyword">self</span> performSelectorOnMainThread:<span class="keyword">@selector</span>(test) withObject:<span class="literal">nil</span> waitUntilDone:<span class="literal">YES</span>];</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<p>å¯ä»¥å‘ç°PerformSelectorsåŒæ ·æ˜¯è§¦å‘Source0äº‹ä»¶</p>
<p><img src="https://user-gold-cdn.xitu.io/2018/6/4/163ca0a7173c2a6d?w=1090&amp;h=243&amp;f=png&amp;s=222065" alt=""></p>
<p>å…¶å®ï¼Œå½“æˆ‘ä»¬è§¦å‘äº†äº‹ä»¶ï¼ˆè§¦æ‘¸/é”å±/æ‘‡æ™ƒç­‰ï¼‰åï¼Œç”±IOKit.frameworkç”Ÿæˆä¸€ä¸ª IOHIDEventäº‹ä»¶</p>
<blockquote>
<p>IOKitæ˜¯è‹¹æœçš„ç¡¬ä»¶é©±åŠ¨æ¡†æ¶ï¼Œç”±å®ƒè¿›è¡Œåº•å±‚æ¥å£çš„æŠ½è±¡å°è£…ä¸ç³»ç»Ÿè¿›è¡Œäº¤äº’ä¼ é€’ç¡¬ä»¶æ„Ÿåº”çš„äº‹ä»¶ï¼Œå¹¶ä¸“é—¨å¤„ç†ç”¨æˆ·äº¤äº’è®¾å¤‡ï¼Œç”±IOHIDServiceså’ŒIOHIDDisplaysä¸¤éƒ¨åˆ†ç»„æˆï¼Œå…¶ä¸­IOHIDServicesæ˜¯ä¸“é—¨å¤„ç†ç”¨æˆ·äº¤äº’çš„ï¼Œå®ƒä¼šå°†äº‹ä»¶å°è£…æˆIOHIDEventså¯¹è±¡</p>
</blockquote>
<p>æ¥ç€ç”¨mach portè½¬å‘ç»™éœ€è¦çš„Appè¿›ç¨‹ï¼Œéšå Source1å°±ä¼šæ¥æ”¶IOHIDEventï¼Œä¹‹åå†å›è°ƒ<strong>IOHIDEventSystemClientQueueCallback()ï¼Œ</strong>IOHIDEventSystemClientQueueCallback()å†…è§¦å‘Source0ï¼ŒSource0 å†è§¦å‘ _UIApplicationHandleEventQueue()ã€‚æ‰€ä»¥è§¦æ‘¸äº‹ä»¶çœ‹åˆ°æ˜¯åœ¨ Source0 å†…çš„ã€‚</p>
<h4 id="Timers-å®šæ—¶å™¨ï¼ŒNSTimer"><a href="#Timers-å®šæ—¶å™¨ï¼ŒNSTimer" class="headerlink" title="Timers : å®šæ—¶å™¨ï¼ŒNSTimer"></a>Timers : å®šæ—¶å™¨ï¼ŒNSTimer</h4><p>é€šè¿‡ä»£ç éªŒè¯<br><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[<span class="built_in">NSTimer</span> scheduledTimerWithTimeInterval:<span class="number">3.0</span> repeats:<span class="literal">NO</span> block:^(<span class="built_in">NSTimer</span> * _Nonnull timer) &#123;</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@"NSTimer ---- timerè°ƒç”¨äº†"</span>);</span><br><span class="line">&#125;];</span><br></pre></td></tr></table></figure></p>
<p>æ‰“å°å®Œæ•´å †æ ˆä¿¡æ¯</p>
<p><img src="https://user-gold-cdn.xitu.io/2018/6/4/163ca0a715aef5d2?w=1102&amp;h=248&amp;f=png&amp;s=249879" alt=""></p>
<h4 id="Observer-ç›‘å¬å™¨ï¼Œç”¨äºç›‘å¬RunLoopçš„çŠ¶æ€"><a href="#Observer-ç›‘å¬å™¨ï¼Œç”¨äºç›‘å¬RunLoopçš„çŠ¶æ€" class="headerlink" title="Observer : ç›‘å¬å™¨ï¼Œç”¨äºç›‘å¬RunLoopçš„çŠ¶æ€"></a>Observer : ç›‘å¬å™¨ï¼Œç”¨äºç›‘å¬RunLoopçš„çŠ¶æ€</h4><h3 id="è¯¦è§£RunLoopç›¸å…³ç±»åŠä½œç”¨"><a href="#è¯¦è§£RunLoopç›¸å…³ç±»åŠä½œç”¨" class="headerlink" title="è¯¦è§£RunLoopç›¸å…³ç±»åŠä½œç”¨"></a>è¯¦è§£RunLoopç›¸å…³ç±»åŠä½œç”¨</h3><p>é€šè¿‡ä¸Šé¢çš„åˆ†æï¼Œæˆ‘ä»¬å¯¹RunLoopå†…éƒ¨ç»“æ„æœ‰äº†å¤§è‡´çš„äº†è§£ï¼Œæ¥ä¸‹æ¥æ¥è¯¦ç»†åˆ†æRunLoopçš„ç›¸å…³ç±»ã€‚ä»¥ä¸‹ä¸ºCore Foundationä¸­å…³äºRunLoopçš„5ä¸ªç±»</p>
<ul>
<li>CFRunLoopRef - è·å¾—å½“å‰RunLoopå’Œä¸»RunLoop</li>
<li>CFRunLoopModeRef - RunLoop è¿è¡Œæ¨¡å¼ï¼Œåªèƒ½é€‰æ‹©ä¸€ç§ï¼Œåœ¨ä¸åŒæ¨¡å¼ä¸­åšä¸åŒçš„æ“ä½œ</li>
<li>CFRunLoopSourceRef - äº‹ä»¶æºï¼Œè¾“å…¥æº</li>
<li>CFRunLoopTimerRef - å®šæ—¶å™¨æ—¶é—´</li>
<li>CFRunLoopObserverRef - è§‚å¯Ÿè€…</li>
</ul>
<p>1ï¼‰CFRunLoopModeRef<br>CFRunLoopModeRefä»£è¡¨RunLoopçš„è¿è¡Œæ¨¡å¼<br>ä¸€ä¸ª RunLoop åŒ…å«è‹¥å¹²ä¸ª Modeï¼Œæ¯ä¸ªModeåˆåŒ…å«è‹¥å¹²ä¸ªSourceã€Timerã€Observer<br>æ¯æ¬¡RunLoopå¯åŠ¨æ—¶ï¼Œåªèƒ½æŒ‡å®šå…¶ä¸­ä¸€ä¸ª Modeï¼Œè¿™ä¸ªModeè¢«ç§°ä½œ CurrentMode<br>å¦‚æœéœ€è¦åˆ‡æ¢Modeï¼Œåªèƒ½é€€å‡ºRunLoopï¼Œå†é‡æ–°æŒ‡å®šä¸€ä¸ªModeè¿›å…¥ï¼Œè¿™æ ·åšä¸»è¦æ˜¯ä¸ºäº†åˆ†éš”å¼€ä¸åŒç»„çš„Sourceã€Timerã€Observerï¼Œè®©å…¶äº’ä¸å½±å“ã€‚å¦‚æœModeé‡Œæ²¡æœ‰ä»»ä½•Source0/Source1/Timer/Observerï¼ŒRunLoopä¼šç«‹é©¬é€€å‡º<br>å¦‚å›¾æ‰€ç¤ºï¼š</p>
<p><img src="https://user-gold-cdn.xitu.io/2018/6/4/163ca0a73688953e?w=364&amp;h=278&amp;f=png&amp;s=33982" alt=""></p>
<p>æ³¨æ„ï¼šä¸€ç§Modeä¸­å¯ä»¥æœ‰å¤šä¸ªSource(äº‹ä»¶æºï¼Œè¾“å…¥æºï¼ŒåŸºäºç«¯å£äº‹ä»¶æºä¾‹é”®ç›˜è§¦æ‘¸ç­‰) Observer(è§‚å¯Ÿè€…ï¼Œè§‚å¯Ÿå½“å‰RunLoopè¿è¡ŒçŠ¶æ€) å’ŒTimer(å®šæ—¶å™¨äº‹ä»¶æº)ã€‚ä½†æ˜¯å¿…é¡»è‡³å°‘æœ‰ä¸€ä¸ªSourceæˆ–è€…Timerï¼Œå› ä¸ºå¦‚æœModeä¸ºç©ºï¼ŒRunLoopè¿è¡Œåˆ°ç©ºæ¨¡å¼ä¸ä¼šè¿›è¡Œç©ºè½¬ï¼Œå°±ä¼šç«‹åˆ»é€€å‡ºã€‚</p>
<blockquote>
<p>ç³»ç»Ÿé»˜è®¤æ³¨å†Œçš„5ä¸ªMode:</p>
</blockquote>
<p>RunLoop æœ‰äº”ç§è¿è¡Œæ¨¡å¼ï¼Œå…¶ä¸­å¸¸è§çš„æœ‰1.2ä¸¤ç§</p>
<ul>
<li><ol>
<li>kCFRunLoopDefaultModeï¼šAppçš„é»˜è®¤Modeï¼Œé€šå¸¸ä¸»çº¿ç¨‹æ˜¯åœ¨è¿™ä¸ªModeä¸‹è¿è¡Œ</li>
</ol>
</li>
<li><ol start="2">
<li>UITrackingRunLoopModeï¼šç•Œé¢è·Ÿè¸ª Modeï¼Œç”¨äº ScrollView è¿½è¸ªè§¦æ‘¸æ»‘åŠ¨ï¼Œä¿è¯ç•Œé¢æ»‘åŠ¨æ—¶ä¸å—å…¶ä»– Mode å½±å“</li>
</ol>
</li>
<li><ol start="3">
<li>UIInitializationRunLoopMode: åœ¨åˆšå¯åŠ¨ App æ—¶ç¬¬è¿›å…¥çš„ç¬¬ä¸€ä¸ª Modeï¼Œå¯åŠ¨å®Œæˆåå°±ä¸å†ä½¿ç”¨ï¼Œä¼šåˆ‡æ¢åˆ°kCFRunLoopDefaultMode</li>
</ol>
</li>
<li><ol start="4">
<li>GSEventReceiveRunLoopMode: æ¥å—ç³»ç»Ÿäº‹ä»¶çš„å†…éƒ¨ Modeï¼Œé€šå¸¸ç”¨ä¸åˆ°</li>
</ol>
</li>
<li><ol start="5">
<li>kCFRunLoopCommonModes: è¿™æ˜¯ä¸€ä¸ªå ä½ç”¨çš„Modeï¼Œä½œä¸ºæ ‡è®°kCFRunLoopDefaultModeå’ŒUITrackingRunLoopModeç”¨ï¼Œå¹¶ä¸æ˜¯ä¸€ç§çœŸæ­£çš„Mode </li>
</ol>
</li>
</ul>
<blockquote>
<p>Modeé—´çš„åˆ‡æ¢<br>æˆ‘ä»¬å¹³æ—¶åœ¨å¼€å‘ä¸­ä¸€å®šé‡åˆ°è¿‡ï¼Œå½“æˆ‘ä»¬ä½¿ç”¨NSTimeræ¯ä¸€æ®µæ—¶é—´æ‰§è¡Œä¸€äº›äº‹æƒ…æ—¶æ»‘åŠ¨UIScrollViewï¼ŒNSTimerå°±ä¼šæš‚åœï¼Œå½“æˆ‘ä»¬åœæ­¢æ»‘åŠ¨ä»¥åï¼ŒNSTimeråˆä¼šé‡æ–°æ¢å¤çš„æƒ…å†µï¼Œæˆ‘ä»¬é€šè¿‡ä¸€æ®µä»£ç æ¥çœ‹ä¸€ä¸‹<br>ä»£ç ä¸­çš„æ³¨é‡Šä¹Ÿå¾ˆé‡è¦ï¼Œå±•ç¤ºäº†æˆ‘ä»¬æ¢ç´¢çš„è¿‡ç¨‹</p>
</blockquote>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">-(<span class="keyword">void</span>)touchesBegan:(<span class="built_in">NSSet</span>&lt;<span class="built_in">UITouch</span> *&gt; *)touches withEvent:(<span class="built_in">UIEvent</span> *)event &#123;</span><br><span class="line">    <span class="comment">// [NSTimer scheduledTimerWithTimeInterval:2.0 target:self selector:@selector(show) userInfo:nil repeats:YES];</span></span><br><span class="line">    <span class="built_in">NSTimer</span> *timer = [<span class="built_in">NSTimer</span> timerWithTimeInterval:<span class="number">2.0</span> target:<span class="keyword">self</span> selector:<span class="keyword">@selector</span>(show) userInfo:<span class="literal">nil</span> repeats:<span class="literal">YES</span>];</span><br><span class="line">    <span class="comment">// åŠ å…¥åˆ°RunLoopä¸­æ‰å¯ä»¥è¿è¡Œ</span></span><br><span class="line">    <span class="comment">// 1. æŠŠå®šæ—¶å™¨æ·»åŠ åˆ°RunLoopä¸­ï¼Œå¹¶ä¸”é€‰æ‹©é»˜è®¤è¿è¡Œæ¨¡å¼NSDefaultRunLoopMode = kCFRunLoopDefaultMode</span></span><br><span class="line">    <span class="comment">// [[NSRunLoop mainRunLoop] addTimer:timer forMode:NSDefaultRunLoopMode];</span></span><br><span class="line">    <span class="comment">// å½“textFiledæ»‘åŠ¨çš„æ—¶å€™ï¼Œtimerå¤±æ•ˆï¼Œåœæ­¢æ»‘åŠ¨æ—¶ï¼Œtimeræ¢å¤</span></span><br><span class="line">    <span class="comment">// åŸå› ï¼šå½“textFiledæ»‘åŠ¨çš„æ—¶å€™ï¼ŒRunLoopçš„Modeä¼šè‡ªåŠ¨åˆ‡æ¢æˆUITrackingRunLoopModeæ¨¡å¼ï¼Œå› æ­¤timerå¤±æ•ˆï¼Œå½“åœæ­¢æ»‘åŠ¨ï¼ŒRunLoopåˆä¼šåˆ‡æ¢å›NSDefaultRunLoopModeæ¨¡å¼ï¼Œå› æ­¤timeråˆä¼šé‡æ–°å¯åŠ¨äº†</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 2. å½“æˆ‘ä»¬å°†timeræ·»åŠ åˆ°UITrackingRunLoopModeæ¨¡å¼ä¸­ï¼Œæ­¤æ—¶åªæœ‰æˆ‘ä»¬åœ¨æ»‘åŠ¨textFieldæ—¶timeræ‰ä¼šè¿è¡Œ</span></span><br><span class="line">    <span class="comment">// [[NSRunLoop mainRunLoop] addTimer:timer forMode:UITrackingRunLoopMode];</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 3. é‚£ä¸ªå¦‚ä½•è®©timeråœ¨ä¸¤ä¸ªæ¨¡å¼ä¸‹éƒ½å¯ä»¥è¿è¡Œå‘¢ï¼Ÿ</span></span><br><span class="line">    <span class="comment">// 3.1 åœ¨ä¸¤ä¸ªæ¨¡å¼ä¸‹éƒ½æ·»åŠ timer æ˜¯å¯ä»¥çš„ï¼Œä½†æ˜¯timeræ·»åŠ äº†ä¸¤æ¬¡ï¼Œå¹¶ä¸æ˜¯åŒä¸€ä¸ªtimer</span></span><br><span class="line">    <span class="comment">// 3.2 ä½¿ç”¨ç«™ä½çš„è¿è¡Œæ¨¡å¼ NSRunLoopCommonModesæ ‡è®°ï¼Œå‡¡æ˜¯è¢«æ‰“ä¸ŠNSRunLoopCommonModesæ ‡è®°çš„éƒ½å¯ä»¥è¿è¡Œï¼Œä¸‹é¢ä¸¤ç§æ¨¡å¼è¢«æ‰“ä¸Šæ ‡ç­¾</span></span><br><span class="line">    <span class="comment">//0 : &lt;CFString 0x10b7fe210 [0x10a8c7a40]&gt;&#123;contents = "UITrackingRunLoopMode"&#125;</span></span><br><span class="line">    <span class="comment">//2 : &lt;CFString 0x10a8e85e0 [0x10a8c7a40]&gt;&#123;contents = "kCFRunLoopDefaultMode"&#125;</span></span><br><span class="line">    <span class="comment">// å› æ­¤ä¹Ÿå°±æ˜¯è¯´å¦‚æœæˆ‘ä»¬ä½¿ç”¨NSRunLoopCommonModesï¼Œtimerå¯ä»¥åœ¨UITrackingRunLoopModeï¼ŒkCFRunLoopDefaultModeä¸¤ç§æ¨¡å¼ä¸‹è¿è¡Œ</span></span><br><span class="line">    [[<span class="built_in">NSRunLoop</span> mainRunLoop] addTimer:timer forMode:<span class="built_in">NSRunLoopCommonModes</span>];</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@"%@"</span>,[<span class="built_in">NSRunLoop</span> mainRunLoop]);</span><br><span class="line">&#125;</span><br><span class="line">-(<span class="keyword">void</span>)show &#123;</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@"-------"</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ç”±ä¸Šè¿°ä»£ç å¯ä»¥çœ‹å‡ºï¼ŒNSTimerä¸ç®¡ç”¨æ˜¯å› ä¸ºModeçš„åˆ‡æ¢ï¼Œå› ä¸ºå¦‚æœæˆ‘ä»¬åœ¨ä¸»çº¿ç¨‹ä½¿ç”¨å®šæ—¶å™¨ï¼Œæ­¤æ—¶RunLoopçš„Modeä¸ºkCFRunLoopDefaultModeï¼Œå³å®šæ—¶å™¨å±äºkCFRunLoopDefaultModeï¼Œé‚£ä¹ˆæ­¤æ—¶æˆ‘ä»¬æ»‘åŠ¨ScrollViewæ—¶ï¼ŒRunLoopçš„Modeä¼šåˆ‡æ¢åˆ°UITrackingRunLoopModeï¼Œå› æ­¤åœ¨ä¸»çº¿ç¨‹çš„å®šæ—¶å™¨å°±ä¸åœ¨ç®¡ç”¨äº†ï¼Œè°ƒç”¨çš„æ–¹æ³•ä¹Ÿå°±ä¸å†æ‰§è¡Œäº†ï¼Œå½“æˆ‘ä»¬åœæ­¢æ»‘åŠ¨æ—¶ï¼ŒRunLoopçš„Modeåˆ‡æ¢å›kCFRunLoopDefaultModeï¼Œæ‰€ä»¥NSTimerå°±åˆç®¡ç”¨äº†ã€‚<br>åŒæ ·é“ç†çš„è¿˜æœ‰ImageViewçš„æ˜¾ç¤ºï¼Œæˆ‘ä»¬ç›´æ¥æ¥çœ‹ä»£ç ï¼Œä¸å†èµ˜è¿°äº†</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">- (<span class="keyword">void</span>)touchesBegan:(<span class="built_in">NSSet</span>&lt;<span class="built_in">UITouch</span> *&gt; *)touches withEvent:(<span class="built_in">UIEvent</span> *)event &#123;</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@"%s"</span>,__func__);</span><br><span class="line">    <span class="comment">// performSelectoré»˜è®¤æ˜¯åœ¨defaultæ¨¡å¼ä¸‹è¿è¡Œï¼Œå› æ­¤åœ¨æ»‘åŠ¨ScrollViewæ—¶ï¼Œå›¾ç‰‡ä¸ä¼šåŠ è½½</span></span><br><span class="line">    <span class="comment">// [self.imageView performSelector:@selector(setImage:) withObject:[UIImage imageNamed:@"abc"] afterDelay:2.0 ];</span></span><br><span class="line">    <span class="comment">// inModes: ä¼ å…¥Modeæ•°ç»„</span></span><br><span class="line">    [<span class="keyword">self</span>.imageView performSelector:<span class="keyword">@selector</span>(setImage:) withObject:[<span class="built_in">UIImage</span> imageNamed:<span class="string">@"abc"</span>] afterDelay:<span class="number">2.0</span> inModes:@[<span class="built_in">NSDefaultRunLoopMode</span>,<span class="built_in">UITrackingRunLoopMode</span>]];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ä½¿ç”¨GCDä¹Ÿå¯æ˜¯åˆ›å»ºè®¡æ—¶å™¨ï¼Œè€Œä¸”æ›´ä¸ºç²¾ç¡®æˆ‘ä»¬æ¥çœ‹ä¸€ä¸‹ä»£ç </p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">- (<span class="keyword">void</span>)touchesBegan:(<span class="built_in">NSSet</span>&lt;<span class="built_in">UITouch</span> *&gt; *)touches withEvent:(<span class="built_in">UIEvent</span> *)event &#123;</span><br><span class="line">    <span class="comment">//åˆ›å»ºé˜Ÿåˆ—</span></span><br><span class="line">    <span class="built_in">dispatch_queue_t</span> queue = dispatch_get_global_queue(<span class="number">0</span>, <span class="number">0</span>);</span><br><span class="line">    <span class="comment">//1.åˆ›å»ºä¸€ä¸ªGCDå®šæ—¶å™¨</span></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">    ç¬¬ä¸€ä¸ªå‚æ•°:è¡¨æ˜åˆ›å»ºçš„æ˜¯ä¸€ä¸ªå®šæ—¶å™¨</span></span><br><span class="line"><span class="comment">    ç¬¬å››ä¸ªå‚æ•°:é˜Ÿåˆ—</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">    dispatch_source_t timer = dispatch_source_create(DISPATCH_SOURCE_TYPE_TIMER, <span class="number">0</span>, <span class="number">0</span>, queue);</span><br><span class="line">    <span class="comment">// éœ€è¦å¯¹timerè¿›è¡Œå¼ºå¼•ç”¨ï¼Œä¿è¯å…¶ä¸ä¼šè¢«é‡Šæ”¾æ‰ï¼Œæ‰ä¼šæŒ‰æ—¶è°ƒç”¨blockå—</span></span><br><span class="line">    <span class="comment">// å±€éƒ¨å˜é‡ï¼Œè®©æŒ‡é’ˆå¼ºå¼•ç”¨</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">self</span>.timer = timer;</span><br><span class="line">    <span class="comment">//2.è®¾ç½®å®šæ—¶å™¨çš„å¼€å§‹æ—¶é—´,é—´éš”æ—¶é—´,ç²¾å‡†åº¦</span></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">    ç¬¬1ä¸ªå‚æ•°:è¦ç»™å“ªä¸ªå®šæ—¶å™¨è®¾ç½®</span></span><br><span class="line"><span class="comment">    ç¬¬2ä¸ªå‚æ•°:å¼€å§‹æ—¶é—´</span></span><br><span class="line"><span class="comment">    ç¬¬3ä¸ªå‚æ•°:é—´éš”æ—¶é—´</span></span><br><span class="line"><span class="comment">    ç¬¬4ä¸ªå‚æ•°:ç²¾å‡†åº¦ ä¸€èˆ¬ä¸º0 åœ¨å…è®¸èŒƒå›´å†…å¢åŠ è¯¯å·®å¯æé«˜ç¨‹åºçš„æ€§èƒ½</span></span><br><span class="line"><span class="comment">    GCDçš„å•ä½æ˜¯çº³ç§’ æ‰€ä»¥è¦*NSEC_PER_SEC</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">    dispatch_source_set_timer(timer, DISPATCH_TIME_NOW, <span class="number">2.0</span> * <span class="built_in">NSEC_PER_SEC</span>, <span class="number">0</span> * <span class="built_in">NSEC_PER_SEC</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//3.è®¾ç½®å®šæ—¶å™¨è¦æ‰§è¡Œçš„äº‹æƒ…</span></span><br><span class="line">    dispatch_source_set_event_handler(timer, ^&#123;</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@"---%@--"</span>,[<span class="built_in">NSThread</span> currentThread]);</span><br><span class="line">    &#125;);</span><br><span class="line">    <span class="comment">// å¯åŠ¨</span></span><br><span class="line">    dispatch_resume(timer);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>2ï¼‰CFRunLoopSourceRefäº‹ä»¶æºï¼ˆè¾“å…¥æºï¼‰<br>Sourceåˆ†ä¸ºä¸¤ç§</p>
<ul>
<li>Source0ï¼šéåŸºäºPortçš„ ç”¨äºç”¨æˆ·ä¸»åŠ¨è§¦å‘çš„äº‹ä»¶ï¼ˆç‚¹å‡»button æˆ–ç‚¹å‡»å±å¹•ï¼‰</li>
<li>Source1ï¼šåŸºäºPortçš„  é€šè¿‡å†…æ ¸å’Œå…¶ä»–çº¿ç¨‹ç›¸äº’å‘é€æ¶ˆæ¯ï¼ˆä¸å†…æ ¸ç›¸å…³ï¼‰</li>
</ul>
<p>è§¦æ‘¸äº‹ä»¶åŠPerformSelectorsä¼šè§¦å‘Source0äº‹ä»¶æºåœ¨å‰æ–‡å·²ç»éªŒè¯è¿‡ï¼Œè¿™é‡Œä¸åœ¨èµ˜è¿°</p>
<p>3ï¼‰CFRunLoopObserverRef</p>
<p>CFRunLoopObserverRefæ˜¯è§‚å¯Ÿè€…ï¼Œèƒ½å¤Ÿç›‘å¬RunLoopçš„çŠ¶æ€æ”¹å˜</p>
<p>æˆ‘ä»¬ç›´æ¥æ¥çœ‹ä»£ç ï¼Œç»™RunLoopæ·»åŠ ç›‘å¬è€…ï¼Œç›‘å¬å…¶è¿è¡ŒçŠ¶æ€</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line">- (<span class="keyword">void</span>)touchesBegan:(<span class="built_in">NSSet</span>&lt;<span class="built_in">UITouch</span> *&gt; *)touches withEvent:(<span class="built_in">UIEvent</span> *)event &#123;</span><br><span class="line">    <span class="comment">//åˆ›å»ºç›‘å¬è€…</span></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">    ç¬¬ä¸€ä¸ªå‚æ•° CFAllocatorRef allocatorï¼šåˆ†é…å­˜å‚¨ç©ºé—´ CFAllocatorGetDefault()é»˜è®¤åˆ†é…</span></span><br><span class="line"><span class="comment">    ç¬¬äºŒä¸ªå‚æ•° CFOptionFlags activitiesï¼šè¦ç›‘å¬çš„çŠ¶æ€ kCFRunLoopAllActivities ç›‘å¬æ‰€æœ‰çŠ¶æ€</span></span><br><span class="line"><span class="comment">    ç¬¬ä¸‰ä¸ªå‚æ•° Boolean repeatsï¼šYES:æŒç»­ç›‘å¬ NO:ä¸æŒç»­</span></span><br><span class="line"><span class="comment">    ç¬¬å››ä¸ªå‚æ•° CFIndex orderï¼šä¼˜å…ˆçº§ï¼Œä¸€èˆ¬å¡«0å³å¯</span></span><br><span class="line"><span class="comment">    ç¬¬äº”ä¸ªå‚æ•° å›è°ƒ ä¸¤ä¸ªå‚æ•°observer:ç›‘å¬è€… activity:ç›‘å¬çš„äº‹ä»¶</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">    æ‰€æœ‰äº‹ä»¶</span></span><br><span class="line"><span class="comment">    typedef CF_OPTIONS(CFOptionFlags, CFRunLoopActivity) &#123;</span></span><br><span class="line"><span class="comment">        kCFRunLoopEntry = (1UL &lt;&lt; 0),   //   å³å°†è¿›å…¥RunLoop</span></span><br><span class="line"><span class="comment">        kCFRunLoopBeforeTimers = (1UL &lt;&lt; 1), // å³å°†å¤„ç†Timer</span></span><br><span class="line"><span class="comment">        kCFRunLoopBeforeSources = (1UL &lt;&lt; 2), // å³å°†å¤„ç†Source</span></span><br><span class="line"><span class="comment">        kCFRunLoopBeforeWaiting = (1UL &lt;&lt; 5), //å³å°†è¿›å…¥ä¼‘çœ </span></span><br><span class="line"><span class="comment">        kCFRunLoopAfterWaiting = (1UL &lt;&lt; 6),// åˆšä»ä¼‘çœ ä¸­å”¤é†’</span></span><br><span class="line"><span class="comment">        kCFRunLoopExit = (1UL &lt;&lt; 7),// å³å°†é€€å‡ºRunLoop</span></span><br><span class="line"><span class="comment">        kCFRunLoopAllActivities = 0x0FFFFFFFU</span></span><br><span class="line"><span class="comment">    &#125;;</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">    <span class="built_in">CFRunLoopObserverRef</span> observer = <span class="built_in">CFRunLoopObserverCreateWithHandler</span>(<span class="built_in">CFAllocatorGetDefault</span>(), kCFRunLoopAllActivities, <span class="literal">YES</span>, <span class="number">0</span>, ^(<span class="built_in">CFRunLoopObserverRef</span> observer, <span class="built_in">CFRunLoopActivity</span> activity) &#123;</span><br><span class="line">            <span class="keyword">switch</span> (activity) &#123;</span><br><span class="line">            <span class="keyword">case</span> kCFRunLoopEntry:</span><br><span class="line">                <span class="built_in">NSLog</span>(<span class="string">@"RunLoopè¿›å…¥"</span>);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> kCFRunLoopBeforeTimers:</span><br><span class="line">                <span class="built_in">NSLog</span>(<span class="string">@"RunLoopè¦å¤„ç†Timersäº†"</span>);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> kCFRunLoopBeforeSources:</span><br><span class="line">                <span class="built_in">NSLog</span>(<span class="string">@"RunLoopè¦å¤„ç†Sourcesäº†"</span>);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> kCFRunLoopBeforeWaiting:</span><br><span class="line">                <span class="built_in">NSLog</span>(<span class="string">@"RunLoopè¦ä¼‘æ¯äº†"</span>);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> kCFRunLoopAfterWaiting:</span><br><span class="line">                <span class="built_in">NSLog</span>(<span class="string">@"RunLoopé†’æ¥äº†"</span>);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> kCFRunLoopExit:</span><br><span class="line">                <span class="built_in">NSLog</span>(<span class="string">@"RunLoopé€€å‡ºäº†"</span>);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">default</span>:</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ç»™RunLoopæ·»åŠ ç›‘å¬è€…</span></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">    ç¬¬ä¸€ä¸ªå‚æ•° CFRunLoopRef rlï¼šè¦ç›‘å¬å“ªä¸ªRunLoop,è¿™é‡Œç›‘å¬çš„æ˜¯ä¸»çº¿ç¨‹çš„RunLoop</span></span><br><span class="line"><span class="comment">    ç¬¬äºŒä¸ªå‚æ•° CFRunLoopObserverRef observer ç›‘å¬è€…</span></span><br><span class="line"><span class="comment">    ç¬¬ä¸‰ä¸ªå‚æ•° CFStringRef mode è¦ç›‘å¬RunLoopåœ¨å“ªç§è¿è¡Œæ¨¡å¼ä¸‹çš„çŠ¶æ€</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">    <span class="built_in">CFRunLoopAddObserver</span>(<span class="built_in">CFRunLoopGetCurrent</span>(), observer, kCFRunLoopDefaultMode);</span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">    CFçš„å†…å­˜ç®¡ç†ï¼ˆCore Foundationï¼‰</span></span><br><span class="line"><span class="comment">    å‡¡æ˜¯å¸¦æœ‰Createã€Copyã€Retainç­‰å­—çœ¼çš„å‡½æ•°ï¼Œåˆ›å»ºå‡ºæ¥çš„å¯¹è±¡ï¼Œéƒ½éœ€è¦åœ¨æœ€ååšä¸€æ¬¡release</span></span><br><span class="line"><span class="comment">    GCDæœ¬æ¥åœ¨iOS6.0ä¹‹å‰ä¹Ÿæ˜¯éœ€è¦æˆ‘ä»¬é‡Šæ”¾çš„ï¼Œ6.0ä¹‹åGCDå·²ç»çº³å…¥åˆ°äº†ARCä¸­ï¼Œæ‰€ä»¥æˆ‘ä»¬ä¸éœ€è¦ç®¡äº†</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">    <span class="built_in">CFRelease</span>(observer);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>æˆ‘ä»¬æ¥çœ‹ä¸€ä¸‹è¾“å‡º</p>
<p><img src="https://user-gold-cdn.xitu.io/2018/6/4/163ca0a73f1b5791?w=439&amp;h=383&amp;f=png&amp;s=244833" alt=""></p>
<p>ä»¥ä¸Šå¯ä»¥çœ‹å‡ºï¼ŒObserverç¡®å®ç”¨æ¥ç›‘å¬RunLoopçš„çŠ¶æ€ï¼ŒåŒ…æ‹¬å”¤é†’ï¼Œä¼‘æ¯ï¼Œä»¥åŠå¤„ç†å„ç§äº‹ä»¶ã€‚</p>
<h3 id="RunLoopå¤„ç†é€»è¾‘"><a href="#RunLoopå¤„ç†é€»è¾‘" class="headerlink" title="RunLoopå¤„ç†é€»è¾‘"></a>RunLoopå¤„ç†é€»è¾‘</h3><p>è¿™æ—¶æˆ‘ä»¬å†æ¥åˆ†æRunLoopçš„å¤„ç†é€»è¾‘ï¼Œå°±ä¼šç®€å•æ˜äº†å¾ˆå¤šï¼Œç°åœ¨å›å¤´çœ‹å®˜æ–¹æ–‡æ¡£RunLoopçš„å¤„ç†é€»è¾‘ï¼Œå¯¹RunLoopçš„å¤„ç†é€»è¾‘æœ‰æ–°çš„è®¤è¯†ã€‚</p>
<p><img src="https://user-gold-cdn.xitu.io/2018/6/4/163ca0a717288734?w=495&amp;h=261&amp;f=png&amp;s=66608" alt=""></p>
<h4 id="æºç è§£æ"><a href="#æºç è§£æ" class="headerlink" title="æºç è§£æ"></a>æºç è§£æ</h4><p>ä¸‹é¢æºç ä»…ä¿ç•™äº†ä¸»æµç¨‹ä»£ç </p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// å…±å¤–éƒ¨è°ƒç”¨çš„å…¬å¼€çš„CFRunLoopRunæ–¹æ³•ï¼Œå…¶å†…éƒ¨ä¼šè°ƒç”¨CFRunLoopRunSpecific</span></span><br><span class="line"><span class="keyword">void</span> <span class="built_in">CFRunLoopRun</span>(<span class="keyword">void</span>) &#123;    <span class="comment">/* DOES CALLOUT */</span></span><br><span class="line">    int32_t result;</span><br><span class="line">    <span class="keyword">do</span> &#123;</span><br><span class="line">        result = <span class="built_in">CFRunLoopRunSpecific</span>(<span class="built_in">CFRunLoopGetCurrent</span>(), kCFRunLoopDefaultMode, <span class="number">1.0e10</span>, <span class="literal">false</span>);</span><br><span class="line">        CHECK_FOR_FORK();</span><br><span class="line">    &#125; <span class="keyword">while</span> (kCFRunLoopRunStopped != result &amp;&amp; kCFRunLoopRunFinished != result);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ç»è¿‡ç²¾ç®€çš„ CFRunLoopRunSpecific å‡½æ•°ä»£ç ï¼Œå…¶å†…éƒ¨ä¼šè°ƒç”¨__CFRunLoopRunå‡½æ•°</span></span><br><span class="line">SInt32 <span class="built_in">CFRunLoopRunSpecific</span>(<span class="built_in">CFRunLoopRef</span> rl, <span class="built_in">CFStringRef</span> modeName, <span class="built_in">CFTimeInterval</span> seconds, Boolean returnAfterSourceHandled) &#123;     <span class="comment">/* DOES CALLOUT */</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// é€šçŸ¥Observers : è¿›å…¥Loop</span></span><br><span class="line">    <span class="comment">// __CFRunLoopDoObserverså†…éƒ¨ä¼šè°ƒç”¨ __CFRUNLOOP_IS_CALLING_OUT_TO_AN_OBSERVER_CALLBACK_FUNCTION__å‡½æ•°</span></span><br><span class="line">    <span class="keyword">if</span> (currentMode-&gt;_observerMask &amp; kCFRunLoopEntry ) __CFRunLoopDoObservers(rl, currentMode, kCFRunLoopEntry);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// æ ¸å¿ƒçš„Loopé€»è¾‘</span></span><br><span class="line">    result = __CFRunLoopRun(rl, currentMode, seconds, returnAfterSourceHandled, previousMode);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// é€šçŸ¥Observers : é€€å‡ºLoop</span></span><br><span class="line">    <span class="keyword">if</span> (currentMode-&gt;_observerMask &amp; kCFRunLoopExit ) __CFRunLoopDoObservers(rl, currentMode, kCFRunLoopExit);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ç²¾ç®€åçš„ __CFRunLoopRunå‡½æ•°ï¼Œä¿ç•™äº†ä¸»è¦ä»£ç </span></span><br><span class="line"><span class="keyword">static</span> int32_t __CFRunLoopRun(<span class="built_in">CFRunLoopRef</span> rl, <span class="built_in">CFRunLoopModeRef</span> rlm, <span class="built_in">CFTimeInterval</span> seconds, Boolean stopAfterHandle, <span class="built_in">CFRunLoopModeRef</span> previousMode) &#123;</span><br><span class="line">    int32_t retVal = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">do</span> &#123;</span><br><span class="line">        <span class="comment">// é€šçŸ¥Observersï¼šå³å°†å¤„ç†Timers</span></span><br><span class="line">        __CFRunLoopDoObservers(rl, rlm, kCFRunLoopBeforeTimers); </span><br><span class="line"></span><br><span class="line">        <span class="comment">// é€šçŸ¥Observersï¼šå³å°†å¤„ç†Sources</span></span><br><span class="line">        __CFRunLoopDoObservers(rl, rlm, kCFRunLoopBeforeSources);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// å¤„ç†Blocks</span></span><br><span class="line">        __CFRunLoopDoBlocks(rl, rlm);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// å¤„ç†Sources0</span></span><br><span class="line">        <span class="keyword">if</span> (__CFRunLoopDoSources0(rl, rlm, stopAfterHandle)) &#123;</span><br><span class="line">            <span class="comment">// å¤„ç†Blocks</span></span><br><span class="line">            __CFRunLoopDoBlocks(rl, rlm);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// å¦‚æœæœ‰Sources1ï¼Œå°±è·³è½¬åˆ°handle_msgæ ‡è®°å¤„</span></span><br><span class="line">        <span class="keyword">if</span> (__CFRunLoopServiceMachPort(dispatchPort, &amp;msg, <span class="keyword">sizeof</span>(msg_buffer), &amp;livePort, <span class="number">0</span>, &amp;voucherState, <span class="literal">NULL</span>)) &#123;</span><br><span class="line">            <span class="keyword">goto</span> handle_msg;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// é€šçŸ¥Observersï¼šå³å°†ä¼‘çœ </span></span><br><span class="line">        __CFRunLoopDoObservers(rl, rlm, kCFRunLoopBeforeWaiting);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// è¿›å…¥ä¼‘çœ ï¼Œç­‰å¾…å…¶ä»–æ¶ˆæ¯å”¤é†’</span></span><br><span class="line">        __CFRunLoopSetSleeping(rl);</span><br><span class="line">        __CFPortSetInsert(dispatchPort, waitSet);</span><br><span class="line">        <span class="keyword">do</span> &#123;</span><br><span class="line">            __CFRunLoopServiceMachPort(waitSet, &amp;msg, <span class="keyword">sizeof</span>(msg_buffer), &amp;livePort, poll ? <span class="number">0</span> : TIMEOUT_INFINITY, &amp;voucherState, &amp;voucherCopy);</span><br><span class="line">        &#125; <span class="keyword">while</span> (<span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// é†’æ¥</span></span><br><span class="line">        __CFPortSetRemove(dispatchPort, waitSet);</span><br><span class="line">        __CFRunLoopUnsetSleeping(rl);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// é€šçŸ¥Observersï¼šå·²ç»å”¤é†’</span></span><br><span class="line">        __CFRunLoopDoObservers(rl, rlm, kCFRunLoopAfterWaiting);</span><br><span class="line"></span><br><span class="line">        handle_msg: <span class="comment">// çœ‹çœ‹æ˜¯è°å”¤é†’äº†RunLoopï¼Œè¿›è¡Œç›¸åº”çš„å¤„ç†</span></span><br><span class="line">        <span class="keyword">if</span> (è¢«Timerå”¤é†’çš„) &#123;</span><br><span class="line">            <span class="comment">// å¤„ç†Timer</span></span><br><span class="line">            __CFRunLoopDoTimers(rl, rlm, mach_absolute_time());</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (è¢«GCDå”¤é†’çš„) &#123;</span><br><span class="line">            __CFRUNLOOP_IS_SERVICING_THE_MAIN_DISPATCH_QUEUE__(msg);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123; <span class="comment">// è¢«Sources1å”¤é†’çš„</span></span><br><span class="line">            __CFRunLoopDoSource1(rl, rlm, rls, msg, msg-&gt;msgh_size, &amp;reply);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// æ‰§è¡ŒBlocks</span></span><br><span class="line">        __CFRunLoopDoBlocks(rl, rlm);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// æ ¹æ®ä¹‹å‰çš„æ‰§è¡Œç»“æœï¼Œæ¥å†³å®šæ€ä¹ˆåšï¼Œä¸ºretValèµ‹ç›¸åº”çš„å€¼</span></span><br><span class="line">        <span class="keyword">if</span> (sourceHandledThisLoop &amp;&amp; stopAfterHandle) &#123;</span><br><span class="line">            retVal = kCFRunLoopRunHandledSource;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (timeout_context-&gt;termTSR &lt; mach_absolute_time()) &#123;</span><br><span class="line">            retVal = kCFRunLoopRunTimedOut;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (__CFRunLoopIsStopped(rl)) &#123;</span><br><span class="line">            __CFRunLoopUnsetStopped(rl);</span><br><span class="line">            retVal = kCFRunLoopRunStopped;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (rlm-&gt;_stopped) &#123;</span><br><span class="line">            rlm-&gt;_stopped = <span class="literal">false</span>;</span><br><span class="line">            retVal = kCFRunLoopRunStopped;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (__CFRunLoopModeIsEmpty(rl, rlm, previousMode)) &#123;</span><br><span class="line">            retVal = kCFRunLoopRunFinished;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">while</span> (<span class="number">0</span> == retVal);</span><br><span class="line">    <span class="keyword">return</span> retVal;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ä¸Šè¿°æºä»£ç ä¸­ï¼Œç›¸åº”å¤„ç†äº‹ä»¶å‡½æ•°å†…éƒ¨è¿˜ä¼šè°ƒç”¨æ›´åº•å±‚çš„å‡½æ•°ï¼Œå†…éƒ¨è°ƒç”¨æ‰æ˜¯çœŸæ­£å¤„ç†äº‹ä»¶çš„å‡½æ•°ï¼Œé€šè¿‡ä¸Šé¢btæ‰“å°å…¨éƒ¨å †æ ˆä¿¡æ¯ä¹Ÿå¯ä»¥å¾—åˆ°éªŒè¯ã€‚</p>
<p>1ï¼‰<strong>CFRunLoopDoObservers å†…éƒ¨è°ƒç”¨ï¼š </strong>CFRUNLOOP_IS_CALLING_OUT_TO_AN_OBSERVER_CALLBACK_FUNCTION__</p>
<p>2ï¼‰<strong>CFRunLoopDoBlocks å†…éƒ¨è°ƒç”¨ï¼š
</strong>CFRUNLOOP_IS_CALLING_OUT_TO_A_BLOCK__</p>
<p>3ï¼‰<strong>CFRunLoopDoSources0 å†…éƒ¨è°ƒç”¨ï¼š
</strong>CFRUNLOOP_IS_CALLING_OUT_TO_A_SOURCE0_PERFORM_FUNCTION__</p>
<p>4ï¼‰<strong>CFRunLoopDoTimers å†…éƒ¨è°ƒç”¨ï¼š
</strong>CFRUNLOOP_IS_CALLING_OUT_TO_A_TIMER_CALLBACK_FUNCTION__</p>
<p>5ï¼‰GCD è°ƒç”¨ï¼š<br><strong>CFRUNLOOP_IS_SERVICING_THE_MAIN_DISPATCH_QUEUE</strong></p>
<p>6ï¼‰<strong>CFRunLoopDoSource1 å†…éƒ¨è°ƒç”¨ï¼š
</strong>CFRUNLOOP_IS_CALLING_OUT_TO_A_SOURCE1_PERFORM_FUNCTION__</p>
<h4 id="RunLoopå¤„ç†é€»è¾‘æµç¨‹å›¾"><a href="#RunLoopå¤„ç†é€»è¾‘æµç¨‹å›¾" class="headerlink" title="RunLoopå¤„ç†é€»è¾‘æµç¨‹å›¾"></a>RunLoopå¤„ç†é€»è¾‘æµç¨‹å›¾</h4><p>æ­¤æ—¶æˆ‘ä»¬æŒ‰ç…§æºç é‡æ–°æ•´ç†ä¸€ä¸‹RunLoopå¤„ç†é€»è¾‘å°±ä¼šå¾ˆæ¸…æ™°</p>
<p><img src="https://user-gold-cdn.xitu.io/2018/6/4/163ca0a716fed87e?w=747&amp;h=746&amp;f=png&amp;s=119107" alt=""></p>
<h3 id="RunLoop-é€€å‡º"><a href="#RunLoop-é€€å‡º" class="headerlink" title="RunLoop é€€å‡º"></a>RunLoop é€€å‡º</h3><ul>
<li>1.ä¸»çº¿ç¨‹é”€æ¯RunLoopé€€å‡º</li>
<li>2.Modeä¸­æœ‰ä¸€äº›Timer ã€Sourceã€ Observerï¼Œè¿™äº›ä¿è¯Modeä¸ä¸ºç©ºæ—¶ä¿è¯RunLoopæ²¡æœ‰ç©ºè½¬å¹¶ä¸”æ˜¯åœ¨è¿è¡Œçš„ï¼Œå½“Modeä¸­ä¸ºç©ºçš„æ—¶å€™ï¼ŒRunLoopä¼šç«‹åˆ»é€€å‡º</li>
<li>3.æˆ‘ä»¬åœ¨å¯åŠ¨RunLoopçš„æ—¶å€™å¯ä»¥è®¾ç½®ä»€ä¹ˆæ—¶å€™åœæ­¢</li>
</ul>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[<span class="built_in">NSRunLoop</span> currentRunLoop]runUntilDate:&lt;<span class="meta">#(nonnull NSDate *)#&gt;</span></span><br><span class="line">[<span class="built_in">NSRunLoop</span> currentRunLoop]runMode:&lt;<span class="meta">#(nonnull NSString *)#&gt; beforeDate:<span class="meta-string">&lt;#(nonnull NSDate *)#&gt;</span></span></span><br></pre></td></tr></table></figure>
<h3 id="ç›¸å…³é—®é¢˜"><a href="#ç›¸å…³é—®é¢˜" class="headerlink" title="ç›¸å…³é—®é¢˜"></a>ç›¸å…³é—®é¢˜</h3><p>ä¸€äº›æœ‰å…³Runloopçš„é—®é¢˜</p>
<p>1ï¼‰åŸºäºNSTimerçš„è½®æ’­å™¨ä»€ä¹ˆæƒ…å†µä¸‹ä¼šè¢«é¡µé¢æ»šåŠ¨æš‚åœï¼Œæ€æ ·å¯ä»¥ä¸è¢«æš‚åœï¼Œä¸ºä»€ä¹ˆï¼Ÿ</p>
<p>NSTimerä¸ç®¡ç”¨æ˜¯å› ä¸ºModeçš„åˆ‡æ¢ï¼Œå› ä¸ºå¦‚æœæˆ‘ä»¬åœ¨ä¸»çº¿ç¨‹ä½¿ç”¨å®šæ—¶å™¨ï¼Œæ­¤æ—¶RunLoopçš„Modeä¸ºkCFRunLoopDefaultModeï¼Œå³å®šæ—¶å™¨å±äºkCFRunLoopDefaultModeï¼Œé‚£ä¹ˆæ­¤æ—¶æˆ‘ä»¬æ»‘åŠ¨ScrollViewæ—¶ï¼ŒRunLoopçš„Modeä¼šåˆ‡æ¢åˆ°UITrackingRunLoopModeï¼Œå› æ­¤åœ¨ä¸»çº¿ç¨‹çš„å®šæ—¶å™¨å°±ä¸åœ¨ç®¡ç”¨äº†ï¼Œè°ƒç”¨çš„æ–¹æ³•ä¹Ÿå°±ä¸å†æ‰§è¡Œäº†ï¼Œå½“æˆ‘ä»¬åœæ­¢æ»‘åŠ¨æ—¶ï¼ŒRunLoopçš„Modeåˆ‡æ¢å›kCFRunLoopDefaultModeï¼Œæ‰€æœ‰NSTimerå°±åˆç®¡ç”¨äº†ã€‚è‹¥æƒ³å®šæ—¶å™¨ç»§ç»­æ‰§è¡Œï¼Œéœ€è¦å°†NSTimer æ³¨å†Œä¸º kCFRunLoopCommonModes ã€‚</p>
<p>2ï¼‰å»¶è¿Ÿæ‰§è¡ŒperformSelecterç›¸å…³æ–¹æ³•æ˜¯æ€æ ·è¢«æ‰§è¡Œçš„ï¼Ÿåœ¨å­çº¿ç¨‹ä¸­ä¹Ÿæ˜¯ä¸€æ ·çš„å—ï¼Ÿ<br>å½“è°ƒç”¨ NSObject çš„ performSelecter:afterDelay: åï¼Œå®é™…ä¸Šå…¶å†…éƒ¨ä¼šåˆ›å»ºä¸€ä¸ª Timer å¹¶æ·»åŠ åˆ°å½“å‰çº¿ç¨‹çš„ RunLoop ä¸­ã€‚æ‰€ä»¥å¦‚æœå½“å‰çº¿ç¨‹æ²¡æœ‰ RunLoopï¼Œåˆ™è¿™ä¸ªæ–¹æ³•ä¼šå¤±æ•ˆã€‚</p>
<p>å½“è°ƒç”¨ performSelector:onThread: æ—¶ï¼Œå®é™…ä¸Šå…¶ä¼šåˆ›å»ºä¸€ä¸ª Timer åŠ åˆ°å¯¹åº”çš„çº¿ç¨‹å»ï¼ŒåŒæ ·çš„ï¼Œå¦‚æœå¯¹åº”çº¿ç¨‹æ²¡æœ‰ RunLoop è¯¥æ–¹æ³•ä¹Ÿä¼šå¤±æ•ˆã€‚</p>
<p>3ï¼‰äº‹ä»¶å“åº”å’Œæ‰‹åŠ¿è¯†åˆ«åº•å±‚å¤„ç†æ˜¯ä¸€è‡´çš„å—ï¼Œä¸ºä»€ä¹ˆï¼Ÿ</p>
<p>äº‹ä»¶å“åº”ï¼š</p>
<p>è‹¹æœæ³¨å†Œäº†ä¸€ä¸ª Source1 (åŸºäº mach port çš„) ç”¨æ¥æ¥æ”¶ç³»ç»Ÿäº‹ä»¶ï¼Œå…¶å›è°ƒå‡½æ•°ä¸º _IOHIDEventSystemClientQueueCallback()ã€‚<br>å½“ä¸€ä¸ªç¡¬ä»¶äº‹ä»¶(è§¦æ‘¸/é”å±/æ‘‡æ™ƒç­‰)å‘ç”Ÿåï¼Œé¦–å…ˆç”± IOKit.framework ç”Ÿæˆä¸€ä¸ª IOHIDEvent äº‹ä»¶å¹¶ç”± SpringBoard æ¥æ”¶ã€‚SpringBoard åªæ¥æ”¶æŒ‰é”®(é”å±/é™éŸ³ç­‰)ï¼Œè§¦æ‘¸ï¼ŒåŠ é€Ÿï¼Œæ¥è¿‘ä¼ æ„Ÿå™¨ç­‰å‡ ç§ Eventï¼Œéšåç”¨ mach port è½¬å‘ç»™éœ€è¦çš„Appè¿›ç¨‹ã€‚éšåè‹¹æœæ³¨å†Œçš„é‚£ä¸ª Source1 å°±ä¼šè§¦å‘å›è°ƒï¼Œå¹¶è°ƒç”¨ _UIApplicationHandleEventQueue() è¿›è¡Œåº”ç”¨å†…éƒ¨çš„åˆ†å‘ã€‚</p>
<p>_UIApplicationHandleEventQueue() ä¼šæŠŠ IOHIDEvent å¤„ç†å¹¶åŒ…è£…æˆ UIEvent è¿›è¡Œå¤„ç†æˆ–åˆ†å‘ï¼Œå…¶ä¸­åŒ…æ‹¬è¯†åˆ« UIGesture/å¤„ç†å±å¹•æ—‹è½¬/å‘é€ç»™ UIWindow ç­‰ã€‚é€šå¸¸äº‹ä»¶æ¯”å¦‚ UIButton ç‚¹å‡»ã€touchesBegin/Move/End/Cancel äº‹ä»¶éƒ½æ˜¯åœ¨è¿™ä¸ªå›è°ƒä¸­å®Œæˆçš„ã€‚</p>
<p>æ‰‹åŠ¿è¯†åˆ«ï¼š</p>
<p>å½“ä¸Šé¢çš„ _UIApplicationHandleEventQueue() è¯†åˆ«äº†ä¸€ä¸ªæ‰‹åŠ¿æ—¶ï¼Œå…¶é¦–å…ˆä¼šè°ƒç”¨ Cancel å°†å½“å‰çš„ touchesBegin/Move/End ç³»åˆ—å›è°ƒæ‰“æ–­ã€‚éšåç³»ç»Ÿå°†å¯¹åº”çš„ UIGestureRecognizer æ ‡è®°ä¸ºå¾…å¤„ç†ã€‚</p>
<p>è‹¹æœæ³¨å†Œäº†ä¸€ä¸ª Observer ç›‘æµ‹ BeforeWaiting (Loopå³å°†è¿›å…¥ä¼‘çœ ) äº‹ä»¶ï¼Œè¿™ä¸ªObserverçš„å›è°ƒå‡½æ•°æ˜¯ _UIGestureRecognizerUpdateObserver()ï¼Œå…¶å†…éƒ¨ä¼šè·å–æ‰€æœ‰åˆšè¢«æ ‡è®°ä¸ºå¾…å¤„ç†çš„ GestureRecognizerï¼Œå¹¶æ‰§è¡ŒGestureRecognizerçš„å›è°ƒã€‚</p>
<p>å½“æœ‰ UIGestureRecognizer çš„å˜åŒ–(åˆ›å»º/é”€æ¯/çŠ¶æ€æ”¹å˜)æ—¶ï¼Œè¿™ä¸ªå›è°ƒéƒ½ä¼šè¿›è¡Œç›¸åº”å¤„ç†ã€‚</p>
<p>4ï¼‰ç•Œé¢åˆ·æ–°æ—¶ï¼Œæ˜¯åœ¨ä»€ä¹ˆæ—¶å€™ä¼šçœŸæ­£æ‰§è¡Œåˆ·æ–°ï¼Œä¸ºä»€ä¹ˆä¼šåˆ·æ–°ä¸åŠæ—¶ï¼Ÿ<br>å½“åœ¨æ“ä½œ UI æ—¶ï¼Œæ¯”å¦‚æ”¹å˜äº† Frameã€æ›´æ–°äº† UIView/CALayer çš„å±‚æ¬¡æ—¶ï¼Œæˆ–è€…æ‰‹åŠ¨è°ƒç”¨äº† UIView/CALayer çš„ setNeedsLayout/setNeedsDisplayæ–¹æ³•åï¼Œè¿™ä¸ª UIView/CALayer å°±è¢«æ ‡è®°ä¸ºå¾…å¤„ç†ï¼Œå¹¶è¢«æäº¤åˆ°ä¸€ä¸ªå…¨å±€çš„å®¹å™¨å»ã€‚</p>
<p>è‹¹æœæ³¨å†Œäº†ä¸€ä¸ª Observer ç›‘å¬ BeforeWaiting(å³å°†è¿›å…¥ä¼‘çœ ) å’Œ Exit (å³å°†é€€å‡ºLoop) äº‹ä»¶ï¼Œå›è°ƒå»æ‰§è¡Œä¸€ä¸ªå¾ˆé•¿çš„å‡½æ•°ï¼š</p>
<p>_ZN2CA11Transaction17observer_callbackEP19__CFRunLoopObservermPv()ã€‚è¿™ä¸ªå‡½æ•°é‡Œä¼šéå†æ‰€æœ‰å¾…å¤„ç†çš„ UIView/CAlayer ä»¥æ‰§è¡Œå®é™…çš„ç»˜åˆ¶å’Œè°ƒæ•´ï¼Œå¹¶æ›´æ–° UI ç•Œé¢ã€‚æ‰€ä»¥è¯´ç•Œé¢åˆ·æ–°å¹¶ä¸ä¸€å®šæ˜¯åœ¨setNeedsLayoutç›¸å…³çš„ä»£ç æ‰§è¡Œåç«‹åˆ»è¿›è¡Œçš„ã€‚</p>
<p>5ï¼‰é¡¹ç›®ç¨‹åºè¿è¡Œä¸­ï¼Œæ€»æ˜¯ä¼´éšç€å¤šæ¬¡è‡ªåŠ¨é‡Šæ”¾æ± çš„åˆ›å»ºå’Œé”€æ¯ï¼Œè¿™äº›æ˜¯åœ¨ä»€ä¹ˆæ—¶å€™å‘ç”Ÿçš„å‘¢ï¼Ÿ</p>
<p>ç³»ç»Ÿå°±æ˜¯é€šè¿‡@autoreleasepool {}è¿™ç§æ–¹å¼æ¥ä¸ºæˆ‘ä»¬åˆ›å»ºè‡ªåŠ¨é‡Šæ”¾æ± çš„ï¼Œä¸€ä¸ªçº¿ç¨‹å¯¹åº”ä¸€ä¸ªrunloopï¼Œç³»ç»Ÿä¼šä¸ºæ¯ä¸€ä¸ªrunloopéšå¼çš„åˆ›å»ºä¸€ä¸ªè‡ªåŠ¨é‡Šæ”¾æ± ï¼Œæ‰€æœ‰çš„autoreleasePoolæ„æˆä¸€ä¸ªæ ˆå¼ç»“æ„ï¼Œåœ¨æ¯ä¸ªrunloopç»“æŸæ—¶ï¼Œå½“å‰æ ˆé¡¶çš„autoreleasePoolä¼šè¢«é”€æ¯ï¼Œè€Œä¸”ä¼šå¯¹å…¶ä¸­çš„æ¯ä¸€ä¸ªå¯¹è±¡åšä¸€æ¬¡releaseï¼ˆä¸¥æ ¼æ¥è¯´ï¼Œæ˜¯ä½ å¯¹è¿™ä¸ªå¯¹è±¡åšäº†å‡ æ¬¡autoreleaseå°±ä¼šåšå‡ æ¬¡releaseï¼Œä¸ä¸€å®šæ˜¯ä¸€æ¬¡)ï¼Œç‰¹åˆ«æŒ‡å‡ºï¼Œä½¿ç”¨å®¹å™¨çš„blockç‰ˆæœ¬çš„æšä¸¾å™¨çš„æ—¶å€™ï¼Œç³»ç»Ÿä¼šè‡ªåŠ¨æ·»åŠ ä¸€ä¸ªautoreleasePool</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[array enumerateObjectsUsingBlock:^(<span class="keyword">id</span> obj, <span class="built_in">NSUInteger</span> idx, <span class="built_in">BOOL</span> *stop) &#123; </span><br><span class="line"><span class="comment">// è¿™é‡Œè¢«ä¸€ä¸ªå±€éƒ¨@autoreleasepoolåŒ…å›´ç€ </span></span><br><span class="line">&#125;];</span><br></pre></td></tr></table></figure>
<p>6ï¼‰å½“æˆ‘ä»¬åœ¨å­çº¿ç¨‹ä¸Šéœ€è¦æ‰§è¡Œä»£ç†æ–¹æ³•æˆ–è€…å›è°ƒæ—¶ï¼Œæ€ä¹ˆç¡®ä¿å½“å‰çº¿ç¨‹æ²¡æœ‰è¢«é”€æ¯ï¼Ÿ<br>é¦–å…ˆå¼•å…¥ä¸€ä¸ªæ¦‚å¿µï¼šEvent_loopï¼Œä¸€èˆ¬ä¸€ä¸ªçº¿ç¨‹æ‰§è¡Œå®Œä»»åŠ¡åå°±ä¼šé€€å‡ºï¼Œå½“éœ€è¦ä¿è¯è¯¥çº¿ç¨‹ä¸é€€å‡ºï¼Œå¯ä»¥é€šè¿‡ç±»ä¼¼ä»¥ä¸‹æ–¹å¼ï¼š</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">function do_loop() &#123;</span><br><span class="line">    initialize();</span><br><span class="line">    <span class="keyword">do</span> &#123;</span><br><span class="line">        var message = get_next_message();</span><br><span class="line">        process_message(message);</span><br><span class="line">    &#125; <span class="keyword">while</span> (message != quit);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>å¼€å¯ä¸€ä¸ªå¾ªç¯ï¼Œä¿è¯çº¿ç¨‹ä¸é€€å‡ºï¼Œè¿™å°±æ˜¯Event_loopæ¨¡å‹ã€‚è¿™æ˜¯åœ¨å¾ˆå¤šæ“ä½œç³»ç»Ÿä¸­éƒ½ä½¿ç”¨çš„æ¨¡å‹ï¼Œä¾‹å¦‚OS/iOSä¸­çš„RunLoopã€‚è¿™ç§æ¨¡å‹æœ€å¤§çš„ä½œç”¨å°±æ˜¯ç®¡ç†äº‹ä»¶/æ¶ˆæ¯ï¼Œåœ¨æœ‰æ–°æ¶ˆæ¯åˆ°æ¥æ—¶ç«‹åˆ»å”¤é†’å¤„ç†ï¼Œæ²¡æœ‰å¾…å¤„ç†æ¶ˆæ¯æ—¶çº¿ç¨‹ä¼‘çœ ï¼Œé¿å…èµ„æºæµªè´¹ã€‚</p>
<h3 id="RunLoop-ä½¿ç”¨åœºæ™¯"><a href="#RunLoop-ä½¿ç”¨åœºæ™¯" class="headerlink" title="RunLoop ä½¿ç”¨åœºæ™¯"></a>RunLoop ä½¿ç”¨åœºæ™¯</h3><p>1ï¼‰å¸¸é©»çº¿ç¨‹</p>
<p>å¸¸é©»çº¿ç¨‹çš„ä½œç”¨ï¼šæˆ‘ä»¬çŸ¥é“ï¼Œå½“å­çº¿ç¨‹ä¸­çš„ä»»åŠ¡æ‰§è¡Œå®Œæ¯•ä¹‹åå°±è¢«é”€æ¯äº†ï¼Œé‚£ä¹ˆå¦‚æœæˆ‘ä»¬éœ€è¦å¼€å¯ä¸€ä¸ªå­çº¿ç¨‹ï¼Œåœ¨ç¨‹åºè¿è¡Œè¿‡ç¨‹ä¸­æ°¸è¿œéƒ½å­˜åœ¨ï¼Œé‚£ä¹ˆæˆ‘ä»¬å°±ä¼šé¢ä¸´ä¸€ä¸ªé—®é¢˜ï¼Œå¦‚ä½•è®©å­çº¿ç¨‹æ°¸è¿œæ´»ç€ï¼Œè¿™æ—¶å°±è¦ç”¨åˆ°å¸¸é©»çº¿ç¨‹ï¼šç»™å­çº¿ç¨‹å¼€å¯ä¸€ä¸ªRunLoop </p>
<blockquote>
<p>æ³¨æ„ï¼šå­çº¿ç¨‹æ‰§è¡Œå®Œæ“ä½œä¹‹åå°±ä¼šç«‹å³é‡Šæ”¾ï¼Œå³ä½¿æˆ‘ä»¬ä½¿ç”¨å¼ºå¼•ç”¨å¼•ç”¨å­çº¿ç¨‹ä½¿å­çº¿ç¨‹ä¸è¢«é‡Šæ”¾ï¼Œä¹Ÿä¸èƒ½ç»™å­çº¿ç¨‹å†æ¬¡æ·»åŠ æ“ä½œï¼Œæˆ–è€…å†æ¬¡å¼€å¯ã€‚ </p>
</blockquote>
<p>å­çº¿ç¨‹å¼€å¯RunLoopçš„ä»£ç ï¼Œå…ˆç‚¹å‡»å±å¹•å¼€å¯å­çº¿ç¨‹å¹¶å¼€å¯å­çº¿ç¨‹RunLoopï¼Œç„¶åç‚¹å‡»buttonã€‚</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line">- (<span class="keyword">void</span>)touchesBegan:(<span class="built_in">NSSet</span>&lt;<span class="built_in">UITouch</span> *&gt; *)touches withEvent:(<span class="built_in">UIEvent</span> *)event &#123;</span><br><span class="line">    <span class="comment">// åˆ›å»ºå­çº¿ç¨‹å¹¶å¼€å¯</span></span><br><span class="line">    <span class="built_in">NSThread</span> *thread = [[<span class="built_in">NSThread</span> alloc]initWithTarget:<span class="keyword">self</span> selector:<span class="keyword">@selector</span>(show) object:<span class="literal">nil</span>];</span><br><span class="line">    <span class="keyword">self</span>.thread = thread;</span><br><span class="line">    [thread start];</span><br><span class="line">&#125;</span><br><span class="line">- (<span class="keyword">void</span>)show &#123;</span><br><span class="line">    <span class="comment">// æ³¨æ„ï¼šæ‰“å°æ–¹æ³•ä¸€å®šè¦åœ¨RunLoopåˆ›å»ºå¼€å§‹è¿è¡Œä¹‹å‰ï¼Œå¦‚æœåœ¨RunLoopè·‘èµ·æ¥ä¹‹åæ‰“å°ï¼ŒRunLoopå…ˆè¿è¡Œèµ·æ¥ï¼Œå·²ç»åœ¨è·‘åœˆäº†å°±å‡ºä¸æ¥äº†ï¼Œè¿›å…¥æ­»å¾ªç¯ä¹Ÿå°±æ— æ³•æ‰§è¡Œåé¢çš„æ“ä½œäº†ã€‚</span></span><br><span class="line">    <span class="comment">// ä½†æ˜¯æ­¤æ—¶ç‚¹å‡»Buttonè¿˜æ˜¯æœ‰æ“ä½œçš„ï¼Œå› ä¸ºButtonæ˜¯åœ¨RunLoopè·‘èµ·æ¥ä¹‹ååŠ å…¥åˆ°å­çº¿ç¨‹çš„ï¼Œå½“ButtonåŠ å…¥åˆ°å­çº¿ç¨‹RunLoopå°±ä¼šè·‘èµ·æ¥</span></span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@"%s"</span>,__func__);</span><br><span class="line">    <span class="comment">// 1.åˆ›å»ºå­çº¿ç¨‹ç›¸å…³çš„RunLoopï¼Œåœ¨å­çº¿ç¨‹ä¸­åˆ›å»ºå³å¯ï¼Œå¹¶ä¸”RunLoopä¸­è¦è‡³å°‘æœ‰ä¸€ä¸ªTimer æˆ– ä¸€ä¸ªSource ä¿è¯RunLoopä¸ä¼šå› ä¸ºç©ºè½¬è€Œé€€å‡ºï¼Œå› æ­¤åœ¨åˆ›å»ºçš„æ—¶å€™ç›´æ¥åŠ å…¥</span></span><br><span class="line">    <span class="comment">// æ·»åŠ Source [NSMachPort port] æ·»åŠ ä¸€ä¸ªç«¯å£</span></span><br><span class="line">    [[<span class="built_in">NSRunLoop</span> currentRunLoop] addPort:[<span class="built_in">NSMachPort</span> port] forMode:<span class="built_in">NSDefaultRunLoopMode</span>];</span><br><span class="line">    <span class="comment">// æ·»åŠ ä¸€ä¸ªTimer</span></span><br><span class="line">    <span class="built_in">NSTimer</span> *timer = [<span class="built_in">NSTimer</span> scheduledTimerWithTimeInterval:<span class="number">2.0</span> target:<span class="keyword">self</span> selector:<span class="keyword">@selector</span>(test) userInfo:<span class="literal">nil</span> repeats:<span class="literal">YES</span>];</span><br><span class="line">    [[<span class="built_in">NSRunLoop</span> currentRunLoop] addTimer:timer forMode:<span class="built_in">NSDefaultRunLoopMode</span>];</span><br><span class="line">    <span class="comment">//åˆ›å»ºç›‘å¬è€…</span></span><br><span class="line">    <span class="built_in">CFRunLoopObserverRef</span> observer = <span class="built_in">CFRunLoopObserverCreateWithHandler</span>(<span class="built_in">CFAllocatorGetDefault</span>(), kCFRunLoopAllActivities, <span class="literal">YES</span>, <span class="number">0</span>, ^(<span class="built_in">CFRunLoopObserverRef</span> observer, <span class="built_in">CFRunLoopActivity</span> activity) &#123;</span><br><span class="line">        <span class="keyword">switch</span> (activity) &#123;</span><br><span class="line">        <span class="keyword">case</span> kCFRunLoopEntry:</span><br><span class="line">            <span class="built_in">NSLog</span>(<span class="string">@"RunLoopè¿›å…¥"</span>);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> kCFRunLoopBeforeTimers:</span><br><span class="line">            <span class="built_in">NSLog</span>(<span class="string">@"RunLoopè¦å¤„ç†Timersäº†"</span>);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> kCFRunLoopBeforeSources:</span><br><span class="line">            <span class="built_in">NSLog</span>(<span class="string">@"RunLoopè¦å¤„ç†Sourcesäº†"</span>);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> kCFRunLoopBeforeWaiting:</span><br><span class="line">            <span class="built_in">NSLog</span>(<span class="string">@"RunLoopè¦ä¼‘æ¯äº†"</span>);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> kCFRunLoopAfterWaiting:</span><br><span class="line">            <span class="built_in">NSLog</span>(<span class="string">@"RunLoopé†’æ¥äº†"</span>);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> kCFRunLoopExit:</span><br><span class="line">            <span class="built_in">NSLog</span>(<span class="string">@"RunLoopé€€å‡ºäº†"</span>);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">default</span>:</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">    <span class="comment">// ç»™RunLoopæ·»åŠ ç›‘å¬è€…</span></span><br><span class="line">    <span class="built_in">CFRunLoopAddObserver</span>(<span class="built_in">CFRunLoopGetCurrent</span>(), observer, kCFRunLoopDefaultMode);</span><br><span class="line">    <span class="comment">// 2.å­çº¿ç¨‹éœ€è¦å¼€å¯RunLoop</span></span><br><span class="line">    [[<span class="built_in">NSRunLoop</span> currentRunLoop]run];</span><br><span class="line">    <span class="built_in">CFRelease</span>(observer);</span><br><span class="line">&#125;</span><br><span class="line">- (<span class="keyword">IBAction</span>)btnClick:(<span class="keyword">id</span>)sender &#123;</span><br><span class="line">    [<span class="keyword">self</span> performSelector:<span class="keyword">@selector</span>(test) onThread:<span class="keyword">self</span>.thread withObject:<span class="literal">nil</span> waitUntilDone:<span class="literal">NO</span>];</span><br><span class="line">&#125;</span><br><span class="line">- (<span class="keyword">void</span>)test &#123;</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@"%@"</span>,[<span class="built_in">NSThread</span> currentThread]);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>æ³¨æ„ï¼šåˆ›å»ºå­çº¿ç¨‹ç›¸å…³çš„RunLoopï¼Œåœ¨å­çº¿ç¨‹ä¸­åˆ›å»ºå³å¯ï¼Œå¹¶ä¸”RunLoopä¸­è¦è‡³å°‘æœ‰ä¸€ä¸ªTimer æˆ– ä¸€ä¸ªSource ä¿è¯RunLoopä¸ä¼šå› ä¸ºç©ºè½¬è€Œé€€å‡ºï¼Œå› æ­¤åœ¨åˆ›å»ºçš„æ—¶å€™ç›´æ¥åŠ å…¥ï¼Œå¦‚æœæ²¡æœ‰åŠ å…¥Timeræˆ–è€…Sourceï¼Œæˆ–è€…åªåŠ å…¥ä¸€ä¸ªç›‘å¬è€…ï¼Œè¿è¡Œç¨‹åºä¼šå´©æºƒ</p>
<p>2ï¼‰è‡ªåŠ¨é‡Šæ”¾æ± <br>Timerå’ŒSourceä¹Ÿæ˜¯ä¸€äº›å˜é‡ï¼Œéœ€è¦å ç”¨ä¸€éƒ¨åˆ†å­˜å‚¨ç©ºé—´ï¼Œæ‰€ä»¥è¦é‡Šæ”¾æ‰ï¼Œå¦‚æœä¸é‡Šæ”¾æ‰ï¼Œå°±ä¼šä¸€ç›´ç§¯ç´¯ï¼Œå ç”¨çš„å†…å­˜ä¹Ÿå°±è¶Šæ¥è¶Šå¤§ï¼Œè¿™æ˜¾ç„¶ä¸æ˜¯æˆ‘ä»¬æƒ³è¦çš„ã€‚</p>
<p><em>é‚£ä¹ˆä»€ä¹ˆæ—¶å€™é‡Šæ”¾ï¼Œæ€ä¹ˆé‡Šæ”¾å‘¢ï¼Ÿ</em></p>
<p>RunLoopå†…éƒ¨æœ‰ä¸€ä¸ªè‡ªåŠ¨é‡Šæ”¾æ± ï¼Œå½“RunLoopå¼€å¯æ—¶ï¼Œå°±ä¼šè‡ªåŠ¨åˆ›å»ºä¸€ä¸ªè‡ªåŠ¨é‡Šæ”¾æ± ï¼Œå½“RunLoopåœ¨ä¼‘æ¯ä¹‹å‰ä¼šé‡Šæ”¾æ‰è‡ªåŠ¨é‡Šæ”¾æ± çš„ä¸œè¥¿ï¼Œç„¶åé‡æ–°åˆ›å»ºä¸€ä¸ªæ–°çš„ç©ºçš„è‡ªåŠ¨é‡Šæ”¾æ± ï¼Œå½“RunLoopè¢«å”¤é†’é‡æ–°å¼€å§‹è·‘åœˆæ—¶ï¼ŒTimer,Sourceç­‰æ–°çš„äº‹ä»¶å°±ä¼šæ”¾åˆ°æ–°çš„è‡ªåŠ¨é‡Šæ”¾æ± ä¸­ï¼Œå½“RunLoopé€€å‡ºçš„æ—¶å€™ä¹Ÿä¼šè¢«é‡Šæ”¾ã€‚</p>
<blockquote>
<p>æ³¨æ„ï¼šåªæœ‰ä¸»çº¿ç¨‹çš„RunLoopä¼šé»˜è®¤å¯åŠ¨ã€‚ä¹Ÿå°±æ„å‘³ç€ä¼šè‡ªåŠ¨åˆ›å»ºè‡ªåŠ¨é‡Šæ”¾æ± ï¼Œå­çº¿ç¨‹éœ€è¦åœ¨çº¿ç¨‹è°ƒåº¦æ–¹æ³•ä¸­æ‰‹åŠ¨æ·»åŠ è‡ªåŠ¨é‡Šæ”¾æ± ã€‚</p>
</blockquote>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">@autorelease&#123;  </span><br><span class="line">    <span class="comment">// æ‰§è¡Œä»£ç  </span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>3ï¼‰AFNetworking<br>ä½¿ç”¨NSOperation+NSURLConnectionå¹¶å‘æ¨¡å‹éƒ½ä¼šé¢ä¸´NSURLConnectionä¸‹è½½å®Œæˆå‰çº¿ç¨‹é€€å‡ºå¯¼è‡´NSOperationå¯¹è±¡æ¥æ”¶ä¸åˆ°å›è°ƒçš„é—®é¢˜ã€‚AFNetWorkingè§£å†³è¿™ä¸ªé—®é¢˜çš„æ–¹æ³•æ˜¯æŒ‰ç…§å®˜æ–¹çš„guid NSURLConnection ä¸Šå†™çš„NSURLConnectionçš„delegateæ–¹æ³•éœ€è¦åœ¨connectionå‘èµ·çš„çº¿ç¨‹runloopä¸­è°ƒç”¨ï¼Œäºæ˜¯AFNetWorkingç›´æ¥å€Ÿé‰´äº†Appleè‡ªå·±çš„ä¸€ä¸ªDemoçš„å®ç°æ–¹æ³•å•ç‹¬èµ·ä¸€ä¸ªglobal threadï¼Œå†…ç½®ä¸€ä¸ªrunloopï¼Œæ‰€æœ‰çš„connectionéƒ½ç”±è¿™ä¸ªrunloopå‘èµ·ï¼Œå›è°ƒä¹Ÿæ˜¯å®ƒæ¥æ”¶ï¼Œä¸å ç”¨ä¸»çº¿ç¨‹ï¼Œä¹Ÿä¸è€—CPUèµ„æºã€‚</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">+ (<span class="keyword">void</span>)networkRequestThreadEntryPoint:(<span class="keyword">id</span>)__unused object &#123;</span><br><span class="line">     <span class="keyword">@autoreleasepool</span> &#123;</span><br><span class="line">          [[<span class="built_in">NSThread</span> currentThread] setName:<span class="string">@"AFNetworking"</span>];</span><br><span class="line">          <span class="built_in">NSRunLoop</span> *runLoop = [<span class="built_in">NSRunLoop</span> currentRunLoop];</span><br><span class="line">          [runLoop addPort:[<span class="built_in">NSMachPort</span> port] forMode:<span class="built_in">NSDefaultRunLoopMode</span>];</span><br><span class="line">          [runLoop run];</span><br><span class="line">     &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">+ (<span class="built_in">NSThread</span> *)networkRequestThread &#123;</span><br><span class="line">     <span class="keyword">static</span> <span class="built_in">NSThread</span> *_networkRequestThread = <span class="literal">nil</span>;</span><br><span class="line">     <span class="keyword">static</span> <span class="built_in">dispatch_once_t</span> oncePredicate;</span><br><span class="line">     <span class="built_in">dispatch_once</span>(&amp;oncePredicate, ^&#123;</span><br><span class="line">          _networkRequestThread =</span><br><span class="line">          [[<span class="built_in">NSThread</span> alloc] initWithTarget:<span class="keyword">self</span></span><br><span class="line">               selector:<span class="keyword">@selector</span>(networkRequestThreadEntryPoint:)</span><br><span class="line">               object:<span class="literal">nil</span>];</span><br><span class="line">          [_networkRequestThread start];</span><br><span class="line">     &#125;);</span><br><span class="line"></span><br><span class="line">     <span class="keyword">return</span> _networkRequestThread;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ç±»ä¼¼çš„å¯ä»¥ç”¨è¿™ä¸ªæ–¹æ³•åˆ›å»ºä¸€ä¸ªå¸¸é©»æœåŠ¡çš„çº¿ç¨‹ã€‚</p>
<p>4ï¼‰TableViewä¸­å®ç°å¹³æ»‘æ»šåŠ¨å»¶è¿ŸåŠ è½½å›¾ç‰‡</p>
<p>åˆ©ç”¨CFRunLoopModeçš„ç‰¹æ€§ï¼Œå¯ä»¥å°†å›¾ç‰‡çš„åŠ è½½æ”¾åˆ°NSDefaultRunLoopModeçš„modeé‡Œï¼Œè¿™æ ·åœ¨æ»šåŠ¨UITrackingRunLoopModeè¿™ä¸ªmodeæ—¶ä¸ä¼šè¢«åŠ è½½è€Œå½±å“åˆ°ã€‚<br><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">UIImage</span> *downloadedImage = ...;</span><br><span class="line">[<span class="keyword">self</span>.imageView performSelector:<span class="keyword">@selector</span>(setImage:)</span><br><span class="line">     withObject:downloadedImage</span><br><span class="line">     afterDelay:<span class="number">0</span></span><br><span class="line">     inModes:@[<span class="built_in">NSDefaultRunLoopMode</span>]];</span><br></pre></td></tr></table></figure></p>
<p>5ï¼‰æ¥åˆ°ç¨‹åºå´©æºƒæ—¶çš„ä¿¡å·è¿›è¡Œè‡ªä¸»å¤„ç†ä¾‹å¦‚å¼¹å‡ºæç¤ºç­‰<br><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">CFRunLoopRef</span> runLoop = <span class="built_in">CFRunLoopGetCurrent</span>();</span><br><span class="line"><span class="built_in">NSArray</span> *allModes = <span class="built_in">CFBridgingRelease</span>(<span class="built_in">CFRunLoopCopyAllModes</span>(runLoop));</span><br><span class="line"><span class="keyword">while</span> (<span class="number">1</span>) &#123;</span><br><span class="line">     <span class="keyword">for</span> (<span class="built_in">NSString</span> *mode <span class="keyword">in</span> allModes) &#123;</span><br><span class="line">          <span class="built_in">CFRunLoopRunInMode</span>((<span class="built_in">CFStringRef</span>)mode, <span class="number">0.001</span>, <span class="literal">false</span>);</span><br><span class="line">     &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>6ï¼‰å¼‚æ­¥æµ‹è¯•<br><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">- (<span class="built_in">BOOL</span>)runUntilBlock:(<span class="built_in">BOOL</span>(^)())block timeout:(<span class="built_in">NSTimeInterval</span>)timeout</span><br><span class="line">&#123;</span><br><span class="line">     __block Boolean fulfilled = <span class="literal">NO</span>;</span><br><span class="line">     <span class="keyword">void</span> (^beforeWaiting) (<span class="built_in">CFRunLoopObserverRef</span> observer, <span class="built_in">CFRunLoopActivity</span> activity) =</span><br><span class="line">     ^(<span class="built_in">CFRunLoopObserverRef</span> observer, <span class="built_in">CFRunLoopActivity</span> activity) &#123;</span><br><span class="line">          fulfilled = block();</span><br><span class="line">          <span class="keyword">if</span> (fulfilled) &#123;</span><br><span class="line">               <span class="built_in">CFRunLoopStop</span>(<span class="built_in">CFRunLoopGetCurrent</span>());</span><br><span class="line">          &#125;</span><br><span class="line">     &#125;;</span><br><span class="line"></span><br><span class="line">     <span class="built_in">CFRunLoopObserverRef</span> observer = <span class="built_in">CFRunLoopObserverCreateWithHandler</span>(<span class="literal">NULL</span>, kCFRunLoopBeforeWaiting, <span class="literal">true</span>, <span class="number">0</span>, beforeWaiting);</span><br><span class="line">     <span class="built_in">CFRunLoopAddObserver</span>(<span class="built_in">CFRunLoopGetCurrent</span>(), observer, kCFRunLoopDefaultMode);</span><br><span class="line"></span><br><span class="line">     <span class="comment">// Run!</span></span><br><span class="line">     <span class="built_in">CFRunLoopRunInMode</span>(kCFRunLoopDefaultMode, timeout, <span class="literal">false</span>);</span><br><span class="line"></span><br><span class="line">     <span class="built_in">CFRunLoopRemoveObserver</span>(<span class="built_in">CFRunLoopGetCurrent</span>(), observer, kCFRunLoopDefaultMode);</span><br><span class="line">     <span class="built_in">CFRelease</span>(observer);</span><br><span class="line"></span><br><span class="line">     <span class="keyword">return</span> fulfilled;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>NSTimerã€ImageViewæ˜¾ç¤ºã€PerformSelectorç­‰åœ¨ä¸Šé¢å·²ç»æœ‰è¿‡ä¾‹å­ï¼Œè¿™é‡Œä¸å†èµ˜è¿°ã€‚</p>
<blockquote>
<p>ä»¥ä¸Šæ–‡ç« æ•´ç†è‡ªï¼š<a href="https://juejin.im/post/5add46606fb9a07abf721d1d" target="_blank" rel="noopener">https://juejin.im/post/5add46606fb9a07abf721d1d</a></p>
</blockquote>

      
    </div>
    <footer class="article-footer">
      
        <div id="donation_div"></div>

<script src="../../../../js/vdonate.js"></script>
<script>
var a = new Donate({
  title: 'å¦‚æœè§‰å¾—æˆ‘çš„æ–‡ç« å¯¹æ‚¨æœ‰ç”¨ï¼Œè¯·éšæ„æ‰“èµã€‚æ‚¨çš„æ”¯æŒå°†é¼“åŠ±æˆ‘ç»§ç»­åˆ›ä½œ!', // å¯é€‰å‚æ•°ï¼Œæ‰“èµæ ‡é¢˜
  btnText: 'Donate', // å¯é€‰å‚æ•°ï¼Œæ‰“èµæŒ‰é’®æ–‡å­—
  el: document.getElementById('donation_div'),
  wechatImage: 'http://ghexoblogimages.oss-cn-beijing.aliyuncs.com/18-11-14/6067039.jpg',
  alipayImage: 'http://ghexoblogimages.oss-cn-beijing.aliyuncs.com/18-11-16/6997594.jpg'
});
</script>
      
      
      
        
	<div id="comment">
		<!-- æ¥å¿…åŠ›Cityç‰ˆå®‰è£…ä»£ç  -->
		<div id="lv-container" data-id="city" data-uid="MTAyMC80MTA5OC8xNzYyMw==">
		<script type="text/javascript">
		   (function(d, s) {
		       var j, e = d.getElementsByTagName(s)[0];

		       if (typeof LivereTower === 'function') { return; }

		       j = d.createElement(s);
		       j.src = 'https://cdn-city.livere.com/js/embed.dist.js';
		       j.async = true;

		       e.parentNode.insertBefore(j, e);
		   })(document, 'script');
		</script>
		<noscript>ä¸ºæ­£å¸¸ä½¿ç”¨æ¥å¿…åŠ›è¯„è®ºåŠŸèƒ½è¯·æ¿€æ´»JavaScript</noscript>
		</div>
		<!-- Cityç‰ˆå®‰è£…ä»£ç å·²å®Œæˆ -->
	</div>



      
      

    </footer>
  </div>
  
    
<nav id="article-nav">
  
    <a href="../../08/iOS Principle Singleton/" id="article-nav-newer" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Newer</strong>
      <div class="article-nav-title">
        
          iOS Principleï¼šSingleton
        
      </div>
    </a>
  
  
    <a href="../../06/iOS Principle KVO/" id="article-nav-older" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Older</strong>
      <div class="article-nav-title">iOS Principleï¼šKVO</div>
    </a>
  
</nav>

  
</article>

<!-- Table of Contents -->

  <aside id="toc-sidebar">
    <div id="toc" class="toc-article">
    <strong class="toc-title">Contents</strong>
    
        <ol class="nav"><li class="nav-item nav-level-3"><a class="nav-link" href="#æ–¹ä¾¿è®°å¿†ï¼š"><span class="nav-number">1.</span> <span class="nav-text">æ–¹ä¾¿è®°å¿†ï¼š</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#RunLoopç®€ä»‹"><span class="nav-number">2.</span> <span class="nav-text">RunLoopç®€ä»‹</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#RunLoopåŸºæœ¬ä½œç”¨"><span class="nav-number">3.</span> <span class="nav-text">RunLoopåŸºæœ¬ä½œç”¨</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#RunLoopåœ¨å“ªé‡Œå¼€å¯"><span class="nav-number">4.</span> <span class="nav-text">RunLoopåœ¨å“ªé‡Œå¼€å¯</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#RunLoopå¯¹è±¡"><span class="nav-number">5.</span> <span class="nav-text">RunLoopå¯¹è±¡</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#å¦‚ä½•è·å¾—RunLoopå¯¹è±¡"><span class="nav-number">5.1.</span> <span class="nav-text">å¦‚ä½•è·å¾—RunLoopå¯¹è±¡</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#RunLoopå’Œçº¿ç¨‹é—´çš„å…³ç³»"><span class="nav-number">6.</span> <span class="nav-text">RunLoopå’Œçº¿ç¨‹é—´çš„å…³ç³»</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#RunLoopç»“æ„ä½“"><span class="nav-number">7.</span> <span class="nav-text">RunLoopç»“æ„ä½“</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#Source1-åŸºäºPortçš„çº¿ç¨‹é—´é€šä¿¡"><span class="nav-number">7.1.</span> <span class="nav-text">Source1 : åŸºäºPortçš„çº¿ç¨‹é—´é€šä¿¡</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Source0-è§¦æ‘¸äº‹ä»¶ï¼ŒPerformSelectors"><span class="nav-number">7.2.</span> <span class="nav-text">Source0 : è§¦æ‘¸äº‹ä»¶ï¼ŒPerformSelectors</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Timers-å®šæ—¶å™¨ï¼ŒNSTimer"><span class="nav-number">7.3.</span> <span class="nav-text">Timers : å®šæ—¶å™¨ï¼ŒNSTimer</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Observer-ç›‘å¬å™¨ï¼Œç”¨äºç›‘å¬RunLoopçš„çŠ¶æ€"><span class="nav-number">7.4.</span> <span class="nav-text">Observer : ç›‘å¬å™¨ï¼Œç”¨äºç›‘å¬RunLoopçš„çŠ¶æ€</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#è¯¦è§£RunLoopç›¸å…³ç±»åŠä½œç”¨"><span class="nav-number">8.</span> <span class="nav-text">è¯¦è§£RunLoopç›¸å…³ç±»åŠä½œç”¨</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#RunLoopå¤„ç†é€»è¾‘"><span class="nav-number">9.</span> <span class="nav-text">RunLoopå¤„ç†é€»è¾‘</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#æºç è§£æ"><span class="nav-number">9.1.</span> <span class="nav-text">æºç è§£æ</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#RunLoopå¤„ç†é€»è¾‘æµç¨‹å›¾"><span class="nav-number">9.2.</span> <span class="nav-text">RunLoopå¤„ç†é€»è¾‘æµç¨‹å›¾</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#RunLoop-é€€å‡º"><span class="nav-number">10.</span> <span class="nav-text">RunLoop é€€å‡º</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#ç›¸å…³é—®é¢˜"><span class="nav-number">11.</span> <span class="nav-text">ç›¸å…³é—®é¢˜</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#RunLoop-ä½¿ç”¨åœºæ™¯"><span class="nav-number">12.</span> <span class="nav-text">RunLoop ä½¿ç”¨åœºæ™¯</span></a></li></ol>
    
    </div>
  </aside>

</section>
        
      </div>
      
      <footer id="footer">
  

  <div class="container">
      	<div class="row">
	      <p> Powered by <a href="http://hexo.io/" target="_blank">Hexo</a> and <a href="https://github.com/iTimeTraveler/hexo-theme-hiker" target="_blank">Hexo-theme-hiker</a> </p>
	      <p id="copyRightEn">Copyright &copy; 2013 - 2018 Technology All Rights Reserved.</p>
	      
	      
    		<p class="busuanzi_uv">
				UV : <span id="busuanzi_value_site_uv"></span> |  
				PV : <span id="busuanzi_value_site_pv"></span>
		    </p>
  		   
		</div>

		
  </div>
</footer>


<!-- min height -->

<script>
    var wrapdiv = document.getElementById("wrap");
    var contentdiv = document.getElementById("content");
    var allheader = document.getElementById("allheader");

    wrapdiv.style.minHeight = document.body.offsetHeight + "px";
    if (allheader != null) {
      contentdiv.style.minHeight = document.body.offsetHeight - allheader.offsetHeight - document.getElementById("footer").offsetHeight + "px";
    } else {
      contentdiv.style.minHeight = document.body.offsetHeight - document.getElementById("footer").offsetHeight + "px";
    }
</script>
    </div>
    <!-- <nav id="mobile-nav">
  
    <a href="../../../../index.html" class="mobile-nav-link">Home</a>
  
    <a href="../../../../archives" class="mobile-nav-link">Archives</a>
  
    <a href="../../../../categories" class="mobile-nav-link">Categories</a>
  
    <a href="../../../../tags" class="mobile-nav-link">Tags</a>
  
    <a href="../../../../about" class="mobile-nav-link">About</a>
  
</nav> -->
    

<!-- mathjax config similar to math.stackexchange -->

<script type="text/x-mathjax-config">
  MathJax.Hub.Config({
    tex2jax: {
      inlineMath: [ ['$','$'], ["\\(","\\)"] ],
      processEscapes: true
    }
  });
</script>

<script type="text/x-mathjax-config">
    MathJax.Hub.Config({
      tex2jax: {
        skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
      }
    });
</script>

<script type="text/x-mathjax-config">
    MathJax.Hub.Queue(function() {
        var all = MathJax.Hub.getAllJax(), i;
        for(i=0; i < all.length; i += 1) {
            all[i].SourceElement().parentNode.className += ' has-jax';
        }
    });
</script>

<script type="text/javascript" src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
</script>


  <link rel="stylesheet" href="../../../../fancybox/jquery.fancybox.css">
  <script src="../../../../fancybox/jquery.fancybox.pack.js"></script>


<script src="../../../../js/scripts.js"></script>




  <script src="../../../../js/dialog.js"></script>








	<div style="display: none;">
    <script src="https://s95.cnzz.com/z_stat.php?id=1260716016&web_id=1260716016" language="JavaScript"></script>
  </div>



	<script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js">
	</script>






  </div>

  <div class="modal fade" id="myModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true" style="display: none;">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h2 class="modal-title" id="myModalLabel">è®¾ç½®</h2>
      </div>
      <hr style="margin-top:0px; margin-bottom:0px; width:80%; border-top: 3px solid #000;">
      <hr style="margin-top:2px; margin-bottom:0px; width:80%; border-top: 1px solid #000;">


      <div class="modal-body">
          <div style="margin:6px;">
            <a data-toggle="collapse" data-parent="#accordion" href="#collapseOne" onclick="javascript:setFontSize();" aria-expanded="true" aria-controls="collapseOne">
              æ­£æ–‡å­—å·å¤§å°
            </a>
          </div>
          <div id="collapseOne" class="panel-collapse collapse" role="tabpanel" aria-labelledby="headingOne">
          <div class="panel-body">
            æ‚¨å·²è°ƒæ•´é¡µé¢å­—ä½“å¤§å°
          </div>
        </div>
      


          <div style="margin:6px;">
            <a data-toggle="collapse" data-parent="#accordion" href="#collapseTwo" onclick="javascript:setBackground();" aria-expanded="true" aria-controls="collapseTwo">
              å¤œé—´æŠ¤çœ¼æ¨¡å¼
            </a>
        </div>
          <div id="collapseTwo" class="panel-collapse collapse" role="tabpanel" aria-labelledby="headingTwo">
          <div class="panel-body">
            å¤œé—´æ¨¡å¼å·²ç»å¼€å¯ï¼Œå†æ¬¡å•å‡»æŒ‰é’®å³å¯å…³é—­ 
          </div>
        </div>

        <div>
            <a data-toggle="collapse" data-parent="#accordion" href="#collapseThree" aria-expanded="true" aria-controls="collapseThree">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;å…³ äº&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</a>
        </div>
         <div id="collapseThree" class="panel-collapse collapse" role="tabpanel" aria-labelledby="headingThree">
          <div class="panel-body">
            Technology
          </div>
          <div class="panel-body">
            Copyright Â© 2018 Steven&#39;s Blog All Rights Reserved.
          </div>
        </div>
      </div>


      <hr style="margin-top:0px; margin-bottom:0px; width:80%; border-top: 1px solid #000;">
      <hr style="margin-top:2px; margin-bottom:0px; width:80%; border-top: 3px solid #000;">
      <div class="modal-footer">
        <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">Ã—</span></button>
      </div>
    </div>
  </div>
</div>
  
  <a id="rocket" href="#top" class=""></a>
  <script type="text/javascript" src="/js/totop.js?v=1.0.0" async=""></script>
  
    <a id="menu-switch"><i class="fa fa-bars fa-lg"></i></a>
  
</body>
</html>