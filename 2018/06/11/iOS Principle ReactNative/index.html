<!DOCTYPE html>
<html>
<head><meta name="generator" content="Hexo 3.8.0">
  <meta charset="utf-8">
  
  <title>ios principleï¼šreactnative | Technology</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  
    <meta name="keywords" content="Principle">
  
  
  
  
  <meta name="description" content="ReactNative åˆ©ç”¨äº†ç§»åŠ¨å¹³å°èƒ½å¤Ÿè¿è¡Œ JavaScript (è„šæœ¬è¯­è¨€)ä»£ç çš„èƒ½åŠ›ï¼Œå¹¶ä¸”å‘æŒ¥äº† JavaScript ä¸ä»…ä»…å¯ä»¥ä¼ é€’é…ç½®ä¿¡æ¯ï¼Œè¿˜å¯ä»¥è¡¨è¾¾é€»è¾‘ä¿¡æ¯çš„ä¼˜ç‚¹~">
<meta name="keywords" content="Principle">
<meta property="og:type" content="article">
<meta property="og:title" content="iOS Principleï¼šReactNative">
<meta property="og:url" content="https://reversescale.github.io/2018/06/11/iOS Principle ReactNative/index.html">
<meta property="og:site_name" content="Technology">
<meta property="og:description" content="ReactNative åˆ©ç”¨äº†ç§»åŠ¨å¹³å°èƒ½å¤Ÿè¿è¡Œ JavaScript (è„šæœ¬è¯­è¨€)ä»£ç çš„èƒ½åŠ›ï¼Œå¹¶ä¸”å‘æŒ¥äº† JavaScript ä¸ä»…ä»…å¯ä»¥ä¼ é€’é…ç½®ä¿¡æ¯ï¼Œè¿˜å¯ä»¥è¡¨è¾¾é€»è¾‘ä¿¡æ¯çš„ä¼˜ç‚¹~">
<meta property="og:locale" content="default">
<meta property="og:image" content="https://user-gold-cdn.xitu.io/2018/6/8/163de72bf327c5e2?w=1265&h=1181&f=png&s=100866">
<meta property="og:image" content="https://user-gold-cdn.xitu.io/2018/6/8/163de72bf39b9c2b?w=691&h=889&f=png&s=50345">
<meta property="og:image" content="https://user-gold-cdn.xitu.io/2018/6/8/163de72bed8ca4d1?w=940&h=370&f=png&s=440483">
<meta property="og:image" content="https://user-gold-cdn.xitu.io/2018/6/8/163de72bf259629a?w=940&h=1168&f=png&s=123372">
<meta property="og:image" content="https://user-gold-cdn.xitu.io/2018/6/8/163de72bf3201885?w=940&h=1168&f=png&s=123372">
<meta property="og:updated_time" content="2018-11-18T05:45:34.574Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="iOS Principleï¼šReactNative">
<meta name="twitter:description" content="ReactNative åˆ©ç”¨äº†ç§»åŠ¨å¹³å°èƒ½å¤Ÿè¿è¡Œ JavaScript (è„šæœ¬è¯­è¨€)ä»£ç çš„èƒ½åŠ›ï¼Œå¹¶ä¸”å‘æŒ¥äº† JavaScript ä¸ä»…ä»…å¯ä»¥ä¼ é€’é…ç½®ä¿¡æ¯ï¼Œè¿˜å¯ä»¥è¡¨è¾¾é€»è¾‘ä¿¡æ¯çš„ä¼˜ç‚¹~">
<meta name="twitter:image" content="https://user-gold-cdn.xitu.io/2018/6/8/163de72bf327c5e2?w=1265&h=1181&f=png&s=100866">
  
    <link rel="alternate" href="/atom.xml" title="Technology" type="application/atom+xml">
  

  

  <link rel="icon" href="/css/images/docccc.png">
  <link rel="apple-touch-icon" href="/css/images/docccc.png">
  
    <link href="//fonts.googleapis.com/css?family=Source+Code+Pro" rel="stylesheet" type="text/css">
  
  <link href="https://fonts.googleapis.com/css?family=Open+Sans|Montserrat:700" rel="stylesheet" type="text/css">
  <link href="https://fonts.googleapis.com/css?family=Roboto:400,300,300italic,400italic" rel="stylesheet" type="text/css">
  <link href="//cdn.bootcss.com/font-awesome/4.6.3/css/font-awesome.min.css" rel="stylesheet">
  <style type="text/css">
    @font-face{font-family:futura-pt;src:url(https://use.typekit.net/af/9749f0/00000000000000000001008f/27/l?subset_id=2&fvd=n5) format("woff2");font-weight:500;font-style:normal;}
    @font-face{font-family:futura-pt;src:url(https://use.typekit.net/af/90cf9f/000000000000000000010091/27/l?subset_id=2&fvd=n7) format("woff2");font-weight:500;font-style:normal;}
    @font-face{font-family:futura-pt;src:url(https://use.typekit.net/af/8a5494/000000000000000000013365/27/l?subset_id=2&fvd=n4) format("woff2");font-weight:lighter;font-style:normal;}
    @font-face{font-family:futura-pt;src:url(https://use.typekit.net/af/d337d8/000000000000000000010095/27/l?subset_id=2&fvd=i4) format("woff2");font-weight:400;font-style:italic;}</style>
  <link rel="stylesheet" href="../../../../css/style.css">

  <script src="../../../../js/jquery-3.1.1.min.js"></script>
  <script src="../../../../js/bootstrap.js"></script>

  <!-- Bootstrap core CSS -->
  <link rel="stylesheet" href="/css/bootstrap.css">

  
    <link rel="stylesheet" href="../../../../css/dialog.css">
  

  

  
    <link rel="stylesheet" href="/css/header-post.css">
  

  
  
  
    <link rel="stylesheet" href="/css/vdonate.css">
  

</head>
</html>


  <body data-spy="scroll" data-target="#toc" data-offset="50">


  
  <div id="container">
    <div id="wrap">
      
        <header>

    <div id="allheader" class="navbar navbar-default navbar-static-top" role="navigation">
        <div class="navbar-inner">
          
          <div class="container"> 
            <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
              <span class="sr-only">Toggle navigation</span>
              <span class="icon-bar"></span>
              <span class="icon-bar"></span>
              <span class="icon-bar"></span>
            </button>

            
              <a class="brand" style="
                 border-width: 0px;  margin-top: 0px;" href="#" data-toggle="modal" data-target="#myModal">
                  <img width="88px" height="88px" alt="Hike News" src="/css/images/docccc.png">
              </a>
            
            
            <div class="navbar-collapse collapse">
              <ul class="hnav navbar-nav">
                
                  <li> <a class="main-nav-link" href="../../../../index.html">Home</a> </li>
                
                  <li> <a class="main-nav-link" href="../../../../archives">Archives</a> </li>
                
                  <li> <a class="main-nav-link" href="../../../../categories">Categories</a> </li>
                
                  <li> <a class="main-nav-link" href="../../../../tags">Tags</a> </li>
                
                  <li> <a class="main-nav-link" href="../../../../about">About</a> </li>
                
                  <li><div id="search-form-wrap">

    <form class="search-form">
        <input type="text" class="ins-search-input search-form-input" placeholder="">
        <button type="submit" class="search-form-submit"></button>
    </form>
    <div class="ins-search">
    <div class="ins-search-mask"></div>
    <div class="ins-search-container">
        <div class="ins-input-wrapper">
            <input type="text" class="ins-search-input" placeholder="Type something...">
            <span class="ins-close ins-selectable"><i class="fa fa-times-circle"></i></span>
        </div>
        <div class="ins-section-wrapper">
            <div class="ins-section-container"></div>
        </div>
    </div>
</div>
<script>
(function (window) {
    var INSIGHT_CONFIG = {
        TRANSLATION: {
            POSTS: 'Posts',
            PAGES: 'Pages',
            CATEGORIES: 'Categories',
            TAGS: 'Tags',
            UNTITLED: '(Untitled)',
        },
        ROOT_URL: '/',
        CONTENT_URL: '../../../../content.json',
    };
    window.INSIGHT_CONFIG = INSIGHT_CONFIG;
})(window);
</script>
<script src="../../../../js/insight.js"></script>

</div></li>
            </ul></div>
          </div>
                
      </div>
    </div>

</header>



      
            
      <div id="content" class="outer">
        
          <section id="main" style="float:none;"><article id="post-iOS Principle ReactNative" style="width: 75%; float:left;" class="article article-type-post" itemscope="" itemprop="blogPost">
  <div id="articleInner" class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 class="thumb" itemprop="name">
      iOS Principleï¼šReactNative
    </h1>
  

      </header>
    
    <div class="article-meta">
      
	<a href="" class="article-date">
	  <time datetime="2018-06-11T13:56:27.000Z" itemprop="datePublished">2018-06-11</time>
	</a>

      
    <a class="article-category-link" href="../../../../categories/Principle/">Principle</a>

      
	<a class="article-views">
	<span id="busuanzi_container_page_pv">
		PV:<span id="busuanzi_value_page_pv"></span>
	</span>
	</a>

    </div>
    <div class="article-entry" itemprop="articleBody">
      
        <p>ReactNative åˆ©ç”¨äº†ç§»åŠ¨å¹³å°èƒ½å¤Ÿè¿è¡Œ JavaScript (è„šæœ¬è¯­è¨€)ä»£ç çš„èƒ½åŠ›ï¼Œå¹¶ä¸”å‘æŒ¥äº† JavaScript ä¸ä»…ä»…å¯ä»¥ä¼ é€’é…ç½®ä¿¡æ¯ï¼Œè¿˜å¯ä»¥è¡¨è¾¾é€»è¾‘ä¿¡æ¯çš„ä¼˜ç‚¹~ </p>
<a id="more"></a>
<hr>
<p>ğŸ‘¨ğŸ»â€ğŸ’» <a href="https://github.com/ReverseScale/iOSPrinciple_ReactNative" target="_blank" rel="noopener">Github Demo</a></p>
<h3 id="æ–¹ä¾¿è®°å¿†ï¼š"><a href="#æ–¹ä¾¿è®°å¿†ï¼š" class="headerlink" title="æ–¹ä¾¿è®°å¿†ï¼š"></a>æ–¹ä¾¿è®°å¿†ï¼š</h3><ul>
<li>ReactåŸç†ï¼šä¸€å¥—å¯ä»¥ç”¨ç®€æ´çš„è¯­æ³•é«˜æ•ˆç»˜åˆ¶ DOM çš„æ¡†æ¶</li>
<li>Reactç‰¹ç‚¹ï¼š<ul>
<li>ç®€æ´ï¼šä¸å•å•æŒ‡å®ƒçš„ HTML å’Œ CSS è¯­æ³•ï¼Œæ›´å› ä¸ºå¯ä»¥å•ç”¨ JavaScript æ„é€ é¡µé¢</li>
<li>é«˜æ•ˆï¼šå› ä¸º React ç‹¬åˆ›äº† Virtual DOM æœºåˆ¶ï¼Œä¸¤å¤§ç‰¹å¾<ul>
<li>å®ƒå­˜åœ¨äºå†…å­˜ä¸­çš„ JavaScript å¯¹è±¡ï¼Œå¹¶ä¸”ä¸ DOM æ˜¯å¯¹åº”å…³ç³»</li>
<li>ä½¿ç”¨é«˜æ•ˆçš„ DOM Diff ç®—æ³•ä¸éœ€è¦å¯¹ DOM è¿›è¡Œé‡æ–°ç»˜åˆ¶</li>
</ul>
</li>
</ul>
</li>
<li>React NativeåŸç†ï¼šé€šè¿‡ JS å¯¹ OC çš„ JavaScript Core æ¡†æ¶çš„äº¤äº’æ¥å®ç°å¯¹åŸç”Ÿçš„è°ƒç”¨<ul>
<li>rn åœ¨ OC å’Œ JS ä¸¤ç«¯éƒ½ä¿å­˜äº†ä¸€ä»½é…ç½®è¡¨ï¼Œé‡Œé¢æ ‡è®°äº†æ‰€æœ‰ OC æš´éœ²ç»™ JS çš„æ¨¡å—å’Œæ–¹æ³• ï¼Œjså¯¹ocçš„è°ƒç”¨é€šè¿‡blockæ–¹å¼å®ç°å›è°ƒ</li>
<li>AppDelegateåˆå§‹åŒ–è¿‡ç¨‹ä¸­åˆ›å»ºbridgeï¼Œå†…éƒ¨é€šè¿‡setUpåˆ›å»ºBatchedBridgeæ¥æ‰¹é‡è¯»å– JS å¯¹ OC çš„æ–¹æ³•è°ƒç”¨å¹¶é€šè¿‡JavaScriptExecutoræ‰§è¡Œ JS ä»£ç </li>
</ul>
</li>
<li>åˆ›å»º BatchedBridge æ­¥éª¤<ul>
<li>è¯»å– JS æºç ï¼šæŠŠ JSX ä»£ç è½¬æˆ JS åŠ è½½è¿›å†…å­˜ä¸­</li>
<li>åˆå§‹åŒ–æ¨¡å—ä¿¡æ¯ï¼šæ‰¾åˆ°æ‰€æœ‰éœ€è¦æš´éœ²ç»™ JS çš„ç±»</li>
<li>åˆå§‹åŒ– JS ä»£ç çš„æ‰§è¡Œå™¨ï¼šå³ RCTJSCExecutor å¯¹è±¡</li>
<li>ç”Ÿæˆæ¨¡å—åˆ—è¡¨å¹¶å†™å…¥ JS ç«¯ï¼šæ¥å— ModuleName å¹¶ä¸”ç”Ÿæˆæ¨¡å—ä¿¡æ¯</li>
<li>æ‰§è¡Œ JavaScript æºç ï¼šé€šè¿‡RCTJSCExecutoræ‰§è¡Œä»£ç ï¼Œå†™å…¥ä¿¡æ¯</li>
</ul>
</li>
<li>ç›¸äº’è°ƒç”¨æ–¹æ³•ï¼š<ul>
<li>OCè°ƒç”¨JSï¼šOCä¼šé€šè¿‡executeBlockOnJavaScriptQueueæ–¹æ³•åœ¨å•ç‹¬çš„çº¿ç¨‹ä¸Šè¿è¡Œ JS ä»£ç <ul>
<li>å¤„ç†å‚æ•°ï¼š_executeJSCall:(NSString *)methodæ–¹æ³•</li>
<li>å®é™…è°ƒç”¨ï¼šsendAppEventWithNameå’Œbodyæ–¹æ³•</li>
</ul>
</li>
<li>JSè°ƒç”¨OCï¼šJS ä¼šè§£æå‡ºæ–¹æ³•çš„ç±»ã€æ–¹æ³•å’Œæ–¹æ³•å‚æ•°å¹¶æ”¾å…¥åˆ° MessageQueue ä¸­ï¼Œç­‰å¾… OC è°ƒç”¨æˆ–è¶…æ—¶å‘é€<ul>
<li>ä½¿ç”¨RCT_EXPORT_METHOD å®ï¼Œç”¨æ¥æ³¨å†Œæ¨¡å—è¡¨</li>
<li>JSä¸­ä½¿ç”¨NativeModules.CryptoExport.æ³¨å†Œæ–¹æ³•è°ƒç”¨</li>
</ul>
</li>
</ul>
</li>
<li>rn çš„æ›´æ–°æœºåˆ¶ï¼šReact çŠ¶æ€æœºï¼Œä¸åœåœ°æ£€æŸ¥ç¡®è®¤æ›´æ–°<ul>
<li>æ–‡æœ¬å…ƒç´ ï¼šReactDOMTextComponent æ¯”è¾ƒæ›¿æ¢æ–‡æœ¬å…ƒç´ </li>
<li>åŸºæœ¬å…ƒç´ ï¼šupdateComponentæ–¹æ³•åˆ†å±æ€§ã€èŠ‚ç‚¹æ›¿æ¢åŸºæœ¬å…ƒç´ </li>
<li>è‡ªå®šä¹‰å…ƒç´ ï¼š_performComponentUpdateåˆ¤æ–­-å…ˆå¸è½½å†å®‰è£…å­èŠ‚ç‚¹</li>
</ul>
</li>
</ul>
<hr>
<blockquote>
<p>20180522æ›´æ–°ï¼šReact Native åŸç†è§£æ</p>
</blockquote>
<h3 id="å‡†å¤‡å·¥ä½œï¼Œé¦–å…ˆè¦æœ‰ä¸ªè§£å‰–å¯¹è±¡"><a href="#å‡†å¤‡å·¥ä½œï¼Œé¦–å…ˆè¦æœ‰ä¸ªè§£å‰–å¯¹è±¡" class="headerlink" title="å‡†å¤‡å·¥ä½œï¼Œé¦–å…ˆè¦æœ‰ä¸ªè§£å‰–å¯¹è±¡"></a>å‡†å¤‡å·¥ä½œï¼Œé¦–å…ˆè¦æœ‰ä¸ªè§£å‰–å¯¹è±¡</h3><p>ä» HelloWord çœ‹èµ·ï¼Œæˆ‘ä»¬æ¥åˆ†æRNçš„å®ç°åŸç†</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> React, &#123; Component &#125; <span class="keyword">from</span> <span class="string">'react'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; AppRegistry, Text &#125; <span class="keyword">from</span> <span class="string">'react-native'</span>;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">HelloWorldApp</span> <span class="keyword">extends</span> <span class="title">Component</span> </span>&#123;</span><br><span class="line">  render() &#123;</span><br><span class="line">    <span class="keyword">return</span> (</span><br><span class="line">      &lt;Text&gt;Hello world!&lt;/Text&gt;</span><br><span class="line">    );</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// æ³¨æ„ï¼Œè¿™é‡Œç”¨å¼•å·æ‹¬èµ·æ¥çš„'HelloWorldApp'å¿…é¡»å’Œä½ initåˆ›å»ºçš„é¡¹ç›®åä¸€è‡´</span></span><br><span class="line">AppRegistry.registerComponent(<span class="string">'HelloWorldApp'</span>, () =&gt; HelloWorldApp);</span><br></pre></td></tr></table></figure>
<p>å¯ä»¥åˆ›å»ºä¸€ä¸ªæ–°çš„é¡¹ç›®</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">react-native init ProjectName</span><br></pre></td></tr></table></figure>
<p>åˆ›å»ºå®Œæˆä½ å¯ä»¥æ‰‹åŠ¨æ‰“å¼€é¡¹ç›®ï¼Œä¹Ÿå¯ä»¥åœ¨é¡¹ç›®æ ¹ç›®å½•æ‰§è¡Œ</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">// å¯åŠ¨ iOS</span><br><span class="line">react-native run-ios</span><br><span class="line">// å¯åŠ¨ Android</span><br><span class="line">react-native run-android</span><br></pre></td></tr></table></figure>
<p>å‡†å¤‡å·¥ä½œå®Œæˆäº†</p>
<hr>
<h3 id="React-åŸç†æ¢ç©¶"><a href="#React-åŸç†æ¢ç©¶" class="headerlink" title="React åŸç†æ¢ç©¶"></a>React åŸç†æ¢ç©¶</h3><p>é¦–å…ˆæˆ‘ä»¬èŠèŠ Reactï¼Œæˆ‘ä»¬æ³¨æ„åˆ°è¿™æ¡æ•°æ®æºä»£ç </p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">return</span> (</span><br><span class="line">      &lt;Text&gt;Hello world!&lt;/Text&gt;</span><br><span class="line">);</span><br></pre></td></tr></table></figure>
<p><em>â€œä¸ºä»€ä¹ˆ JavaScript ä»£ç é‡Œé¢å‡ºç°äº† HTML çš„è¯­æ³•ï¼Ÿâ€</em></p>
<p>React Native æŠŠä¸€ç»„ç›¸å…³çš„ HTML æ ‡ç­¾ï¼Œä¹Ÿå°±æ˜¯ app å†…çš„ UI æ§ä»¶ï¼Œå°è£…è¿›ä¸€ä¸ªç»„ä»¶(Component)ä¸­ï¼Œè¿™ç§è¯­æ³•è¢«ç§°ä¸º JSXï¼Œå®ƒæ˜¯ä¸€ç§ JavaScript è¯­æ³•æ‹“å±•ã€‚</p>
<p>JSX å…è®¸æˆ‘ä»¬å†™ HTML æ ‡ç­¾æˆ– React æ ‡ç­¾ï¼Œå®ƒä»¬ç»ˆå°†è¢«è½¬æ¢æˆåŸç”Ÿçš„ JavaScript å¹¶åˆ›å»º DOMã€‚</p>
<p>åœ¨ React æ¡†æ¶ä¸­ï¼Œé™¤äº†å¯ä»¥ç”¨ JavaScript å†™ HTML ä»¥å¤–ï¼Œæˆ‘ä»¬ç”šè‡³å¯ä»¥å†™ CSSã€‚</p>
<blockquote>
<p>æ€»ä¹‹ React æ˜¯ä¸€å¥—å¯ä»¥ç”¨ç®€æ´çš„è¯­æ³•é«˜æ•ˆç»˜åˆ¶ DOM çš„æ¡†æ¶</p>
</blockquote>
<ul>
<li>ç®€æ´ï¼šä¸å•å•æŒ‡å®ƒçš„ HTML å’Œ CSS è¯­æ³•ï¼Œæ›´å› ä¸ºå¯ä»¥å•ç”¨ JavaScript æ„é€ é¡µé¢ï¼›</li>
<li>é«˜æ•ˆï¼šå› ä¸º React ç‹¬åˆ›äº† Virtual DOM æœºåˆ¶ï¼ŒVirtual DOM æœ‰ä¸¤å¤§ç‰¹å¾ï¼Œä¸€å®ƒå­˜åœ¨äºå†…å­˜ä¸­çš„ JavaScript å¯¹è±¡ï¼Œå¹¶ä¸”ä¸ DOM æ˜¯ä¸€ä¸€å¯¹åº”çš„å…³ç³»ï¼›äºŒä½¿ç”¨é«˜æ•ˆçš„ DOM Diff ç®—æ³•ä¸éœ€è¦å¯¹ DOM è¿›è¡Œé‡æ–°ç»˜åˆ¶ã€‚</li>
</ul>
<p>å½“ç„¶ï¼ŒReact å¹¶ä¸æ˜¯å‰ç«¯å¼€å‘çš„å…¨éƒ¨ã€‚ä»ä¹‹å‰çš„æè¿°ä¹Ÿèƒ½çœ‹å‡ºï¼Œå®ƒä¸“æ³¨äº UI éƒ¨åˆ†ï¼Œå¯¹åº”åˆ° MVC ç»“æ„ä¸­å°±æ˜¯ View å±‚ã€‚</p>
<p>è¦æƒ³å®ç°å®Œæ•´çš„ MVC æ¶æ„ï¼Œè¿˜éœ€è¦ Model å’Œ Controller çš„ç»“æ„ã€‚åœ¨å‰ç«¯å¼€å‘æ—¶ï¼Œæˆ‘ä»¬å¯ä»¥é‡‡ç”¨ Flux å’Œ Reduxï¼ˆåŸºäºFluxï¼‰ æ¶æ„ï¼Œå®ƒä»¬å¹¶éæ¡†æ¶(Library)ï¼Œè€Œæ˜¯å’Œ MVC ä¸€æ ·éƒ½æ˜¯ä¸€ç§æ¶æ„è®¾è®¡(Architecture)ã€‚</p>
<hr>
<h3 id="React-Native-åŸç†æ¢ç©¶"><a href="#React-Native-åŸç†æ¢ç©¶" class="headerlink" title="React Native åŸç†æ¢ç©¶"></a>React Native åŸç†æ¢ç©¶</h3><h4 id="è°ˆè°ˆ-RN-çš„æ•…äº‹èƒŒæ™¯"><a href="#è°ˆè°ˆ-RN-çš„æ•…äº‹èƒŒæ™¯" class="headerlink" title="è°ˆè°ˆ RN çš„æ•…äº‹èƒŒæ™¯"></a>è°ˆè°ˆ RN çš„æ•…äº‹èƒŒæ™¯</h4><p>React åœ¨å‰ç«¯å–å¾—çªç ´æ€§æˆåŠŸä»¥åï¼ŒJavaScript å¼€å§‹è¯•å›¾ä¸€ç»Ÿä¸‰ç«¯ã€‚</p>
<p>æœ€ç»ˆï¼Œä¸€ä¸ªåŸºäº JavaScriptï¼Œå…·å¤‡åŠ¨æ€é…ç½®èƒ½åŠ›ï¼Œé¢å‘å‰ç«¯å¼€å‘è€…çš„ç§»åŠ¨ç«¯å¼€å‘æ¡†æ¶ â€”â€” React Native</p>
<hr>
<h4 id="è°ˆè°ˆ-RN-çš„åŸç†"><a href="#è°ˆè°ˆ-RN-çš„åŸç†" class="headerlink" title="è°ˆè°ˆ RN çš„åŸç†"></a>è°ˆè°ˆ RN çš„åŸç†</h4><p>å³ä½¿ä½¿ç”¨äº† React Nativeï¼Œæˆ‘ä»¬ä¾ç„¶éœ€è¦ UIKit ç­‰æ¡†æ¶ï¼Œè°ƒç”¨çš„æ˜¯ Objective-C ä»£ç ï¼ŒJavaScript åªæ˜¯æä¾›äº†é…ç½®ä¿¡æ¯å’Œé€»è¾‘çš„å¤„ç†ç»“æœã€‚</p>
<p>è€Œ JavaScript æ˜¯ä¸€ç§è„šæœ¬è¯­è¨€ï¼Œå®ƒä¸ä¼šç»è¿‡ç¼–è¯‘ã€é“¾æ¥ç­‰æ“ä½œï¼Œè€Œæ˜¯åœ¨è¿è¡Œæ—¶æ‰åŠ¨æ€çš„è¿›è¡Œè¯æ³•ã€è¯­æ³•åˆ†æï¼Œç”ŸæˆæŠ½è±¡è¯­æ³•æ ‘(AST)å’Œå­—èŠ‚ç ï¼Œç„¶åç”±è§£é‡Šå™¨è´Ÿè´£æ‰§è¡Œæˆ–è€…ä½¿ç”¨ JIT å°†å­—èŠ‚ç è½¬åŒ–ä¸ºæœºå™¨ç å†æ‰§è¡Œã€‚</p>
<p>è‹¹æœæä¾›äº†ä¸€ä¸ªå«åš JavaScript Core çš„æ¡†æ¶ï¼Œè¿™æ˜¯ä¸€ä¸ª JavaScript å¼•æ“ã€‚æ•´ä¸ªæµç¨‹ç”± JavaScript å¼•æ“è´Ÿè´£å®Œæˆã€‚ </p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">JSContext *context = [[JSContext alloc] init];  </span><br><span class="line">JSValue *jsVal = [context evaluateScript:<span class="string">@"21+7"</span>];  </span><br><span class="line"><span class="keyword">int</span> iVal = [jsVal toInt32];</span><br></pre></td></tr></table></figure>
<p>JavaScript æ˜¯ä¸€ç§å•çº¿ç¨‹çš„è¯­è¨€ï¼Œå®ƒä¸å…·å¤‡è‡ªè¿è¡Œçš„èƒ½åŠ›ï¼Œå› æ­¤æ€»æ˜¯è¢«åŠ¨è°ƒç”¨ã€‚å¾ˆå¤šä»‹ç» React Native çš„æ–‡ç« éƒ½ä¼šæåˆ° â€œJavaScript çº¿ç¨‹â€ çš„æ¦‚å¿µï¼Œå®é™…ä¸Šï¼Œå®ƒè¡¨ç¤ºçš„æ˜¯ Objective-C åˆ›å»ºäº†ä¸€ä¸ªå•ç‹¬çš„çº¿ç¨‹ï¼Œè¿™ä¸ªçº¿ç¨‹åªç”¨äºæ‰§è¡Œ JavaScript ä»£ç ï¼Œè€Œä¸” JavaScript ä»£ç åªä¼šåœ¨è¿™ä¸ªçº¿ç¨‹ä¸­æ‰§è¡Œã€‚</p>
<hr>
<p>ä¸‹é¢å°† JavaScript ğŸ‘‰ OC</p>
<p>ç”±äº JavaScript Core æ˜¯ä¸€ä¸ªé¢å‘ Objective-C çš„æ¡†æ¶ï¼Œåœ¨ Objective-C è¿™ä¸€ç«¯ï¼Œæˆ‘ä»¬å¯¹ JavaScript ä¸Šä¸‹æ–‡çŸ¥æ ¹çŸ¥åº•ï¼Œå¯ä»¥å¾ˆå®¹æ˜“çš„è·å–åˆ°å¯¹è±¡ï¼Œæ–¹æ³•ç­‰å„ç§ä¿¡æ¯ï¼Œå½“ç„¶ä¹ŸåŒ…æ‹¬è°ƒç”¨ JavaScript å‡½æ•°ã€‚</p>
<p>çœŸæ­£å¤æ‚çš„é—®é¢˜åœ¨äºï¼ŒJavaScript ä¸çŸ¥é“ Objective-C æœ‰å“ªäº›æ–¹æ³•å¯ä»¥è°ƒç”¨ã€‚</p>
<p>React Native è§£å†³è¿™ä¸ªé—®é¢˜çš„æ–¹æ¡ˆæ˜¯åœ¨ Objective-C å’Œ JavaScript ä¸¤ç«¯éƒ½ä¿å­˜äº†ä¸€ä»½é…ç½®è¡¨ï¼Œé‡Œé¢æ ‡è®°äº†æ‰€æœ‰ Objective-C æš´éœ²ç»™ JavaScript çš„æ¨¡å—å’Œæ–¹æ³•ã€‚</p>
<p>è¿™æ ·ï¼Œæ— è®ºæ˜¯å“ªä¸€æ–¹è°ƒç”¨å¦ä¸€æ–¹çš„æ–¹æ³•ï¼Œå®é™…ä¸Šä¼ é€’çš„æ•°æ®åªæœ‰ </p>
<ul>
<li>ModuleId ç±»</li>
<li>MethodId æ–¹æ³•</li>
<li>Arguments  æ–¹æ³•å‚æ•°</li>
</ul>
<p>å½“ Objective-C æ¥æ”¶åˆ°è¿™ä¸‰ä¸ªå€¼åï¼Œå°±å¯ä»¥é€šè¿‡ runtime å”¯ä¸€ç¡®å®šè¦è°ƒç”¨çš„æ˜¯å“ªä¸ªå‡½æ•°ï¼Œç„¶åè°ƒç”¨è¿™ä¸ªå‡½æ•°ã€‚</p>
<p>å¯¹äº Objective-C æ¥è¯´ï¼Œæ‰§è¡Œå®Œ JavaScript ä»£ç å†æ‰§è¡Œ Objective-C å›è°ƒæ¯«æ— éš¾åº¦ï¼Œéš¾ç‚¹ä¾ç„¶åœ¨äº JavaScript ä»£ç è°ƒç”¨ Objective-C ä¹‹åï¼Œå¦‚ä½•åœ¨ Objective-C çš„ä»£ç ä¸­ï¼Œå›è°ƒæ‰§è¡Œ JavaScript ä»£ç ã€‚</p>
<p>ç›®å‰ React Native çš„åšæ³•æ˜¯ï¼šåœ¨ JavaScript è°ƒç”¨ Objective-C ä»£ç æ—¶ï¼Œæ³¨å†Œè¦å›è°ƒçš„ Blockï¼Œå¹¶ä¸”æŠŠ Block Id ä½œä¸ºå‚æ•°å‘é€ç»™ Objective-Cï¼ŒObjective-C æ”¶åˆ°å‚æ•°æ—¶ä¼šåˆ›å»º Blockï¼Œè°ƒç”¨å®Œ Objective-C å‡½æ•°åå°±ä¼šæ‰§è¡Œè¿™ä¸ªåˆšåˆšåˆ›å»ºçš„ Blockã€‚</p>
<p>Objective-C ä¼šå‘ Block ä¸­ä¼ å…¥å‚æ•°å’Œ Block Idï¼Œç„¶ååœ¨ Block å†…éƒ¨è°ƒç”¨ JavaScript çš„æ–¹æ³•ï¼Œéšå JavaScript æŸ¥æ‰¾åˆ°å½“æ—¶æ³¨å†Œçš„ Block å¹¶æ‰§è¡Œã€‚</p>
<blockquote>
<p>ç®€å•çš„è¡¨ç¤ºå°±æ˜¯ï¼šJS ğŸ‘‰ OC (Block ğŸ‘‰ JS)</p>
</blockquote>
<hr>
<h3 id="ç»§ç»­çœ‹é¡¹ç›®-åˆå§‹åŒ–"><a href="#ç»§ç»­çœ‹é¡¹ç›®-åˆå§‹åŒ–" class="headerlink" title="ç»§ç»­çœ‹é¡¹ç›®-åˆå§‹åŒ–"></a>ç»§ç»­çœ‹é¡¹ç›®-åˆå§‹åŒ–</h3><p>é™¤äº† index.js ä¸­çš„ JavaScript ä»£ç ï¼Œç•™ç»™æˆ‘ä»¬çš„è¿˜æœ‰ AppDelegate ä¸­çš„å…¥å£æ–¹æ³•ï¼š</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">- (<span class="built_in">BOOL</span>)application:(<span class="built_in">UIApplication</span> *)application didFinishLaunchingWithOptions:(<span class="built_in">NSDictionary</span> *)launchOptions &#123;</span><br><span class="line">  <span class="built_in">NSURL</span> *jsCodeLocation;</span><br><span class="line"></span><br><span class="line">  jsCodeLocation = [[RCTBundleURLProvider sharedSettings] jsBundleURLForBundleRoot:<span class="string">@"index"</span> fallbackResource:<span class="literal">nil</span>];</span><br><span class="line"></span><br><span class="line">  RCTRootView *rootView = [[RCTRootView alloc] initWithBundleURL:jsCodeLocation</span><br><span class="line">                                                      moduleName:<span class="string">@"demo"</span></span><br><span class="line">                                               initialProperties:<span class="literal">nil</span></span><br><span class="line">                                                   launchOptions:launchOptions];</span><br><span class="line">  rootView.backgroundColor = [[<span class="built_in">UIColor</span> alloc] initWithRed:<span class="number">1.0</span>f green:<span class="number">1.0</span>f blue:<span class="number">1.0</span>f alpha:<span class="number">1</span>];</span><br><span class="line"></span><br><span class="line">  <span class="keyword">self</span>.window = [[<span class="built_in">UIWindow</span> alloc] initWithFrame:[<span class="built_in">UIScreen</span> mainScreen].bounds];</span><br><span class="line">  <span class="built_in">UIViewController</span> *rootViewController = [<span class="built_in">UIViewController</span> new];</span><br><span class="line">  rootViewController.view = rootView;</span><br><span class="line">  <span class="keyword">self</span>.window.rootViewController = rootViewController;</span><br><span class="line">  [<span class="keyword">self</span>.window makeKeyAndVisible];</span><br><span class="line">  <span class="keyword">return</span> <span class="literal">YES</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>å®é™…æˆ‘ä»¬æ“ä½œçš„è§†å›¾å°±æ˜¯è¿™ä¸ª RootView ï¼Œä½†æ˜¯ RootView æ˜¯ä¾æ‰˜äº Bridge å¯¹è±¡ï¼Œå®ƒæ˜¯ Objective-C ä¸ JavaScript äº¤äº’çš„æ¡¥æ¢ï¼Œåç»­çš„æ–¹æ³•äº¤äº’å®Œå…¨ä¾èµ–äºå®ƒï¼Œè€Œæ•´ä¸ªåˆå§‹åŒ–è¿‡ç¨‹çš„æœ€ç»ˆç›®çš„å…¶å®ä¹Ÿå°±æ˜¯åˆ›å»ºè¿™ä¸ªæ¡¥æ¢å¯¹è±¡ã€‚</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">- (<span class="keyword">instancetype</span>)initWithBundleURL:(<span class="built_in">NSURL</span> *)bundleURL</span><br><span class="line">                       moduleName:(<span class="built_in">NSString</span> *)moduleName</span><br><span class="line">                initialProperties:(<span class="built_in">NSDictionary</span> *)initialProperties</span><br><span class="line"> Â  Â  Â  Â  Â  Â  Â  Â  Â  Â launchOptions:(<span class="built_in">NSDictionary</span> *)launchOptions &#123;</span><br><span class="line">  RCTBridge *bridge = [[RCTBridge alloc] initWithBundleURL:bundleURL</span><br><span class="line">                                            moduleProvider:<span class="literal">nil</span></span><br><span class="line">                                             launchOptions:launchOptions];</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> [<span class="keyword">self</span> initWithBridge:bridge moduleName:moduleName initialProperties:initialProperties];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>åˆå§‹åŒ–æ–¹æ³•çš„æ ¸å¿ƒæ˜¯ setUp æ–¹æ³•ï¼Œè€Œ setUp æ–¹æ³•çš„ä¸»è¦ä»»åŠ¡åˆ™æ˜¯åˆ›å»º BatchedBridgeã€‚</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">- (<span class="keyword">void</span>)setUp &#123;</span><br><span class="line">  RCT_PROFILE_BEGIN_EVENT(<span class="number">0</span>, <span class="string">@"-[RCTBridge setUp]"</span>, <span class="literal">nil</span>);</span><br><span class="line"></span><br><span class="line">  _performanceLogger = [RCTPerformanceLogger new];</span><br><span class="line">  [_performanceLogger markStartForTag:RCTPLBridgeStartup];</span><br><span class="line">  [_performanceLogger markStartForTag:RCTPLTTI];</span><br><span class="line"></span><br><span class="line">  Class bridgeClass = <span class="keyword">self</span>.bridgeClass;</span><br><span class="line"></span><br><span class="line">  <span class="meta">#if RCT_DEV</span></span><br><span class="line">  RCTExecuteOnMainQueue(^&#123;</span><br><span class="line">    RCTRegisterReloadCommandListener(<span class="keyword">self</span>);</span><br><span class="line">  &#125;);</span><br><span class="line">  <span class="meta">#endif</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// Only update bundleURL from delegate if delegate bundleURL has changed</span></span><br><span class="line">  <span class="built_in">NSURL</span> *previousDelegateURL = _delegateBundleURL;</span><br><span class="line">  _delegateBundleURL = [<span class="keyword">self</span>.delegate sourceURLForBridge:<span class="keyword">self</span>];</span><br><span class="line">  <span class="keyword">if</span> (_delegateBundleURL &amp;&amp; ![_delegateBundleURL isEqual:previousDelegateURL]) &#123;</span><br><span class="line">    _bundleURL = _delegateBundleURL;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Sanitize the bundle URL</span></span><br><span class="line">  _bundleURL = [RCTConvert <span class="built_in">NSURL</span>:_bundleURL.absoluteString];</span><br><span class="line"></span><br><span class="line">  <span class="keyword">self</span>.batchedBridge = [[bridgeClass alloc] initWithParentBridge:<span class="keyword">self</span>];</span><br><span class="line">  [<span class="keyword">self</span>.batchedBridge start];</span><br><span class="line"></span><br><span class="line">  RCT_PROFILE_END_EVENT(RCTProfileTagAlways, <span class="string">@""</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>BatchedBridge çš„ä½œç”¨æ˜¯æ‰¹é‡è¯»å– JavaScript å¯¹ Objective-C çš„æ–¹æ³•è°ƒç”¨ï¼ŒåŒæ—¶å®ƒå†…éƒ¨æŒæœ‰ä¸€ä¸ª JavaScriptExecutorï¼Œé¡¾åæ€ä¹‰ï¼Œè¿™ä¸ªå¯¹è±¡ç”¨æ¥æ‰§è¡Œ JavaScript ä»£ç ã€‚</p>
<h4 id="åˆ›å»º-BatchedBridge-çš„å…³é”®æ˜¯-start-æ–¹æ³•ï¼Œå®ƒå¯ä»¥åˆ†ä¸ºäº”ä¸ªæ­¥éª¤ï¼š"><a href="#åˆ›å»º-BatchedBridge-çš„å…³é”®æ˜¯-start-æ–¹æ³•ï¼Œå®ƒå¯ä»¥åˆ†ä¸ºäº”ä¸ªæ­¥éª¤ï¼š" class="headerlink" title="åˆ›å»º BatchedBridge çš„å…³é”®æ˜¯ start æ–¹æ³•ï¼Œå®ƒå¯ä»¥åˆ†ä¸ºäº”ä¸ªæ­¥éª¤ï¼š"></a>åˆ›å»º BatchedBridge çš„å…³é”®æ˜¯ start æ–¹æ³•ï¼Œå®ƒå¯ä»¥åˆ†ä¸ºäº”ä¸ªæ­¥éª¤ï¼š</h4><ul>
<li>è¯»å– JavaScript æºç </li>
<li>åˆå§‹åŒ–æ¨¡å—ä¿¡æ¯</li>
<li>åˆå§‹åŒ– JavaScript ä»£ç çš„æ‰§è¡Œå™¨ï¼Œå³ RCTJSCExecutor å¯¹è±¡</li>
<li>ç”Ÿæˆæ¨¡å—åˆ—è¡¨å¹¶å†™å…¥ JavaScript ç«¯</li>
<li>æ‰§è¡Œ JavaScript æºç </li>
</ul>
<p>é€ä¸ªåˆ†æä¸Šé¢æ¯ä¸€æ­¥å®Œæˆçš„æ“ä½œï¼š</p>
<p><em>1.è¯»å–JavaScriptæºç </em><br>è¿™ä¸€éƒ¨åˆ†çš„å…·ä½“ä»£ç å®ç°æ²¡æœ‰å¤ªå¤§çš„è®¨è®ºæ„ä¹‰ã€‚æˆ‘ä»¬åªè¦æ˜ç™½ï¼ŒJavaScript çš„ä»£ç æ˜¯åœ¨ Objective-C æä¾›çš„ç¯å¢ƒä¸‹è¿è¡Œçš„ï¼Œæ‰€ä»¥ç¬¬ä¸€æ­¥å°±æ˜¯æŠŠ JavaScript åŠ è½½è¿›å†…å­˜ä¸­ï¼Œå¯¹äºä¸€ä¸ªç©ºçš„é¡¹ç›®æ¥è¯´ï¼Œæ‰€æœ‰çš„ JavaScript ä»£ç å¤§çº¦å ç”¨ 1.5 Mb çš„å†…å­˜ç©ºé—´ã€‚</p>
<p>éœ€è¦è¯´æ˜çš„æ˜¯ï¼Œåœ¨è¿™ä¸€æ­¥ä¸­ï¼ŒJSX ä»£ç å·²ç»è¢«è½¬åŒ–æˆåŸç”Ÿçš„ JavaScript ä»£ç ã€‚</p>
<p><em>2.åˆå§‹åŒ–æ¨¡å—ä¿¡æ¯</em><br>è¿™ä¸€æ­¥åœ¨æ–¹æ³• initModulesWithDispatchGroup: ä¸­å®ç°ï¼Œä¸»è¦ä»»åŠ¡æ˜¯æ‰¾åˆ°æ‰€æœ‰éœ€è¦æš´éœ²ç»™ JavaScript çš„ç±»ã€‚</p>
<p>æ¯ä¸€ä¸ªéœ€è¦æš´éœ²ç»™ JavaScript çš„ç±»(ä¹Ÿæˆä¸º Moduleï¼Œä»¥ä¸‹ä¸ä½œåŒºåˆ†)éƒ½ä¼šæ ‡è®°ä¸€ä¸ªå®ï¼šRCT_EXPORT_MODULEï¼Œè¿™ä¸ªå®çš„å…·ä½“å®ç°å¹¶ä¸å¤æ‚</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#define RCT_EXPORT_MODULE(js_name) \</span></span><br><span class="line">RCT_EXTERN <span class="keyword">void</span> RCTRegisterModule(Class); \</span><br><span class="line">+ (<span class="built_in">NSString</span> *)moduleName &#123; <span class="keyword">return</span> @<span class="meta">#js_name; &#125; \</span></span><br><span class="line">+ (<span class="keyword">void</span>)load &#123; RCTRegisterModule(<span class="keyword">self</span>); &#125;</span><br></pre></td></tr></table></figure>
<p>è¿™æ ·ï¼Œè¿™ä¸ªç±»åœ¨ load æ–¹æ³•ä¸­å°±ä¼šè°ƒç”¨ RCTRegisterModule æ–¹æ³•æ³¨å†Œè‡ªå·±ï¼š</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span> RCTRegisterModule(Class moduleClass) &#123;</span><br><span class="line">  <span class="keyword">static</span> <span class="built_in">dispatch_once_t</span> onceToken;</span><br><span class="line">  <span class="built_in">dispatch_once</span>(&amp;onceToken, ^&#123;</span><br><span class="line">    RCTModuleClasses = [<span class="built_in">NSMutableArray</span> new];</span><br><span class="line">  &#125;);</span><br><span class="line">  [RCTModuleClasses addObject:moduleClass];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>å› æ­¤ï¼ŒReact Native å¯ä»¥é€šè¿‡ RCTModuleClasses æ‹¿åˆ°æ‰€æœ‰æš´éœ²ç»™ JavaScript çš„ç±»ã€‚ä¸‹ä¸€æ­¥æ“ä½œæ˜¯éå†è¿™ä¸ªæ•°ç»„ï¼Œç„¶åç”Ÿæˆ RCTModuleData å¯¹è±¡ï¼š</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> (Class moduleClass <span class="keyword">in</span> RCTGetModuleClasses()) &#123;</span><br><span class="line">    RCTModuleData *moduleData = [[RCTModuleData alloc]initWithModuleClass:moduleClass                                                                      bridge:<span class="keyword">self</span>];</span><br><span class="line">    [moduleClassesByID addObject:moduleClass];</span><br><span class="line">    [moduleDataByID addObject:moduleData];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>å¯ä»¥æƒ³è§ï¼ŒRCTModuleData å¯¹è±¡æ˜¯æ¨¡å—é…ç½®è¡¨çš„ä¸»è¦ç»„æˆéƒ¨åˆ†ã€‚å¦‚æœæŠŠæ¨¡å—é…ç½®è¡¨æƒ³è±¡æˆä¸€ä¸ªæ•°ç»„ï¼Œé‚£ä¹ˆæ¯ä¸€ä¸ªå…ƒç´ å°±æ˜¯ä¸€ä¸ª RCTModuleData å¯¹è±¡ã€‚</p>
<p>è¿™ä¸ªå¯¹è±¡ä¿å­˜äº† Module çš„åå­—ï¼Œå¸¸é‡ç­‰åŸºæœ¬ä¿¡æ¯ï¼Œæœ€é‡è¦çš„å±æ€§æ˜¯ä¸€ä¸ªæ•°ç»„ï¼Œä¿å­˜äº†æ‰€æœ‰éœ€è¦æš´éœ²ç»™ JavaScript çš„æ–¹æ³•ã€‚</p>
<p>æš´éœ²ç»™ JavaScript çš„æ–¹æ³•éœ€è¦ç”¨ RCT_EXPORT_METHOD è¿™ä¸ªå®æ¥æ ‡è®°ï¼Œå®ƒçš„å®ç°åŸç†æ¯”è¾ƒå¤æ‚ï¼Œæœ‰å…´è¶£çš„è¯»è€…å¯ä»¥è‡ªè¡Œé˜…è¯»ã€‚ç®€å•æ¥è¯´ï¼Œå®ƒä¸ºå‡½æ•°ååŠ ä¸Šäº† <strong>rct_export</strong> å‰ç¼€ï¼Œå†é€šè¿‡ runtime è·å–ç±»çš„å‡½æ•°åˆ—è¡¨ï¼Œæ‰¾å‡ºå…¶ä¸­å¸¦æœ‰æŒ‡å®šå‰ç¼€çš„æ–¹æ³•å¹¶æ”¾å…¥æ•°ç»„ä¸­:</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">- (<span class="built_in">NSArray</span>&lt;<span class="keyword">id</span>&lt;RCTBridgeMethod&gt;&gt; *)methods&#123;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">int</span> methodCount;</span><br><span class="line">    Method *methods = class_copyMethodList(object_getClass(_moduleClass), &amp;methodCount); <span class="comment">// è·å–æ–¹æ³•åˆ—è¡¨</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">unsigned</span> <span class="keyword">int</span> i = <span class="number">0</span>; i &lt; methodCount; i++) &#123;</span><br><span class="line">        RCTModuleMethod *moduleMethod = <span class="comment">/* åˆ›å»º method */</span></span><br><span class="line">        [_methods addObject:moduleMethod];</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> _methods;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>å› æ­¤ Objective-C ç®¡ç†æ¨¡å—é…ç½®è¡¨çš„é€»è¾‘æ˜¯ï¼šBridge æŒæœ‰ä¸€ä¸ªæ•°ç»„ï¼Œæ•°ç»„ä¸­ä¿å­˜äº†æ‰€æœ‰çš„æ¨¡å—çš„ RCTModuleData å¯¹è±¡ï¼ŒRCTModuleDataåˆä¿å­˜äº†ç±»çš„æ–¹æ³•ã€å¸¸äº®ã€ç±»åç­‰ä¿¡æ¯ã€‚åªè¦ç»™å®š ModuleId å’Œ MethodId å°±å¯ä»¥å”¯ä¸€ç¡®å®šè¦è°ƒç”¨çš„æ–¹æ³•ã€‚ </p>
<p><em>3.åˆå§‹åŒ–JavaScriptæ‰§è¡Œå™¨ï¼ˆRCTJSCExecutorï¼‰</em><br>é€šè¿‡æŸ¥çœ‹æºç å¯ä»¥çœ‹åˆ°ï¼Œåˆå§‹åŒ– JavaScript æ‰§è¡Œå™¨çš„æ—¶å€™ï¼Œä¼šè°ƒç”¨<br><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">+ (<span class="keyword">instancetype</span>)initializedExecutorWithContextProvider:(RCTJSContextProvider *)JSContextProvider </span><br><span class="line">applicationScript:(<span class="built_in">NSData</span> *)applicationScript </span><br><span class="line">sourceURL:(<span class="built_in">NSURL</span> *)sourceURL </span><br><span class="line">JSContext:(JSContext **)JSContext </span><br><span class="line">error:(<span class="built_in">NSError</span> **)error;</span><br></pre></td></tr></table></figure></p>
<p>è¿”å›çš„ excuter å¯¹è±¡æ˜¯å·²ç»è¢«åŒæ­¥æ‰§è¡Œçš„<br><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// æ‰§è¡Œå¯¹åº”çš„æ–¹æ³•</span></span><br><span class="line">- (<span class="keyword">void</span>)callFunctionOnModule:(NSString *)<span class="keyword">module</span> method:(NSString *)method arguments:(NSArray *)args jsValueCallback:(RCTJavaScriptValueCallback)onComplete</span><br><span class="line">&#123;</span><br><span class="line">  [self _callFunctionOnModule:<span class="keyword">module</span> method:method arguments:args returnValue:NO unwrapResult:NO callback:onComplete];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>è¿™é‡Œéœ€è¦å…³æ³¨ nativeRequireModuleConfig å’Œ nativeFlushQueueImmediate è¿™ä¸¤ä¸ªblockã€‚</p>
<p>åœ¨è¿™ä¸¤ä¸ª block ä¸­ä¼šé€šè¿‡ bridge è°ƒç”¨ oc çš„æ–¹æ³•ã€‚<br><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br></pre></td><td class="code"><pre><span class="line">[<span class="keyword">self</span> executeBlockOnJavaScriptQueue:^&#123;</span><br><span class="line">    <span class="keyword">if</span> (!<span class="keyword">self</span>.valid) &#123;</span><br><span class="line">      <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    JSContext *context = <span class="literal">nil</span>;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">self</span>-&gt;_jscWrapper) &#123;</span><br><span class="line">      RCTAssert(<span class="keyword">self</span>-&gt;_context != <span class="literal">nil</span>, <span class="string">@"If wrapper was pre-initialized, context should be too"</span>);</span><br><span class="line">      context = <span class="keyword">self</span>-&gt;_context.context;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      [<span class="keyword">self</span>-&gt;_performanceLogger markStartForTag:RCTPLJSCWrapperOpenLibrary];</span><br><span class="line">      <span class="keyword">self</span>-&gt;_jscWrapper = RCTJSCWrapperCreate(<span class="keyword">self</span>-&gt;_useCustomJSCLibrary);</span><br><span class="line">      [<span class="keyword">self</span>-&gt;_performanceLogger markStopForTag:RCTPLJSCWrapperOpenLibrary];</span><br><span class="line"></span><br><span class="line">      RCTAssert(<span class="keyword">self</span>-&gt;_context == <span class="literal">nil</span>, <span class="string">@"Didn't expect to set up twice"</span>);</span><br><span class="line">      context = [<span class="keyword">self</span>-&gt;_jscWrapper-&gt;JSContext new];</span><br><span class="line">      <span class="keyword">self</span>-&gt;_context = [[RCTJavaScriptContext alloc] initWithJSContext:context onThread:<span class="keyword">self</span>-&gt;_javaScriptThread];</span><br><span class="line">      [[<span class="built_in">NSNotificationCenter</span> defaultCenter] postNotificationName:RCTJavaScriptContextCreatedNotification</span><br><span class="line">                                                          object:context];</span><br><span class="line"></span><br><span class="line">      configureCacheOnContext(context, <span class="keyword">self</span>-&gt;_jscWrapper);</span><br><span class="line">      installBasicSynchronousHooksOnContext(context);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    __<span class="keyword">weak</span> RCTJSCExecutor *weakSelf = <span class="keyword">self</span>;</span><br><span class="line"></span><br><span class="line">    context[<span class="string">@"nativeRequireModuleConfig"</span>] = ^<span class="built_in">NSString</span> *(<span class="built_in">NSString</span> *moduleName) &#123;</span><br><span class="line">      RCTJSCExecutor *strongSelf = weakSelf;</span><br><span class="line">      <span class="keyword">if</span> (!strongSelf.valid) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">nil</span>;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      RCT_PROFILE_BEGIN_EVENT(RCTProfileTagAlways, <span class="string">@"nativeRequireModuleConfig"</span>, <span class="literal">nil</span>);</span><br><span class="line">      <span class="built_in">NSArray</span> *config = [strongSelf-&gt;_bridge configForModuleName:moduleName];</span><br><span class="line">      <span class="built_in">NSString</span> *result = config ? RCTJSONStringify(config, <span class="literal">NULL</span>) : <span class="literal">nil</span>;</span><br><span class="line">      RCT_PROFILE_END_EVENT(RCTProfileTagAlways, <span class="string">@"js_call,config"</span>, @&#123; <span class="string">@"moduleName"</span>: moduleName &#125;);</span><br><span class="line">      <span class="keyword">return</span> result;</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    context[<span class="string">@"nativeFlushQueueImmediate"</span>] = ^(<span class="built_in">NSArray</span>&lt;<span class="built_in">NSArray</span> *&gt; *calls)&#123;</span><br><span class="line">      RCTJSCExecutor *strongSelf = weakSelf;</span><br><span class="line">      <span class="keyword">if</span> (!strongSelf.valid || !calls) &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      RCT_PROFILE_BEGIN_EVENT(RCTProfileTagAlways, <span class="string">@"nativeFlushQueueImmediate"</span>, <span class="literal">nil</span>);</span><br><span class="line">      [strongSelf-&gt;_bridge handleBuffer:calls batchEnded:<span class="literal">NO</span>];</span><br><span class="line">      RCT_PROFILE_END_EVENT(RCTProfileTagAlways, <span class="string">@"js_call"</span>, <span class="literal">nil</span>);</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line"><span class="meta">#if RCT_PROFILE</span></span><br><span class="line">    __<span class="keyword">weak</span> RCTBridge *weakBridge = <span class="keyword">self</span>-&gt;_bridge;</span><br><span class="line">    context[<span class="string">@"nativeTraceBeginAsyncFlow"</span>] = ^(__unused uint64_t tag, __unused <span class="built_in">NSString</span> *name, int64_t cookie) &#123;</span><br><span class="line">      <span class="keyword">if</span> (RCTProfileIsProfiling()) &#123;</span><br><span class="line">        [weakBridge.flowIDMapLock lock];</span><br><span class="line">        int64_t newCookie = [_RCTProfileBeginFlowEvent() longLongValue];</span><br><span class="line">        <span class="built_in">CFDictionarySetValue</span>(weakBridge.flowIDMap, (<span class="keyword">const</span> <span class="keyword">void</span> *)cookie, (<span class="keyword">const</span> <span class="keyword">void</span> *)newCookie);</span><br><span class="line">        [weakBridge.flowIDMapLock unlock];</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    context[<span class="string">@"nativeTraceEndAsyncFlow"</span>] = ^(__unused uint64_t tag, __unused <span class="built_in">NSString</span> *name, int64_t cookie) &#123;</span><br><span class="line">      <span class="keyword">if</span> (RCTProfileIsProfiling()) &#123;</span><br><span class="line">        [weakBridge.flowIDMapLock lock];</span><br><span class="line">        int64_t newCookie = (int64_t)<span class="built_in">CFDictionaryGetValue</span>(weakBridge.flowIDMap, (<span class="keyword">const</span> <span class="keyword">void</span> *)cookie);</span><br><span class="line">        _RCTProfileEndFlowEvent(@(newCookie));</span><br><span class="line">        <span class="built_in">CFDictionaryRemoveValue</span>(weakBridge.flowIDMap, (<span class="keyword">const</span> <span class="keyword">void</span> *)cookie);</span><br><span class="line">        [weakBridge.flowIDMapLock unlock];</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;;</span><br><span class="line"><span class="meta">#endif</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#if RCT_DEV</span></span><br><span class="line">    RCTInstallJSCProfiler(<span class="keyword">self</span>-&gt;_bridge, context.JSGlobalContextRef);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Inject handler used by HMR</span></span><br><span class="line">    context[<span class="string">@"nativeInjectHMRUpdate"</span>] = ^(<span class="built_in">NSString</span> *sourceCode, <span class="built_in">NSString</span> *sourceCodeURL) &#123;</span><br><span class="line">      RCTJSCExecutor *strongSelf = weakSelf;</span><br><span class="line">      <span class="keyword">if</span> (!strongSelf.valid) &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      RCTJSCWrapper *jscWrapper = strongSelf-&gt;_jscWrapper;</span><br><span class="line">      JSStringRef execJSString = jscWrapper-&gt;JSStringCreateWithUTF8CString(sourceCode.UTF8String);</span><br><span class="line">      JSStringRef jsURL = jscWrapper-&gt;JSStringCreateWithUTF8CString(sourceCodeURL.UTF8String);</span><br><span class="line">      jscWrapper-&gt;JSEvaluateScript(strongSelf-&gt;_context.context.JSGlobalContextRef, execJSString, <span class="literal">NULL</span>, jsURL, <span class="number">0</span>, <span class="literal">NULL</span>);</span><br><span class="line">      jscWrapper-&gt;JSStringRelease(jsURL);</span><br><span class="line">      jscWrapper-&gt;JSStringRelease(execJSString);</span><br><span class="line">    &#125;;</span><br><span class="line"><span class="meta">#endif</span></span><br><span class="line">  &#125;];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p><em>4.ç”Ÿæˆæ¨¡å—é…ç½®è¡¨å¹¶å†™å…¥JavaScriptç«¯</em> </p>
<p>å¤ä¹ ä¸€ä¸‹ nativeRequireModuleConfig è¿™ä¸ª Blockï¼Œå®ƒå¯ä»¥æ¥å— ModuleName å¹¶ä¸”ç”Ÿæˆè¯¦ç»†çš„æ¨¡å—ä¿¡æ¯ï¼Œä½†åœ¨å‰æ–‡ä¸­æˆ‘ä»¬æ²¡æœ‰æåˆ° JavaScript æ˜¯å¦‚ä½•çŸ¥é“ Objective-C è¦æš´éœ²å“ªäº›ç±»çš„(ç›®å‰åªæ˜¯ Objective-C è‡ªå·±çŸ¥é“)ã€‚</p>
<p>è¿™ä¸€æ­¥çš„æ“ä½œå°±æ˜¯ä¸ºäº†è®© JavaScript è·å–æ‰€æœ‰æ¨¡å—çš„åå­—</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">- (<span class="built_in">NSString</span> *)moduleConfig &#123;</span><br><span class="line">  <span class="built_in">NSMutableArray</span>&lt;<span class="built_in">NSArray</span> *&gt; *config = [<span class="built_in">NSMutableArray</span> new];</span><br><span class="line">  <span class="keyword">for</span> (RCTModuleData *moduleData <span class="keyword">in</span> _moduleDataByID) &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">self</span>.executorClass == [RCTJSCExecutor <span class="keyword">class</span>]) &#123;</span><br><span class="line">      [config addObject:@[moduleData.name]];</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      [config addObject:RCTNullIfNil(moduleData.config)];</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> RCTJSONStringify(@&#123;</span><br><span class="line">    <span class="string">@"remoteModuleConfig"</span>: config,</span><br><span class="line">  &#125;, <span class="literal">NULL</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><em>5.æ‰§è¡ŒJavaScriptä»£ç </em></p>
<p>è¿™ä¸€æ­¥ä¹Ÿæ²¡ä»€ä¹ˆæŠ€æœ¯éš¾åº¦å¯ä»¥ï¼Œä»£ç å·²ç»åŠ è½½è¿›äº†å†…å­˜ï¼Œè¯¥åšçš„é…ç½®ä¹Ÿå·²ç»å®Œæˆï¼Œåªè¦æŠŠ JavaScript ä»£ç è¿è¡Œä¸€éå³å¯ã€‚</p>
<p>è¿è¡Œä»£ç æ—¶ï¼Œç¬¬ä¸‰æ­¥ä¸­æ‰€è¯´çš„é‚£äº› Block å°±ä¼šè¢«æ‰§è¡Œï¼Œä»è€Œå‘ JavaScript ç«¯å†™å…¥é…ç½®ä¿¡æ¯ã€‚</p>
<p>è‡³æ­¤ï¼ŒJavaScript å’Œ Objective-C éƒ½å…·å¤‡äº†å‘å¯¹æ–¹äº¤äº’çš„èƒ½åŠ›ï¼Œå‡†å¤‡å·¥ä½œä¹Ÿå°±å…¨éƒ¨å®Œæˆäº†ã€‚</p>
<hr>
<h3 id="æ–¹æ³•è°ƒç”¨"><a href="#æ–¹æ³•è°ƒç”¨" class="headerlink" title="æ–¹æ³•è°ƒç”¨"></a>æ–¹æ³•è°ƒç”¨</h3><p>å¦‚å‰æ–‡æ‰€è¿°ï¼Œåœ¨ React Native ä¸­ï¼ŒObjective-C å’Œ JavaScript çš„äº¤äº’éƒ½æ˜¯é€šè¿‡ä¼ é€’ ModuleIdã€MethodId å’Œ Arguments è¿›è¡Œçš„ã€‚ä»¥ä¸‹æ˜¯åˆ†æƒ…å†µè®¨è®º </p>
<h4 id="OC-è°ƒç”¨-JavaScript"><a href="#OC-è°ƒç”¨-JavaScript" class="headerlink" title="OC è°ƒç”¨ JavaScript"></a>OC è°ƒç”¨ JavaScript</h4><p>ä¹Ÿè®¸ä½ åœ¨å…¶ä»–æ–‡ç« ä¸­æ›¾ç»å¤šæ¬¡å¬è¯´ JavaScript ä»£ç æ€»æ˜¯åœ¨ä¸€ä¸ªå•ç‹¬çš„çº¿ç¨‹ä¸Šé¢è°ƒç”¨ï¼Œå®ƒçš„å®é™…å«ä¹‰æ˜¯ Objective-C ä¼šåœ¨å•ç‹¬çš„çº¿ç¨‹ä¸Šè¿è¡Œ JavaScript ä»£ç </p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">- (<span class="keyword">void</span>)executeBlockOnJavaScriptQueue:(dispatch_block_t)block &#123;</span><br><span class="line">  <span class="keyword">if</span> ([<span class="built_in">NSThread</span> currentThread] != _javaScriptThread) &#123;</span><br><span class="line">    [<span class="keyword">self</span> performSelector:<span class="keyword">@selector</span>(executeBlockOnJavaScriptQueue:)</span><br><span class="line">                 onThread:_javaScriptThread withObject:block waitUntilDone:<span class="literal">NO</span>];</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    block();</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>è°ƒç”¨JavaScriptçš„æ ¸å¿ƒä»£ç å¦‚ä¸‹</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">- (<span class="keyword">void</span>)_executeJSCall:(<span class="built_in">NSString</span> *)method</span><br><span class="line">             arguments:(<span class="built_in">NSArray</span> *)arguments</span><br><span class="line">              callback:(RCTJavaScriptCallback)onComplete&#123;</span><br><span class="line">    [<span class="keyword">self</span> executeBlockOnJavaScriptQueue:^&#123;</span><br><span class="line">        <span class="comment">// è·å– contextJSRefã€methodJSRefã€moduleJSRef</span></span><br><span class="line">        resultJSRef = JSObjectCallAsFunction(contextJSRef, (JSObjectRef)methodJSRef, (JSObjectRef)moduleJSRef, arguments.count, jsArgs, &amp;errorJSRef);</span><br><span class="line">        objcValue = <span class="comment">/*resultJSRef è½¬æ¢æˆ Objective-C ç±»å‹*/</span></span><br><span class="line">        onComplete(objcValue, <span class="literal">nil</span>);</span><br><span class="line">    &#125;];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œè¿™ä¸ªå‡½æ•°åæ˜¯æˆ‘ä»¬è¦è°ƒç”¨ JavaScript çš„ä¸­è½¬å‡½æ•°åï¼Œæ¯”å¦‚ callFunctionReturnFlushedQueueã€‚ä¹Ÿå°±æ˜¯è¯´å®ƒçš„ä½œç”¨å…¶å®æ˜¯å¤„ç†å‚æ•°ï¼Œè€ŒéçœŸæ­£è¦è°ƒç”¨çš„ JavaScript å‡½æ•°ã€‚ </p>
<p>åœ¨å®é™…ä½¿ç”¨çš„æ—¶å€™ï¼Œæˆ‘ä»¬å¯ä»¥è¿™æ ·å‘èµ·å¯¹ JavaScript çš„è°ƒç”¨ï¼š</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[_bridge.eventDispatcher sendAppEventWithName:<span class="string">@"greeted"</span></span><br><span class="line">                                         body:@&#123; <span class="string">@"name"</span>: <span class="string">@"nmae"</span>&#125;];</span><br></pre></td></tr></table></figure>
<p>è¿™é‡Œçš„ Name å’Œ Body å‚æ•°åˆ†åˆ«è¡¨ç¤ºè¦è°ƒç”¨çš„ JavaScript çš„å‡½æ•°åå’Œå‚æ•°ã€‚</p>
<hr>
<h4 id="JavaScriptè°ƒç”¨OC"><a href="#JavaScriptè°ƒç”¨OC" class="headerlink" title="JavaScriptè°ƒç”¨OC"></a>JavaScriptè°ƒç”¨OC</h4><p>åœ¨è°ƒç”¨ Objective-C ä»£ç æ—¶ï¼Œå¦‚å‰æ–‡æ‰€è¿°ï¼ŒJavaScript ä¼šè§£æå‡ºæ–¹æ³•çš„ ModuleIdã€MethodId å’Œ Arguments å¹¶æ”¾å…¥åˆ° MessageQueue ä¸­ï¼Œç­‰å¾… Objective-C ä¸»åŠ¨æ‹¿èµ°ï¼Œæˆ–è€…è¶…æ—¶åä¸»åŠ¨å‘é€ç»™ Objective-Cã€‚</p>
<p>Objective-C è´Ÿè´£å¤„ç†è°ƒç”¨çš„æ–¹æ³•æ˜¯ handleBufferï¼Œå®ƒçš„å‚æ•°æ˜¯ä¸€ä¸ªå«æœ‰å››ä¸ªå…ƒç´ çš„æ•°ç»„ï¼Œæ¯ä¸ªå…ƒç´ ä¹Ÿéƒ½æ˜¯ä¸€ä¸ªæ•°ç»„ï¼Œåˆ†åˆ«å­˜æ”¾äº† ModuleIdã€MethodIdã€Paramsï¼Œç¬¬å››ä¸ªå…ƒç´ ç›®æµ‹ç”¨å¤„ä¸å¤§ã€‚</p>
<p>å‡½æ•°å†…éƒ¨åœ¨æ¯ä¸€æ¬¡æ–¹è°ƒç”¨ä¸­è°ƒç”¨ _handleRequestNumber:moduleID:methodID:params æ–¹æ³•ï¼Œé€šè¿‡æŸ¥æ‰¾æ¨¡å—é…ç½®è¡¨æ‰¾å‡ºè¦è°ƒç”¨çš„æ–¹æ³•ï¼Œå¹¶é€šè¿‡ runtime åŠ¨æ€çš„è°ƒç”¨ï¼š</p>
<p>æ¼”ç¤ºJavaScriptè°ƒç”¨OCæ–¹æ³•:</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//.hæ–‡ä»¶</span></span><br><span class="line"><span class="meta">#import <span class="meta-string">&lt;Foundation/Foundation.h&gt;</span></span></span><br><span class="line"><span class="meta">#import <span class="meta-string">"RCTBridge.h"</span></span></span><br><span class="line"><span class="meta">#import <span class="meta-string">"RCTLog.h"</span></span></span><br><span class="line"><span class="meta">#import <span class="meta-string">"EncryptUtil.h"</span></span></span><br><span class="line"><span class="meta">#import <span class="meta-string">"RSA.h"</span></span></span><br><span class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">CryptoExport</span> : <span class="title">NSObject</span>&lt;<span class="title">RCTBridgeModule</span>&gt;</span></span><br><span class="line"><span class="keyword">@end</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//.mæ–‡ä»¶</span></span><br><span class="line"><span class="meta">#import <span class="meta-string">"CryptoExport.h"</span></span></span><br><span class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">CryptoExport</span></span></span><br><span class="line">RCT_EXPORT_MODULE()<span class="comment">//å¿…é¡»å®šä¹‰çš„å®</span></span><br><span class="line">RCT_EXPORT_METHOD(rsaEncryptValue:(<span class="built_in">NSString</span> *)src withKey:(<span class="built_in">NSString</span> *)rsaKey successCallback:(RCTResponseSenderBlock)successCallback)&#123;</span><br><span class="line">  <span class="built_in">NSString</span> *rsaValue = [RSA encryptString:src publicKey:rsaKey];</span><br><span class="line">  successCallback(@[rsaValue]);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">@end</span></span><br></pre></td></tr></table></figure>
<p>æ¯ä¸ªocçš„æ–¹æ³•å‰å¿…é¡»åŠ ä¸Š RCT_EXPORT_METHOD å®ï¼Œç”¨æ¥æ³¨å†Œæ¨¡å—è¡¨ã€‚ </p>
<p>åœ¨JavaScriptä¸­çš„è°ƒåŠ¨å¦‚ä¸‹</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">NativeModules.CryptoExport.rsaEncryptValue(value, rsaKey,<span class="function"><span class="keyword">function</span> (<span class="params">rsaValue</span>) </span>&#123;</span><br><span class="line">        <span class="built_in">console</span>.log(rsaValue)</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<hr>
<h3 id="React-Native-æ›´æ–°æœºåˆ¶"><a href="#React-Native-æ›´æ–°æœºåˆ¶" class="headerlink" title="React Native æ›´æ–°æœºåˆ¶"></a>React Native æ›´æ–°æœºåˆ¶</h3><p><img src="https://user-gold-cdn.xitu.io/2018/6/8/163de72bf327c5e2?w=1265&amp;h=1181&amp;f=png&amp;s=100866" alt=""><br>ä¹‹å‰æˆ‘ä»¬è¯´è¿‡ï¼ŒReactæ˜¯çŠ¶æ€æœºï¼Œå°±æ˜¯ä¸åœçš„å»æ£€æŸ¥å½“å‰çš„çŠ¶æ€ï¼Œåˆ¤æ–­æ˜¯å¦éœ€è¦åˆ·æ–°ã€‚</p>
<p>è°ƒç”¨this.setState<br><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">ReactClass.prototype.setState = <span class="function"><span class="keyword">function</span>(<span class="params">newState</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">this</span>._reactInternalInstance.receiveComponent(<span class="literal">null</span>, newState);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>è°ƒç”¨å†…éƒ¨receiveComponentæ–¹æ³•ï¼Œè¿™é‡Œåœ¨æ¥å—å…ƒç´ çš„æ—¶å€™ä¸»è¦åˆ†ä¸‰ç§æƒ…å†µï¼š</p>
<ul>
<li>æ–‡æœ¬å…ƒç´ </li>
<li>åŸºæœ¬å…ƒç´ </li>
<li>è‡ªå®šä¹‰å…ƒç´ </li>
</ul>
<p>æ–‡æœ¬å…ƒç´ <br><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">ReactDOMTextComponent.prototype.receiveComponent(nextText, transaction) &#123;</span><br><span class="line">     <span class="comment">//è·Ÿä»¥å‰ä¿å­˜çš„å­—ç¬¦ä¸²æ¯”è¾ƒ</span></span><br><span class="line">    <span class="keyword">if</span> (nextText !== <span class="keyword">this</span>._currentElement) &#123;</span><br><span class="line">      <span class="keyword">this</span>._currentElement = nextText;</span><br><span class="line">      <span class="keyword">var</span> nextStringText = <span class="string">''</span> + nextText;</span><br><span class="line">      <span class="keyword">if</span> (nextStringText !== <span class="keyword">this</span>._stringText) &#123;</span><br><span class="line">        <span class="keyword">this</span>._stringText = nextStringText;</span><br><span class="line">        <span class="keyword">var</span> commentNodes = <span class="keyword">this</span>.getHostNode();</span><br><span class="line">        <span class="comment">// æ›¿æ¢æ–‡æœ¬å…ƒç´ </span></span><br><span class="line">        DOMChildrenOperations.replaceDelimitedText(</span><br><span class="line">          commentNodes[<span class="number">0</span>],</span><br><span class="line">          commentNodes[<span class="number">1</span>],</span><br><span class="line">          nextStringText</span><br><span class="line">        );</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure></p>
<p>åŸºæœ¬å…ƒç´ <br><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">ReactDOMComponent.prototype.receiveComponent = <span class="function"><span class="keyword">function</span>(<span class="params">nextElement, transaction, context</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> prevElement = <span class="keyword">this</span>._currentElement;</span><br><span class="line">    <span class="keyword">this</span>._currentElement = nextElement;</span><br><span class="line">    <span class="keyword">this</span>.updateComponent(transaction, prevElement, nextElement, context);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>updateComponent æ–¹æ³•<br><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">ReactDOMComponent.prototype.updateComponent = <span class="function"><span class="keyword">function</span>(<span class="params">transaction, prevElement, nextElement, context</span>) </span>&#123;</span><br><span class="line">    <span class="comment">// ç•¥.....</span></span><br><span class="line">    <span class="comment">//éœ€è¦å•ç‹¬çš„æ›´æ–°å±æ€§</span></span><br><span class="line">    <span class="keyword">this</span>._updateDOMProperties(lastProps, nextProps, transaction, isCustomComponentTag);</span><br><span class="line">    <span class="comment">//å†æ›´æ–°å­èŠ‚ç‚¹</span></span><br><span class="line">    <span class="keyword">this</span>._updateDOMChildren(</span><br><span class="line">      lastProps,</span><br><span class="line">      nextProps,</span><br><span class="line">      transaction,</span><br><span class="line">      context</span><br><span class="line">    );</span><br><span class="line">    <span class="comment">// ......</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>è‡ªå®šä¹‰å…ƒç´ <br><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">ReactCompositeComponent.prototype.receiveComponent = <span class="function"><span class="keyword">function</span>(<span class="params">nextElement, transaction, nextContext</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> prevElement = <span class="keyword">this</span>._currentElement;</span><br><span class="line">    <span class="keyword">var</span> prevContext = <span class="keyword">this</span>._context;</span><br><span class="line">    <span class="keyword">this</span>._pendingElement = <span class="literal">null</span>;</span><br><span class="line">    <span class="keyword">this</span>.updateComponent(</span><br><span class="line">      transaction,</span><br><span class="line">      prevElement,</span><br><span class="line">      nextElement,</span><br><span class="line">      prevContext,</span><br><span class="line">      nextContext</span><br><span class="line">    );</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>updateComponent æ–¹æ³•<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">ReactCompositeComponent.prototype.updateComponent = function(</span><br><span class="line">    transaction,</span><br><span class="line">    prevParentElement,</span><br><span class="line">    nextParentElement,</span><br><span class="line">    prevUnmaskedContext,</span><br><span class="line">    nextUnmaskedContext</span><br><span class="line">)&#123;</span><br><span class="line">//çœç•¥</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>è°ƒç”¨å†…éƒ¨ _performComponentUpdate æ–¹æ³•<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">ReactCompositeComponent.prototype._updateRenderedComponentWithNextElement = function() &#123;</span><br><span class="line"></span><br><span class="line">    // åˆ¤å®šä¸¤ä¸ªelementéœ€ä¸éœ€è¦æ›´æ–°</span><br><span class="line">    if (shouldUpdateReactComponent(prevRenderedElement, nextRenderedElement)) &#123;</span><br><span class="line">      // å¦‚æœéœ€è¦æ›´æ–°ï¼Œå°±ç»§ç»­è°ƒç”¨å­èŠ‚ç‚¹çš„receiveComponentçš„æ–¹æ³•ï¼Œä¼ å…¥æ–°çš„elementæ›´æ–°å­èŠ‚ç‚¹ã€‚</span><br><span class="line">      ReactReconciler.receiveComponent(</span><br><span class="line">        prevComponentInstance,</span><br><span class="line">        nextRenderedElement,</span><br><span class="line">        transaction,</span><br><span class="line">        this._processChildContext(context)</span><br><span class="line">      );</span><br><span class="line">    &#125; else &#123;</span><br><span class="line">      // å¸è½½ä¹‹å‰çš„å­èŠ‚ç‚¹ï¼Œå®‰è£…æ–°çš„å­èŠ‚ç‚¹</span><br><span class="line">      var oldHostNode = ReactReconciler.getHostNode(prevComponentInstance);</span><br><span class="line">      ReactReconciler.unmountComponent(</span><br><span class="line">        prevComponentInstance,</span><br><span class="line">        safely,</span><br><span class="line">        false /* skipLifecycle */</span><br><span class="line">      );</span><br><span class="line">      var nodeType = ReactNodeTypes.getType(nextRenderedElement);</span><br><span class="line">      this._renderedNodeType = nodeType;</span><br><span class="line">      var child = this._instantiateReactComponent(</span><br><span class="line">        nextRenderedElement,</span><br><span class="line">        nodeType !== ReactNodeTypes.EMPTY /* shouldHaveDebugID */</span><br><span class="line">      );</span><br><span class="line">      this._renderedComponent = child;</span><br><span class="line"></span><br><span class="line">      var nextMarkup = ReactReconciler.mountComponent(</span><br><span class="line">        child,</span><br><span class="line">        transaction,</span><br><span class="line">        this._hostParent,</span><br><span class="line">        this._hostContainerInfo,</span><br><span class="line">        this._processChildContext(context),</span><br><span class="line">        debugID</span><br><span class="line">      );</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure></p>
<p>this._updateDOMChildren æ–¹æ³•å†…éƒ¨è°ƒç”¨diffç®—æ³•</p>
<p><img src="https://user-gold-cdn.xitu.io/2018/6/8/163de72bf39b9c2b?w=691&amp;h=889&amp;f=png&amp;s=50345" alt=""></p>
<p>å®ç°è¿‡ç¨‹<br><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br></pre></td><td class="code"><pre><span class="line">_updateChildren: <span class="function"><span class="keyword">function</span>(<span class="params">nextNestedChildrenElements, transaction, context</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> prevChildren = <span class="keyword">this</span>._renderedChildren;</span><br><span class="line">    <span class="keyword">var</span> removedNodes = &#123;&#125;;</span><br><span class="line">    <span class="keyword">var</span> mountImages = [];</span><br><span class="line"></span><br><span class="line">    <span class="comment">// è·å–æ–°çš„å­å…ƒç´ æ•°ç»„</span></span><br><span class="line">    <span class="keyword">var</span> nextChildren = <span class="keyword">this</span>._reconcilerUpdateChildren(</span><br><span class="line">      prevChildren,</span><br><span class="line">      nextNestedChildrenElements,</span><br><span class="line">      mountImages,</span><br><span class="line">      removedNodes,</span><br><span class="line">      transaction,</span><br><span class="line">      context</span><br><span class="line">    );</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!nextChildren &amp;&amp; !prevChildren) &#123;</span><br><span class="line">      <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">var</span> updates = <span class="literal">null</span>;</span><br><span class="line">    <span class="keyword">var</span> name;</span><br><span class="line">    <span class="keyword">var</span> nextIndex = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">var</span> lastIndex = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">var</span> nextMountIndex = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">var</span> lastPlacedNode = <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (name <span class="keyword">in</span> nextChildren) &#123;</span><br><span class="line">      <span class="keyword">if</span> (!nextChildren.hasOwnProperty(name)) &#123;</span><br><span class="line">        <span class="keyword">continue</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">var</span> prevChild = prevChildren &amp;&amp; prevChildren[name];</span><br><span class="line">      <span class="keyword">var</span> nextChild = nextChildren[name];</span><br><span class="line">      <span class="keyword">if</span> (prevChild === nextChild) &#123;</span><br><span class="line">          <span class="comment">// åŒä¸€ä¸ªå¼•ç”¨ï¼Œè¯´æ˜æ˜¯ä½¿ç”¨çš„åŒä¸€ä¸ªcomponent,æ‰€ä»¥æˆ‘ä»¬éœ€è¦åšç§»åŠ¨çš„æ“ä½œ</span></span><br><span class="line">          <span class="comment">// ç§»åŠ¨å·²æœ‰çš„å­èŠ‚ç‚¹</span></span><br><span class="line">          <span class="comment">// NOTICEï¼šè¿™é‡Œæ ¹æ®nextIndex, lastIndexå†³å®šæ˜¯å¦ç§»åŠ¨</span></span><br><span class="line">        updates = enqueue(</span><br><span class="line">          updates,</span><br><span class="line">          <span class="keyword">this</span>.moveChild(prevChild, lastPlacedNode, nextIndex, lastIndex)</span><br><span class="line">        );</span><br><span class="line"></span><br><span class="line">        <span class="comment">// æ›´æ–°lastIndex</span></span><br><span class="line">        lastIndex = <span class="built_in">Math</span>.max(prevChild._mountIndex, lastIndex);</span><br><span class="line">        <span class="comment">// æ›´æ–°componentçš„.mountIndexå±æ€§</span></span><br><span class="line">        prevChild._mountIndex = nextIndex;</span><br><span class="line"></span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (prevChild) &#123;</span><br><span class="line">          <span class="comment">// æ›´æ–°lastIndex</span></span><br><span class="line">          lastIndex = <span class="built_in">Math</span>.max(prevChild._mountIndex, lastIndex);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// æ·»åŠ æ–°çš„å­èŠ‚ç‚¹åœ¨æŒ‡å®šçš„ä½ç½®ä¸Š</span></span><br><span class="line">        updates = enqueue(</span><br><span class="line">          updates,</span><br><span class="line">          <span class="keyword">this</span>._mountChildAtIndex(</span><br><span class="line">            nextChild,</span><br><span class="line">            mountImages[nextMountIndex],</span><br><span class="line">            lastPlacedNode,</span><br><span class="line">            nextIndex,</span><br><span class="line">            transaction,</span><br><span class="line">            context</span><br><span class="line">          )</span><br><span class="line">        );</span><br><span class="line"></span><br><span class="line">        nextMountIndex++;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="comment">// æ›´æ–°nextIndex</span></span><br><span class="line">      nextIndex++;</span><br><span class="line">      lastPlacedNode = ReactReconciler.getHostNode(nextChild);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ç§»é™¤æ‰ä¸å­˜åœ¨çš„æ—§å­èŠ‚ç‚¹ï¼Œå’Œæ—§å­èŠ‚ç‚¹å’Œæ–°å­èŠ‚ç‚¹ä¸åŒçš„æ—§å­èŠ‚ç‚¹</span></span><br><span class="line">    <span class="keyword">for</span> (name <span class="keyword">in</span> removedNodes) &#123;</span><br><span class="line">      <span class="keyword">if</span> (removedNodes.hasOwnProperty(name)) &#123;</span><br><span class="line">        updates = enqueue(</span><br><span class="line">          updates,</span><br><span class="line">          <span class="keyword">this</span>._unmountChild(prevChildren[name], removedNodes[name])</span><br><span class="line">        );</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure></p>
<blockquote>
<p>ä»¥ä¸‹æ˜¯é’ˆå¯¹ Demo é¡¹ç›®çš„é€šä¿¡åŸç†è§£é‡Š</p>
</blockquote>
<h3 id="é€šä¿¡åŸºæœ¬åŸç†"><a href="#é€šä¿¡åŸºæœ¬åŸç†" class="headerlink" title="é€šä¿¡åŸºæœ¬åŸç†"></a>é€šä¿¡åŸºæœ¬åŸç†</h3><p>é¦–å…ˆï¼Œæˆ‘ä»¬æ¥çœ‹ä¸€ä¸‹åœ¨iOSä¸­Nativeå¦‚ä½•è°ƒç”¨JSã€‚ä»iOS7å¼€å§‹ï¼Œç³»ç»Ÿè¿›ä¸€æ­¥å¼€æ”¾äº†WebCore SDKï¼Œæä¾›JavaScriptå¼•æ“åº“ï¼Œä½¿å¾—æˆ‘ä»¬èƒ½å¤Ÿç›´æ¥ä¸å¼•æ“äº¤äº’æ‹¥æœ‰æ›´å¤šçš„æ§åˆ¶æƒã€‚å…¶ä¸­ï¼Œæœ‰ä¸¤ä¸ªæœ€åŸºç¡€çš„æ¦‚å¿µï¼š</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">JSContext <span class="comment">// JSä»£ç çš„ç¯å¢ƒï¼Œä¸€ä¸ªJSContextæ˜¯ä¸€ä¸ªå…¨å±€ç¯å¢ƒçš„å®ä¾‹</span></span><br><span class="line">JSValue <span class="comment">// åŒ…è£…äº†æ¯ä¸€ä¸ªå¯èƒ½çš„JSå€¼ï¼šå­—ç¬¦ä¸²ã€æ•°å­—ã€æ•°ç»„ã€å¯¹è±¡ã€æ–¹æ³•ç­‰</span></span><br></pre></td></tr></table></figure>
<p>é€šè¿‡è¿™ä¸¤ä¸ªç±»ï¼Œæˆ‘ä»¬èƒ½å¤Ÿéå¸¸æ–¹ä¾¿çš„å®ç°Javascriptä¸Nativeä»£ç ä¹‹é—´çš„äº¤äº’ï¼Œé¦–å…ˆæˆ‘ä»¬é€šè¿‡ä¸€ä¸ªç®€å•ç¤ºä¾‹æ¥è§‚å¯ŸNativeå¦‚ä½•è°ƒç”¨Javascriptä»£ç ï¼š</p>
<p>ğŸŒ°ï¼šNative -&gt; JavaScript</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// å¤´æ–‡ä»¶</span></span><br><span class="line"><span class="meta">#import <span class="meta-string">&lt;JavaScriptCore/JSContext.h&gt;</span></span></span><br><span class="line"><span class="meta">#import <span class="meta-string">&lt;JavaScriptCore/JSValue.h&gt;</span></span></span><br><span class="line">- (<span class="keyword">void</span>)createJSContext &#123;</span><br><span class="line">    JSContext *context = [[JSContext alloc] init];</span><br><span class="line">    [context evaluateScript:<span class="string">@"var num = 5 + 5"</span>];</span><br><span class="line">    [context evaluateScript:<span class="string">@"var names = ['Grace', 'Ada', 'Margaret']"</span>];</span><br><span class="line">    [context evaluateScript:<span class="string">@"var triple = function(value) &#123; return value * 3 &#125;"</span>];</span><br><span class="line">    JSValue *tripleNum = [context evaluateScript:<span class="string">@"triple(num)"</span>];</span><br><span class="line">    JSValue *tripleFunction = context[<span class="string">@"triple"</span>];</span><br><span class="line">    JSValue *result = [tripleFunction callWithArguments:@[@<span class="number">5</span>]];</span><br><span class="line">    <span class="comment">// æ‰“å°ç»“æœ</span></span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@"JSContext function \ntripleNum:%@ \nresult:%@"</span>, tripleNum, result);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>é‚£ä¹ˆï¼ŒJSContextå¦‚ä½•è®¿é—®æˆ‘ä»¬æœ¬åœ°å®¢æˆ·ç«¯OCä»£ç å‘¢ï¼Ÿç­”æ¡ˆæ˜¯é€šè¿‡Blockså’ŒJSExportsåè®®ä¸¤ç§æ–¹å¼ã€‚<br>æˆ‘ä»¬æ¥çœ‹ä¸€ä¸ªé€šè¿‡Blocksæ¥å®ç°JSè®¿é—®æœ¬åœ°ä»£ç çš„ç¤ºä¾‹ï¼š</p>
<p>ğŸŒ°ï¼šJavaScript -&gt; Native</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">context[<span class="string">@"testSay"</span>] = ^(<span class="built_in">NSString</span> *input) &#123;</span><br><span class="line">    <span class="built_in">NSMutableString</span> *mutableString = [input mutableCopy];</span><br><span class="line">    <span class="built_in">CFStringTransform</span>((__bridge <span class="built_in">CFMutableStringRef</span>)mutableString, <span class="literal">NULL</span>, kCFStringTransformToLatin, <span class="literal">NO</span>);</span><br><span class="line">    <span class="built_in">CFStringTransform</span>((__bridge <span class="built_in">CFMutableStringRef</span>)mutableString, <span class="literal">NULL</span>, kCFStringTransformStripCombiningMarks, <span class="literal">NO</span>);</span><br><span class="line">    <span class="keyword">return</span> mutableString;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="built_in">NSLog</span>(<span class="string">@"%@"</span>, [context evaluateScript:<span class="string">@"testSay('hello world')"</span>]);</span><br></pre></td></tr></table></figure>
<p>å…³äºJSCoreåº“çš„æ›´å¤šå­¦ä¹ ä»‹ç»ï¼Œè¯·çœ‹JavaScriptCoreã€‚</p>
<blockquote>
<p>Javaâ€‹Scriptâ€‹Core ç›¸å…³ä»‹ç» <a href="http://nshipster.cn/javascriptcore/" target="_blank" rel="noopener">http://nshipster.cn/javascriptcore/</a></p>
</blockquote>
<h3 id="React-Native-åˆå§‹åŒ–è¿‡ç¨‹è§£æ"><a href="#React-Native-åˆå§‹åŒ–è¿‡ç¨‹è§£æ" class="headerlink" title="React Native åˆå§‹åŒ–è¿‡ç¨‹è§£æ"></a>React Native åˆå§‹åŒ–è¿‡ç¨‹è§£æ</h3><p>åœ¨äº†è§£React-Nativeä¸­JS-&gt;Nativeçš„å…·ä½“è°ƒç”¨ä¹‹å‰ï¼Œæˆ‘ä»¬å…ˆåšä¸€äº›å‡†å¤‡å·¥ä½œï¼Œçœ‹çœ‹æ¡†æ¶ä¸­Native appçš„å¯åŠ¨è¿‡ç¨‹ã€‚æ‰“å¼€FBæä¾›çš„AwesomeProjectå®šä½åˆ°appDelegateçš„didFinishLaunchingWithOptionsæ–¹æ³•ä¸­ï¼š</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// æŒ‡å®šJSé¡µé¢æ–‡ä»¶ä½ç½®</span></span><br><span class="line">jsCodeLocation = [<span class="built_in">NSURL</span> URLWithString:<span class="string">@"http://localhost:8081/index.ios.bundle?platform=ios&amp;dev=false"</span>];</span><br><span class="line"><span class="comment">// åˆ›å»ºReact Nativeè§†å›¾å¯¹è±¡</span></span><br><span class="line">RCTRootView *rootView = [[RCTRootView alloc] initWithBundleURL:jsCodeLocation</span><br><span class="line">moduleName:<span class="string">@"ReactExperiment"</span></span><br><span class="line">initialProperties:<span class="literal">nil</span></span><br><span class="line">launchOptions:launchOptions];</span><br><span class="line"><span class="keyword">self</span>.window = [[<span class="built_in">UIWindow</span> alloc] initWithFrame:[<span class="built_in">UIScreen</span> mainScreen].bounds];</span><br><span class="line"><span class="comment">// åˆ›å»ºVCï¼Œå¹¶ä¸”æŠŠReact Native Root Viewèµ‹å€¼ç»™VC</span></span><br><span class="line"><span class="built_in">UIViewController</span> *rootViewController = [<span class="built_in">UIViewController</span> new];</span><br><span class="line">rootViewController.view = rootView;</span><br><span class="line"><span class="keyword">self</span>.window.rootViewController = rootViewController;</span><br><span class="line">[<span class="keyword">self</span>.window makeKeyAndVisible];</span><br></pre></td></tr></table></figure>
<p>å¯ä»¥çœ‹åˆ°ä½¿ç”¨é›†æˆéå¸¸ç®€å•ï¼Œé‚£ä¹ˆRCTRootViewåˆ°åº•åšäº†å“ªäº›äº‹æƒ…æœ€åæ¸²æŸ“å°†è§†å›¾å‘ˆç°åœ¨ç”¨æˆ·é¢å‰å‘¢ï¼Ÿ<br>æˆ‘ä»¬ç»§ç»­è·Ÿç€ä»£ç å¾€ä¸‹åˆ†æå°±ä¼šçœ‹åˆ°æˆ‘ä»¬ä»Šå¤©çš„ä¸»è§’RCTBridgeã€‚</p>
<p>ğŸ¥Ÿï¼šRCTBridge</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">- (<span class="keyword">instancetype</span>)initWithBundleURL:(<span class="built_in">NSURL</span> *)bundleURL</span><br><span class="line">moduleName:(<span class="built_in">NSString</span> *)moduleName</span><br><span class="line">initialProperties:(<span class="built_in">NSDictionary</span> *)initialProperties</span><br><span class="line">launchOptions:(<span class="built_in">NSDictionary</span> *)launchOptions &#123;</span><br><span class="line">    RCTBridge *bridge = [[RCTBridge alloc] initWithBundleURL:bundleURL</span><br><span class="line">    moduleProvider:<span class="literal">nil</span></span><br><span class="line">    launchOptions:launchOptions];</span><br><span class="line">    <span class="keyword">return</span> [<span class="keyword">self</span> initWithBridge:bridge moduleName:moduleName initialProperties:initialProperties];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>RCTBridgeæ˜¯Naitiveç«¯çš„bridgeï¼Œèµ·ç€æ¡¥æ¥ä¸¤ç«¯çš„ä½œç”¨ ã€‚äº‹å®ä¸Šå…·ä½“çš„å®ç°æ”¾ç½®åœ¨RCTBatchedBridgeä¸­ï¼Œåœ¨å®ƒçš„startæ–¹æ³•ä¸­æ‰§è¡Œäº†ä¸€ç³»åˆ—é‡è¦çš„åˆå§‹åŒ–å·¥ä½œã€‚è¿™éƒ¨åˆ†ä¹Ÿæ˜¯ReactNative SDKçš„ç²¾é«“æ‰€åœ¨ï¼ŒåŸºäºGCDå®ç°ä¸€å¥—å¼‚æ­¥åˆå§‹åŒ–ç»„ä»¶æ¡†æ¶ã€‚å¤§è‡´çš„å·¥ä½œæµç¨‹å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</p>
<p><img src="https://user-gold-cdn.xitu.io/2018/6/8/163de72bed8ca4d1?w=940&amp;h=370&amp;f=png&amp;s=440483" alt=""></p>
<h4 id="Load-JS-Source-Codeï¼ˆå¹¶è¡Œï¼‰"><a href="#Load-JS-Source-Codeï¼ˆå¹¶è¡Œï¼‰" class="headerlink" title="Load JS Source Codeï¼ˆå¹¶è¡Œï¼‰"></a>Load JS Source Codeï¼ˆå¹¶è¡Œï¼‰</h4><p>åŠ è½½é¡µé¢æºç é˜¶æ®µã€‚è¯¥é˜¶æ®µä¸»è¦è´Ÿè´£ä»æŒ‡å®šçš„ä½ç½®ï¼ˆç½‘ç»œæˆ–è€…æœ¬åœ°ï¼‰åŠ è½½React Nativeé¡µé¢ä»£ç ã€‚ä¸initModuleså„æ¨¡å—åˆå§‹åŒ–è¿‡ç¨‹å¹¶è¡Œæ‰§è¡Œï¼Œé€šè¿‡GCDåˆ†ç»„é˜Ÿåˆ—ä¿è¯ä¸¤ä¸ªé˜¶æ®µå®Œæˆåæ‰ä¼šåŠ è½½è§£æé¡µé¢æºç ã€‚</p>
<h4 id="Init-Moduleï¼ˆåŒæ­¥ï¼‰"><a href="#Init-Moduleï¼ˆåŒæ­¥ï¼‰" class="headerlink" title="Init Moduleï¼ˆåŒæ­¥ï¼‰"></a>Init Moduleï¼ˆåŒæ­¥ï¼‰</h4><p>åˆå§‹åŒ–åŠ è½½React Nativeæ¨¡å—ã€‚è¯¥é˜¶æ®µä¼šå°†æ‰€æœ‰æ³¨å†Œçš„Nativeæ¨¡å—ç±»æ•´ç†ä¿å­˜åˆ°ä¸€ä¸ªä»¥Module Idä¸ºä¸‹æ ‡çš„æ•°ç»„å¯¹è±¡ä¸­ï¼ˆåŒæ—¶è¿˜ä¼šä¿å­˜ä¸€ä¸ªä»¥Module Nameä¸ºKeyçš„Dictionaryï¼Œç”¨äºåšç´¢å¼•æ–¹ä¾¿åç»­çš„æ¨¡å—æŸ¥æ‰¾ï¼‰ã€‚</p>
<p>æ•´ä¸ªæ¨¡å—çš„åŸºç¡€åˆå§‹åŒ–å’Œæ³¨å†Œè¿‡ç¨‹åœ¨ç³»ç»ŸLoad Classé˜¶æ®µå°±ä¼šå®Œæˆã€‚React Nativeå¯¹æ¨¡å—æ³¨å†Œçš„å®ç°è¿˜æ˜¯æ¯”è¾ƒå·§å¦™ã€æ–¹ä¾¿ï¼Œåªéœ€è¦å¯¹ç›®æ ‡ç±»æ·»åŠ ç›¸åº”çš„å®å³å¯ã€‚</p>
<ul>
<li>1.æ³¨å†Œæ¨¡å—ã€‚å®ç°RCTBridgeModuleåè®®ï¼Œå¹¶ä¸”åœ¨å“åº”çš„Implementionæ–‡ä»¶ä¸­æ·»åŠ RCT_EXPORT_MODULEå®ï¼Œè¯¥å®ä¼šä¸ºæ‰€åœ¨ç±»è‡ªåŠ¨æ·»åŠ ä¸€ä¸ª+loadæ–¹æ³•ï¼Œè°ƒç”¨RCTBridgeçš„RCTRegisterModuleå®ç°åœ¨Load Classé˜¶æ®µå°±å®Œæˆæ¨¡å—æ³¨å†Œå·¥ä½œã€‚</li>
<li>2.æ³¨å†Œå‡½æ•°ã€‚å¾…æ³¨å†Œå‡½æ•°æ‰€åœ¨çš„ç±»å¿…é¡»æ˜¯å·²æ³¨å†Œæ¨¡å—ï¼Œåœ¨éœ€è¦æ³¨å†Œçš„å‡½æ•°å‰æ·»åŠ RCT_EXPORT_MODULEå®å³å¯ã€‚</li>
</ul>
<p>å½“ç„¶è¿™é‡Œéœ€è¦æ³¨æ„çš„é—®é¢˜æ˜¯æ¨¡å—åˆå§‹åŒ–æ˜¯ä¸€ä¸ªåŒæ­¥ä»»åŠ¡ï¼Œå®ƒå¿…é¡»è¢«åŒæ­¥åŠ è½½ï¼Œæ‰€ä»¥å½“æ¨¡å—è¾ƒå¤šæ—¶åŠ¿å¿…ä¼šå¸¦æ¥é«˜å»¶è¿Ÿçš„é—®é¢˜ï¼Œä¹Ÿæ˜¯åœ¨æ–°çš„ç‰ˆæœ¬ä¸­SDKå°†Module Methodæ”¹ä¸ºLazy Loadçš„åŸå› ä¹‹ä¸€ã€‚</p>
<h4 id="Setup-JS-Executorï¼ˆå¹¶è¡Œï¼‰"><a href="#Setup-JS-Executorï¼ˆå¹¶è¡Œï¼‰" class="headerlink" title="Setup JS Executorï¼ˆå¹¶è¡Œï¼‰"></a>Setup JS Executorï¼ˆå¹¶è¡Œï¼‰</h4><p>åˆå§‹åŒ–JSå¼•æ“ã€‚React Nativeåœ¨0.18ä¸­å·²ç»å¾ˆå¥½çš„æŠ½è±¡äº†åŸæ¥äº†JSExecutorï¼Œç›®å‰å®ç°äº†RCTWebSocketExecutorå’ŒRCTJSCExecutorä¸¤ä¸ªè„šæœ¬å¼•æ“çš„å°è£…ï¼Œå‰è€…ç”¨äºé€šè¿‡WebSocketé“¾æ¥åˆ°Chromeè°ƒè¯•ï¼Œåè€…åˆ™æ˜¯å†…ç½®é»˜è®¤å¼•æ“ç›´æ¥é€šè¿‡IOS SDK JSContextæ¥å®ç°ç›¸å…³çš„é€»è¾‘ã€‚</p>
<p>å¦å¤–ï¼Œåœ¨æœ¬é˜¶æ®µè¿˜ä¼šé€šè¿‡block hookçš„æ–¹å¼æ³¨å†Œéƒ¨åˆ†æ ¸å¿ƒAPI</p>
<ul>
<li>1.nativeRequireModuleConfigï¼šç”¨äºåœ¨JSç«¯è·å–å¯¹åº”çš„Native Moduleï¼Œåœ¨0.14åçš„ç‰ˆæœ¬React Nativeå·²ç»å¯¹åˆå§‹åŒ–æ¨¡å—åšäº†éƒ¨åˆ†ä¼˜åŒ–ï¼ŒæŠŠå…³äºNative Module Methodéƒ¨åˆ†çš„åŠ è½½å·¥ä½œæ”¾ç½®åœ¨requireModuleConfigæ—¶æ‰åš</li>
<li>2.nativeLoggingHookï¼šè°ƒç”¨Nativeå†™å…¥æ—¥å¿—</li>
<li>3.nativeFlushQueueImmediateï¼šæ‰‹åŠ¨è§¦å‘æ‰§è¡Œå½“å‰Native Callé˜Ÿåˆ—ä¸­æ‰€æœ‰çš„Nativeå¤„ç†è¯·æ±‚</li>
<li>4.nativePerformanceNowï¼šç”¨äºæ€§èƒ½ç»Ÿè®¡ï¼Œè·å–å½“å‰Nativeçš„ç»å¯¹æ—¶é—´ï¼ˆæ¯«ç§’ï¼‰</li>
</ul>
<p>å¯¹äºæ¨¡å—ç±»ä¸­æƒ³è¦å£°æ˜çš„æ–¹æ³•ï¼Œéœ€è¦æ·»åŠ RCT_EXPORT_METHODå®ã€‚å®ƒä¼šç»™æ–¹æ³•åæ·»åŠ â€ rct_export â€œå‰ç¼€ã€‚</p>
<p>ğŸŒ°ï¼šReact è°ƒç”¨ Native çš„ SVProgressHUD æç¤ºçª—</p>
<p>åœ¨ Native ä¸­å£°æ˜æ–¹æ³•<br><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">RCT_EXPORT_METHOD(calliOSActionWithOneParams:(<span class="built_in">NSString</span> *)name) &#123;</span><br><span class="line">    [SVProgressHUD setDefaultMaskType:SVProgressHUDMaskTypeBlack];</span><br><span class="line">    [SVProgressHUD showSuccessWithStatus:[<span class="built_in">NSString</span> stringWithFormat:<span class="string">@"å‚æ•°ï¼š%@"</span>,name]];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>åœ¨ React ä¸­è°ƒç”¨ calliOSActionWithOneParams æ–¹æ³•<br><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&lt;TouchableOpacity style=&#123;styles.calltonative&#125;</span><br><span class="line">    onPress=&#123;()=&gt;&#123;</span><br><span class="line">        RNCalliOSAction.calliOSActionWithOneParams(<span class="string">'hello'</span>);</span><br><span class="line">    &#125;&#125;&gt;</span><br><span class="line">    &lt;Text&gt;ç‚¹å‡»è°ƒç”¨ Native æ–¹æ³•, å¹¶ä¼ é€’ä¸€ä¸ªå‚æ•°&lt;<span class="regexp">/Text&gt;</span></span><br><span class="line"><span class="regexp">&lt;/</span>TouchableOpacity&gt;</span><br></pre></td></tr></table></figure></p>
<h4 id="Module-Configï¼ˆå¹¶è¡Œï¼‰"><a href="#Module-Configï¼ˆå¹¶è¡Œï¼‰" class="headerlink" title="Module Configï¼ˆå¹¶è¡Œï¼‰"></a>Module Configï¼ˆå¹¶è¡Œï¼‰</h4><p>è¿™æ­¥å°†ç¬¬2æ­¥ä¸­çš„Nativeæ¨¡å—ç±»è½¬æ¢æˆJsonï¼Œä¿å­˜ä¸ºremoteModuleConfigã€‚æ³¨æ„åœ¨è¿™é‡Œè·å–åˆ°çš„åˆ—è¡¨å¹¶éå«æœ‰å®Œæ•´æ¨¡å—ä¿¡æ¯ï¼Œè€Œä»…ä»…æ˜¯ä¸€ä¸ªModule Listè€Œå·²ã€‚</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line"><span class="string">"remoteModuleConfig"</span>:[</span><br><span class="line">[</span><br><span class="line"><span class="string">"HTSimpleAPI"</span>, <span class="comment">// module</span></span><br><span class="line">],</span><br><span class="line">[</span><br><span class="line"><span class="string">"RCTViewManager"</span>,</span><br><span class="line">],</span><br><span class="line">[</span><br><span class="line"><span class="string">"HTTestView"</span>,</span><br><span class="line">],</span><br><span class="line">[</span><br><span class="line"><span class="string">"RCTAccessibilityManager"</span>,</span><br><span class="line">],</span><br><span class="line">...</span><br><span class="line">],</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="JS-Source-Codeä»£ç åˆ†æ"><a href="#JS-Source-Codeä»£ç åˆ†æ" class="headerlink" title="JS Source Codeä»£ç åˆ†æ"></a>JS Source Codeä»£ç åˆ†æ</h4><p>JSçš„ä¸»å…¥å£index.ios.jsåœ¨æˆ‘ä»¬çœ‹æ¥åªæœ‰çŸ­çŸ­æ•°åè¡Œï¼Œç„¶è€Œè¿™ä¸æ˜¯æœ€ç»ˆæ‰§è¡Œçš„ä»£ç ã€‚React-Nativeé¡µé¢æºç éœ€è¦é€šè¿‡Transform Serverè½¬æ¢å¤„ç†ï¼Œå¹¶æŠŠè½¬åŒ–åçš„æ¨¡å—ä¸€èµ·åˆå¹¶ä¸ºä¸€ä¸ªbundle.jsï¼Œè¿™ä¸ªè¿‡ç¨‹ç§°ä¸ºbuildBundleã€‚è½¬æ¢åçš„index.ios.bundleæ‰æ˜¯æœ€ç»ˆå¯è¢«Javascriptå¼•æ“ç›´æ¥è§£é‡Šè¿è¡Œçš„ä»£ç ã€‚ä¸‹é¢æˆ‘ä»¬æŒ‰ç…§ä¸»ç¨‹åºçš„é€»è¾‘æ¥åˆ†ææºç å‡ ä¸ªæ ¸å¿ƒæ¨¡å—å®ç°åŸç†ã€‚</p>
<p>åœ¨React Serverä¸­éœ€è¦æŸ¥çœ‹Bundleçš„æ¨¡å—æ˜ å°„å…³ç³»å¯ä»¥ç›´æ¥è®¿é—®ï¼š<a href="http://localhost:8081/index.ios.bundle.mapï¼ŒæŸ¥çœ‹ç›¸å…³ä¾èµ–å’ŒBundleçš„ç¼“å­˜åˆ™å¯ä»¥è®¿é—®ï¼š" target="_blank" rel="noopener">http://localhost:8081/index.ios.bundle.mapï¼ŒæŸ¥çœ‹ç›¸å…³ä¾èµ–å’ŒBundleçš„ç¼“å­˜åˆ™å¯ä»¥è®¿é—®ï¼š</a> <a href="http://localhost:8081/debug" target="_blank" rel="noopener">http://localhost:8081/debug</a></p>
<p>1.BatchedBridge</p>
<p>åœ¨ä¸Šä¸€éƒ¨åˆ†æˆ‘ä»¬çŸ¥é“ï¼ŒNativeå®Œæˆæ¨¡å—åˆå§‹åŒ–åä¼šé€šè¿‡Inject Json Configå°†é…ç½®ä¿¡æ¯åŒæ­¥è‡³JSé‡Œä¸­çš„å…¨å±€å˜é‡__fbBatchedBridgeConfigï¼Œæ‰“å¼€BatchedBridge.jsæˆ‘ä»¬å¯ä»¥çœ‹åˆ°å¦‚ä¸‹ä»£ç ã€‚</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">__d(<span class="string">'BatchedBridge'</span>,<span class="function"><span class="keyword">function</span>(<span class="params">global, require, module, exports</span>) </span>&#123; <span class="string">'use strict'</span>;</span><br><span class="line"><span class="keyword">var</span> MessageQueue=<span class="built_in">require</span>(<span class="string">'MessageQueue'</span>);</span><br><span class="line"><span class="keyword">var</span> BatchedBridge=<span class="keyword">new</span> MessageQueue(</span><br><span class="line">__fbBatchedBridgeConfig.remoteModuleConfig,</span><br><span class="line">__fbBatchedBridgeConfig.localModulesConfig);</span><br><span class="line"><span class="comment">//......</span></span><br><span class="line"><span class="built_in">Object</span>.defineProperty(global,<span class="string">'__fbBatchedBridge'</span>,&#123;<span class="attr">value</span>:BatchedBridge&#125;);</span><br><span class="line"><span class="built_in">module</span>.exports = BatchedBridge;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<p>å¯¹äºè¿™æ®µä»£ç ï¼Œæˆ‘ä»¬å¯ä»¥å¾—å‡ºä»¥ä¸‹å‡ ä¸ªç»“è®ºï¼š</p>
<ul>
<li>1.åœ¨JSç«¯ä¹Ÿå­˜åœ¨ä¸€ä¸ªbridgeæ¨¡å—BatchedBridgeï¼Œä¹Ÿæ˜¯ä¸Nativeå»ºç«‹åŒå‘é€šä¿¡çš„å…³é”®æ‰€åœ¨</li>
<li>2.BatchedBridgeæ˜¯ä¸€ä¸ªMessageQueueå®ä¾‹ï¼Œå®ƒåœ¨åˆ›å»ºæ—¶ä¼ å…¥äº†__fbBatchedBridgeConfigå€¼ä¿å­˜Nativeç«¯æ”¯æŒçš„æ¨¡å—åˆ—è¡¨é…ç½®</li>
</ul>
<p>BatchedBridgeåœ¨åˆ›å»ºæ—¶å°†è‡ªå·±å†™å…¥å…¨å±€å˜é‡<strong>fbBatchedBridgeä¸Šï¼Œè¿™æ ·Nativeå¯ä»¥é€šè¿‡JSContext[@â€</strong>fbBatchedBridgeâ€]è®¿é—®åˆ°JS bridgeå¯¹è±¡ã€‚</p>
<p>2.MessageQueue</p>
<p>æ¥ç€æˆ‘ä»¬ç»§ç»­çœ‹MessageQueueï¼Œå®ƒåœ¨æ•´ä¸ªé€šè®¯é“¾è·¯çš„æœºåˆ¶ä¸Šé¢æœ‰ç€é‡è¦ä½œç”¨ï¼Œé¦–å…ˆæˆ‘ä»¬æ¥è§‚å¯Ÿä¸€ä¸‹å®ƒçš„æ„é€ å‡½æ•°ã€‚</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">constructor</span>(remoteModules, localModules) &#123;</span><br><span class="line"><span class="keyword">this</span>.RemoteModules = &#123;&#125;;</span><br><span class="line"><span class="keyword">this</span>._callableModules = &#123;&#125;;</span><br><span class="line"><span class="keyword">this</span>._queue = [[], [], [], <span class="number">0</span>];</span><br><span class="line"><span class="keyword">this</span>._moduleTable = &#123;&#125;;</span><br><span class="line"><span class="keyword">this</span>._methodTable = &#123;&#125;;</span><br><span class="line"><span class="keyword">this</span>._callbacks = [];</span><br><span class="line"><span class="keyword">this</span>._callbackID = <span class="number">0</span>;</span><br><span class="line"><span class="keyword">this</span>._callID = <span class="number">0</span>;</span><br><span class="line"><span class="comment">//......</span></span><br><span class="line"><span class="keyword">let</span> modulesConfig = <span class="keyword">this</span>._genModulesConfig(remoteModules);</span><br><span class="line"><span class="keyword">this</span>._genModules(modulesConfig);</span><br><span class="line"><span class="comment">//......</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ä»æ„é€ å‡½æ•°ï¼Œæˆ‘ä»¬å¤§è‡´èƒ½äº†è§£MessageQueueçš„å‡ ä¸ªä¿¡æ¯ï¼š</p>
<ul>
<li>1.RemoteModuleså±æ€§ï¼Œç”¨äºä¿å­˜Nativeç«¯æ¨¡å—é…ç½®</li>
<li>2.Callbackså±æ€§ç¼“å­˜jsçš„å›è°ƒæ–¹æ³•</li>
<li>3.Queueäº‹ä»¶é˜Ÿåˆ—ç”¨äºå¤„ç†å„ç±»äº‹ä»¶ç­‰</li>
</ul>
<p>åœ¨æ„é€ å‡½æ•°ä¸­ï¼Œè§£æNativeä¼ å…¥çš„remoteModules JSONï¼Œè½¬æ¢æˆJSå¯¹è±¡</p>
<p>3.Config Modules</p>
<p>æ ¹æ®ä¸Šä¸€æ­¥MessageQueueçš„é€»è¾‘ï¼Œç»§ç»­å¾€ä¸‹è·Ÿè¸ª_genModuleså‡½æ•°ï¼Œå¯ä»¥çœ‹åˆ°åœ¨MessageQueueå·²ç»å¯¹Nativeæ³¨å…¥çš„Module Configåšäº†ä¸€æ¬¡é¢„å¤„ç†ï¼Œå¦‚æœdebugæ¨¡å¼å¯ä»¥çœ‹åˆ°å¤§è‡´çš„æ•°æ®ç»“æ„ä¼šè½¬æ¢æˆå¦‚ä¸‹è¡¨ä¸­æ‰€ç¤ºç»“æ„ï¼ˆå…¶ä¸­HTSimepleAPIæ˜¯ä¸€ä¸ªè‡ªå®šä¹‰æ¨¡å—ï¼‰ã€‚</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">config = [<span class="string">"HTSimpleAPI"</span>, <span class="built_in">Array</span>[<span class="number">1</span>]], moduleID = <span class="number">0</span></span><br><span class="line">config = <span class="literal">null</span>, moduleID = <span class="number">1</span></span><br><span class="line">config = <span class="literal">null</span>, moduleID = <span class="number">2</span></span><br><span class="line">config = [<span class="string">"RCTAccessibilityManager"</span>, <span class="built_in">Array</span>[<span class="number">3</span>]], moduleID = <span class="number">3</span></span><br></pre></td></tr></table></figure>
<p>è‡³äºè¿™æ ·çš„é¢„å¤„ç†æœ‰ä»€ä¹ˆä½œç”¨ï¼Œæˆ‘ä»¬ç»§ç»­å¾€ä¸‹åˆ†æï¼Œåé¢å†æ¥æ€»ç»“ã€‚</p>
<p>4.Lazily Config Methods</p>
<p>å¯¹äºNativeModuleï¼Œå®ƒä»¬åœ¨ä¸Šä¸€æ­¥ä¹‹ååªæœ‰ä¸€ä¸ªåŒ…å«Module Nameç­‰ç®€å•ä¿¡æ¯çš„Module Listçš„å¯¹è±¡ï¼Œåªæœ‰åœ¨å®é™…è°ƒç”¨äº†è¯¥æ¨¡å—ä¹‹åæ‰ä¼šåŠ è½½è¯¥æ¨¡å—çš„å…·ä½“ä¿¡æ¯ï¼ˆæ¯”å¦‚æš´éœ²çš„APIç­‰ï¼‰ã€‚</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> NativeModules = &#123;&#125;;</span><br><span class="line"><span class="built_in">Object</span>.keys(RemoteModules).forEach(<span class="function">(<span class="params">moduleName</span>) =&gt;</span> &#123;</span><br><span class="line"><span class="built_in">Object</span>.defineProperty(NativeModules, moduleName, &#123;</span><br><span class="line">enumerable: <span class="literal">true</span>,</span><br><span class="line">get: <span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line"><span class="keyword">let</span> <span class="built_in">module</span> = RemoteModules[moduleName];</span><br><span class="line"><span class="keyword">if</span> (<span class="built_in">module</span> &amp;&amp; <span class="keyword">typeof</span> <span class="built_in">module</span>.moduleID === <span class="string">'number'</span> &amp;&amp; global.nativeRequireModuleConfig) &#123;</span><br><span class="line"><span class="keyword">const</span> json = global.nativeRequireModuleConfig(moduleName);</span><br><span class="line"><span class="keyword">const</span> config = json &amp;&amp; <span class="built_in">JSON</span>.parse(json);</span><br><span class="line"><span class="built_in">module</span> = config &amp;&amp; BatchedBridge.processModuleConfig(config, <span class="built_in">module</span>.moduleID);</span><br><span class="line">RemoteModules[moduleName] = <span class="built_in">module</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> <span class="built_in">module</span>;</span><br><span class="line">&#125;,</span><br><span class="line">&#125;);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<p>è¿™æ®µä»£ç å®šä¹‰äº†ä¸€ä¸ªå…¨å±€æ¨¡å—NativeModulesï¼Œéå†ä¹‹å‰å–åˆ°çš„remoteModulesï¼Œå°†æ¯ä¸€ä¸ªmoduleåœ¨NativeModuleså¯¹è±¡ä¸Šæ‰©å±•äº†ä¸€ä¸ªgetteræ–¹æ³•ï¼Œè¯¥æ–¹æ³•ä¸­é€šè¿‡nativeRequireModuleConfigè¿›ä¸€æ­¥åŠ è½½æ¨¡å—çš„è¯¦ç»†ä¿¡æ¯ï¼Œé€šè¿‡processModuleConfigå¯¹æ¨¡å—ä¿¡æ¯è¿›è¡Œé¢„å¤„ç†ã€‚è¿›ä¸€æ­¥åˆ†æä»£ç å°±å¯ä»¥å‘ç°è¿™ä¸ªæ–¹æ³•å…¶å®æ˜¯Nativeä¸­å®šä¹‰çš„å…¨å±€JS Blockï¼ˆnativeRequireModuleConfigï¼‰ã€‚</p>
<p>æ¥ä¸‹æ¥æˆ‘ä»¬ç»§ç»­çœ‹processModuleConfigä¸­å…·ä½“çš„ä»£ç é€»è¾‘ï¼Œå¦‚ä¸‹è¡¨æ‰€ç¤ºï¼š</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">processModuleConfig(config, moduleID) &#123;</span><br><span class="line">    <span class="keyword">const</span> <span class="built_in">module</span> = <span class="keyword">this</span>._genModule(config, moduleID);</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">module</span>;</span><br><span class="line">&#125;</span><br><span class="line">_genMethod(<span class="built_in">module</span>, method, type) &#123;</span><br><span class="line"><span class="comment">//......</span></span><br><span class="line">    fn = <span class="function"><span class="keyword">function</span>(<span class="params">...args</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> self.__nativeCall(<span class="built_in">module</span>, method, args, onFail, onSucc);</span><br><span class="line">&#125;;</span><br><span class="line"><span class="comment">//......</span></span><br><span class="line"><span class="keyword">return</span> fn;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>processModuleConfigæ–¹æ³•çš„ä¸»è¦å·¥ä½œæ˜¯ç”Ÿæˆmethodsé…ç½®ï¼Œå¹¶å¯¹æ¯ä¸€ä¸ªmethodå°è£…äº†ä¸€ä¸ªé—­åŒ…fnï¼Œå½“è°ƒç”¨methodæ—¶ï¼Œä¼šè½¬æ¢æˆæˆè°ƒç”¨self.__nativeCall(moduleID, methodID, args, onFail, onSucc)æ–¹æ³•</p>
<p>é¢„å¤„ç†å®Œæˆåï¼Œåœ¨JavaScriptç¯å¢ƒä¸­çš„Moudle Configä¿¡æ¯æ‰ç®—å®Œæ•´ï¼ŒåŒ…å«Module Nameã€Native Methodç­‰ä¿¡æ¯ï¼Œå…·ä½“ä¿¡æ¯å¦‚ä¸‹æ‰€ç¤ºã€‚</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">config = [<span class="string">"HTSimpleAPI"</span>, <span class="built_in">Array</span>[<span class="number">1</span>]], moduleID = <span class="number">0</span></span><br><span class="line">methodName = <span class="string">"test"</span>, methodID = <span class="number">0</span></span><br><span class="line">config = <span class="literal">null</span>, moduleID = <span class="number">1</span></span><br><span class="line">config = <span class="literal">null</span>, moduleID = <span class="number">2</span></span><br><span class="line">config = [<span class="string">"RCTAccessibilityManager"</span>, <span class="built_in">Array</span>[<span class="number">3</span>]], moduleID = <span class="number">3</span></span><br><span class="line">methodName = <span class="string">"setAccessibilityContentSizeMultipliers"</span>, methodID = <span class="number">0</span></span><br><span class="line">methodName = <span class="string">"getMultiplier"</span>, methodID = <span class="number">1</span></span><br><span class="line">methodName = <span class="string">"getCurrentVoiceOverState"</span>, methodID = <span class="number">2</span></span><br></pre></td></tr></table></figure>
<p>è¿˜è®°å¾—ç¬¬äºŒéƒ¨åˆ†ç¬¬5æ­¥ä¸­Nativeç«¯ç”Ÿæˆçš„æ¨¡å—é…ç½®è¡¨å—ï¼Ÿç»“åˆå®ƒçš„ç»“æ„ï¼Œæˆ‘ä»¬å¯ä»¥å¾—çŸ¥ï¼šå¯¹äºModule&amp;Methodï¼Œåœ¨Nativeå’ŒJSç«¯éƒ½ä»¥æ•°ç»„çš„å½¢å¼å­˜æ”¾ï¼Œæ•°ç»„ä¸‹æ ‡å³ä¸ºå®ƒä»¬çš„ModuleIDå’ŒMethodIDã€‚</p>
<p>5.__nativeCall</p>
<p>åˆ†æå®ŒBridgeéƒ¨åˆ†çš„æ˜ å°„å…³ç³»ä»¥åŠæ¨¡å—åŠ è½½ï¼Œé‚£ä¹ˆæˆ‘ä»¬å†æ¥çœ‹çœ‹æœ€ç»ˆè°ƒç”¨Nativeä»£ç æ˜¯å¦‚ä½•å®ç°çš„ã€‚å½“JSè°ƒç”¨module.methodæ—¶ï¼Œå…¶å®è°ƒç”¨äº†self.<strong>nativeCall(module, method, args, onFail, onSucc)ï¼Œå¯¹äº</strong>nativeCallæ–¹æ³•ï¼š</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">__nativeCall(<span class="built_in">module</span>, method, params, onFail, onSucc) &#123;</span><br><span class="line">    <span class="keyword">if</span> (onFail || onSucc) &#123;</span><br><span class="line">    ......</span><br><span class="line">    onFail &amp;&amp; params.push(<span class="keyword">this</span>._callbackID);</span><br><span class="line">    <span class="keyword">this</span>._callbacks[<span class="keyword">this</span>._callbackID++] = onFail;</span><br><span class="line">    onSucc &amp;&amp; params.push(<span class="keyword">this</span>._callbackID);</span><br><span class="line">    <span class="keyword">this</span>._callbacks[<span class="keyword">this</span>._callbackID++] = onSucc;</span><br><span class="line">    &#125;</span><br><span class="line"><span class="keyword">this</span>._queue[MODULE_IDS].push(<span class="built_in">module</span>);</span><br><span class="line"><span class="keyword">this</span>._queue[METHOD_IDS].push(method);</span><br><span class="line"><span class="keyword">this</span>._queue[PARAMS].push(params);</span><br><span class="line">global.nativeFlushQueueImmediate(<span class="keyword">this</span>._queue);</span><br><span class="line">......</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>è¿™æ®µä»£ç ä¸ºæ¯ä¸ªmethodåˆ›å»ºäº†ä¸€ä¸ªé—­åŒ…fnï¼Œåœ¨__nativeCallæ–¹æ³•ä¸­ï¼Œå¹¶ä¸”åœ¨è¿™é‡Œåšäº†ä¸¤ä»¶é‡è¦çš„å·¥ä½œï¼š</p>
<ul>
<li>1.æŠŠonFailå’ŒonSuccç¼“å­˜åˆ°_callbacksä¸­ï¼ŒåŒæ—¶æŠŠcallbackIDæ·»åŠ åˆ°params</li>
<li>2.æŠŠmoduleID, methodID, paramsæ”¾å…¥é˜Ÿåˆ—ä¸­ï¼Œå›è°ƒNativeä»£ç .</li>
</ul>
<p>__nativeCallå¦‚ä½•åšåˆ°å›è°ƒNativeä»£ç å‘¢ï¼Ÿçœ‹ç¬¬äºŒéƒ¨åˆ†ç¬¬3æ­¥ï¼Œåœ¨åˆå§‹åŒ–JSå¼•æ“JSExecutor Setupæ—¶ï¼ŒNativeç«¯æ³¨å†Œä¸€ä¸ªå…¨å±€blockå›è°ƒnativeFlushedQueueImmediateï¼ŒnativeCallåœ¨å¤„ç†å®Œæ¯•åï¼Œé€šè¿‡è¯¥å›è°ƒæŠŠé˜Ÿåˆ—ä½œä¸ºè¿”å›å€¼ä¼ ç»™Nativeã€‚nativeFlushedQueueImmediateçš„å®ç°å¦‚ä¸‹æ‰€ç¤ºã€‚</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">[self addSynchronousHookWithName:@<span class="string">"nativeFlushQueueImmediate"</span> usingBlock:^(NSArray *calls)&#123;</span><br><span class="line">RCTJSCExecutor *strongSelf = weakSelf;</span><br><span class="line">    <span class="keyword">if</span> (!strongSelf.valid || !calls) &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">[strongSelf-&gt;_bridge handleBuffer:calls batchEnded:NO];</span><br><span class="line">&#125;];</span><br></pre></td></tr></table></figure>
<p>è¿™é‡Œçš„handleBufferå°±æ˜¯Nativeç«¯è§£æJSçš„æ¨¡å—è°ƒç”¨æœ€åé€šè¿‡NSInvocationæœºåˆ¶è°ƒç”¨Nativeä»£ç å¯¹åº”çš„é€»è¾‘ã€‚æœ‰å…´è¶£çš„æœ‹å‹ç»§ç»­è·Ÿè¸ªhandleBufferä»£ç ä¼šå‘ç°ï¼Œä»–çš„å®ç°å’ŒReactåœ¨JSç«¯å®šä¹‰çš„MessageQueueæœ‰æƒŠäººçš„ç›¸ä¼¼ä¹‹å¤„ã€‚</p>
<p>6.Call JS function &amp; Callbacks</p>
<p>æœ€åï¼Œæˆ‘ä»¬å›è¿‡å¤´æ¥çœ‹çœ‹Nativeç«¯æ˜¯å¦‚ä½•è°ƒç”¨JSç«¯çš„ç›¸å…³é€»è¾‘çš„ï¼Œè¿™éƒ¨åˆ†æˆ‘ä»¬éœ€è¦å›åˆ°MessageQueue.jsä»£ç ä¸­æ¥ï¼Œå¯ä»¥çœ‹åˆ°MessageQueueæš´éœ²äº†3ä¸ªæ ¸å¿ƒæ–¹æ³•ï¼šâ€™invokeCallbackAndReturnFlushedQueueâ€™ã€â€™callFunctionReturnFlushedQueueâ€™ã€â€™flushedQueueâ€™ã€‚</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// å°†APIæš´éœ²åˆ°å…¨å±€ä½œç”¨åŸŸä¸­</span></span><br><span class="line">[</span><br><span class="line"><span class="string">'invokeCallbackAndReturnFlushedQueue'</span>,</span><br><span class="line"><span class="string">'callFunctionReturnFlushedQueue'</span>,</span><br><span class="line"><span class="string">'flushedQueue'</span>,</span><br><span class="line">].forEach(<span class="function">(<span class="params">fn</span>) =&gt;</span> <span class="keyword">this</span>[fn] = <span class="keyword">this</span>[fn].bind(<span class="keyword">this</span>));</span><br><span class="line">â€¦</span><br><span class="line"><span class="comment">// å£°æ˜å¸¦æœ‰è¿”å›å€¼çš„å‡½æ•°</span></span><br><span class="line">callFunctionReturnFlushedQueue(<span class="built_in">module</span>, method, args) &#123;</span><br><span class="line">guard(<span class="function"><span class="params">()</span> =&gt;</span> &#123;C</span><br><span class="line"><span class="keyword">this</span>.__callFunction(<span class="built_in">module</span>, method, args);</span><br><span class="line"><span class="keyword">this</span>.__callImmediates();</span><br><span class="line">&#125;);</span><br><span class="line"><span class="keyword">return</span> <span class="keyword">this</span>.flushedQueue();</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// å£°æ˜å¸¦æœ‰Callbackçš„å‡½æ•°</span></span><br><span class="line">invokeCallbackAndReturnFlushedQueue(cbID, args) &#123;</span><br><span class="line">guard(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line"><span class="keyword">this</span>.__invokeCallback(cbID, args);</span><br><span class="line"><span class="keyword">this</span>.__callImmediates();</span><br><span class="line">&#125;);</span><br><span class="line"><span class="keyword">return</span> <span class="keyword">this</span>.flushedQueue();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>callFunctionReturnFlushedQueueç”¨äºå®ç°Nativeè°ƒç”¨å¸¦æœ‰è¿”å›å€¼çš„JSç«¯å‡½æ•°ï¼ˆè¿™é‡Œçš„è¿”å›å€¼ä¹Ÿæ˜¯é€šè¿‡Queueæ¥æ¨¡æ‹Ÿï¼‰ï¼›<br>invokeCallbackAndReturnFlushedQueueç”¨äºå®ç°Nativeè°ƒç”¨å¸¦æœ‰Callçš„JSç«¯å‡½æ•°ï¼ˆå¯ä»¥å°†Nativeçš„Callbackä½œä¸ºJSç«¯å‡½æ•°çš„å…¥å‚ï¼ŒJSç«¯æ‰§è¡Œå®Œåè°ƒç”¨Nativeçš„Callbackï¼‰ã€‚</p>
<p>å¯¹äºcallFunctionReturnFlushedQueueæ–¹æ³•ï¼Œå®ƒæœ€ç»ˆè°ƒç”¨çš„æ˜¯__callFunctionï¼š</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">__callFunction(<span class="built_in">module</span>, method, args) &#123;</span><br><span class="line">......</span><br><span class="line"><span class="keyword">var</span> moduleMethods = <span class="keyword">this</span>._callableModules[<span class="built_in">module</span>];</span><br><span class="line">......</span><br><span class="line">moduleMethods[method].apply(moduleMethods, args);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>å¯ä»¥çœ‹åˆ°ï¼Œæ­¤å¤„ä¼šæ ¹æ®Nativeä¼ å…¥çš„module, methodï¼Œè°ƒç”¨JSç«¯ç›¸åº”çš„æ¨¡å—å¹¶ä¼ å…¥å‚æ•°åˆ—è¡¨args.<br>åŒæ—¶æˆ‘ä»¬åˆå¯ä»¥è·å¾—å¯¹äºMessageQueueçš„å¦ä¸€æ¡æ¨æµ‹ï¼Œ_callableModulesç”¨æ¥å­˜æ”¾JSç«¯æš´éœ²ç»™Nativeçš„æ¨¡å—ï¼Œè¿›ä¸€æ­¥åˆ†ææˆ‘ä»¬å¯ä»¥å‘ç°SDKä¸­æ­£æ˜¯é€šè¿‡registerCallableModulesæ–¹æ³•æ³¨å†ŒJSç«¯æš´éœ²APIæ¨¡å—ã€‚</p>
<p>å¯¹äºJS bridgeæä¾›çš„è°ƒç”¨å›è°ƒæ–¹æ³•invokeCallbackAndReturnFlushedQueueï¼ŒåŸç†ä¸Šå’ŒcallFunctionå·®ä¸å¤šï¼Œä¸å†ç»†è¯´ã€‚</p>
<h4 id="JS-Native-é€šä¿¡åŸç†"><a href="#JS-Native-é€šä¿¡åŸç†" class="headerlink" title="JS  Native é€šä¿¡åŸç†"></a>JS <-> Native é€šä¿¡åŸç†</-></h4><p>1.Native-&gt;JS</p>
<p>ç»¼ä¸Šæ‰€è¿°ï¼Œåœ¨JSç«¯æä¾›callFunctionReturnFlushedQueueï¼ŒNative bridgeè°ƒç”¨JSç«¯æ–¹æ³•æ—¶ï¼Œåº”è¯¥ä½¿ç”¨è¿™ä¸ªæ–¹æ³•ã€‚æŸ¥çœ‹Nativeä»£ç å®ç°å¯çŸ¥ï¼ŒRCTBridgeå°è£…äº†enqueueJSCallæ–¹æ³•è°ƒç”¨JSï¼Œæ¢³ç†Native-&gt;JSçš„æ•´ä½“äº¤äº’æµç¨‹å¦‚ä¸‹å›¾æ‰€ç¤ºã€‚</p>
<p><img src="https://user-gold-cdn.xitu.io/2018/6/8/163de72bf259629a?w=940&amp;h=1168&amp;f=png&amp;s=123372" alt=""></p>
<p>ä¹‹å‰å·²ç»è®ºè¿°è¿‡ï¼Œå¦‚æœåœ¨NATIVEç«¯éœ€è¦è‡ªå®šä¹‰æ¨¡å—æä¾›ç»™JSç«¯ä½¿ç”¨é‚£ä¹ˆè¯¥ç±»éœ€è¦å®ç°RCTBridgeModuleåè®® ã€‚</p>
<p>æ­¤å¤–ï¼ŒReact-Nativeæä¾›äº†å¦ä¸€ç§åŸºäºé€šçŸ¥çš„æ–¹å¼ï¼Œé€šè¿‡RCTEventDispatcherå‘é€æ¶ˆæ¯é€šçŸ¥ ã€‚eventDispatcherä½œä¸ºNative Bridgeçš„å±æ€§ï¼Œå°è£…äº†sendEventWithName:body:æ–¹æ³•ã€‚ä½¿ç”¨æ—¶ï¼ŒNativeä¸­ç±»åŒæ ·éœ€è¦å®ç°RCTBridgeModuleåè®®ï¼Œé€šè¿‡self.bridgeå‘é€é€šçŸ¥ï¼ŒJSç«¯å¯¹åº”äº‹ä»¶çš„EventEmitteræ·»åŠ ç›‘å¬å¤„ç†è°ƒç”¨ã€‚</p>
<blockquote>
<p>æŸ¥çœ‹sendEventæ–¹æ³•çš„ä»£ç å¯ä»¥å‘ç°ï¼Œè¿™ç§æ–¹å¼æœ¬è´¨ä¸Šè¿˜æ˜¯è°ƒç”¨enqueueJSCallæ–¹æ³•ã€‚å®˜æ–¹æ¨èæˆ‘ä»¬ä½¿ç”¨é€šçŸ¥çš„æ–¹å¼æ¥å®ç° Native-&gt;JSï¼Œè¿™æ ·å¯ä»¥å‡å°‘æ¨¡å—åˆå§‹åŒ–åŠ è½½è§£æçš„æ—¶é—´ã€‚</p>
</blockquote>
<p>2.JS-&gt;Native</p>
<p>æœ€åï¼Œæˆ‘ä»¬æ¥çœ‹ä¸€ä¸‹JSå¦‚ä½•è°ƒç”¨Nativeã€‚ç­”æ¡ˆæ˜¯JSä¸ä¼šä¸»åŠ¨ä¼ é€’æ•°æ®ç»™Nativeï¼Œä¹Ÿä¸èƒ½ç›´æ¥è°ƒç”¨Nativeï¼ˆä¸€ç§æƒ…å†µé™¤å¤–ï¼Œåœ¨å…¥å£ç›´æ¥é€šè¿‡NativeModulesè°ƒç”¨APIï¼‰ï¼Œåªæœ‰åœ¨Nativeè°ƒç”¨JSæ—¶æ‰ä¼šé€šè¿‡è¿”å›å€¼è§¦å‘è°ƒç”¨ã€‚å› ä¸ºNativeæ˜¯åŸºäºäº‹ä»¶å“åº”æœºåˆ¶çš„ï¼Œæ¯”å¦‚è§¦æ‘¸äº‹ä»¶ã€å¯åŠ¨äº‹ä»¶ã€å®šæ—¶å™¨äº‹ä»¶ã€å›è°ƒäº‹ä»¶ç­‰ã€‚</p>
<p>å½“äº‹ä»¶å‘ç”Ÿæ—¶ï¼ŒNativeä¼šè°ƒç”¨JSç›¸åº”æ¨¡å—å¤„ç†ï¼Œå®Œæ¯•åå†é€šè¿‡è¿”å›å€¼æŠŠé˜Ÿåˆ—ä¼ é€’ç»™Nativeæ‰§è¡Œå¯¹åº”çš„ä»£ç ã€‚</p>
<p><img src="https://user-gold-cdn.xitu.io/2018/6/8/163de72bf3201885?w=940&amp;h=1168&amp;f=png&amp;s=123372" alt=""></p>
<p>å¦‚ä¸Šå›¾æ‰€ç¤ºï¼Œæ•´ä¸ªè°ƒç”¨è¿‡ç¨‹å¯ä»¥å½’çº³ä¸ºï¼š</p>
<ul>
<li>1.JSæŠŠéœ€è¦Module, Method, args(CallbackID)ä¿å­˜åœ¨é˜Ÿåˆ—ä¸­ï¼Œ ä½œä¸ºè¿”å›å€¼é€šè¿‡blockså›è°ƒNative</li>
<li>2.Nativeè°ƒç”¨ç›¸åº”æ¨¡å—æ–¹æ³•ï¼Œå®Œæˆ</li>
<li>3.Nativeé€šè¿‡CallbackIDè°ƒç”¨JSå›è°ƒ</li>
</ul>
<h3 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h3><p>React Nativeçš„é€šè®¯åŸºç¡€å»ºç«‹åœ¨ä¼ ç»Ÿçš„JS Bridgeä¹‹ä¸Šï¼Œä¸è¿‡å¯¹äºBridgeå¤„ç†çš„MessageQueueæœºåˆ¶ã€æ¨¡å—å®šä¹‰ã€åŠ è½½æœºåˆ¶ä¸Šçš„å·§å¦™å¤„ç†æŒ‡çš„å€Ÿé‰´ã€‚å¯¹äºä¸Šè¿°çš„æ•´ä¸ªåŸç†è§£æå¯ä»¥æ¦‚æ‹¬ä¸ºä»¥ä¸‹å››ä¸ªéƒ¨åˆ†ï¼š</p>
<ul>
<li>1.åœ¨å¯åŠ¨é˜¶æ®µï¼Œåˆå§‹åŒ–JSå¼•æ“ï¼Œç”ŸæˆNativeç«¯æ¨¡å—é…ç½®è¡¨å­˜äºä¸¤ç«¯ï¼Œå…¶ä¸­æ¨¡å—é…ç½®æ˜¯åŒæ­¥å–å¾—ï¼Œè€Œå„æ¨¡å—çš„æ–¹æ³•é…ç½®åœ¨è¯¥æ–¹æ³•è¢«çœŸæ­£è°ƒç”¨æ—¶æ‡’åŠ è½½ã€‚</li>
<li>2.Nativeå’ŒJSç«¯åˆ†åˆ«æœ‰ä¸€ä¸ªbridgeï¼Œå‘ç”Ÿè°ƒç”¨æ—¶ï¼Œè°ƒç”¨ç«¯bridgeæŸ¥æ‰¾æ¨¡å—é…ç½®è¡¨å°†è°ƒç”¨è½¬æ¢æˆ{moduleID, methodID, args(callbackID)}ï¼Œå¤„ç†ç«¯é€šè¿‡åŒä¸€ä»½æ¨¡å—é…ç½®è¡¨è½¬æ¢ä¸ºå®é™…çš„æ–¹æ³•å®ç°ã€‚</li>
<li>3.Native-&gt;JSï¼ŒåŸç†ä¸Šä½¿ç”¨JSCoreä»Nativeæ‰§è¡ŒJSä»£ç ï¼ŒReact-Nativeåœ¨æ­¤åŸºç¡€ä¸Šç»™æˆ‘ä»¬æä¾›äº†é€šçŸ¥å‘é€çš„æ‰§è¡Œæ–¹å¼ã€‚</li>
<li>4.JS-&gt;Nativeï¼ŒåŸç†ä¸ŠJSå¹¶ä¸ä¸»åŠ¨è°ƒç”¨Nativeï¼Œè€Œæ˜¯æŠŠæ–¹æ³•å’Œå‚æ•°(å›è°ƒ)ç¼“å­˜åˆ°é˜Ÿåˆ—ä¸­ï¼Œåœ¨Nativeäº‹ä»¶è§¦å‘å¹¶è®¿é—®JSåï¼Œé€šè¿‡blockså›è°ƒNativeã€‚</li>
</ul>
<blockquote>
<p>ä»¥ä¸ŠåŸç†è§£ææ–‡ç« æ¥æºï¼š<a href="http://i.dotidea.cn/2016/05/react-native-communication-principle-for-ios/ã€https://blog.csdn.net/passionhe/article/details/52498061ã€https://blog.csdn.net/xiangzhihong8/article/details/54425807" target="_blank" rel="noopener">http://i.dotidea.cn/2016/05/react-native-communication-principle-for-ios/ã€https://blog.csdn.net/passionhe/article/details/52498061ã€https://blog.csdn.net/xiangzhihong8/article/details/54425807</a></p>
</blockquote>

      
    </div>
    <footer class="article-footer">
      
        <div id="donation_div"></div>

<script src="../../../../js/vdonate.js"></script>
<script>
var a = new Donate({
  title: 'å¦‚æœè§‰å¾—æˆ‘çš„æ–‡ç« å¯¹æ‚¨æœ‰ç”¨ï¼Œè¯·éšæ„æ‰“èµã€‚æ‚¨çš„æ”¯æŒå°†é¼“åŠ±æˆ‘ç»§ç»­åˆ›ä½œ!', // å¯é€‰å‚æ•°ï¼Œæ‰“èµæ ‡é¢˜
  btnText: 'Donate', // å¯é€‰å‚æ•°ï¼Œæ‰“èµæŒ‰é’®æ–‡å­—
  el: document.getElementById('donation_div'),
  wechatImage: 'http://ghexoblogimages.oss-cn-beijing.aliyuncs.com/18-11-14/6067039.jpg',
  alipayImage: 'http://ghexoblogimages.oss-cn-beijing.aliyuncs.com/18-11-16/6997594.jpg'
});
</script>
      
      
      
        
	<div id="comment">
		<!-- æ¥å¿…åŠ›Cityç‰ˆå®‰è£…ä»£ç  -->
		<div id="lv-container" data-id="city" data-uid="MTAyMC80MTA5OC8xNzYyMw==">
		<script type="text/javascript">
		   (function(d, s) {
		       var j, e = d.getElementsByTagName(s)[0];

		       if (typeof LivereTower === 'function') { return; }

		       j = d.createElement(s);
		       j.src = 'https://cdn-city.livere.com/js/embed.dist.js';
		       j.async = true;

		       e.parentNode.insertBefore(j, e);
		   })(document, 'script');
		</script>
		<noscript>ä¸ºæ­£å¸¸ä½¿ç”¨æ¥å¿…åŠ›è¯„è®ºåŠŸèƒ½è¯·æ¿€æ´»JavaScript</noscript>
		</div>
		<!-- Cityç‰ˆå®‰è£…ä»£ç å·²å®Œæˆ -->
	</div>



      
      

    </footer>
  </div>
  
    
<nav id="article-nav">
  
    <a href="../../12/iOS Principle Notification/" id="article-nav-newer" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Newer</strong>
      <div class="article-nav-title">
        
          iOS Principleï¼šNotification
        
      </div>
    </a>
  
  
    <a href="../../10/iOS Principle Block/" id="article-nav-older" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Older</strong>
      <div class="article-nav-title">iOS Principleï¼šBlock</div>
    </a>
  
</nav>

  
</article>

<!-- Table of Contents -->

  <aside id="toc-sidebar">
    <div id="toc" class="toc-article">
    <strong class="toc-title">Contents</strong>
    
        <ol class="nav"><li class="nav-item nav-level-3"><a class="nav-link" href="#æ–¹ä¾¿è®°å¿†ï¼š"><span class="nav-number">1.</span> <span class="nav-text">æ–¹ä¾¿è®°å¿†ï¼š</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#å‡†å¤‡å·¥ä½œï¼Œé¦–å…ˆè¦æœ‰ä¸ªè§£å‰–å¯¹è±¡"><span class="nav-number">2.</span> <span class="nav-text">å‡†å¤‡å·¥ä½œï¼Œé¦–å…ˆè¦æœ‰ä¸ªè§£å‰–å¯¹è±¡</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#React-åŸç†æ¢ç©¶"><span class="nav-number">3.</span> <span class="nav-text">React åŸç†æ¢ç©¶</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#React-Native-åŸç†æ¢ç©¶"><span class="nav-number">4.</span> <span class="nav-text">React Native åŸç†æ¢ç©¶</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#è°ˆè°ˆ-RN-çš„æ•…äº‹èƒŒæ™¯"><span class="nav-number">4.1.</span> <span class="nav-text">è°ˆè°ˆ RN çš„æ•…äº‹èƒŒæ™¯</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#è°ˆè°ˆ-RN-çš„åŸç†"><span class="nav-number">4.2.</span> <span class="nav-text">è°ˆè°ˆ RN çš„åŸç†</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#ç»§ç»­çœ‹é¡¹ç›®-åˆå§‹åŒ–"><span class="nav-number">5.</span> <span class="nav-text">ç»§ç»­çœ‹é¡¹ç›®-åˆå§‹åŒ–</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#åˆ›å»º-BatchedBridge-çš„å…³é”®æ˜¯-start-æ–¹æ³•ï¼Œå®ƒå¯ä»¥åˆ†ä¸ºäº”ä¸ªæ­¥éª¤ï¼š"><span class="nav-number">5.1.</span> <span class="nav-text">åˆ›å»º BatchedBridge çš„å…³é”®æ˜¯ start æ–¹æ³•ï¼Œå®ƒå¯ä»¥åˆ†ä¸ºäº”ä¸ªæ­¥éª¤ï¼š</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#æ–¹æ³•è°ƒç”¨"><span class="nav-number">6.</span> <span class="nav-text">æ–¹æ³•è°ƒç”¨</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#OC-è°ƒç”¨-JavaScript"><span class="nav-number">6.1.</span> <span class="nav-text">OC è°ƒç”¨ JavaScript</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#JavaScriptè°ƒç”¨OC"><span class="nav-number">6.2.</span> <span class="nav-text">JavaScriptè°ƒç”¨OC</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#React-Native-æ›´æ–°æœºåˆ¶"><span class="nav-number">7.</span> <span class="nav-text">React Native æ›´æ–°æœºåˆ¶</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#é€šä¿¡åŸºæœ¬åŸç†"><span class="nav-number">8.</span> <span class="nav-text">é€šä¿¡åŸºæœ¬åŸç†</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#React-Native-åˆå§‹åŒ–è¿‡ç¨‹è§£æ"><span class="nav-number">9.</span> <span class="nav-text">React Native åˆå§‹åŒ–è¿‡ç¨‹è§£æ</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#Load-JS-Source-Codeï¼ˆå¹¶è¡Œï¼‰"><span class="nav-number">9.1.</span> <span class="nav-text">Load JS Source Codeï¼ˆå¹¶è¡Œï¼‰</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Init-Moduleï¼ˆåŒæ­¥ï¼‰"><span class="nav-number">9.2.</span> <span class="nav-text">Init Moduleï¼ˆåŒæ­¥ï¼‰</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Setup-JS-Executorï¼ˆå¹¶è¡Œï¼‰"><span class="nav-number">9.3.</span> <span class="nav-text">Setup JS Executorï¼ˆå¹¶è¡Œï¼‰</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Module-Configï¼ˆå¹¶è¡Œï¼‰"><span class="nav-number">9.4.</span> <span class="nav-text">Module Configï¼ˆå¹¶è¡Œï¼‰</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#JS-Source-Codeä»£ç åˆ†æ"><span class="nav-number">9.5.</span> <span class="nav-text">JS Source Codeä»£ç åˆ†æ</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#JS-Native-é€šä¿¡åŸç†"><span class="nav-number">9.6.</span> <span class="nav-text">JS  Native é€šä¿¡åŸç†</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#æ€»ç»“"><span class="nav-number">10.</span> <span class="nav-text">æ€»ç»“</span></a></li></ol>
    
    </div>
  </aside>

</section>
        
      </div>
      
      <footer id="footer">
  

  <div class="container">
      	<div class="row">
	      <p> Powered by <a href="http://hexo.io/" target="_blank">Hexo</a> and <a href="https://github.com/iTimeTraveler/hexo-theme-hiker" target="_blank">Hexo-theme-hiker</a> </p>
	      <p id="copyRightEn">Copyright &copy; 2013 - 2019 Technology All Rights Reserved.</p>
	      
	      
    		<p class="busuanzi_uv">
				UV : <span id="busuanzi_value_site_uv"></span> |  
				PV : <span id="busuanzi_value_site_pv"></span>
		    </p>
  		   
		</div>

		
  </div>
</footer>


<!-- min height -->

<script>
    var wrapdiv = document.getElementById("wrap");
    var contentdiv = document.getElementById("content");
    var allheader = document.getElementById("allheader");

    wrapdiv.style.minHeight = document.body.offsetHeight + "px";
    if (allheader != null) {
      contentdiv.style.minHeight = document.body.offsetHeight - allheader.offsetHeight - document.getElementById("footer").offsetHeight + "px";
    } else {
      contentdiv.style.minHeight = document.body.offsetHeight - document.getElementById("footer").offsetHeight + "px";
    }
</script>
    </div>
    <!-- <nav id="mobile-nav">
  
    <a href="../../../../index.html" class="mobile-nav-link">Home</a>
  
    <a href="../../../../archives" class="mobile-nav-link">Archives</a>
  
    <a href="../../../../categories" class="mobile-nav-link">Categories</a>
  
    <a href="../../../../tags" class="mobile-nav-link">Tags</a>
  
    <a href="../../../../about" class="mobile-nav-link">About</a>
  
</nav> -->
    

<!-- mathjax config similar to math.stackexchange -->

<script type="text/x-mathjax-config">
  MathJax.Hub.Config({
    tex2jax: {
      inlineMath: [ ['$','$'], ["\\(","\\)"] ],
      processEscapes: true
    }
  });
</script>

<script type="text/x-mathjax-config">
    MathJax.Hub.Config({
      tex2jax: {
        skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
      }
    });
</script>

<script type="text/x-mathjax-config">
    MathJax.Hub.Queue(function() {
        var all = MathJax.Hub.getAllJax(), i;
        for(i=0; i < all.length; i += 1) {
            all[i].SourceElement().parentNode.className += ' has-jax';
        }
    });
</script>

<script type="text/javascript" src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
</script>


  <link rel="stylesheet" href="../../../../fancybox/jquery.fancybox.css">
  <script src="../../../../fancybox/jquery.fancybox.pack.js"></script>


<script src="../../../../js/scripts.js"></script>




  <script src="../../../../js/dialog.js"></script>








	<div style="display: none;">
    <script src="https://s95.cnzz.com/z_stat.php?id=1260716016&web_id=1260716016" language="JavaScript"></script>
  </div>



	<script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js">
	</script>






  </div>

  <div class="modal fade" id="myModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true" style="display: none;">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h2 class="modal-title" id="myModalLabel">è®¾ç½®</h2>
      </div>
      <hr style="margin-top:0px; margin-bottom:0px; width:80%; border-top: 3px solid #000;">
      <hr style="margin-top:2px; margin-bottom:0px; width:80%; border-top: 1px solid #000;">


      <div class="modal-body">
          <div style="margin:6px;">
            <a data-toggle="collapse" data-parent="#accordion" href="#collapseOne" onclick="javascript:setFontSize();" aria-expanded="true" aria-controls="collapseOne">
              æ­£æ–‡å­—å·å¤§å°
            </a>
          </div>
          <div id="collapseOne" class="panel-collapse collapse" role="tabpanel" aria-labelledby="headingOne">
          <div class="panel-body">
            æ‚¨å·²è°ƒæ•´é¡µé¢å­—ä½“å¤§å°
          </div>
        </div>
      


          <div style="margin:6px;">
            <a data-toggle="collapse" data-parent="#accordion" href="#collapseTwo" onclick="javascript:setBackground();" aria-expanded="true" aria-controls="collapseTwo">
              å¤œé—´æŠ¤çœ¼æ¨¡å¼
            </a>
        </div>
          <div id="collapseTwo" class="panel-collapse collapse" role="tabpanel" aria-labelledby="headingTwo">
          <div class="panel-body">
            å¤œé—´æ¨¡å¼å·²ç»å¼€å¯ï¼Œå†æ¬¡å•å‡»æŒ‰é’®å³å¯å…³é—­ 
          </div>
        </div>

        <div>
            <a data-toggle="collapse" data-parent="#accordion" href="#collapseThree" aria-expanded="true" aria-controls="collapseThree">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;å…³ äº&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</a>
        </div>
         <div id="collapseThree" class="panel-collapse collapse" role="tabpanel" aria-labelledby="headingThree">
          <div class="panel-body">
            Technology
          </div>
          <div class="panel-body">
            Copyright Â© 2019 Tim&#39;s Blog All Rights Reserved.
          </div>
        </div>
      </div>


      <hr style="margin-top:0px; margin-bottom:0px; width:80%; border-top: 1px solid #000;">
      <hr style="margin-top:2px; margin-bottom:0px; width:80%; border-top: 3px solid #000;">
      <div class="modal-footer">
        <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">Ã—</span></button>
      </div>
    </div>
  </div>
</div>
  
  <a id="rocket" href="#top" class=""></a>
  <script type="text/javascript" src="/js/totop.js?v=1.0.0" async=""></script>
  
    <a id="menu-switch"><i class="fa fa-bars fa-lg"></i></a>
  
</body>
</html>